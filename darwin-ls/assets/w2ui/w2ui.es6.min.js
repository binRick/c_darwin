/* w2ui 2.0.x (nightly) (9/10/2022, 11:11:37 AM) (c) http://w2ui.com, vitmalina@gmail.com */
class w2event{constructor(e,t){Object.assign(this,{type:t.type??null,detail:t,owner:e,target:t.target??null,phase:t.phase??"before",object:t.object??null,execute:null,isStopped:!1,isCancelled:!1,onComplete:null,listeners:[]}),delete t.type,delete t.target,delete t.object,this.complete=new Promise((e,t)=>{this._resolve=e,this._reject=t}),this.complete.catch(()=>{})}finish(e){e&&w2utils.extend(this.detail,e),this.phase="after",this.owner.trigger.call(this.owner,this)}done(e){this.listeners.push(e)}preventDefault(){this._reject(),this.isCancelled=!0}stopPropagation(){this.isStopped=!0}}class w2base{constructor(e){if(this.activeEvents=[],this.listeners=[],void 0!==e){if(!w2utils.checkName(e))return;w2ui[e]=this}this.debug=!1}on(e,t){return(e="string"==typeof e?e.split(/[,\s]+/):[e]).forEach(i=>{var e="string"==typeof i?i:i.type+":"+i.execute+"."+i.scope;if("string"==typeof i){let[e,t]=i.split(".");var[s,l]=e.replace(":complete",":after").replace(":done",":after").split(":");i={type:s,execute:l??"before",scope:t}}(i=w2utils.extend({type:null,execute:"before",onComplete:null},i)).type?t?(Array.isArray(this.listeners)||(this.listeners=[]),this.listeners.push({name:e,edata:i,handler:t}),this.debug&&console.log("w2base: add event",{name:e,edata:i,handler:t})):console.log("ERROR: You must specify event handler function when calling .on() method of "+this.name):console.log("ERROR: You must specify event type when calling .on() method of "+this.name)}),this}off(e,r){return(e="string"==typeof e?e.split(/[,\s]+/):[e]).forEach(i=>{var e="string"==typeof i?i:i.type+":"+i.execute+"."+i.scope;if("string"==typeof i){let[e,t]=i.split(".");var[s,l]=e.replace(":complete",":after").replace(":done",":after").split(":");i={type:s||"*",execute:l||"",scope:t||""}}if((i=w2utils.extend({type:null,execute:null,onComplete:null},i)).type||i.scope){r=r||null;let t=0;this.listeners=this.listeners.filter(e=>"*"!==i.type&&i.type!==e.edata.type||""!==i.execute&&i.execute!==e.edata.execute||""!==i.scope&&i.scope!==e.edata.scope||null!=i.handler&&i.handler!==e.edata.handler||(t++,!1)),this.debug&&console.log(`w2base: remove event (${t})`,{name:e,edata:i,handler:r})}else console.log("ERROR: You must specify event type when calling .off() method of "+this.name)}),this}trigger(e,i){if(1==arguments.length?i=e:(i.type=e,i.target=i.target??this),w2utils.isPlainObject(i)&&"after"==i.phase){if(!(i=this.activeEvents.find(e=>e.type==i.type&&e.target==i.target)))return void console.log(`ERROR: Cannot find even handler for "${i.type}" on "${i.target}".`);console.log("NOTICE: This syntax \"edata.trigger({ phase: 'after' })\" is outdated. Use edata.finish() instead.")}else i instanceof w2event||(i=new w2event(this,i),this.activeEvents.push(i));let s,t,l;Array.isArray(this.listeners)||(this.listeners=[]),this.debug&&console.log(`w2base: trigger "${i.type}:${i.phase}"`,i);for(let e=this.listeners.length-1;0<=e;e--){let t=this.listeners[e];if(!(null==t||t.edata.type!==i.type&&"*"!==t.edata.type||t.edata.target!==i.target&&null!=t.edata.target||t.edata.execute!==i.phase&&"*"!==t.edata.execute&&"*"!==t.edata.phase)&&(Object.keys(t.edata).forEach(e=>{null==i[e]&&null!=t.edata[e]&&(i[e]=t.edata[e])}),s=[],l=new RegExp(/\((.*?)\)/).exec(String(t.handler).split("=>")[0]),2===(s=l?l[1].split(/\s*,\s*/):s).length?(t.handler.call(this,i.target,i),this.debug&&console.log(" - call (old)",t.handler)):(t.handler.call(this,i),this.debug&&console.log(" - call",t.handler)),!0===i.isStopped||!0===i.stop))return i}var r="on"+i.type.substr(0,1).toUpperCase()+i.type.substr(1);if("before"===i.phase&&"function"==typeof this[r]&&(t=this[r],s=[],l=new RegExp(/\((.*?)\)/).exec(String(t).split("=>")[0]),2===(s=l?l[1].split(/\s*,\s*/):s).length?(t.call(this,i.target,i),this.debug&&console.log(" - call: on[Event] (old)",t)):(t.call(this,i),this.debug&&console.log(" - call: on[Event]",t)),!0===i.isStopped||!0===i.stop))return i;if(null!=i.object&&"before"===i.phase&&"function"==typeof i.object[r]&&(t=i.object[r],s=[],l=new RegExp(/\((.*?)\)/).exec(String(t).split("=>")[0]),2===(s=l?l[1].split(/\s*,\s*/):s).length?(t.call(this,i.target,i),this.debug&&console.log(" - call: edata.object (old)",t)):(t.call(this,i),this.debug&&console.log(" - call: edata.object",t)),!0===i.isStopped||!0===i.stop))return i;if("after"===i.phase){"function"==typeof i.onComplete&&i.onComplete.call(this,i);for(let e=0;e<i.listeners.length;e++)"function"==typeof i.listeners[e]&&(i.listeners[e].call(this,i),this.debug&&console.log(" - call: done",t));i._resolve(i),this.debug&&console.log(`w2base: trigger "${i.type}:${i.phase}"`,i)}return i}}const w2locale={locale:"en-US",dateFormat:"m/d/yyyy",timeFormat:"hh:mi pm",datetimeFormat:"m/d/yyyy|hh:mi pm",currencyPrefix:"$",currencySuffix:"",currencyPrecision:2,groupSymbol:",",decimalSymbol:".",shortmonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],fullmonths:["January","February","March","April","May","June","July","August","September","October","November","December"],shortdays:["M","T","W","T","F","S","S"],fulldays:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],weekStarts:"S",phrases:{"${count} letters or more...":"---","Add new record":"---","Add New":"---","Advanced Search":"---",after:"---","AJAX error. See console for more details.":"---","All Fields":"---",All:"---",Any:"---","Are you sure you want to delete ${count} ${records}?":"---","Attach files by dragging and dropping or Click to Select":"---",before:"---","begins with":"---",begins:"---",between:"---",buffered:"---",Cancel:"---",Close:"---",Column:"---",Confirmation:"---",contains:"---",Copied:"---","Copy to clipboard":"---","Current Date & Time":"---","Delete selected records":"---",Delete:"---",'Do you want to delete search item "${item}"?':"---","Edit selected record":"---",Edit:"---","Empty list":"---","ends with":"---",ends:"---","Field should be at least ${count} characters.":"---",Hide:"---",in:"---","is not":"---",is:"---","less than":"---","Line #":"---","Load ${count} more...":"---","Loading...":"---","Maximum number of files is ${count}":"---","Maximum total size is ${count}":"---",Modified:"---","more than":"---","Multiple Fields":"---",Name:"---","No items found":"---","No matches":"---",No:"---",none:"---","Not a float":"---","Not a hex number":"---","Not a valid date":"---","Not a valid email":"---","Not alpha-numeric":"---","Not an integer":"---","Not in money format":"---","not in":"---",Notification:"---",of:"---",Ok:"---",Opacity:"---","Record ID":"---",record:"---",records:"---","Refreshing...":"---","Reload data in the list":"---",Remove:"---","Remove This Field":"---","Request aborted.":"---","Required field":"---",Reset:"---","Restore Default State":"---","Returned data is not in valid JSON format.":"---","Save changed records":"---","Save Grid State":"---",Save:"---","Saved Searches":"---","Saving...":"---","Search took ${count} seconds":"---",Search:"---","Select Hour":"---","Select Minute":"---",selected:"---","Server Response ${count} seconds":"---","Show/hide columns":"---",Show:"---",Size:"---",Skip:"---","Sorting took ${count} seconds":"---","Type to search...":"---",Type:"---",Yes:"---",Yesterday:"---","Your remote data source record count has changed, reloading from the first record.":"---"}};class Query{constructor(e,t,i){this.version=.7,this.context=t??document,this.previous=i??null;let s=[];if(Array.isArray(e))s=e;else if(e instanceof Node||e instanceof Window)s=[e];else if(e instanceof Query)s=e.nodes;else if("string"==typeof e){if("function"!=typeof this.context.querySelector)throw new Error("Invalid context");s=Array.from(this.context.querySelectorAll(e))}else if(null==e)s=[];else{t=Array.from(e??[]);if("object"!=typeof e||!Array.isArray(t))throw new Error(`Invalid selector "${e}"`);s=t}this.nodes=s,this.length=s.length,this.each((e,t)=>{this[t]=e})}static _fragment(e){let i=document.createElement("template");return i.innerHTML=e,i.content.childNodes.forEach(e=>{var t=Query._scriptConvert(e);t!=e&&i.content.replaceChild(t,e)}),i.content}static _scriptConvert(e){let t=e=>{let t=e.ownerDocument,i=t.createElement("script");i.text=e.text;var s=e.attributes;for(let e=0;e<s.length;e++)i.setAttribute(s[e].name,s[e].value);return i};return(e="SCRIPT"==e.tagName?t(e):e).querySelectorAll&&e.querySelectorAll("script").forEach(e=>{e.parentNode.replaceChild(t(e),e)}),e}static _fixProp(e){var t={cellpadding:"cellPadding",cellspacing:"cellSpacing",class:"className",colspan:"colSpan",contenteditable:"contentEditable",for:"htmlFor",frameborder:"frameBorder",maxlength:"maxLength",readonly:"readOnly",rowspan:"rowSpan",tabindex:"tabIndex",usemap:"useMap"};return t[e]||e}_insert(l,i){let r=[],n=this.length;if(!(n<1)){let e=this;if("string"==typeof i)this.each(e=>{var t=Query._fragment(i);r.push(...t.childNodes),e[l](t)});else if(i instanceof Query){let s=1==n&&1==i.length;i.each(i=>{this.each(e=>{var t=s?i:i.cloneNode(!0);r.push(t),e[l](t),Query._scriptConvert(t)})}),s||i.remove()}else{if(!(i instanceof Node))throw new Error(`Incorrect argument for "${l}(html)". It expects one string argument.`);this.each(e=>{var t=1===n?i:Query._fragment(i.outerHTML);r.push(...1===n?[i]:t.childNodes),e[l](t)}),1<n&&i.remove()}return e="replaceWith"==l?new Query(r,this.context,this):e}}_save(e,t,i){e._mQuery=e._mQuery??{},Array.isArray(i)?(e._mQuery[t]=e._mQuery[t]??[],e._mQuery[t].push(...i)):null!=i?e._mQuery[t]=i:delete e._mQuery[t]}get(e){var t=this[e=e<0?this.length+e:e];return t||(null!=e?null:this.nodes)}eq(e){let t=[this[e=e<0?this.length+e:e]];return null==t[0]&&(t=[]),new Query(t,this.context,this)}then(e){e=e(this);return null!=e?e:this}find(t){let i=[];return this.each(e=>{e=Array.from(e.querySelectorAll(t));0<e.length&&i.push(...e)}),new Query(i,this.context,this)}filter(t){let i=[];return this.each(e=>{(e===t||"string"==typeof t&&e.matches&&e.matches(t)||"function"==typeof t&&t(e))&&i.push(e)}),new Query(i,this.context,this)}next(){let t=[];return this.each(e=>{e=e.nextElementSibling;e&&t.push(e)}),new Query(t,this.context,this)}prev(){let t=[];return this.each(e=>{e=e.previousElementSibling;e&&t.push(e)}),new Query(t,this.context,this)}shadow(e){let t=[],i=(this.each(e=>{e.shadowRoot&&t.push(e.shadowRoot)}),new Query(t,this.context,this));return e?i.find(e):i}closest(t){let i=[];return this.each(e=>{e=e.closest(t);e&&i.push(e)}),new Query(i,this.context,this)}host(t){let i=[],s=e=>e.parentNode?s(e.parentNode):e,l=e=>{e=s(e);i.push(e.host||e),e.host&&t&&l(e.host)};return this.each(e=>{l(e)}),new Query(i,this.context,this)}parent(e){return this.parents(e,!0)}parents(e,t){let i=[],s=e=>{if(-1==i.indexOf(e)&&i.push(e),!t&&e.parentNode)return s(e.parentNode)},l=(this.each(e=>{e.parentNode&&s(e.parentNode)}),new Query(i,this.context,this));return e?l.filter(e):l}add(e){e=e instanceof Query?e.nodes:Array.isArray(e)?e:[e];return new Query(this.nodes.concat(e),this.context,this)}each(i){return this.nodes.forEach((e,t)=>{i(e,t,this)}),this}append(e){return this._insert("append",e)}prepend(e){return this._insert("prepend",e)}after(e){return this._insert("after",e)}before(e){return this._insert("before",e)}replace(e){return this._insert("replaceWith",e)}remove(){return this.each(e=>{e.remove()}),this}css(t,e){let s=t;var i=arguments.length;if(0!==i&&(1!==i||"string"!=typeof t))return"object"!=typeof t&&((s={})[t]=e),this.each((i,e)=>{Object.keys(s).forEach(e=>{var t=String(s[e]).toLowerCase().includes("!important")?"important":"";i.style.setProperty(e,String(s[e]).replace(/\!important/i,""),t)})}),this;if(this[0]){let e=this[0].style;return"string"==typeof t?(i=e.getPropertyPriority(t),e.getPropertyValue(t)+(i?"!"+i:"")):Object.fromEntries(this[0].style.cssText.split(";").filter(e=>!!e).map(e=>e.split(":").map(e=>e.trim())))}}addClass(e){return this.toggleClass(e,!0),this}removeClass(e){return this.toggleClass(e,!1),this}toggleClass(t,s){return"string"==typeof t&&(t=t.split(/[,\s]+/)),this.each(i=>{let e=t;(e=null==e&&!1===s?Array.from(i.classList):e).forEach(t=>{if(""!==t){let e=null!=s?s?"add":"remove":"toggle";i.classList[e](t)}})}),this}hasClass(e){if(null==(e="string"==typeof e?e.split(/[,\s]+/):e)&&0<this.length)return Array.from(this[0].classList);let i=!1;return this.each(t=>{i=i||e.every(e=>Array.from(t.classList??[]).includes(e))}),i}on(e,s,l){"function"==typeof s&&(l=s,s=void 0);let r;return s?.delegate&&(r=s.delegate,delete s.delegate),(e=e.split(/[,\s]+/)).forEach(e=>{let[t,i]=String(e).toLowerCase().split(".");if(r){let i=l;l=e=>{var t=query(e.target).parents(r);0<t.length?e.delegate=t[0]:e.delegate=e.target,(e.target.matches(r)||0<t.length)&&i(e)}}this.each(e=>{this._save(e,"events",[{event:t,scope:i,callback:l,options:s}]),e.addEventListener(t,l,s)})}),this}off(e,t,r){return"function"==typeof t&&(r=t,t=void 0),(e=(e??"").split(/[,\s]+/)).forEach(e=>{let[s,l]=String(e).toLowerCase().split(".");this.each(t=>{if(Array.isArray(t._mQuery?.events))for(let e=t._mQuery.events.length-1;0<=e;e--){var i=t._mQuery.events[e];null==l||""===l?i.event!=s&&""!==s||i.callback!=r&&null!=r||(t.removeEventListener(i.event,i.callback,i.options),t._mQuery.events.splice(e,1)):i.event!=s&&""!==s||i.scope!=l||(t.removeEventListener(i.event,i.callback,i.options),t._mQuery.events.splice(e,1))}})}),this}trigger(e,t){let i;return i=e instanceof Event||e instanceof CustomEvent?e:new(["click","dblclick","mousedown","mouseup","mousemove"].includes(e)?MouseEvent:["keydown","keyup","keypress"].includes(e)?KeyboardEvent:Event)(e,t),this.each(e=>{e.dispatchEvent(i)}),this}attr(t,i){if(void 0===i&&"string"==typeof t)return this[0]?this[0].getAttribute(t):void 0;{let e={};return"object"==typeof t?e=t:e[t]=i,this.each(i=>{Object.entries(e).forEach(([e,t])=>{i.setAttribute(e,t)})}),this}}removeAttr(){return this.each(t=>{Array.from(arguments).forEach(e=>{t.removeAttribute(e)})}),this}prop(t,i){if(void 0===i&&"string"==typeof t)return this[0]?this[0][t]:void 0;{let e={};return"object"==typeof t?e=t:e[t]=i,this.each(i=>{Object.entries(e).forEach(([e,t])=>{e=Query._fixProp(e);i[e]=t,"innerHTML"==e&&Query._scriptConvert(i)})}),this}}removeProp(){return this.each(t=>{Array.from(arguments).forEach(e=>{delete t[Query._fixProp(e)]})}),this}data(i,t){if(i instanceof Object)Object.entries(i).forEach(e=>{this.data(e[0],e[1])});else{if(i&&-1!=i.indexOf("-")&&console.error(`Key "${i}" contains "-" (dash). Dashes are not allowed in property names. Use camelCase instead.`),!(arguments.length<2))return this.each(e=>{null!=t?e.dataset[i]=t instanceof Object?JSON.stringify(t):t:delete e.dataset[i]}),this;if(this[0]){let t=Object.assign({},this[0].dataset);return Object.keys(t).forEach(e=>{if(t[e].startsWith("[")||t[e].startsWith("{"))try{t[e]=JSON.parse(t[e])}catch(e){}}),i?t[i]:t}}}removeData(e){return"string"==typeof e&&(e=e.split(/[,\s]+/)),this.each(t=>{e.forEach(e=>{delete t.dataset[e]})}),this}show(){return this.toggle(!0)}hide(){return this.toggle(!1)}toggle(l){return this.each(e=>{var t=e.style.display,i=getComputedStyle(e).display,s="none"==t||"none"==i;!s||null!=l&&!0!==l||(e.style.display=e._mQuery?.prevDisplay??(t==i?"":"block"),this._save(e,"prevDisplay",null)),s||null!=l&&!1!==l||("none"!=i&&this._save(e,"prevDisplay",i),e.style.setProperty("display","none"))})}empty(){return this.html("")}html(e){return this.prop("innerHTML",e)}text(e){return this.prop("textContent",e)}val(e){return this.prop("value",e)}change(){return this.trigger("change")}click(){return this.trigger("click")}}let query=function(e,t){if("function"!=typeof e)return new Query(e,t);"complete"==document.readyState?e():window.addEventListener("load",e)},w2ui=(query.html=e=>{e=Query._fragment(e);return query(e.children,e)},{});class Utils{constructor(){this.version="2.0.x",this.tmp={},this.settings=this.extend({},{dataType:"HTTPJSON",dateStartYear:1950,dateEndYear:2030,macButtonOrder:!1,warnNoPhrase:!1},w2locale,{phrases:null}),this.i18nCompare=Intl.Collator().compare,this.hasLocalStorage=function(){var e="w2ui_test";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}(),this.isMac=/Mac/i.test(navigator.platform),this.isMobile=/(iphone|ipod|ipad|mobile|android)/i.test(navigator.userAgent),this.isIOS=/(iphone|ipod|ipad)/i.test(navigator.platform),this.isAndroid=/(android)/i.test(navigator.userAgent),this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.formatters={number(e,t){return 20<parseInt(t)&&(t=20),parseInt(t)<0&&(t=0),null==e||""===e?"":w2utils.formatNumber(parseFloat(e),t,!0)},float(e,t){return w2utils.formatters.number(e,t)},int(e,t){return w2utils.formatters.number(e,0)},money(e,t){if(null==e||""===e)return"";e=w2utils.formatNumber(Number(e),w2utils.settings.currencyPrecision);return(w2utils.settings.currencyPrefix||"")+e+(w2utils.settings.currencySuffix||"")},currency(e,t){return w2utils.formatters.money(e,t)},percent(e,t){return null==e||""===e?"":w2utils.formatNumber(e,t||1)+"%"},size(e,t){return null==e||""===e?"":w2utils.formatSize(parseInt(e))},date(e,t){if(""===t&&(t=w2utils.settings.dateFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return'<span title="'+(i=!1===i?w2utils.isDate(e,t,!0):i)+'">'+w2utils.formatDate(i,t)+"</span>"},datetime(e,t){if(""===t&&(t=w2utils.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return'<span title="'+(i=!1===i?w2utils.isDate(e,t,!0):i)+'">'+w2utils.formatDateTime(i,t)+"</span>"},time(e,t){if(""===t&&(t=w2utils.settings.timeFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t="h24"===(t="h12"===t?"hh:mi pm":t)?"h24:mi":t,!0);return'<span title="'+(i=!1===i?w2utils.isDate(e,t,!0):i)+'">'+w2utils.formatTime(e,t)+"</span>"},timestamp(e,t){if(""===t&&(t=w2utils.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return(i=!1===i?w2utils.isDate(e,t,!0):i).toString?i.toString():""},gmt(e,t){if(""===t&&(t=w2utils.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return(i=!1===i?w2utils.isDate(e,t,!0):i).toUTCString?i.toUTCString():""},age(e,t){if(null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,null,!0);return'<span title="'+(i=!1===i?w2utils.isDate(e,null,!0):i)+'">'+w2utils.age(e)+(t?" "+t:"")+"</span>"},interval(e,t){return null==e||0===e||""===e?"":w2utils.interval(e)+(t?" "+t:"")},toggle(e,t){return e?"Yes":""},password(t,e){let i="";for(let e=0;e<t.length;e++)i+="*";return i}}}isBin(e){return/^[0-1]+$/.test(e)}isInt(e){return/^[-+]?[0-9]+$/.test(e)}isFloat(e){return("number"==typeof(e="string"==typeof e?e.replace(this.settings.groupSymbol,"").replace(this.settings.decimalSymbol,"."):e)||"string"==typeof e&&""!==e)&&!isNaN(Number(e))}isMoney(e){if("object"==typeof e||""===e)return!1;if(this.isFloat(e))return!0;var t=this.settings;let i=new RegExp("^"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[-+]?"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[0-9]*[\\"+t.decimalSymbol+"]?[0-9]+"+(t.currencySuffix?"\\"+t.currencySuffix+"?":"")+"$","i");return"string"==typeof e&&(e=e.replace(new RegExp(t.groupSymbol,"g"),"")),i.test(e)}isHex(e){return/^(0x)?[0-9a-fA-F]+$/.test(e)}isAlphaNumeric(e){return/^[a-zA-Z0-9_-]+$/.test(e)}isEmail(e){return/^[a-zA-Z0-9._%\-+]+@[а-яА-Яa-zA-Z0-9.-]+\.[а-яА-Яa-zA-Z]+$/.test(e)}isIpAddress(e){let t=new RegExp("^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$");return t.test(e)}isDate(i,e,t){if(!i)return!1;let s="Invalid Date",l,r,n;if(null==e&&(e=this.settings.dateFormat),"function"==typeof i.getFullYear)n=i.getFullYear(),l=i.getMonth()+1,r=i.getDate();else if(parseInt(i)==i&&0<parseInt(i))i=new Date(parseInt(i)),n=i.getFullYear(),l=i.getMonth()+1,r=i.getDate();else{if(i=String(i),new RegExp("mon","ig").test(e)){e=e.replace(/month/gi,"m").replace(/mon/gi,"m").replace(/dd/gi,"d").replace(/[, ]/gi,"/").replace(/\/\//g,"/").toLowerCase(),i=i.replace(/[, ]/gi,"/").replace(/\/\//g,"/").toLowerCase();for(let t=0,e=this.settings.fullmonths.length;t<e;t++){let e=this.settings.fullmonths[t];i=i.replace(new RegExp(e,"ig"),parseInt(t)+1).replace(new RegExp(e.substr(0,3),"ig"),parseInt(t)+1)}}var a=i.replace(/-/g,"/").replace(/\./g,"/").toLowerCase().split("/"),e=e.replace(/-/g,"/").replace(/\./g,"/").toLowerCase();"mm/dd/yyyy"===e&&(l=a[0],r=a[1],n=a[2]),"m/d/yyyy"===e&&(l=a[0],r=a[1],n=a[2]),"dd/mm/yyyy"===e&&(l=a[1],r=a[0],n=a[2]),"d/m/yyyy"===e&&(l=a[1],r=a[0],n=a[2]),"yyyy/dd/mm"===e&&(l=a[2],r=a[1],n=a[0]),"yyyy/d/m"===e&&(l=a[2],r=a[1],n=a[0]),"yyyy/mm/dd"===e&&(l=a[1],r=a[2],n=a[0]),"yyyy/m/d"===e&&(l=a[1],r=a[2],n=a[0]),"mm/dd/yy"===e&&(l=a[0],r=a[1],n=a[2]),"m/d/yy"===e&&(l=a[0],r=a[1],n=parseInt(a[2])+1900),"dd/mm/yy"===e&&(l=a[1],r=a[0],n=parseInt(a[2])+1900),"d/m/yy"===e&&(l=a[1],r=a[0],n=parseInt(a[2])+1900),"yy/dd/mm"===e&&(l=a[2],r=a[1],n=parseInt(a[0])+1900),"yy/d/m"===e&&(l=a[2],r=a[1],n=parseInt(a[0])+1900),"yy/mm/dd"===e&&(l=a[1],r=a[2],n=parseInt(a[0])+1900),"yy/m/d"===e&&(l=a[1],r=a[2],n=parseInt(a[0])+1900)}return!!this.isInt(n)&&(!!this.isInt(l)&&(!!this.isInt(r)&&(n=+n,l=+l,r=+r,(s=new Date(n,l-1,r)).setFullYear(n),null!=l&&("Invalid Date"!==String(s)&&(s.getMonth()+1===l&&s.getDate()===r&&s.getFullYear()===n&&(!0!==t||s))))))}isTime(e,t){if(null==e)return!1;let i,s,l;s=0<=(e=(e=String(e)).toUpperCase()).indexOf("AM");var r=(l=0<=e.indexOf("PM"))||s,e=(i=r?12:24,(e=e.replace("AM","").replace("PM","").trim()).split(":"));let n=parseInt(e[0]||0),a=parseInt(e[1]||0),o=parseInt(e[2]||0);return(r&&1===e.length||2===e.length||3===e.length)&&(!(""===e[0]||n<0||n>i||!this.isInt(e[0])||2<e[0].length)&&(!(1<e.length&&(""===e[1]||a<0||59<a||!this.isInt(e[1])||2!==e[1].length))&&(!(2<e.length&&(""===e[2]||o<0||59<o||!this.isInt(e[2])||2!==e[2].length))&&((r||i!==n||0===a&&0===o)&&((!r||1!==e.length||0!==n)&&(!0!==t||(l&&12!==n&&(n+=12),s&&12===n&&(n+=12),{hours:n,minutes:a,seconds:o})))))))}isDateTime(i,s,l){if("function"==typeof i.getFullYear)return!0!==l||i;var r=parseInt(i);if(r===i)return!(r<0)&&(!0!==l||new Date(r));r=String(i).indexOf(" ");if(r<0)return!(String(i).indexOf("T")<0||"Invalid Date"==String(new Date(i)))&&(!0!==l||new Date(i));{let e=(s=null==s?this.settings.datetimeFormat:s).split("|");s=[i.substr(0,r),i.substr(r).trim()];e[0]=e[0].trim(),e[1]&&(e[1]=e[1].trim());let t=this.isDate(s[0],e[0],!0);i=this.isTime(s[1],!0);return!1!==t&&!1!==i&&(!0!==l||(t.setHours(i.hours),t.setMinutes(i.minutes),t.setSeconds(i.seconds),t))}}age(e){let t;if(""===e||null==e)return"";if(t="function"==typeof e.getFullYear?e:parseInt(e)==e&&0<parseInt(e)?new Date(parseInt(e)):new Date(e),"Invalid Date"===String(t))return"";let i=new Date;e=(i.getTime()-t.getTime())/1e3;let s="",l="";return e<0?(s=0,l="sec"):e<60?(s=Math.floor(e),l="sec",e<0&&(s=0,l="sec")):e<3600?(s=Math.floor(e/60),l="min"):e<86400?(s=Math.floor(e/60/60),l="hour"):e<2592e3?(s=Math.floor(e/24/60/60),l="day"):e<31536e3?(s=Math.floor(e/30/24/60/60*10)/10,l="month"):e<126144e3?(s=Math.floor(e/365/24/60/60*10)/10,l="year"):126144e3<=e&&(s=Math.floor(e/365.25/24/60/60*10)/10,l="year"),s+" "+l+(1<s?"s":"")}interval(e){let t="";return t=e<100?"< 0.01 sec":e<1e3?Math.floor(e/10)/100+" sec":e<1e4?Math.floor(e/100)/10+" sec":e<6e4?Math.floor(e/1e3)+" secs":e<36e5?Math.floor(e/6e4)+" mins":e<864e5?Math.floor(e/36e5*10)/10+" hours":e<2628e6?Math.floor(e/864e5*10)/10+" days":e<31536e6?Math.floor(e/2628e6*10)/10+" months":Math.floor(e/31536e5)/10+" years"}date(e){if(""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let t=new Date(e);if(this.isInt(e)&&(t=new Date(Number(e))),"Invalid Date"===String(t))return"";e=this.settings.shortmonths;let i=new Date,s=new Date;s.setTime(s.getTime()-864e5);var l=e[t.getMonth()]+" "+t.getDate()+", "+t.getFullYear(),r=e[i.getMonth()]+" "+i.getDate()+", "+i.getFullYear(),e=e[s.getMonth()]+" "+s.getDate()+", "+s.getFullYear(),n=t.getHours()-(12<t.getHours()?12:0)+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+" "+(12<=t.getHours()?"pm":"am");let a=l==r?n:l;return'<span title="'+l+" "+(t.getHours()-(12<t.getHours()?12:0)+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+":"+(t.getSeconds()<10?"0":"")+t.getSeconds()+" "+(12<=t.getHours()?"pm":"am"))+'">'+(a=l==e?this.lang("Yesterday"):a)+"</span>"}formatSize(e){if(!this.isFloat(e)||""===e)return"";if(0===(e=parseFloat(e)))return 0;var t=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return(Math.floor(e/Math.pow(1024,t)*10)/10).toFixed(0===t?0:1)+" "+(["Bt","KB","MB","GB","TB","PB","EB","ZB"][t]||"??")}formatNumber(e,t,i){if(null==e||""===e||"object"==typeof e)return"";let s={minimumFractionDigits:t,maximumFractionDigits:t,useGrouping:i};return(null==t||t<0)&&(s.minimumFractionDigits=0,s.maximumFractionDigits=20),parseFloat(e).toLocaleString(this.settings.locale,s)}formatDate(e,t){if(t=t||this.settings.dateFormat,""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let i=new Date(e);if(this.isInt(e)&&(i=new Date(Number(e))),"Invalid Date"===String(i))return"";var e=i.getFullYear(),s=i.getMonth(),l=i.getDate();return t.toLowerCase().replace("month",this.settings.fullmonths[s]).replace("mon",this.settings.shortmonths[s]).replace(/yyyy/g,("000"+e).slice(-4)).replace(/yyy/g,("000"+e).slice(-4)).replace(/yy/g,("0"+e).slice(-2)).replace(/(^|[^a-z$])y/g,"$1"+e).replace(/mm/g,("0"+(s+1)).slice(-2)).replace(/dd/g,("0"+l).slice(-2)).replace(/th/g,1==l?"st":"th").replace(/th/g,2==l?"nd":"th").replace(/th/g,3==l?"rd":"th").replace(/(^|[^a-z$])m/g,"$1"+(s+1)).replace(/(^|[^a-z$])d/g,"$1"+l)}formatTime(e,t){if(t=t||this.settings.timeFormat,""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let i=new Date(e);if(this.isInt(e)&&(i=new Date(Number(e))),this.isTime(e)&&(e=this.isTime(e,!0),(i=new Date).setHours(e.hours),i.setMinutes(e.minutes)),"Invalid Date"===String(i))return"";let s="am",l=i.getHours();e=i.getHours();let r=i.getMinutes(),n=i.getSeconds();return r<10&&(r="0"+r),n<10&&(n="0"+n),-1===t.indexOf("am")&&-1===t.indexOf("pm")||(12<=l&&(s="pm"),12<l&&(l-=12),0===l&&(l=12)),t.toLowerCase().replace("am",s).replace("pm",s).replace("hhh",l<10?"0"+l:l).replace("hh24",e<10?"0"+e:e).replace("h24",e).replace("hh",l).replace("mm",r).replace("mi",r).replace("ss",n).replace(/(^|[^a-z$])h/g,"$1"+l).replace(/(^|[^a-z$])m/g,"$1"+r).replace(/(^|[^a-z$])s/g,"$1"+n)}formatDateTime(e,t){let i;return""===e||null==e||"object"==typeof e&&!e.getMonth?"":("string"!=typeof t?i=[this.settings.dateFormat,this.settings.timeFormat]:((i=t.split("|"))[0]=i[0].trim(),i[1]=1<i.length?i[1].trim():this.settings.timeFormat),"h12"===i[1]&&(i[1]="h:m pm"),"h24"===i[1]&&(i[1]="h24:m"),this.formatDate(e,i[0])+" "+this.formatTime(e,i[1]))}stripSpaces(i){if(null==i)return i;switch(typeof i){case"number":break;case"string":i=String(i).replace(/(?:\r\n|\r|\n)/g," ").replace(/\s\s+/g," ").trim();break;case"object":Array.isArray(i)?(i=this.extend([],i)).forEach((e,t)=>{i[t]=this.stripSpaces(e)}):(i=this.extend({},i),Object.keys(i).forEach(e=>{i[e]=this.stripSpaces(i[e])}))}return i}stripTags(i){if(null==i)return i;switch(typeof i){case"number":break;case"string":i=String(i).replace(/<(?:[^>=]|='[^']*'|="[^"]*"|=[^'"][^\s>]*)*>/gi,"");break;case"object":Array.isArray(i)?(i=this.extend([],i)).forEach((e,t)=>{i[t]=this.stripTags(e)}):(i=this.extend({},i),Object.keys(i).forEach(e=>{i[e]=this.stripTags(i[e])}))}return i}encodeTags(i){if(null==i)return i;switch(typeof i){case"number":break;case"string":i=String(i).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;");break;case"object":Array.isArray(i)?(i=this.extend([],i)).forEach((e,t)=>{i[t]=this.encodeTags(e)}):(i=this.extend({},i),Object.keys(i).forEach(e=>{i[e]=this.encodeTags(i[e])}))}return i}decodeTags(i){if(null==i)return i;switch(typeof i){case"number":break;case"string":i=String(i).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&");break;case"object":Array.isArray(i)?(i=this.extend([],i)).forEach((e,t)=>{i[t]=this.decodeTags(e)}):(i=this.extend({},i),Object.keys(i).forEach(e=>{i[e]=this.decodeTags(i[e])}))}return i}escapeId(e){if(""===e||null==e)return"";return(e+"").replace(/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,(e,t)=>t?"\0"===e?"�":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e)}unescapeId(e){if(""===e||null==e)return"";return e.replace(/\\[\da-fA-F]{1,6}[\x20\t\r\n\f]?|\\([^\r\n\f])/g,(e,t)=>{e="0x"+e.slice(1)-65536;return t||(e<0?String.fromCharCode(65536+e):String.fromCharCode(e>>10|55296,1023&e|56320))})}base64encode(e){let t="",i,s,l,r,n,a,o,h=0;var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";for(e=function(t){t=String(t).replace(/\r\n/g,"\n");let i="";for(let e=0;e<t.length;e++){var s=t.charCodeAt(e);s<128?i+=String.fromCharCode(s):i=127<s&&s<2048?(i+=String.fromCharCode(s>>6|192))+String.fromCharCode(63&s|128):(i=(i+=String.fromCharCode(s>>12|224))+String.fromCharCode(s>>6&63|128))+String.fromCharCode(63&s|128)}return i}(e);h<e.length;)i=e.charCodeAt(h++),s=e.charCodeAt(h++),l=e.charCodeAt(h++),r=i>>2,n=(3&i)<<4|s>>4,a=(15&s)<<2|l>>6,o=63&l,isNaN(s)?a=o=64:isNaN(l)&&(o=64),t=t+d.charAt(r)+d.charAt(n)+d.charAt(a)+d.charAt(o);return t}base64decode(e){let t="";var i,s,l,r,n,a;let o=0;var h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");o<e.length;)l=h.indexOf(e.charAt(o++)),i=(15&(r=h.indexOf(e.charAt(o++))))<<4|(n=h.indexOf(e.charAt(o++)))>>2,s=(3&n)<<6|(a=h.indexOf(e.charAt(o++))),t+=String.fromCharCode(l<<2|r>>4),64!==n&&(t+=String.fromCharCode(i)),64!==a&&(t+=String.fromCharCode(s));return t=function(e){let t="",i=0,s=0,l,r;for(;i<e.length;)(s=e.charCodeAt(i))<128?(t+=String.fromCharCode(s),i++):191<s&&s<224?(l=e.charCodeAt(i+1),t+=String.fromCharCode((31&s)<<6|63&l),i+=2):(l=e.charCodeAt(i+1),r=e.charCodeAt(i+2),t+=String.fromCharCode((15&s)<<12|(63&l)<<6|63&r),i+=3);return t}(t)}async sha256(e){e=(new TextEncoder).encode(e);return crypto.subtle.digest("SHA-256",e).then(e=>{const t=Array.from(new Uint8Array(e));return t.map(e=>e.toString(16).padStart(2,"0")).join("")})}transition(r,n,a,o){return new Promise((e,t)=>{var i=getComputedStyle(r);let s=parseInt(i.width),l=parseInt(i.height);if(r&&n){switch(r.parentNode.style.cssText+="perspective: 900px; overflow: hidden;",r.style.cssText+="; position: absolute; z-index: 1019; backface-visibility: hidden",n.style.cssText+="; position: absolute; z-index: 1020; backface-visibility: hidden",a){case"slide-left":r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; transform: translate3d("+s+"px, 0, 0)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",r.style.cssText+="transition: 0.5s; transform: translate3d(-"+s+"px, 0, 0)"},1);break;case"slide-right":r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; transform: translate3d(-"+s+"px, 0, 0)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: translate3d(0px, 0, 0)",r.style.cssText+="transition: 0.5s; transform: translate3d("+s+"px, 0, 0)"},1);break;case"slide-down":r.style.cssText+="overflow: hidden; z-index: 1; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; z-index: 0; transform: translate3d(0, 0, 0)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",r.style.cssText+="transition: 0.5s; transform: translate3d(0, "+l+"px, 0)"},1);break;case"slide-up":r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; transform: translate3d(0, "+l+"px, 0)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",r.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)"},1);break;case"flip-left":r.style.cssText+="overflow: hidden; transform: rotateY(0deg)",n.style.cssText+="overflow: hidden; transform: rotateY(-180deg)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: rotateY(0deg)",r.style.cssText+="transition: 0.5s; transform: rotateY(180deg)"},1);break;case"flip-right":r.style.cssText+="overflow: hidden; transform: rotateY(0deg)",n.style.cssText+="overflow: hidden; transform: rotateY(180deg)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: rotateY(0deg)",r.style.cssText+="transition: 0.5s; transform: rotateY(-180deg)"},1);break;case"flip-down":r.style.cssText+="overflow: hidden; transform: rotateX(0deg)",n.style.cssText+="overflow: hidden; transform: rotateX(180deg)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: rotateX(0deg)",r.style.cssText+="transition: 0.5s; transform: rotateX(-180deg)"},1);break;case"flip-up":r.style.cssText+="overflow: hidden; transform: rotateX(0deg)",n.style.cssText+="overflow: hidden; transform: rotateX(-180deg)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: rotateX(0deg)",r.style.cssText+="transition: 0.5s; transform: rotateX(180deg)"},1);break;case"pop-in":r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(.8); opacity: 0;",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: scale(1); opacity: 1;",r.style.cssText+="transition: 0.5s;"},1);break;case"pop-out":r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(1); opacity: 1;",n.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); opacity: 0;",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; opacity: 1;",r.style.cssText+="transition: 0.5s; transform: scale(1.7); opacity: 0;"},1);break;default:r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; translate3d(0, 0, 0); opacity: 0;",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; opacity: 1;",r.style.cssText+="transition: 0.5s"},1)}setTimeout(()=>{"slide-down"===a&&(query(r).css("z-index","1019"),query(n).css("z-index","1020")),n&&query(n).css({opacity:"1"}).css({transition:"",transform:""}),r&&query(r).css({opacity:"1"}).css({transition:"",transform:""}),"function"==typeof o&&o(),e()},500)}else console.log("ERROR: Cannot do transition when one of the divs is null")})}lock(s,l={}){if(null!=s){"string"==typeof l&&(l={msg:l}),arguments[2]&&(l.spinner=arguments[2]),l=this.extend({spinner:!1},l),s?.[0]instanceof Node&&(s=Array.isArray(s)?s:s.get()),l.msg||0===l.msg||(l.msg=""),this.unlock(s),query(s).prepend('<div class="w2ui-lock"></div><div class="w2ui-lock-msg"></div>');let e=query(s).find(".w2ui-lock"),t=query(s).find(".w2ui-lock-msg");l.msg||t.css({"background-color":"transparent","background-image":"none",border:"0px","box-shadow":"none"}),!0===l.spinner&&(l.msg=`<div class="w2ui-spinner" ${l.msg?"":'style="width: 35px; height: 35px"'}></div>`+l.msg),l.msg?t.html(l.msg).css("display","block"):t.remove(),null!=l.opacity&&e.css("opacity",l.opacity),e.css({display:"block"}),l.bgColor&&e.css({"background-color":l.bgColor});let i=getComputedStyle(e.get(0)).opacity??.15;e.on("mousedown",function(){"function"==typeof l.onClick?l.onClick():e.css({transition:".2s",opacity:1.5*i})}).on("mouseup",function(){"function"!=typeof l.onClick&&e.css({transition:".2s",opacity:i})}).on("mousewheel",function(e){e&&(e.stopPropagation(),e.preventDefault())})}}unlock(e,t){null!=e&&(e?.[0]instanceof Node&&(e=Array.isArray(e)?e:e.get()),this.isInt(t)?(query(e).find(".w2ui-lock").css({transition:t/1e3+"s",opacity:0}),query(e).find(".w2ui-lock-msg").remove(),setTimeout(()=>{query(e).find(".w2ui-lock").remove()},t)):(query(e).find(".w2ui-lock").remove(),query(e).find(".w2ui-lock-msg").remove()))}message(r,l){let e,t,s;var i=()=>{let e=query(r?.box).find(".w2ui-message");0!=e.length&&"function"==typeof(l=e.get(0)._msg_options||{})?.close&&l.close()};let n=e=>{let i=e.box._msg_prevFocus;if(query(r.box).find(".w2ui-message").length<=1?r.owner?r.owner.unlock(r.param,150):this.unlock(r.box,150):query(r.box).find(`#w2ui-message-${r.owner?.name}-`+(e.msgIndex-1)).css("z-index",1500),i){let t=query(i).closest(".w2ui-message");if(0<t.length){let e=t.get(0)._msg_options;e.setFocus(i)}else i.focus()}else"function"==typeof r.owner?.focus&&owner.focus();query(e.box).remove(),0===e.msgIndex&&(c.css("z-index",e.tmp.zIndex),query(r.box).css("overflow",e.tmp.overflow)),e.trigger&&s.finish()};if("object"!=typeof(l="string"!=typeof l&&"number"!=typeof l?l:{width:String(l).length<300?350:550,height:String(l).length<300?170:250,text:String(l)}))return void i();null!=l.text&&(l.body=`<div class="w2ui-centered w2ui-msg-text">${l.text}</div>`),null==l.width&&(l.width=350),null==l.height&&(l.height=170),null==l.hideOn&&(l.hideOn=["esc"]),null==l.on&&(h=l,l=new w2base,w2utils.extend(l,h)),l.on("open",e=>{w2utils.bindEvents(query(l.box).find(".w2ui-eaction"),l),query(e.detail.box).find("button, input, textarea, [name=hidden-first]").off(".message").on("keydown.message",function(e){27==e.keyCode&&l.hideOn.includes("esc")&&(l.cancelAction?l.action(l.cancelAction):l.close())}),l.setFocus(l.focus)}),l.off(".prom");let a={self:l,action(e){return l.on("action.prom",e),a},close(e){return l.on("close.prom",e),a},open(e){return l.on("open.prom",e),a},then(e){return l.on("open:after.prom",e),a}},o=(null==l.actions&&null==l.buttons&&null==l.html&&(l.actions={Ok(e){e.detail.self.close()}}),l.off(".buttons"),null!=l.actions&&(l.buttons="",Object.keys(l.actions).forEach(e=>{var t=l.actions[e];let i=e;"function"==typeof t&&(l.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${e}","event"]'>${e}</button>`),"object"==typeof t&&(l.buttons+=`<button class="w2ui-btn w2ui-eaction ${t.class||""}" data-click='["action","${e}","event"]'
                        style="${t.style}" ${t.attrs}>${t.text||e}</button>`,i=Array.isArray(l.actions)?t.text:e),"string"==typeof t&&(l.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${t}","event"]'>${t}</button>`,i=t),"string"==typeof i&&(i=i[0].toLowerCase()+i.substr(1).replace(/\s+/g,"")),a[i]=function(t){return l.on("action.buttons",e=>{e.detail.action[0].toLowerCase()+e.detail.action.substr(1).replace(/\s+/g,"")==i&&t(e)}),a}})),Array("html","body","buttons").forEach(e=>{l[e]=String(l[e]??"").trim()}),""===l.body&&""===l.buttons||(l.html=`
                <div class="w2ui-message-body">${l.body||""}</div>
                <div class="w2ui-message-buttons">${l.buttons||""}</div>
            `),getComputedStyle(query(r.box).get(0)));var h=parseFloat(o.width),d=parseFloat(o.height);let u=0,c=(0<query(r.after).length&&(o=getComputedStyle(query(r.after).get(0)),u=parseInt("none"!=o.display?parseInt(o.height):0)),l.width>h&&(l.width=h-10),l.height>d-u&&(l.height=d-10-u),l.originalWidth=l.width,l.originalHeight=l.height,parseInt(l.width)<0&&(l.width=h+l.width),parseInt(l.width)<10&&(l.width=10),parseInt(l.height)<0&&(l.height=d+l.height-u),parseInt(l.height)<10&&(l.height=10),l.originalHeight<0&&(l.height=d+l.originalHeight-u),l.originalWidth<0&&(l.width=h+2*l.originalWidth),query(r.box).find(r.after));return l.tmp||(l.tmp={zIndex:c.css("z-index"),overflow:o.overflow}),""===l.html&&""===l.body&&""===l.buttons?i():(l.msgIndex=query(r.box).find(".w2ui-message").length,0===l.msgIndex&&"function"==typeof this.lock&&(query(r.box).css("overflow","hidden"),r.owner?r.owner.lock(r.param):this.lock(r.box)),query(r.box).find(".w2ui-message").css("z-index",1390),c.css("z-index",1501),d=`
                <div id="w2ui-message-${r.owner?.name}-${l.msgIndex}" class="w2ui-message" data-mousedown="stop"
                    style="z-index: 1500; left: ${(h-l.width)/2}px; top: ${u}px;
                        width: ${l.width}px; height: ${l.height}px; transform: translateY(-${l.height}px)"
                    ${l.hideOn.includes("click")?r.param?`data-click='["message", "${r.param}"]`:'data-click="message"':""}>
                    <span name="hidden-first" tabindex="0" style="position: absolute; top: -100px"></span>
                    ${l.html}
                    <span name="hidden-last" tabindex="0" style="position: absolute; top: -100px"></span>
                </div>`,0<query(r.after).length?query(r.box).find(r.after).after(d):query(r.box).prepend(d),l.box=query(r.box).find(`#w2ui-message-${r.owner?.name}-`+l.msgIndex)[0],w2utils.bindEvents(l.box,this),query(l.box).addClass("animating"),(l.box._msg_options=l).box._msg_prevFocus=document.activeElement,setTimeout(()=>{if(!0===(s=l.trigger("open",{target:this.name,box:l.box,self:l})).isCancelled)return query(r.box).find(`#w2ui-message-${r.owner?.name}-`+l.msgIndex).remove(),void(0===l.msgIndex&&(c.css("z-index",l.tmp.zIndex),query(r.box).css("overflow",l.tmp.overflow)));query(l.box).css({transition:"0.3s",transform:"translateY(0px)"})},0),t=setTimeout(()=>{query(r.box).find(`#w2ui-message-${r.owner?.name}-`+l.msgIndex).removeClass("animating").css({transition:"0s"}),s.finish()},300)),l.action=(e,t)=>{let i=l.actions[e],s=(i instanceof Object&&i.onClick&&(i=i.onClick),l.trigger("action",{target:this.name,action:e,self:l,originalEvent:t,value:l.input?l.input.value:null}));!0!==s.isCancelled&&("function"==typeof i&&i(s),s.finish())},l.close=()=>{if(!0!==(s=l.trigger("close",{target:"self",box:l.box,self:l})).isCancelled){if(clearTimeout(t),query(l.box).hasClass("animating"))return clearTimeout(e),void n(l);query(l.box).addClass("w2ui-closing animating").css({transition:"0.15s",transform:"translateY(-"+l.height+"px)"}),0!==l.msgIndex&&query(r.box).find(`#w2ui-message-${r.owner?.name}-`+(l.msgIndex-1)).css("z-index",1499),e=setTimeout(()=>{n(l)},150)}},l.setFocus=t=>{var e=query(r.box).find(".w2ui-message").length-1;let s=query(r.box).find(`#w2ui-message-${r.owner?.name}-`+e),l="input, button, select, textarea, [contentEditable], .w2ui-input";if(null!=t){let e=isNaN(t)?s.find(l).filter(t).get(0):s.find(l).get(t);e?.focus()}else s.find("[name=hidden-first]").get(0)?.focus();query(r.box).find(".w2ui-message").find(l+",[name=hidden-first],[name=hidden-last]").off(".keep-focus"),query(s).find(l+",[name=hidden-first],[name=hidden-last]").on("blur.keep-focus",function(e){setTimeout(()=>{var e=document.activeElement,t=0<query(s).find(l).filter(e).length,i=query(e).attr("name");!t&&e&&e!==document.body&&query(s).find(l).get(0)?.focus(),"hidden-last"==i&&query(s).find(l).get(0)?.focus(),"hidden-first"==i&&query(s).find(l).get(-1)?.focus()},1)})},a}confirm(e,t){w2utils.normButtons(t="string"==typeof t?{text:t}:t,{yes:"Yes",no:"No"});let i=w2utils.message(e,t);return i&&i.action(e=>{e.detail.self.close()}),i}normButtons(i,s){i.actions=i.actions??{};let e=Object.keys(s);return e.forEach(t=>{var e=i["btn_"+t];e&&(s[t]={text:w2utils.lang(e.text??""),class:e.class??"",style:e.style??"",attrs:e.attrs??""},delete i["btn_"+t]),Array("text","class","style","attrs").forEach(e=>{i[t+"_"+e]&&("string"==typeof s[t]&&(s[t]={text:s[t]}),s[t][e]=i[t+"_"+e],delete i[t+"_"+e])})}),e.includes("yes")&&e.includes("no")&&(w2utils.settings.macButtonOrder?w2utils.extend(i.actions,{no:s.no,yes:s.yes}):w2utils.extend(i.actions,{yes:s.yes,no:s.no})),e.includes("ok")&&e.includes("cancel")&&(w2utils.settings.macButtonOrder?w2utils.extend(i.actions,{cancel:s.cancel,ok:s.ok}):w2utils.extend(i.actions,{ok:s.ok,cancel:s.cancel})),i}getSize(e,t){let i=0;if(0<(e=query(e)).length){e=e[0];var s=getComputedStyle(e);switch(t){case"width":i=parseFloat(s.width),"auto"===s.width&&(i=0);break;case"height":i=parseFloat(s.height),"auto"===s.height&&(i=0)}}return i}getStrWidth(e,t){query("body").append(`
            <div id="_tmp_width" style="position: absolute; top: -9000px; ${t||""}">
                ${this.encodeTags(e)}
            </div>`);t=query("#_tmp_width")[0].clientWidth;return query("#_tmp_width").remove(),t}execTemplate(e,i){return"string"==typeof e&&i&&"object"==typeof i?e.replace(/\${([^}]+)?}/g,function(e,t){return i[t]||t}):e}marker(e,s,l={onlyFirst:!1,wholeWord:!1}){Array.isArray(s)||(s=null!=s&&""!==s?[s]:[]);let r=l.wholeWord;query(e).each(t=>{for(var e=t,i=/\<span class=\"w2ui\-marker\"\>((.|\n|\r)*)\<\/span\>/gi;-1!==e.innerHTML.indexOf('<span class="w2ui-marker"');)e.innerHTML=e.innerHTML.replace(i,"$1");s.forEach(e=>{e=(e="string"!=typeof e?String(e):e).replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&").replace(/&/g,"&amp;").replace(/</g,"&gt;").replace(/>/g,"&lt;");e=new RegExp((r?"\\b":"")+e+(r?"\\b":"")+"(?!([^<]+)?>)","i"+(l.onlyFirst?"":"g"));t.innerHTML=t.innerHTML.replace(e,e=>'<span class="w2ui-marker">'+e+"</span>")})})}lang(e,t){if(!e||null==this.settings.phrases||"string"!=typeof e||"<=>=".includes(e))return this.execTemplate(e,t);let i=this.settings.phrases[e];return null==i?(i=e,this.settings.warnNoPhrase&&(this.settings.missing||(this.settings.missing={}),this.settings.missing[e]="---",this.settings.phrases[e]="---",console.log(`Missing translation for "%c${e}%c", see %c w2utils.settings.phrases %c with value "---"`,"color: orange","","color: #999",""))):"---"!==i||this.settings.warnNoPhrase||(i=e),"---"===i&&(i=`<span ${this.tooltip(e)}>---</span>`),this.execTemplate(i,t)}locale(l,i,r){return new Promise((s,t)=>{if(Array.isArray(l)){this.settings.phrases={};let i=[],t={};return l.forEach((e,t)=>{5===e.length&&(e="locale/"+e.toLowerCase()+".json",l[t]=e),i.push(this.locale(e,!0,!1))}),void Promise.allSettled(i).then(e=>{e.forEach(e=>{e.value&&(t[e.value.file]=e.value.data)}),l.forEach(e=>{this.settings=this.extend({},this.settings,t[e])}),s()})}(l=l||"en-us")instanceof Object?this.settings=this.extend({},this.settings,w2locale,l):(5===l.length&&(l="locale/"+l.toLowerCase()+".json"),fetch(l,{method:"GET"}).then(e=>e.json()).then(e=>{!0!==r&&(this.settings=i?this.extend({},this.settings,e):this.extend({},this.settings,w2locale,{phrases:{}},e)),s({file:l,data:e})}).catch(e=>{console.log("ERROR: Cannot load locale "+l),t(e)}))})}scrollBarSize(){if(this.tmp.scrollBarSize)return this.tmp.scrollBarSize;return query("body").append(`
            <div id="_scrollbar_width" style="position: absolute; top: -300px; width: 100px; height: 100px; overflow-y: scroll;">
                <div style="height: 120px">1</div>
            </div>
        `),this.tmp.scrollBarSize=100-query("#_scrollbar_width > div")[0].clientWidth,query("#_scrollbar_width").remove(),this.tmp.scrollBarSize}checkName(e){return null==e?(console.log('ERROR: Property "name" is required but not supplied.'),!1):null!=w2ui[e]?(console.log(`ERROR: Object named "${e}" is already registered as w2ui.${e}.`),!1):!!this.isAlphaNumeric(e)||(console.log('ERROR: Property "name" has to be alpha-numeric (a-z, 0-9, dash and underscore).'),!1)}checkUniqueId(t,i,s,l){Array.isArray(i)||(i=[i]);let r=!0;return i.forEach(e=>{e.id===t&&(console.log(`ERROR: The item id="${t}" is not unique within the ${s} "${l}".`,i),r=!1)}),r}encodeParams(t,i=""){let s="";return Object.keys(t).forEach(e=>{""!=s&&(s+="&"),"object"==typeof t[e]?s+=this.encodeParams(t[e],i+e+(i?"]":"")+"["):s+=""+i+e+(i?"]":"")+"="+t[e]}),s}parseRoute(e){let n=[];e=e.replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,(e,t,i,s,l,r)=>(n.push({name:s,optional:!!r}),t=t||"",(r?"":t)+"(?:"+(r?t:"")+(i||"")+(l||(i?"([^/.]+?)":"([^/]+?)"))+")"+(r||""))).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)");return{path:new RegExp("^"+e+"$","i"),keys:n}}getCursorPosition(i){if(null==i)return null;let s=0,t=i.ownerDocument||i.document,e=t.defaultView||t.parentWindow,l;if(["INPUT","TEXTAREA"].includes(i.tagName))s=i.selectionStart;else if(e.getSelection){if(0<(l=e.getSelection()).rangeCount){let e=l.getRangeAt(0),t=e.cloneRange();t.selectNodeContents(i),t.setEnd(e.endContainer,e.endOffset),s=t.toString().length}}else if((l=t.selection)&&"Control"!==l.type){var r=l.createRange();let e=t.body.createTextRange();e.moveToElementText(i),e.setEndPoint("EndToEnd",r),s=e.text.length}return s}setCursorPosition(s,l,r){if(null!=s){let e=document.createRange(),i,t=window.getSelection();if(["INPUT","TEXTAREA"].includes(s.tagName))s.setSelectionRange(l,r??l);else{for(let t=0;t<s.childNodes.length;t++){let e=query(s.childNodes[t]).text();if(l<=(e=s.childNodes[t].tagName?(e=query(s.childNodes[t]).html()).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&nbsp;/g," "):e).length){(i=(i=s.childNodes[t]).childNodes&&0<i.childNodes.length?i.childNodes[0]:i).childNodes&&0<i.childNodes.length&&(i=i.childNodes[0]);break}l-=e.length}null!=i&&(l>i.length&&(l=i.length),e.setStart(i,l),r?e.setEnd(i,r):e.collapse(!0),t.removeAllRanges(),t.addRange(e))}}}parseColor(e){if("string"!=typeof e)return null;let t={};if(3===(e="#"===(e=e.trim().toUpperCase())[0]?e.substr(1):e).length)t={r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:1};else if(6===e.length)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:1};else if(8===e.length)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:Math.round(parseInt(e.substr(6,2),16)/255*100)/100};else if(4<e.length&&"RGB("===e.substr(0,4)){var i=e.replace("RGB","").replace(/\(/g,"").replace(/\)/g,"").split(",");t={r:parseInt(i[0],10),g:parseInt(i[1],10),b:parseInt(i[2],10),a:1}}else{if(!(5<e.length&&"RGBA("===e.substr(0,5)))return null;i=e.replace("RGBA","").replace(/\(/g,"").replace(/\)/g,"").split(",");t={r:parseInt(i[0],10),g:parseInt(i[1],10),b:parseInt(i[2],10),a:parseFloat(i[3])}}return t}hsv2rgb(e,t,i,s){let l,r,n,a,o,h,d,u;switch(1===arguments.length&&(t=e.s,i=e.v,s=e.a,e=e.h),h=(i/=100)*(1-(t/=100)),d=i*(1-(o=6*(e/=360)-(a=Math.floor(6*e)))*t),u=i*(1-(1-o)*t),a%6){case 0:l=i,r=u,n=h;break;case 1:l=d,r=i,n=h;break;case 2:l=h,r=i,n=u;break;case 3:l=h,r=d,n=i;break;case 4:l=u,r=h,n=i;break;case 5:l=i,r=h,n=d}return{r:Math.round(255*l),g:Math.round(255*r),b:Math.round(255*n),a:null!=s?s:1}}rgb2hsv(e,t,i,s){1===arguments.length&&(t=e.g,i=e.b,s=e.a,e=e.r);let l=Math.max(e,t,i),r=Math.min(e,t,i),n=l-r,a,o=0===l?0:n/l,h=l/255;switch(l){case r:a=0;break;case e:a=t-i+n*(t<i?6:0),a/=6*n;break;case t:a=i-e+2*n,a/=6*n;break;case i:a=e-t+4*n,a/=6*n}return{h:Math.round(360*a),s:Math.round(100*o),v:Math.round(100*h),a:null!=s?s:1}}tooltip(e,t){let i="mouseenter",s="mouseleave";return t=(t="object"==typeof e?e:t)||{},"string"==typeof e&&(t.html=e),t.showOn&&(i=t.showOn,delete t.showOn),t.hideOn&&(s=t.hideOn,delete t.hideOn),t.name||(t.name="no-name"),` on${i}="w2tooltip.show(this, `+`JSON.parse(w2utils.base64decode('${this.base64encode(JSON.stringify(t))}')))" `+`on${s}="w2tooltip.hide('${t.name}')"`}isPlainObject(e){if(null==e)return!1;if("[object Object]"!==Object.prototype.toString.call(e))return!1;if(void 0===e.constructor)return!0;e=Object.getPrototypeOf(e);return null===e||e===Object.prototype}clone(e,i){let s;return i=Object.assign({functions:!0,elements:!0,events:!0,exclude:[]},i??{}),Array.isArray(e)?(s=Array.from(e)).forEach((e,t)=>{s[t]=this.clone(e,i)}):this.isPlainObject(e)?(s={},Object.assign(s,e),i.exclude&&i.exclude.forEach(e=>{delete s[e]}),Object.keys(s).forEach(e=>{s[e]=this.clone(s[e],i),void 0===s[e]&&delete s[e]})):e instanceof Function&&!i.functions||e instanceof Node&&!i.elements||e instanceof Event&&!i.events||(s=e),s}extend(i,s){if(Array.isArray(i)){if(!Array.isArray(s))throw new Error("Arrays can be extended with arrays only");i.splice(0,i.length),s.forEach(e=>{i.push(this.clone(e))})}else{if(i instanceof Node||i instanceof Event)throw new Error("HTML elmenents and events cannot be extended");if(i&&"object"==typeof i&&null!=s){if("object"!=typeof s)throw new Error("Object can be extended with other objects only.");Object.keys(s).forEach(e=>{var t;null!=i[e]&&"object"==typeof i[e]&&null!=s[e]&&"object"==typeof s[e]?(t=this.clone(s[e]),i[e]instanceof Node||i[e]instanceof Event?i[e]=t:(Array.isArray(i[e])&&this.isPlainObject(t)&&(i[e]={}),this.extend(i[e],t))):i[e]=this.clone(s[e])})}else if(null!=s)throw new Error("Object is not extendable, only {} or [] can be extended.")}if(2<arguments.length)for(let e=2;e<arguments.length;e++)this.extend(i,arguments[e]);return i}naturalCompare(e,t){let s,i,l=1,r=0,n=0,a=String.alphabet;function o(e,t,i){if(i){for(s=t;(i=o(e,s))<76&&65<i;)++s;return+e.slice(t-1,s)}return-1<(i=a&&a.indexOf(e.charAt(t)))?i+76:(i=e.charCodeAt(t)||0)<45||127<i?i:i<46?65:i<48?i-1:i<58?i+18:i<65?i-11:i<91?i+11:i<97?i-37:i<123?i+5:i-63}if((e+="")!=(t+=""))for(;l;)if(i=o(e,r++),l=o(t,n++),i<76&&l<76&&66<i&&66<l&&(i=o(e,r,r),l=o(t,n,r=s),n=s),i!=l)return i<l?-1:1;return 0}normMenu(i,e){return Array.isArray(i)?(i.forEach((e,t)=>{"string"==typeof e||"number"==typeof e?i[t]={id:e,text:String(e)}:null!=e?(null!=e.caption&&null==e.text&&(e.text=e.caption),null!=e.text&&null==e.id&&(e.id=e.text),null==e.text&&null!=e.id&&(e.text=e.id)):i[t]={id:null,text:"null"}}),i):"function"==typeof i?(e=i.call(this,i,e),w2utils.normMenu.call(this,e)):"object"==typeof i?Object.keys(i).map(e=>({id:e,text:i[e]})):void 0}bindEvents(e,r){0!=e.length&&(e?.[0]instanceof Node&&(e=Array.isArray(e)?e:e.get()),query(e).each(s=>{let l=query(s).data();Object.keys(l).forEach(i=>{if(-1!=["click","dblclick","mouseenter","mouseleave","mouseover","mouseout","mousedown","mousemove","mouseup","contextmenu","focus","focusin","focusout","blur","input","change","keydown","keyup","keypress"].indexOf(String(i).toLowerCase())){let e=l[i],t=(e="string"==typeof e?e.split("|").map(e=>("null"===(e="undefined"===(e="false"===(e="true"===e?!0:e)?!1:e)?void 0:e)&&(e=null),parseFloat(e)==e&&(e=parseFloat(e)),e=["'",'"',"`"].includes(e[0])&&["'",'"',"`"].includes(e[e.length-1])?e.substring(1,e.length-1):e)):e)[0];e=e.slice(1),query(s).off(i+".w2utils-bind").on(i+".w2utils-bind",function(i){switch(t){case"alert":alert(e[0]);break;case"stop":i.stopPropagation();break;case"prevent":i.preventDefault();break;case"stopPrevent":return i.stopPropagation(),i.preventDefault(),!1;default:if(null==r[t])throw new Error(`Cannot dispatch event as the method "${t}" does not exist.`);r[t].apply(r,e.map((e,t)=>{switch(String(e).toLowerCase()){case"event":return i;case"this":return this;default:return e}}))}})}})}))}}var w2utils=new Utils;class Dialog extends w2base{constructor(){super(),this.defaults={title:"",text:"",body:"",buttons:"",width:450,height:250,focus:null,actions:null,style:"",speed:.3,modal:!1,maximized:!1,keyboard:!0,showClose:!0,showMax:!1,transition:null,openMaximized:!1,moved:!1},this.name="popup",this.status="closed",this.onOpen=null,this.onClose=null,this.onMax=null,this.onMin=null,this.onToggle=null,this.onKeydown=null,this.onAction=null,this.onMove=null,this.handleResize=e=>{this.options.moved||this.center(void 0,void 0,!0)}}open(r){let n=this;if("closing"==w2popup.status||query("#w2ui-popup").hasClass("animating"))setTimeout(()=>{n.open.call(n,r)},100);else{var e=this.options;null!=(r=["string","number"].includes(typeof r)?w2utils.extend({title:"Notification",body:`<div class="w2ui-centered">${r}</div>`,actions:{Ok(){w2popup.close()}},cancelAction:"ok"},arguments[1]??{}):r).text&&(r.body=`<div class="w2ui-centered w2ui-msg-text">${r.text}</div>`),r=Object.assign({},this.defaults,e,{title:"",body:""},r,{maximized:!1}),this.options=r,0===query("#w2ui-popup").length&&(w2popup.off("*"),Object.keys(w2popup).forEach(e=>{e.startsWith("on")&&"on"!=e&&(w2popup[e]=null)})),Object.keys(r).forEach(e=>{e.startsWith("on")&&"on"!=e&&r[e]&&(w2popup[e]=r[e])}),r.width=parseInt(r.width),r.height=parseInt(r.height);let s,t,i;var{top:a,left:o}=this.center();let l={self:this,action(e){return n.on("action.prom",e),l},close(e){return n.on("close.prom",e),l},then(e){return n.on("open:after.prom",e),l}};if(null==r.actions||r.buttons||(r.buttons="",Object.keys(r.actions).forEach(e=>{var t=r.actions[e];let i=e;"function"==typeof t&&(r.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${e}","event"]'>${e}</button>`),"object"==typeof t&&(r.buttons+=`<button class="w2ui-btn w2ui-eaction ${t.class||""}" data-click='["action","${e}","event"]'
                        style="${t.style}" ${t.attrs}>${t.text||e}</button>`,i=Array.isArray(r.actions)?t.text:e),"string"==typeof t&&(r.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${t}","event"]'>${t}</button>`,i=t),"string"==typeof i&&(i=i[0].toLowerCase()+i.substr(1).replace(/\s+/g,"")),l[i]=function(t){return n.on("action.buttons",e=>{e.detail.action[0].toLowerCase()+e.detail.action.substr(1).replace(/\s+/g,"")==i&&t(e)}),l}})),0===query("#w2ui-popup").length){if(!0===(s=this.trigger("open",{target:"popup",present:!1})).isCancelled)return;w2popup.status="opening",w2utils.lock(document.body,{opacity:.3,onClick:r.modal?null:()=>{w2popup.close()}});let e="";r.showClose&&(e+=`<div class="w2ui-popup-button w2ui-popup-close">
                            <span class="w2ui-icon w2ui-icon-cross w2ui-eaction" data-mousedown="stop" data-click="close"></span>
                        </div>`),r.showMax&&(e+=`<div class="w2ui-popup-button w2ui-popup-max">
                            <span class="w2ui-icon w2ui-icon-box w2ui-eaction" data-mousedown="stop" data-click="toggle"></span>
                        </div>`);o=`
                left: ${o}px;
                top: ${a}px;
                width: ${parseInt(r.width)}px;
                height: ${parseInt(r.height)}px;
                transition: ${r.speed}s
            `;t=`<div id="w2ui-popup" class="w2ui-popup w2ui-anim-open animating" style="${w2utils.stripSpaces(o)}"></div>`,query("body").append(t),query("#w2ui-popup")[0]._w2popup={self:this,created:new Promise(e=>{this._promCreated=e}),opened:new Promise(e=>{this._promOpened=e}),closing:new Promise(e=>{this._promClosing=e}),closed:new Promise(e=>{this._promClosed=e})},o=`${r.title?"":"top: 0px !important;"} `+(r.buttons?"":"bottom: 0px !important;"),t=`
                <span name="hidden-first" tabindex="0" style="position: absolute; top: -100px"></span>
                <div class="w2ui-popup-title" style="${r.title?"":"display: none"}">${e}</div>
                <div class="w2ui-box" style="${o}">
                    <div class="w2ui-popup-body ${!r.title||" w2ui-popup-no-title"}
                        ${!r.buttons||" w2ui-popup-no-buttons"}" style="${r.style}">
                    </div>
                </div>
                <div class="w2ui-popup-buttons" style="${r.buttons?"":"display: none"}"></div>
                <span name="hidden-last" tabindex="0" style="position: absolute; top: -100px"></span>
            `,query("#w2ui-popup").html(t),r.title&&query("#w2ui-popup .w2ui-popup-title").append(w2utils.lang(r.title)),r.buttons&&query("#w2ui-popup .w2ui-popup-buttons").append(r.buttons),r.body&&query("#w2ui-popup .w2ui-popup-body").append(r.body),setTimeout(()=>{query("#w2ui-popup").css("transition",r.speed+"s").removeClass("w2ui-anim-open"),w2utils.bindEvents("#w2ui-popup .w2ui-eaction",w2popup),query("#w2ui-popup").find(".w2ui-popup-body").show(),this._promCreated()},1),clearTimeout(this._timer),this._timer=setTimeout(()=>{w2popup.status="open",n.setFocus(r.focus),s.finish(),this._promOpened(),query("#w2ui-popup").removeClass("animating")},1e3*r.speed)}else{if(!0===(s=this.trigger("open",{target:"popup",present:!0})).isCancelled)return;w2popup.status="opening",null!=e&&(e.maximized||e.width==r.width&&e.height==r.height||w2popup.resize(r.width,r.height),r.prevSize=r.width+"px:"+r.height+"px",r.maximized=e.maximized);a=query("#w2ui-popup .w2ui-box").get(0).cloneNode(!0);query(a).removeClass("w2ui-box").addClass("w2ui-box-temp").find(".w2ui-popup-body").empty().append(r.body),query("#w2ui-popup .w2ui-box").after(a),r.buttons?(query("#w2ui-popup .w2ui-popup-buttons").show().html("").append(r.buttons),query("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-buttons"),query("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","")):(query("#w2ui-popup .w2ui-popup-buttons").hide().html(""),query("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-buttons"),query("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","0px")),r.title?(query("#w2ui-popup .w2ui-popup-title").show().html((r.showClose?`<div class="w2ui-popup-button w2ui-popup-close">
                                <span class="w2ui-icon w2ui-icon-cross w2ui-eaction" data-mousedown="stop" data-click="close"></span>
                            </div>`:"")+(r.showMax?`<div class="w2ui-popup-button w2ui-popup-max">
                                <span class="w2ui-icon w2ui-icon-box w2ui-eaction" data-mousedown="stop" data-click="toggle"></span>
                            </div>`:"")).append(r.title),query("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-title"),query("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","")):(query("#w2ui-popup .w2ui-popup-title").hide().html(""),query("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-title"),query("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","0px"));let t=query("#w2ui-popup .w2ui-box")[0],i=query("#w2ui-popup .w2ui-box-temp")[0];query("#w2ui-popup").addClass("animating"),w2utils.transition(t,i,r.transition,()=>{query(t).remove(),query(i).removeClass("w2ui-box-temp").addClass("w2ui-box");let e=query(i).find(".w2ui-popup-body");1==e.length&&(e[0].style.cssText=r.style,e.show()),n.setFocus(r.focus),query("#w2ui-popup").removeClass("animating")}),w2popup.status="open",s.finish(),w2utils.bindEvents("#w2ui-popup .w2ui-eaction",w2popup),query("#w2ui-popup").find(".w2ui-popup-body").show()}return r.openMaximized&&this.max(),r._last_focus=document.activeElement,r.keyboard&&query(document.body).on("keydown",this.keydown),query(window).on("resize",this.handleResize),i={resizing:!1,mvMove:function(t){if(1==i.resizing){t=t||window.event,i.div_x=t.screenX-i.x,i.div_y=t.screenY-i.y;let e=w2popup.trigger("move",{target:"popup",div_x:i.div_x,div_y:i.div_y,originalEvent:t});!0!==e.isCancelled&&(query("#w2ui-popup").css({transition:"none",transform:"translate3d("+i.div_x+"px, "+i.div_y+"px, 0px)"}),n.options.moved=!0,e.finish())}},mvStop:function(e){1==i.resizing&&(e=e||window.event,w2popup.status="open",i.div_x=e.screenX-i.x,i.div_y=e.screenY-i.y,query("#w2ui-popup").css({left:i.pos_x+i.div_x+"px",top:i.pos_y+i.div_y+"px"}).css({transition:"none",transform:"translate3d(0px, 0px, 0px)"}),i.resizing=!1,query(document.body).off(".w2ui-popup"),i.isLocked||w2popup.unlock())}},query("#w2ui-popup .w2ui-popup-title").on("mousedown",function(e){var t;w2popup.options.maximized||(e=(e=e)||window.event,w2popup.status="moving",t=query("#w2ui-popup").get(0).getBoundingClientRect(),Object.assign(i,{resizing:!0,isLocked:1==query("#w2ui-popup > .w2ui-lock").length,x:e.screenX,y:e.screenY,pos_x:t.x,pos_y:t.y}),i.isLocked||w2popup.lock({opacity:0}),query(document.body).on("mousemove.w2ui-popup",i.mvMove).on("mouseup.w2ui-popup",i.mvStop),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault())}),l}}load(l){return new Promise((t,e)=>{if(null==(l="string"==typeof l?{url:l}:l).url)return console.log("ERROR: The url is not defined."),void e("The url is not defined");w2popup.status="loading";let[i,s]=String(l.url).split("#");i&&fetch(i).then(e=>e.text()).then(e=>{t(this.template(e,s,l))})})}template(t,e,i={}){let s;try{s=query(t)}catch(e){s=query.html(t)}return e&&(s=s.filter("#"+e)),Object.assign(i,{width:parseInt(query(s).css("width")),height:parseInt(query(s).css("height")),title:query(s).find("[rel=title]").html(),body:query(s).find("[rel=body]").html(),buttons:query(s).find("[rel=buttons]").html(),style:query(s).find("[rel=body]").get(0).style.cssText}),w2popup.open(i)}action(e,t){let i=this.options.actions[e],s=(i instanceof Object&&i.onClick&&(i=i.onClick),this.trigger("action",{action:e,target:"popup",self:this,originalEvent:t,value:this.input?this.input.value:null}));!0!==s.isCancelled&&("function"==typeof i&&i.call(this,t),s.finish())}keydown(t){if(!this.options||this.options.keyboard){let e=w2popup.trigger("keydown",{target:"popup",originalEvent:t});!0!==e.isCancelled&&(27===t.keyCode&&(t.preventDefault(),0==query("#w2ui-popup .w2ui-message").length&&(w2popup.options.cancelAction?w2popup.action(w2popup.options.cancelAction):w2popup.close())),e.finish())}}close(){if(0!==query("#w2ui-popup").length&&"closed"!=this.status)if("opening"==this.status)setTimeout(()=>{w2popup.close()},100);else{let e=this.trigger("close",{target:"popup"});!0!==e.isCancelled&&(w2popup.status="closing",query("#w2ui-popup").css("transition",this.options.speed+"s").addClass("w2ui-anim-close animating"),w2utils.unlock(document.body,300),this._promClosing(),setTimeout(()=>{query("#w2ui-popup").remove(),this.options._last_focus&&0<this.options._last_focus.length&&this.options._last_focus.focus(),w2popup.status="closed",w2popup.options={},e.finish(),this._promClosed()},1e3*this.options.speed),this.options.keyboard&&query(document.body).off("keydown",this.keydown),query(window).off("resize",this.handleResize))}}toggle(){let e=this.trigger("toggle",{target:"popup"});!0!==e.isCancelled&&(!0===this.options.maximized?w2popup.min():w2popup.max(),setTimeout(()=>{e.finish()},1e3*this.options.speed+50))}max(){if(!0!==this.options.maximized){let e=this.trigger("max",{target:"popup"});var t;!0!==e.isCancelled&&(w2popup.status="resizing",t=query("#w2ui-popup").get(0).getBoundingClientRect(),this.options.prevSize=t.width+":"+t.height,w2popup.resize(1e4,1e4,()=>{w2popup.status="open",this.options.maximized=!0,e.finish()}))}}min(){if(!0===this.options.maximized){var t=this.options.prevSize.split(":");let e=this.trigger("min",{target:"popup"});!0!==e.isCancelled&&(w2popup.status="resizing",this.options.maximized=!1,w2popup.resize(parseInt(t[0]),parseInt(t[1]),()=>{w2popup.status="open",this.options.prevSize=null,e.finish()}))}}clear(){query("#w2ui-popup .w2ui-popup-title").html(""),query("#w2ui-popup .w2ui-popup-body").html(""),query("#w2ui-popup .w2ui-popup-buttons").html("")}reset(){w2popup.open(w2popup.defaults)}message(e){return w2utils.message({owner:this,box:query("#w2ui-popup").get(0),after:".w2ui-popup-title"},e)}confirm(e){return w2utils.confirm({owner:this,box:query("#w2ui-popup"),after:".w2ui-popup-title"},e)}setFocus(t){let s=query("#w2ui-popup"),l="input, button, select, textarea, [contentEditable], .w2ui-input";if(null!=t){let e=isNaN(t)?s.find(l).filter(t).get(0):s.find(l).get(t);e?.focus()}else s.find("[name=hidden-first]").get(0).focus();query(s).find(l+",[name=hidden-first],[name=hidden-last]").off(".keep-focus").on("blur.keep-focus",function(e){setTimeout(()=>{var e=document.activeElement,t=0<query(s).find(l).filter(e).length,i=query(e).attr("name");!t&&e&&e!==document.body&&query(s).find(l).get(0)?.focus(),"hidden-last"==i&&query(s).find(l).get(0)?.focus(),"hidden-first"==i&&query(s).find(l).get(-1)?.focus()},1)})}lock(e,t){let i=Array.from(arguments);i.unshift(query("#w2ui-popup")),w2utils.lock(...i)}unlock(e){w2utils.unlock(query("#w2ui-popup"),e)}center(e,t,i){let s,l;l=null==window.innerHeight?(s=parseInt(document.documentElement.offsetWidth),parseInt(document.documentElement.offsetHeight)):(s=parseInt(window.innerWidth),parseInt(window.innerHeight)),e=parseInt(e??this.options.width),t=parseInt(t??this.options.height),!0===this.options.maximized&&(e=s,t=l),s-10<e&&(e=s-10),l-10<t&&(t=l-10);var r=(l-t)/2,n=(s-e)/2;return i&&(query("#w2ui-popup").css({transition:"none",top:r+"px",left:n+"px",width:e+"px",height:t+"px"}),this.resizeMessages()),{top:r,left:n,width:e,height:t}}resize(e,t,i){let s=this;null==this.options.speed&&(this.options.speed=0);var{top:e,left:t,width:l,height:r}=this.center(e,t),n=this.options.speed;query("#w2ui-popup").css({transition:n+`s width, ${n}s height, ${n}s left, ${n}s top`,top:e+"px",left:t+"px",width:l+"px",height:r+"px"});let a=setInterval(()=>{s.resizeMessages()},10);setTimeout(()=>{clearInterval(a),s.resizeMessages(),"function"==typeof i&&i()},1e3*this.options.speed+50)}resizeMessages(){query("#w2ui-popup .w2ui-message").each(e=>{let t=e._msg_options,i=query("#w2ui-popup");parseInt(t.width)<10&&(t.width=10),parseInt(t.height)<10&&(t.height=10);var s=i[0].getBoundingClientRect(),l=parseInt(i.find(".w2ui-popup-title")[0].clientHeight),r=parseInt(s.width),s=parseInt(s.height);t.width=t.originalWidth,t.width>r-10&&(t.width=r-10),t.height=t.originalHeight,t.height>s-l-5&&(t.height=s-l-5),t.originalHeight<0&&(t.height=s+t.originalHeight-l),t.originalWidth<0&&(t.width=r+2*t.originalWidth),query(e).css({left:(r-t.width)/2+"px",width:t.width+"px",height:t.height+"px"})})}}function w2alert(e,t,i){let s;t={title:w2utils.lang(t??"Notification"),body:`<div class="w2ui-centered w2ui-msg-text">${e}</div>`,showClose:!1,actions:["Ok"],cancelAction:"ok"};return(s=0<query("#w2ui-popup").length&&"closing"!=w2popup.status?w2popup.message(t):w2popup.open(t)).ok(e=>{"function"==typeof e.detail.self?.close&&e.detail.self.close(),"function"==typeof i&&i()}),s}function w2confirm(e,t,i){let s,l=e;return(l=["string","number"].includes(typeof l)?{msg:l}:l).msg&&(l.body=`<div class="w2ui-centered w2ui-msg-text">${l.msg}</div>`,delete l.msg),w2utils.extend(l,{title:w2utils.lang(t??"Confirmation"),showClose:!1,modal:!0,cancelAction:"no"}),w2utils.normButtons(l,{yes:"Yes",no:"No"}),(s=0<query("#w2ui-popup").length&&"closing"!=w2popup.status?w2popup.message(l):w2popup.open(l)).self.off(".confirm").on("action:after.confirm",e=>{"function"==typeof e.detail.self?.close&&e.detail.self.close(),"function"==typeof i&&i(e.detail.action)}),s}function w2prompt(e,t,i){let s,l=e;return(l=["string","number"].includes(typeof l)?{label:l}:l).label&&(l.focus=0,l.body=l.textarea?`<div class="w2ui-prompt textarea">
                 <div>${l.label}</div>
                 <textarea id="w2prompt" class="w2ui-input" ${l.attrs??""}
                    data-keydown="keydown|event" data-keyup="change|event">${l.value??""}</textarea>
               </div>`:`<div class="w2ui-prompt w2ui-centered">
                 <label>${l.label}</label>
                 <input id="w2prompt" class="w2ui-input" ${l.attrs??""}
                    data-keydown="keydown|event" data-keyup="change|event" value="${l.value??""}">
               </div>`),w2utils.extend(l,{title:w2utils.lang(t??"Notification"),showClose:!1,modal:!0,cancelAction:"cancel"}),w2utils.normButtons(l,{ok:"Ok",cancel:"Cancel"}),(s=0<query("#w2ui-popup").length&&"closing"!=w2popup.status?w2popup.message(l):w2popup.open(l)).self.box?s.self.input=query(s.self.box).find("#w2prompt").get(0):s.self.input=query("#w2ui-popup .w2ui-popup-body #w2prompt").get(0),null!==l.value&&s.self.input.select(),s.change=function(e){return s.self.on("change",e),this},s.self.off(".prompt").on("open:after.prompt",e=>{e=e.detail.box||query("#w2ui-popup .w2ui-popup-body").get(0);w2utils.bindEvents(query(e).find("#w2prompt"),{keydown(e){27==e.keyCode&&e.stopPropagation()},change(e){let t=s.self.trigger("change",{target:"prompt",originalEvent:e});!0!==t.isCancelled&&(13==e.keyCode&&e.ctrlKey&&s.self.action("Ok",e),27==e.keyCode&&s.self.action("Cancel",e),t.finish())}}),query(e).find(".w2ui-eaction").trigger("keyup")}).on("action:after.prompt",e=>{"function"==typeof e.detail.self?.close&&e.detail.self.close(),"function"==typeof i&&i(e.detail.action)}),s}let w2popup=new Dialog;class Tooltip{static active={};constructor(){this.defaults={name:null,html:"",style:"",class:"",position:"top|bottom",align:"",anchor:null,anchorClass:"",anchorStyle:"",autoShow:!1,autoShowOn:null,autoHideOn:null,arrowSize:8,margin:0,screenMargin:2,autoResize:!0,offsetX:0,offsetY:0,maxWidth:null,maxHeight:null,watchScroll:null,watchResize:null,hideOn:null,onThen:null,onShow:null,onHide:null,onUpdate:null,onMove:null}}static observeRemove=new MutationObserver(e=>{let i=0;Object.keys(Tooltip.active).forEach(e=>{let t=Tooltip.active[e];t.displayed&&(t.anchor&&t.anchor.isConnected?i++:t.hide())}),0===i&&Tooltip.observeRemove.disconnect()});trigger(e,t){var i;if(2==arguments.length&&(i=e,(e=t).type=i),e.overlay)return e.overlay.trigger(e);console.log("ERROR: cannot find overlay where to trigger events")}get(e){return 0==arguments.length?Object.keys(Tooltip.active):!0===e?Tooltip.active:Tooltip.active[e.replace(/[\s\.#]/g,"_")]}attach(t,s){let l,r,n=this;if(0!=arguments.length){1==arguments.length&&t.anchor?t=(l=t).anchor:2===arguments.length&&"string"==typeof s?s=(l={anchor:t,html:s}).html:2===arguments.length&&null!=s&&"object"==typeof s&&(s=(l=s).html),l=w2utils.extend({},this.defaults,l||{}),!(s=!s&&l.text?l.text:s)&&l.html&&(s=l.html),delete l.anchor;let e=l.name||t.id;var a;t!=document&&t!=document.body||(t=document.body,e="context-menu"),e||(e="noname-"+Object.keys(Tooltip.active).length,console.log("NOTICE: name property is not defined for tooltip, could lead to too many instances")),e=e.replace(/[\s\.#]/g,"_"),Tooltip.active[e]?((r=Tooltip.active[e]).prevOptions=r.options,r.options=l,r.anchor=t,r.prevOptions.html==r.options.html&&r.prevOptions.class==r.options.class&&r.prevOptions.style==r.options.style||(r.needsUpdate=!0),l=r.options):(r=new w2base,Object.assign(r,{id:"w2overlay-"+e,name:e,options:l,anchor:t,displayed:!1,tmp:{observeResize:new ResizeObserver(()=>{this.resize(r.name)})},hide(){n.hide(e)}}),Tooltip.active[e]=r),Object.keys(r.options).forEach(e=>{var t=r.options[e];e.startsWith("on")&&"function"==typeof t&&(r[e]=t,delete r.options[e])}),!0===l.autoShow&&(l.autoShowOn=l.autoShowOn??"mouseenter",l.autoHideOn=l.autoHideOn??"mouseleave",l.autoShow=!1),l.autoShowOn&&(a="autoShow-"+r.name,query(t).off("."+a).on(l.autoShowOn+"."+a,e=>{n.show(r.name),e.stopPropagation()}),delete l.autoShowOn),l.autoHideOn&&(a="autoHide-"+r.name,query(t).off("."+a).on(l.autoHideOn+"."+a,e=>{n.hide(r.name),e.stopPropagation()}),delete l.autoHideOn),r.off(".attach");let i={overlay:r,then:t=>(r.on("show:after.attach",e=>{t(e)}),i),show:t=>(r.on("show.attach",e=>{t(e)}),i),hide:t=>(r.on("hide.attach",e=>{t(e)}),i),update:t=>(r.on("update.attach",e=>{t(e)}),i),move:t=>(r.on("move.attach",e=>{t(e)}),i)};return i}}update(e,t){let i=Tooltip.active[e];i?(i.needsUpdate=!0,i.options.html=t,this.show(e)):console.log(`Tooltip "${e}" is not displayed. Cannot update it.`)}show(i){if(i instanceof HTMLElement||i instanceof Object){let e=i,t=(i instanceof HTMLElement&&((e=arguments[1]||{}).anchor=i),this.attach(e));return query(t.overlay.anchor).off(".autoShow-"+t.overlay.name).off(".autoHide-"+t.overlay.name),setTimeout(()=>{this.show(t.overlay.name)},1),t}let s,r=this,n=Tooltip.active[i.replace(/[\s\.#]/g,"_")];if(n){let l=n.options;if(!n||n.displayed&&!n.needsUpdate)this.resize(n?.name);else{var e=l.position.split("|"),e=["top","bottom"].includes(e[0]);let t="both"==l.align&&e?"":"white-space: nowrap;";if(l.maxWidth&&w2utils.getStrWidth(l.html,"")>l.maxWidth&&(t="width: "+l.maxWidth+"px; white-space: inherit; overflow: auto;"),t+=" max-height: "+(l.maxHeight||window.innerHeight-40)+"px;",""!==l.html&&null!=l.html){if(n.box){if(!0===(s=this.trigger("update",{target:i,overlay:n})).isCancelled)return void(n.prevOptions&&(n.options=n.prevOptions,delete n.prevOptions));query(n.box).find(".w2ui-overlay-body").attr("style",(l.style||"")+"; "+t).removeClass().addClass("w2ui-overlay-body "+l.class).html(l.html),this.resize(n.name)}else{if(!0===(s=this.trigger("show",{target:i,overlay:n})).isCancelled)return;query("body").append(`<div id="${n.id}" name="${i}" style="display: none; pointer-events: none" class="w2ui-overlay"
                        data-click="stop" data-focusin="stop">
                    <style></style>
                    <div class="w2ui-overlay-body ${l.class}" style="${l.style||""}; ${t}">
                        ${l.html}
                    </div>
                </div>`),n.box=query("#"+w2utils.escapeId(n.id))[0],n.displayed=!0;let e=query(n.anchor).data("tooltipName")??[];e.push(i),query(n.anchor).data("tooltipName",e),w2utils.bindEvents(n.box,{}),n.tmp.originalCSS="",0<query(n.anchor).length&&(n.tmp.originalCSS=query(n.anchor)[0].style.cssText),this.resize(n.name)}l.anchorStyle&&(n.anchor.style.cssText+=";"+l.anchorStyle),!l.anchorClass||"w2ui-focus"==l.anchorClass&&n.anchor==document.body||query(n.anchor).addClass(l.anchorClass),"string"==typeof l.hideOn&&(l.hideOn=[l.hideOn]),Array.isArray(l.hideOn)||(l.hideOn=[]),Object.assign(n.tmp,{scrollLeft:document.body.scrollLeft,scrollTop:document.body.scrollTop});{let t=e=>{r.hide(n.name)},i=query(n.anchor),s="tooltip-"+n.name;query("body").off("."+s),l.hideOn.includes("doc-click")&&(["INPUT","TEXTAREA"].includes(n.anchor.tagName)&&i.off(`.${s}-doc`).on(`click.${s}-doc`,e=>{e.stopPropagation()}),query("body").on("click."+s,t));l.hideOn.includes("focus-change")&&query("body").on("focusin."+s,e=>{document.activeElement!=n.anchor&&r.hide(n.name)});["INPUT","TEXTAREA"].includes(n.anchor.tagName)&&(i.off("."+s),l.hideOn.forEach(e=>{-1==["doc-click","focus-change"].indexOf(e)&&i.on(e+"."+s,{once:!0},t)}))}{var a=document.body;let e="tooltip-"+n.name,t=a;"BODY"==a.tagName&&(t=a.ownerDocument);query(t).off("."+e).on("scroll."+e,e=>{Object.assign(n.tmp,{scrollLeft:a.scrollLeft,scrollTop:a.scrollTop}),r.resize(n.name)})}return query(n.box).show(),n.tmp.observeResize.observe(n.box),Tooltip.observeRemove.observe(document.body,{subtree:!0,childList:!0}),query(n.box).css("opacity",1).find(".w2ui-overlay-body").html(l.html),setTimeout(()=>{query(n.box).css({"pointer-events":"auto"}).data("ready","yes")},100),delete n.needsUpdate,n.box.overlay=n,s&&s.finish(),{overlay:n}}r.hide(i)}}}hide(t){let s;if(0==arguments.length)Object.keys(Tooltip.active).forEach(e=>{this.hide(e)});else if(t instanceof HTMLElement){let e=query(t).data("tooltipName")??[];void e.forEach(e=>{this.hide(e)})}else if("string"==typeof t&&(t=t.replace(/[\s\.#]/g,"_"),s=Tooltip.active[t]),s&&s.box){delete Tooltip.active[t];let i=this.trigger("hide",{target:t,overlay:s});if(!0!==i.isCancelled){var l="tooltip-"+s.name;s.tmp.observeResize?.disconnect(),s.options.watchScroll&&query(s.options.watchScroll).off(".w2scroll-"+s.name);let t=0,e=(Object.keys(Tooltip.active).forEach(e=>{Tooltip.active[e].displayed&&t++}),0==t&&Tooltip.observeRemove.disconnect(),query("body").off("."+l),query(document).off("."+l),s.box.remove(),s.box=null,s.displayed=!1,query(s.anchor).data("tooltipName")??[]);-1!=e.indexOf(s.name)&&e.splice(e.indexOf(s.name),1),0==e.length?query(s.anchor).removeData("tooltipName"):query(s.anchor).data("tooltipName",e),s.anchor.style.cssText=s.tmp.originalCSS,query(s.anchor).off("."+l).removeClass(s.options.anchorClass),i.finish()}}}resize(s){if(0==arguments.length)Object.keys(Tooltip.active).forEach(e=>{e=Tooltip.active[e];e.displayed&&this.resize(e.name)});else{let e=Tooltip.active[s.replace(/[\s\.#]/g,"_")],t=this.getPosition(e.name);var l=t.left+"x"+t.top;let i;e.tmp.lastPos!=l&&(i=this.trigger("move",{target:s,overlay:e,pos:t})),query(e.box).css({left:t.left+"px",top:t.top+"px"}).then(e=>{null!=t.width&&e.css("width",t.width+"px").find(".w2ui-overlay-body").css("width","100%"),null!=t.height&&e.css("height",t.height+"px").find(".w2ui-overlay-body").css("height","100%")}).find(".w2ui-overlay-body").removeClass("w2ui-arrow-right w2ui-arrow-left w2ui-arrow-top w2ui-arrow-bottom").addClass(t.arrow.class).closest(".w2ui-overlay").find("style").text(t.arrow.style),e.tmp.lastPos!=l&&i&&(e.tmp.lastPos=l,i.finish())}}getPosition(g){let y=Tooltip.active[g.replace(/[\s\.#]/g,"_")];if(y&&y.box){let t=y.options;(y.tmp.resizedY||y.tmp.resizedX)&&query(y.box).css({width:"",height:"",scroll:"auto"});var w,g=w2utils.scrollBarSize(),b=!(document.body.scrollWidth==document.body.clientWidth),v=!(document.body.scrollHeight==document.body.clientHeight);let i={width:window.innerWidth-(v?g:0),height:window.innerHeight-(b?g:0)},e=("auto"==t.position?"top|bottom|right|left":t.position).split("|"),s=["top","bottom"].includes(e[0]),l=y.box.getBoundingClientRect(),r=y.anchor.getBoundingClientRect(),n=(y.anchor==document.body&&({x,y:_,width:C,height:q}=t.originalEvent,r={left:x-2,top:_-4,width:C,height:q,arrow:"none"}),t.arrowSize),a=("none"==r.arrow&&(n=0),{top:r.top,bottom:i.height-(r.top+r.height)-+(b?g:0),left:r.left,right:i.width-(r.left+r.width)+(v?g:0)});l.width<22&&(l.width=22),l.height<14&&(l.height=14);let o,h,d,u,c="",p={offset:0,class:"",style:`#${y.id} { --tip-size: ${n}px; }`},f={left:0,top:0},m={posX:"",x:0,posY:"",y:0};e.forEach(e=>{["top","bottom"].includes(e)&&(!c&&l.height+n/1.893<a[e]&&(c=e),a[e]>m.y&&Object.assign(m,{posY:e,y:a[e]})),["left","right"].includes(e)&&(!c&&l.width+n/1.893<a[e]&&(c=e),a[e]>m.x&&Object.assign(m,{posX:e,x:a[e]}))}),c=c||(s?m.posY:m.posX),t.autoResize&&(["top","bottom"].includes(c)&&(l.height>a[c]?(u=a[c],y.tmp.resizedY=!0):y.tmp.resizedY=!1),["left","right"].includes(c)&&(l.width>a[c]?(d=a[c],y.tmp.resizedX=!0):y.tmp.resizedX=!1));var x=c;switch(p.class=r.arrow||"w2ui-arrow-"+x,x){case"top":o=r.left+(r.width-(d??l.width))/2,h=r.top-(u??l.height)-n/1.5+1;break;case"bottom":o=r.left+(r.width-(d??l.width))/2,h=r.top+r.height+n/1.25+1;break;case"left":o=r.left-(d??l.width)-n/1.2-1,h=r.top+(r.height-(u??l.height))/2;break;case"right":o=r.left+r.width+n/1.2+1,h=r.top+(r.height-(u??l.height))/2}if(s)"left"==t.align&&(f.left=r.left-o,o=r.left),"right"==t.align&&(f.left=r.left+r.width-(d??l.width)-o,o=r.left+r.width-(d??l.width)),["top","bottom"].includes(c)&&t.align.startsWith("both")&&(w=t.align.split(":")[1]??50,r.width>=w&&(o=r.left,d=r.width)),"top"==t.align&&(f.top=r.top-h,h=r.top),"bottom"==t.align&&(f.top=r.top+r.height-(u??l.height)-h,h=r.top+r.height-(u??l.height)),["left","right"].includes(c)&&t.align.startsWith("both")&&(w=t.align.split(":")[1]??50,r.height>=w&&(h=r.top,u=r.height));{let e;(["left","right"].includes(t.align)&&r.width<(d??l.width)||["top","bottom"].includes(t.align)&&r.height<(u??l.height))&&(e=!0);var _="right"==c?n:t.screenMargin,C="bottom"==c?n:t.screenMargin,q=i.width-(d??l.width)-("left"==c?n:t.screenMargin),b=i.height-(u??l.height)-("top"==c?n:t.screenMargin)+3;(["top","bottom"].includes(c)||t.autoResize)&&(o<_&&(e=!0,f.left-=o,o=_),o>q&&(e=!0,f.left-=o-q,o+=q-o));(["left","right"].includes(c)||t.autoResize)&&(h<C&&(e=!0,f.top-=h,h=C),h>b&&(e=!0,f.top-=h-b,h+=b-h));e&&(_=s?"left":"top",q=s?"width":"height",p.offset=-f[_],C=l[q]/2-n,Math.abs(p.offset)>C+n&&(p.class=""),Math.abs(p.offset)>C&&(p.offset=p.offset<0?-C:C),p.style=w2utils.stripSpaces(`#${y.id} .w2ui-overlay-body:after,
                            #${y.id} .w2ui-overlay-body:before {
                                --tip-size: ${n}px;
                                margin-${_}: ${p.offset}px;
                            }`))}v="top"==c?-t.margin:"bottom"==c?t.margin:0,g="left"==c?-t.margin:"right"==c?t.margin:0;return h=Math.floor(100*(h+parseFloat(t.offsetY)+parseInt(v)))/100,{left:o=Math.floor(100*(o+parseFloat(t.offsetX)+parseInt(g)))/100,top:h,arrow:p,adjust:f,width:d,height:u,pos:c}}}}class ColorTooltip extends Tooltip{constructor(){super(),this.palette=[["000000","333333","555555","777777","888888","999999","AAAAAA","CCCCCC","DDDDDD","EEEEEE","F7F7F7","FFFFFF"],["FF011B","FF9838","FFC300","FFFD59","86FF14","14FF7A","2EFFFC","2693FF","006CE7","9B24F4","FF21F5","FF0099"],["FFEAEA","FCEFE1","FCF4DC","FFFECF","EBFFD9","D9FFE9","E0FFFF","E8F4FF","ECF4FC","EAE6F4","FFF5FE","FCF0F7"],["F4CCCC","FCE5CD","FFF1C2","FFFDA1","D5FCB1","B5F7D0","BFFFFF","D6ECFF","CFE2F3","D9D1E9","FFE3FD","FFD9F0"],["EA9899","F9CB9C","FFE48C","F7F56F","B9F77E","84F0B1","83F7F7","B5DAFF","9FC5E8","B4A7D6","FAB9F6","FFADDE"],["E06666","F6B26B","DEB737","E0DE51","8FDB48","52D189","4EDEDB","76ACE3","6FA8DC","8E7CC3","E07EDA","F26DBD"],["CC0814","E69138","AB8816","B5B20E","6BAB30","27A85F","1BA8A6","3C81C7","3D85C6","674EA7","A14F9D","BF4990"],["99050C","B45F17","80650E","737103","395E14","10783D","13615E","094785","0A5394","351C75","780172","782C5A"]],this.defaults=w2utils.extend({},this.defaults,{advanced:!1,transparent:!0,position:"top|bottom",class:"w2ui-white",color:"",liveUpdate:!0,arrowSize:12,autoResize:!1,anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change"],onSelect:null,onLiveUpdate:null})}attach(e,t){let i;1==arguments.length&&e.anchor?e=(i=e).anchor:2===arguments.length&&null!=t&&"object"==typeof t&&((i=t).anchor=e);var s=i.hideOn;i=w2utils.extend({},this.defaults,i||{}),s&&(i.hideOn=s),i.style+="; padding: 0;",i.transparent&&"333333"==this.palette[0][1]&&(this.palette[0].splice(1,1),this.palette[0].push("")),i.transparent||"333333"==this.palette[0][1]||(this.palette[0].splice(1,0,"333333"),this.palette[0].pop()),i.color&&(i.color=String(i.color).toUpperCase()),"string"==typeof i.color&&"#"===i.color.substr(0,1)&&(i.color=i.color.substr(1)),this.index=[-1,-1];let l=super.attach(i),r=l.overlay;return r.options.html=this.getColorHTML(r.name,i),r.on("show.attach",e=>{let t=e.detail.overlay;var e=t.anchor,i=t.options;["INPUT","TEXTAREA"].includes(e.tagName)&&!i.color&&e.value&&(t.tmp.initColor=e.value),delete t.newColor}),r.on("show:after.attach",e=>{var t;l.overlay?.box&&(t=query(l.overlay.box).find(".w2ui-eaction"),w2utils.bindEvents(t,this),this.initControls(l.overlay))}),r.on("update:after.attach",e=>{var t;l.overlay?.box&&(t=query(l.overlay.box).find(".w2ui-eaction"),w2utils.bindEvents(t,this),this.initControls(l.overlay))}),r.on("hide.attach",e=>{e=e.detail.overlay;let t=e.anchor;var i=e.newColor??e.options.color??"";["INPUT","TEXTAREA"].includes(t.tagName)&&t.value!=i&&(t.value=i);let s=this.trigger("select",{color:i,target:e.name,overlay:e});!0!==s.isCancelled&&s.finish()}),l.liveUpdate=t=>(r.on("liveUpdate.attach",e=>{t(e)}),l),l.select=t=>(r.on("select.attach",e=>{t(e)}),l),l}select(e,t){let i,s=(this.index=[-1,-1],"string"!=typeof t&&(i=t.target,this.index=query(i).attr("index").split(":"),t=query(i).closest(".w2ui-overlay").attr("name")),this.get(t)),l=this.trigger("liveUpdate",{color:e,target:t,overlay:s,param:arguments[1]});!0!==l.isCancelled&&(["INPUT","TEXTAREA"].includes(s.anchor.tagName)&&s.options.liveUpdate&&query(s.anchor).val(e),s.newColor=e,query(s.box).find(".w2ui-selected").removeClass("w2ui-selected"),i&&query(i).addClass("w2ui-selected"),l.finish())}nextColor(e){var t=this.palette;switch(e){case"up":index[0]--;break;case"down":index[0]++;break;case"right":index[1]++;break;case"left":index[1]--}return index[0]<0&&(index[0]=0),index[0]>t.length-2&&(index[0]=t.length-2),index[1]<0&&(index[1]=0),index[1]>t[0].length-1&&(index[1]=t[0].length-1),t[index[0]][index[1]]}tabClick(e,t){"string"!=typeof t&&(t=query(t.target).closest(".w2ui-overlay").attr("name"));var t=this.get(t),i=query(t.box).find(`.w2ui-color-tab:nth-child(${e})`);query(t.box).find(".w2ui-color-tab").removeClass("w2ui-selected"),query(i).addClass("w2ui-selected"),query(t.box).find(".w2ui-tab-content").hide().closest(".w2ui-colors").find(".tab-"+e).show()}getColorHTML(s,l){let r=`
            <div class="w2ui-colors">
                <div class="w2ui-tab-content tab-1">`;for(let i=0;i<this.palette.length;i++){r+='<div class="w2ui-color-row">';for(let t=0;t<this.palette[i].length;t++){var n=this.palette[i][t];let e="FFFFFF"===n?"; border: 1px solid #efefef":"";r+=`
                    <div class="w2ui-color w2ui-eaction ${""===n?"w2ui-no-color":""} ${l.color==n?"w2ui-selected":""}"
                        style="background-color: #${n+e};" name="${n}" index="${i}:${t}"
                        data-mousedown="select|'${n}'|event" data-mouseup="hide|${s}">&nbsp;
                    </div>`}r+="</div>",i<2&&(r+='<div style="height: 8px"></div>')}return r=(r=(r+="</div>")+`
            <div class="w2ui-tab-content tab-2" style="display: none">
                <div class="color-info">
                    <div class="color-preview-bg"><div class="color-preview"></div><div class="color-original"></div></div>
                    <div class="color-part">
                        <span>H</span> <input class="w2ui-input" name="h" maxlength="3" max="360" tabindex="101">
                        <span>R</span> <input class="w2ui-input" name="r" maxlength="3" max="255" tabindex="104">
                    </div>
                    <div class="color-part">
                        <span>S</span> <input class="w2ui-input" name="s" maxlength="3" max="100" tabindex="102">
                        <span>G</span> <input class="w2ui-input" name="g" maxlength="3" max="255" tabindex="105">
                    </div>
                    <div class="color-part">
                        <span>V</span> <input class="w2ui-input" name="v" maxlength="3" max="100" tabindex="103">
                        <span>B</span> <input class="w2ui-input" name="b" maxlength="3" max="255" tabindex="106">
                    </div>
                    <div class="color-part opacity">
                        <span>${w2utils.lang("Opacity")}</span>
                        <input class="w2ui-input" name="a" maxlength="5" max="1" tabindex="107">
                    </div>
                </div>
                <div class="palette" name="palette">
                    <div class="palette-bg"></div>
                    <div class="value1 move-x move-y"></div>
                </div>
                <div class="rainbow" name="rainbow">
                    <div class="value2 move-x"></div>
                </div>
                <div class="alpha" name="alpha">
                    <div class="alpha-bg"></div>
                    <div class="value2 move-x"></div>
                </div>
            </div>`)+`
            <div class="w2ui-color-tabs">
                <div class="w2ui-color-tab selected w2ui-eaction" data-click="tabClick|1|event|this"><span class="w2ui-icon w2ui-icon-colors"></span></div>
                <div class="w2ui-color-tab w2ui-eaction" data-click="tabClick|2|event|this"><span class="w2ui-icon w2ui-icon-settings"></span></div>
                <div style="padding: 5px; width: 100%; text-align: right;">
                    ${"string"==typeof l.html?l.html:""}
                </div>
            </div>`}initControls(r){let n,a=this;var e=r.options;let o=w2utils.parseColor(e.color||r.tmp.initColor),h=(null==o&&(o={r:140,g:150,b:160,a:1}),w2utils.rgb2hsv(o));!0===e.advanced&&this.tabClick(2,r.name),d(h,!0,!0),query(r.box).find("input").off(".w2color").on("change.w2color",e=>{let t=query(e.target),i=parseFloat(t.val());e=parseFloat(t.attr("max")),isNaN(i)&&(i=0,t.val(0)),1<e&&(i=parseInt(i)),0<e&&i>e&&(t.val(e),i=e),i<0&&(t.val(0),i=0),e=t.attr("name");let s={};-1!==["r","g","b","a"].indexOf(e)?(o[e]=i,h=w2utils.rgb2hsv(o)):-1!==["h","s","v"].indexOf(e)&&(s[e]=i),d(s,!0)}),query(r.box).find(".color-original").off(".w2color").on("click.w2color",e=>{e=w2utils.parseColor(query(e.target).css("background-color"));null!=e&&(o=e,d(h=w2utils.rgb2hsv(o),!0))});e=`${w2utils.isIOS?"touchstart":"mousedown"}.w2color`;let s=`${w2utils.isIOS?"touchend":"mouseup"}.w2color`,l=`${w2utils.isIOS?"touchmove":"mousemove"}.w2color`;function d(e,t,i){null!=e.h&&(h.h=e.h),null!=e.s&&(h.s=e.s),null!=e.v&&(h.v=e.v),null!=e.a&&(o.a=e.a,h.a=e.a);let s="rgba("+(o=w2utils.hsv2rgb(h)).r+","+o.g+","+o.b+","+o.a+")",l=[Number(o.r).toString(16).toUpperCase(),Number(o.g).toString(16).toUpperCase(),Number(o.b).toString(16).toUpperCase(),Math.round(255*Number(o.a)).toString(16).toUpperCase()];if(l.forEach((e,t)=>{1===e.length&&(l[t]="0"+e)}),s=l[0]+l[1]+l[2]+l[3],1===o.a&&(s=l[0]+l[1]+l[2]),query(r.box).find(".color-preview").css("background-color","#"+s),query(r.box).find("input").each(e=>{e.name&&(null!=o[e.name]&&(e.value=o[e.name]),null!=h[e.name]&&(e.value=h[e.name]),"a"===e.name&&(e.value=o.a))}),i?(e=r.tmp?.initColor||s,query(r.box).find(".color-original").css("background-color","#"+e),query(r.box).find(".w2ui-colors .w2ui-selected").removeClass("w2ui-selected"),query(r.box).find(`.w2ui-colors [name="${e}"]`).addClass("w2ui-selected"),8==s.length&&a.tabClick(2,r.name)):a.select(s,r.name),t){{let e=query(r.box).find(".palette .value1"),t=query(r.box).find(".rainbow .value2"),i=query(r.box).find(".alpha .value2"),s=parseInt(e[0].clientWidth)/2,l=parseInt(t[0].clientWidth)/2;e.css({left:150*h.s/100-s+"px",top:125*(100-h.v)/100-s+"px"}),t.css("left",h.h/2.4-l+"px"),i.css("left",150*o.a-l+"px")}u()}}function u(){var e=w2utils.hsv2rgb(h.h,100,100),e=`${e.r},${e.g},`+e.b;query(r.box).find(".palette").css("background-image",`linear-gradient(90deg, rgba(${e},0) 0%, rgba(${e},1) 100%)`)}function c(e){query("body").off(".w2color")}function p(e){let t=n.el;var i=e.pageX-n.x,e=e.pageY-n.y;let s=n.left+i,l=n.top+e;var i=parseInt(t.prop("clientWidth"))/2,e=(s<-i&&(s=-i),l<-i&&(l=-i),s>n.width-i&&(s=n.width-i),l>n.height-i&&(l=n.height-i),t.hasClass("move-x")&&t.css({left:s+"px"}),t.hasClass("move-y")&&t.css({top:l+"px"}),query(t.get(0).parentNode).attr("name")),r=parseInt(t.css("left"))+i,i=parseInt(t.css("top"))+i;"palette"===e&&d({s:Math.round(r/n.width*100),v:Math.round(100-i/n.height*100)}),"rainbow"===e&&(d({h:Math.round(2.4*r)}),u()),"alpha"===e&&d({a:parseFloat(Number(r/150).toFixed(2))})}query(r.box).find(".palette, .rainbow, .alpha").off(".w2color").on(e+".w2color",function(e){let t=query(this).find(".value1, .value2"),i=parseInt(t.prop("clientWidth"))/2;t.hasClass("move-x")&&t.css({left:e.offsetX-i+"px"});t.hasClass("move-y")&&t.css({top:e.offsetY-i+"px"});n={el:t,x:e.pageX,y:e.pageY,width:t.prop("parentNode").clientWidth,height:t.prop("parentNode").clientHeight,left:parseInt(t.css("left")),top:parseInt(t.css("top"))},p(e),query("body").off(".w2color").on(l,p).on(s,c)})}}class MenuTooltip extends Tooltip{constructor(){super(),this.defaults=w2utils.extend({},this.defaults,{type:"normal",items:[],index:null,render:null,spinner:!1,msgNoItems:w2utils.lang("No items found"),topHTML:"",menuStyle:"",filter:!1,markSearch:!1,match:"contains",search:!1,altRows:!1,arrowSize:10,align:"left",position:"bottom|top",class:"w2ui-white",anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change","select"],onSelect:null,onSubMenu:null,onRemove:null})}attach(e,t){let i;1==arguments.length&&e.anchor?e=(i=e).anchor:2===arguments.length&&null!=t&&"object"==typeof t&&((i=t).anchor=e);var s=i.hideOn;i=w2utils.extend({},this.defaults,i||{}),s&&(i.hideOn=s),i.style+="; padding: 0;",null==i.items&&(i.items=[]),i.html=this.getMenuHTML(i);let l=super.attach(i),r=l.overlay;return r.on("show:after.attach, update:after.attach",e=>{if(l.overlay?.box){let e="";r.selected=null,r.options.items=w2utils.normMenu(r.options.items),["INPUT","TEXTAREA"].includes(r.anchor.tagName)&&(e=r.anchor.value,r.selected=r.anchor.dataset.selectedIndex);var t=query(l.overlay.box).find(".w2ui-eaction"),t=(w2utils.bindEvents(t,this),this.applyFilter(r.name,null,e));r.tmp.searchCount=t,r.tmp.search=e,this.refreshSearch(r.name),this.initControls(l.overlay),this.refreshIndex(r.name)}}),r.on("hide:after.attach",e=>{w2tooltip.hide(r.name+"-tooltip")}),l.select=t=>(r.on("select.attach",e=>{t(e)}),l),l.remove=t=>(r.on("remove.attach",e=>{t(e)}),l),l.subMenu=t=>(r.on("subMenu.attach",e=>{t(e)}),l),l}initControls(i){query(i.box).find(".w2ui-menu:not(.w2ui-sub-menu)").off(".w2menu").on("mouseDown.w2menu",{delegate:".w2ui-menu-item"},e=>{var t=e.delegate.dataset;this.menuDown(i,e,t.index,t.parents)}).on((w2utils.isIOS?"touchStart":"click")+".w2menu",{delegate:".w2ui-menu-item"},e=>{var t=e.delegate.dataset;this.menuClick(i,e,parseInt(t.index),t.parents)}).find(".w2ui-menu-item").off(".w2menu").on("mouseEnter.w2menu",e=>{var t=e.target.dataset,t=i.options.items[t.index]?.tooltip;t&&w2tooltip.show({name:i.name+"-tooltip",anchor:e.target,html:t,position:"right|left",hideOn:["doc-click"]})}).on("mouseLeave.w2menu",e=>{w2tooltip.hide(i.name+"-tooltip")}),["INPUT","TEXTAREA"].includes(i.anchor.tagName)&&query(i.anchor).off(".w2menu").on("input.w2menu",e=>{}).on("keyup.w2menu",e=>{e._searchType="filter",this.keyUp(i,e)}),i.options.search&&query(i.box).find("#menu-search").off(".w2menu").on("keyup.w2menu",e=>{e._searchType="search",this.keyUp(i,e)})}getCurrent(e,t){let i=Tooltip.active[e.replace(/[\s\.#]/g,"_")];e=i.options;let s=(t||(i.selected??"")).split("-");t=s.length-1;let l=s[t];var r=s.slice(0,s.length-1).join("-");l=w2utils.isInt(l)?parseInt(l):0;let n=e.items;return s.forEach((e,t)=>{t<s.length-1&&(n=n[e].items)}),{last:t,index:l,items:n,item:n[l],parents:r}}getMenuHTML(h,t,d,u){if(h.spinner)return`
            <div class="w2ui-menu">
                <div class="w2ui-no-items">
                    <div class="w2ui-spinner"></div>
                    ${w2utils.lang("Loading...")}
                </div>
            </div>`;u=u||[],null==t&&(t=h.items),Array.isArray(t)||(t=[]);let c=0,i=null,e="",p=(!d&&h.search&&(e+=`
                <div class="w2ui-menu-search">
                    <span class="w2ui-icon w2ui-icon-search"></span>
                    <input id="menu-search" class="w2ui-input" type="text"/>
                </div>`,t.forEach(e=>e.hidden=!1)),!d&&h.topHTML&&(e+=`<div class="w2ui-menu-top">${h.topHTML}</div>`),`
            ${e}
            <div class="w2ui-menu ${d?"w2ui-sub-menu":""}" ${d?"":`style="${h.menuStyle}"`}
                data-parent="${u}">
        `);return t.forEach((n,a)=>{i=n.icon;var o=(0<u.length?u.join("-")+"-":"")+a;if(null==i&&(i=null),-1==["radio","check"].indexOf(h.type)||Array.isArray(n.items)||!1===n.group||(i=!0===n.checked?"w2ui-icon-check":"w2ui-icon-empty"),!0!==n.hidden){let s=n.text,l="",r="";if("function"==typeof(s="function"==typeof h.render?h.render(n,h):s)&&(s=s(n,h)),i&&(l='<div class="menu-icon"><span class="w2ui-icon '+i+'"></span></div>'),"break"!==n.type&&null!=s&&""!==s&&"--"!=String(s).substr(0,2)){let e=["w2ui-menu-item"],t=(1==h.altRows&&e.push(c%2==0?"w2ui-even":"w2ui-odd"),1),i=(""===l&&t++,null==n.count&&null==n.hotkey&&!0!==n.remove&&null==n.items&&t++,null==n.tooltip&&null!=n.hint&&(n.tooltip=n.hint),"");if(!0===n.remove)i='<span class="remove">x</span>';else if(null!=n.items){let e=[];"function"==typeof n.items?e=n.items(n):Array.isArray(n.items)&&(e=n.items),i="<span></span>",r=`
                            <div class="w2ui-sub-menu-box" style="${n.expanded?"":"display: none"}">
                                ${this.getMenuHTML(h,e,!0,u.concat(a))}
                            </div>`}else null!=n.count&&(i+="<span>"+n.count+"</span>"),null!=n.hotkey&&(i+='<span class="hotkey">'+n.hotkey+"</span>");!0===n.disabled&&e.push("w2ui-disabled"),!0===n._noSearchInside&&e.push("w2ui-no-search-inside"),""!==r&&(e.push("has-sub-menu"),n.expanded?e.push("expanded"):e.push("collapsed")),p+=`
                        <div index="${o}" class="${e.join(" ")}" style="${n.style||""}"
                            data-index="${a}" data-parents="${u.join("-")}">
                                <div style="width: ${(d?20:0)+parseInt(n.indent??0)}px"></div>
                                ${l}
                                <div class="menu-text" colspan="${t}">${w2utils.lang(s)}</div>
                                <div class="menu-extra">${i}</div>
                        </div>
                        `+r,c++}else{var e=(s??"").replace(/^-+/g,"");p+=`
                        <div index="${o}" class="w2ui-menu-divider ${""!=e?"has-text":""}">
                            <div class="line"></div>
                            ${e?`<div class="text">${e}</div>`:""}
                        </div>`}}t[a]=n}),0===c&&h.msgNoItems&&(p+=`
                <div class="w2ui-no-items">
                    ${w2utils.lang(h.msgNoItems)}
                </div>`),p+="</div>"}refreshIndex(t){t=Tooltip.active[t.replace(/[\s\.#]/g,"_")];if(t){t.displayed||this.show(t.name);var i=query(t.box).find(".w2ui-overlay-body").get(0),s=query(t.box).find(".w2ui-menu-search, .w2ui-menu-top").get(0);query(t.box).find(".w2ui-menu-item.w2ui-selected").removeClass("w2ui-selected");let e=query(t.box).find(`.w2ui-menu-item[index="${t.selected}"]`).addClass("w2ui-selected").get(0);e&&(e.offsetTop+e.clientHeight>i.clientHeight+i.scrollTop&&e.scrollIntoView({behavior:"smooth",block:"start",inline:"start"}),e.offsetTop<i.scrollTop+(s?s.clientHeight:0)&&e.scrollIntoView({behavior:"smooth",block:"end",inline:"end"}))}}refreshSearch(i){let s=Tooltip.active[i.replace(/[\s\.#]/g,"_")];s&&(s.displayed||this.show(s.name),query(s.box).find(".w2ui-no-items").hide(),query(s.box).find(".w2ui-menu-item, .w2ui-menu-divider").each(e=>{var t;this.getCurrent(i,e.getAttribute("index")).item.hidden?query(e).hide():((t=s.tmp?.search)&&s.options.markSearch&&w2utils.marker(e,t,{onlyFirst:"begins"==s.options.match}),query(e).show())}),query(s.box).find(".w2ui-sub-menu").each(e=>{var t=query(e).find(".w2ui-menu-item").get().some(e=>"none"!=e.style.display);this.getCurrent(i,e.dataset.parent).item.expanded&&(t?query(e).parent().show():query(e).parent().hide())}),0==s.tmp.searchCount&&(0==query(s.box).find(".w2ui-no-items").length&&query(s.box).find(".w2ui-menu:not(.w2ui-sub-menu)").append(`
                    <div class="w2ui-no-items">
                        ${w2utils.lang(s.options.msgNoItems)}
                    </div>`),query(s.box).find(".w2ui-no-items").show()))}applyFilter(r,e,n){let a=0,t=Tooltip.active[r.replace(/[\s\.#]/g,"_")],o=t.options;if(!1!==o.filter){null==e&&(e=t.options.items),null==n&&(n=["INPUT","TEXTAREA"].includes(t.anchor.tagName)?t.anchor.value:"");let l=[];return o.selected&&(Array.isArray(o.selected)?l=o.selected.map(e=>e?.id??e):o.selected?.id&&(l=[o.selected.id])),e.forEach(t=>{let i="",s="";-1!==["is","begins","begins with"].indexOf(o.match)&&(i="^"),-1!==["is","ends","ends with"].indexOf(o.match)&&(s="$");try{let e=new RegExp(i+n+s,"i");e.test(t.text)||"..."===t.text?t.hidden=!1:t.hidden=!0}catch(e){}var e;o.hideSelected&&l.includes(t.id)&&(t.hidden=!0),Array.isArray(t.items)&&0<t.items.length&&(delete t._noSearchInside,0<(e=this.applyFilter(r,t.items,n))&&(a+=e,t.hidden&&(t._noSearchInside=!0),n&&(t.expanded=!0),t.hidden=!1)),!0!==t.hidden&&a++}),t.tmp.activeChain=this.getActiveChain(r,e),t.selected=null,a}}getActiveChain(i,e,s=[],l=[],t){let r=Tooltip.active[i.replace(/[\s\.#]/g,"_")];return null!=r.tmp.activeChain?r.tmp.activeChain:((e=null==e?r.options.items:e).forEach((e,t)=>{e.hidden||e.disabled||e?.text.startsWith("--")||(l.push(s.concat([t]).join("-")),Array.isArray(e.items)&&0<e.items.length&&e.expanded&&(s.push(t),this.getActiveChain(i,e.items,s,l,!0),s.pop()))}),null==t&&(r.tmp.activeChain=l),l)}menuDown(e,t,i,s){e=e.options;let l=e.items,r=query(t.delegate).find(".w2ui-icon"),n=query(t.target).closest(".w2ui-menu:not(.w2ui-sub-menu)");if("string"==typeof s&&""!==s){let e=s.split("-");e.forEach(e=>{l=l[e].items})}let a=l[i];if(!a.disabled){let l=(i,s)=>{i.forEach((e,t)=>{e.id!=a.id&&(e.group===a.group&&e.checked&&(n.find(`.w2ui-menu-item[index="${(s?s+"-":"")+t}"] .w2ui-icon`).removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),i[t].checked=!1),Array.isArray(e.items)&&l(e.items,t))})};"check"!==e.type&&"radio"!==e.type||!1===a.group||query(t.target).hasClass("remove")||query(t.target).closest(".w2ui-menu-item").hasClass("has-sub-menu")||(a.checked="radio"==e.type||!a.checked,a.checked?("radio"===e.type&&query(t.target).closest(".w2ui-menu").find(".w2ui-icon").removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),"check"===e.type&&null!=a.group&&l(e.items),r.removeClass("w2ui-icon-empty").addClass("w2ui-icon-check")):"check"===e.type&&r.removeClass("w2ui-icon-check").addClass("w2ui-icon-empty")),query(t.target).hasClass("remove")||(n.find(".w2ui-menu-item").removeClass("w2ui-selected"),query(t.delegate).addClass("w2ui-selected"))}}menuClick(t,i,s,l){let r=t.options,n=r.items,a=query(i.delegate).closest(".w2ui-menu-item"),o=!r.hideOn.includes("select");if((i.shiftKey||i.metaKey||i.ctrlKey)&&(o=!0),"string"==typeof l&&""!==l){let e=l.split("-");e.forEach(e=>{n=n[e].items})}else l=null;let h=(n="function"==typeof n?n({overlay:t,index:s,parentIndex:l,event:i}):n)[s];if(!h.disabled||query(i.target).hasClass("remove")){let e;if(query(i.target).hasClass("remove")){if(!0===(e=this.trigger("remove",{originalEvent:i,target:t.name,overlay:t,item:h,index:s,parentIndex:l,el:a[0]})).isCancelled)return;o=!r.hideOn.includes("item-remove"),a.remove()}else if(a.hasClass("has-sub-menu")){if(!0===(e=this.trigger("subMenu",{originalEvent:i,target:t.name,overlay:t,item:h,index:s,parentIndex:l,el:a[0]})).isCancelled)return;o=!0,a.hasClass("expanded")?(h.expanded=!1,a.removeClass("expanded").addClass("collapsed"),query(a.get(0).nextElementSibling).hide()):(h.expanded=!0,a.addClass("expanded").removeClass("collapsed"),query(a.get(0).nextElementSibling).show()),t.selected=parseInt(a.attr("index"))}else{var d=this.findChecked(r.items);if(t.selected=parseInt(a.attr("index")),!0===(e=this.trigger("select",{originalEvent:i,target:t.name,overlay:t,item:h,index:s,parentIndex:l,selected:d,keepOpen:o,el:a[0]})).isCancelled)return;null!=h.keepOpen&&(o=h.keepOpen),["INPUT","TEXTAREA"].includes(t.anchor.tagName)&&(t.anchor.dataset.selected=h.id,t.anchor.dataset.selectedIndex=t.selected)}o||this.hide(t.name),e.finish()}}findChecked(e){let t=[];return e.forEach(e=>{e.checked&&t.push(e),Array.isArray(e.items)&&(t=t.concat(this.findChecked(e.items)))}),t}keyUp(s,l){var e,r=s.options,t=l.target.value;let n=!0,a=!1;switch(l.keyCode){case 8:""!==t||s.displayed||(n=!1);break;case 13:if(!s.displayed||!s.selected)return;var{index:i,parents:o}=this.getCurrent(s.name);l.delegate=query(s.box).find(".w2ui-selected").get(0),this.menuClick(s,l,parseInt(i),o),n=!1;break;case 27:if(n=!1,s.displayed)this.hide(s.name);else{let e=s.anchor;["INPUT","TEXTAREA"].includes(e.tagName)&&(e.value="",delete e.dataset.selected,delete e.dataset.selectedIndex)}break;case 37:{if(!s.displayed)return;let{item:e,index:t,parents:i}=this.getCurrent(s.name);i&&(e=r.items[i],t=parseInt(i),i="",a=!0),Array.isArray(e.items)&&0<e.items.length&&e.expanded&&(l.delegate=query(s.box).find(`.w2ui-menu-item[index="${t}"]`).get(0),s.selected=t,this.menuClick(s,l,parseInt(t),i)),n=!1;break}case 39:if(!s.displayed)return;var{item:i,index:o,parents:h}=this.getCurrent(s.name);Array.isArray(i.items)&&0<i.items.length&&!i.expanded&&(l.delegate=query(s.box).find(".w2ui-selected").get(0),this.menuClick(s,l,parseInt(o),h)),n=!1;break;case 38:{if(!s.displayed)break;let e=this.getActiveChain(s.name);null==s.selected||0==s.selected?.length?s.selected=e[e.length-1]:(-1==(i=e.indexOf(s.selected))&&(s.selected=e[e.length-1]),0<i&&(s.selected=e[i-1])),n=!1,a=!0,l.preventDefault();break}case 40:{if(!s.displayed)break;let e=this.getActiveChain(s.name);null==s.selected||0==s.selected?.length?s.selected=e[0]:(-1==(o=e.indexOf(s.selected))&&(s.selected=e[0]),o<e.length-1&&(s.selected=e[o+1])),n=!1,a=!0,l.preventDefault();break}}n&&s.displayed&&(r.filter&&"filter"==l._searchType||r.search&&"search"==l._searchType)&&(e=this.applyFilter(s.name,null,t),s.tmp.searchCount=e,s.tmp.search=t,0!==e&&this.getActiveChain(s.name).includes(s.selected)||(s.selected=null),this.refreshSearch(s.name)),a&&this.refreshIndex(s.name)}}class DateTooltip extends Tooltip{constructor(){super();let e=new Date;this.daysCount=[31,28,31,30,31,30,31,31,30,31,30,31],this.today=e.getFullYear()+"/"+(Number(e.getMonth())+1)+"/"+e.getDate(),this.defaults=w2utils.extend({},this.defaults,{position:"top|bottom",class:"w2ui-calendar",type:"date",format:"",value:"",start:null,end:null,blockDates:[],blockWeekdays:[],colored:{},arrowSize:12,autoResize:!1,anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change"],onSelect:null})}attach(e,t){let i;1==arguments.length&&e.anchor?e=(i=e).anchor:2===arguments.length&&null!=t&&"object"==typeof t&&((i=t).anchor=e);var s,l=i.hideOn,l=(i=w2utils.extend({},this.defaults,i||{}),l&&(i.hideOn=l),i.format||(l=w2utils.settings.dateFormat,s=w2utils.settings.timeFormat,"date"==i.type?i.format=l:"time"==i.type?i.format=s:i.format=l+"|"+s),"time"==i.type?this.getHourHTML(i):this.getMonthHTML(i));i.style+="; padding: 0;",i.html=l.html;let r=super.attach(i),n=r.overlay;return Object.assign(n.tmp,l),n.on("show.attach",e=>{let t=e.detail.overlay;var e=t.anchor,i=t.options;["INPUT","TEXTAREA"].includes(e.tagName)&&!i.value&&e.value&&(t.tmp.initValue=e.value),delete t.newValue,delete t.newDate}),n.on("show:after.attach",e=>{r.overlay?.box&&this.initControls(r.overlay)}),n.on("update:after.attach",e=>{r.overlay?.box&&this.initControls(r.overlay)}),n.on("hide.attach",e=>{let t=e.detail.overlay,i=t.anchor;if(null!=t.newValue){t.newDate&&(t.newValue=t.newDate+" "+t.newValue),["INPUT","TEXTAREA"].includes(i.tagName)&&i.value!=t.newValue&&(i.value=t.newValue);let e=this.trigger("select",{date:t.newValue,target:t.name,overlay:t});!0!==e.isCancelled&&e.finish()}}),r.select=t=>(n.on("select.attach",e=>{t(e)}),r),r}initControls(r){let n=r.options,t=e=>{let{month:t,year:i}=r.tmp;12<(t+=e)&&(t=1,i++),t<1&&(t=12,i--);e=this.getMonthHTML(n,t,i);Object.assign(r.tmp,e),query(r.box).find(".w2ui-overlay-body").html(e.html),this.initControls(r)},i=(e,t)=>{query(e.target).parent().find(".w2ui-jump-month, .w2ui-jump-year").removeClass("w2ui-selected"),query(e.target).addClass("w2ui-selected");let i=new Date,{jumpMonth:s,jumpYear:l}=r.tmp;t&&(null==l&&(l=i.getFullYear()),null==s&&(s=i.getMonth()+1)),s&&l&&(e=this.getMonthHTML(n,s,l),Object.assign(r.tmp,e),query(r.box).find(".w2ui-overlay-body").html(e.html),r.tmp.jump=!1,this.initControls(r))};query(r.box).find(".w2ui-cal-title").off(".calendar").on("click.calendar",e=>{if(Object.assign(r.tmp,{jumpYear:null,jumpMonth:null}),r.tmp.jump){var{month:t,year:i}=r.tmp,t=this.getMonthHTML(n,t,i);query(r.box).find(".w2ui-overlay-body").html(t.html),r.tmp.jump=!1}else{query(r.box).find(".w2ui-overlay-body .w2ui-cal-days").replace(this.getYearHTML());let e=query(r.box).find(`[name="${r.tmp.year}"]`).get(0);e&&e.scrollIntoView(!0),r.tmp.jump=!0}this.initControls(r),e.stopPropagation()}).find(".w2ui-cal-previous").off(".calendar").on("click.calendar",e=>{t(-1),e.stopPropagation()}).parent().find(".w2ui-cal-next").off(".calendar").on("click.calendar",e=>{t(1),e.stopPropagation()}),query(r.box).find(".w2ui-cal-now").off(".calendar").on("click.calendar",e=>{"datetime"==n.type?r.newDate?r.newValue=w2utils.formatTime(new Date,n.format.split("|")[1]):r.newValue=w2utils.formatDateTime(new Date,n.format):"date"==n.type?r.newValue=w2utils.formatDate(new Date,n.format):"time"==n.type&&(r.newValue=w2utils.formatTime(new Date,n.format)),this.hide(r.name)}),query(r.box).off(".calendar").on("click.calendar",{delegate:".w2ui-day.w2ui-date"},e=>{"datetime"==n.type?(r.newDate=query(e.target).attr("date"),query(r.box).find(".w2ui-overlay-body").html(this.getHourHTML(r.options).html),this.initControls(r)):(r.newValue=query(e.target).attr("date"),this.hide(r.name))}).on("click.calendar",{delegate:".w2ui-jump-month"},e=>{r.tmp.jumpMonth=parseInt(query(e.target).attr("name")),i(e)}).on("dblclick.calendar",{delegate:".w2ui-jump-month"},e=>{r.tmp.jumpMonth=parseInt(query(e.target).attr("name")),i(e,!0)}).on("click.calendar",{delegate:".w2ui-jump-year"},e=>{r.tmp.jumpYear=parseInt(query(e.target).attr("name")),i(e)}).on("dblclick.calendar",{delegate:".w2ui-jump-year"},e=>{r.tmp.jumpYear=parseInt(query(e.target).attr("name")),i(e,!0)}).on("click.calendar",{delegate:".w2ui-time.hour"},e=>{var e=query(e.target).attr("hour");let t=this.str2min(n.value)%60;r.tmp.initValue&&!n.value&&(t=this.str2min(r.tmp.initValue)%60),n.noMinutes?(r.newValue=this.min2str(60*e,n.format),this.hide(r.name)):(r.newValue=e+":"+t,e=this.getMinHTML(e,n).html,query(r.box).find(".w2ui-overlay-body").html(e),this.initControls(r))}).on("click.calendar",{delegate:".w2ui-time.min"},e=>{e=60*Math.floor(this.str2min(r.newValue)/60)+parseInt(query(e.target).attr("min"));r.newValue=this.min2str(e,n.format),this.hide(r.name)})}getMonthHTML(r,n,e){let t=w2utils.settings.fulldays.slice(),i=w2utils.settings.shortdays.slice(),s=("M"!==w2utils.settings.weekStarts&&(t.unshift(t.pop()),i.unshift(i.pop())),new Date);let l="datetime"===r.type?w2utils.isDateTime(r.value,r.format,!0):w2utils.isDate(r.value,r.format,!0);var a=w2utils.formatDate(l);null!=n&&null!=e||(e=(l||s).getFullYear(),n=l?l.getMonth()+1:s.getMonth()+1),12<n&&(n-=12,e++),(n<1||0===n)&&(n+=12,e--),e/4==Math.floor(e/4)?this.daysCount[1]=29:this.daysCount[1]=28,r.current=n+"/"+e;let o=(s=new Date(e,n-1,1)).getDay(),h="";var d=w2utils.settings.weekStarts;for(let e=0;e<i.length;e++){var u="M"==d&&5==e||"M"!=d&&6==e,c="M"==d&&6==e||"M"!=d&&0==e;h+=`<div class="w2ui-day w2ui-weekday ${u?"w2ui-sunday":""} ${c?"w2ui-saturday":""}">${i[e]}</div>`}let p=`
            <div class="w2ui-cal-title">
                <div class="w2ui-cal-previous">
                    <div></div>
                </div>
                <div class="w2ui-cal-next">
                    <div></div>
                </div>
                ${w2utils.settings.fullmonths[n-1]}, ${e}
                <span class="arrow-down"></span>
            </div>
            <div class="w2ui-cal-days">
                ${h}
        `,f=new Date(e+`/${n}/1`);var m=f.getDay();"M"==w2utils.settings.weekStarts&&o--,0<m&&(f=new Date(f.getTime()-864e5*o));for(let e=0;e<42;e++){let e=[];var g=`${f.getFullYear()}/${f.getMonth()+1}/`+f.getDate(),y=(6===f.getDay()&&e.push("w2ui-saturday"),0===f.getDay()&&e.push("w2ui-sunday"),f.getMonth()+1!==n&&e.push("outside"),g==this.today&&e.push("w2ui-today"),f.getDate());let t="",i="",s,l;l="datetime"===r.type?(s=w2utils.formatDateTime(g,r.format),w2utils.formatDate(g,w2utils.settings.dateFormat)):s=w2utils.formatDate(g,r.format),r.colored&&void 0!==r.colored[l]&&(g=r.colored[l].split("|"),i="background-color: "+g[0]+";",t="color: "+g[1]+";"),p+=`<div class="w2ui-day ${this.inRange(s,r,!0)?"w2ui-date "+(l==a?"w2ui-selected":""):"w2ui-blocked"} ${e.join(" ")}"
                       style="${t+i}" date="${l}" data-date="${f.getTime()}">
                            ${y}
                    </div>`,f=new Date(f.getTime()+864e5)}return p+="</div>",r.btnNow&&(m=w2utils.lang("Today"+("datetime"==r.type?" & Now":"")),p+=`<div class="w2ui-cal-now">${m}</div>`),{html:p,month:n,year:e}}getYearHTML(){let t="",i="";for(let e=0;e<w2utils.settings.fullmonths.length;e++)t+=`<div class="w2ui-jump-month" name="${e+1}">${w2utils.settings.shortmonths[e]}</div>`;for(let e=w2utils.settings.dateStartYear;e<=w2utils.settings.dateEndYear;e++)i+=`<div class="w2ui-jump-year" name="${e}">${e}</div>`;return`<div class="w2ui-cal-jump">
            <div id="w2ui-jump-month">${t}</div>
            <div id="w2ui-jump-year">${i}</div>
        </div>`}getHourHTML(l){(l=l??{}).format||(l.format=w2utils.settings.timeFormat);var r=-1<l.format.indexOf("h24"),n=l.value||(l.anchor?l.anchor.value:"");let a=[];for(let s=0;s<24;s++){let e=(12<=s&&!r?s-12:s)+":00"+(r?"":s<12?" am":" pm"),t=(12!=s||r||(e="12:00 pm"),a[Math.floor(s/8)]||(a[Math.floor(s/8)]=""),this.min2str(this.str2min(e))),i=this.min2str(this.str2min(e)+59);"datetime"===l.type&&(h=w2utils.isDateTime(n,l.format,!0),o=l.format.split("|")[0].trim(),t=w2utils.formatDate(h,o)+" "+t,i=w2utils.formatDate(h,o)+" "+i);var o,h=this.inRange(t,l)||this.inRange(i,l);a[Math.floor(s/8)]+=`<span hour="${s}"
                class="hour ${h?"w2ui-time ":"w2ui-blocked"}">${e}</span>`}return{html:`<div class="w2ui-calendar">
            <div class="w2ui-time-title">${w2utils.lang("Select Hour")}</div>
            <div class="w2ui-cal-time">
                <div class="w2ui-cal-column">${a[0]}</div>
                <div class="w2ui-cal-column">${a[1]}</div>
                <div class="w2ui-cal-column">${a[2]}</div>
            </div>
            ${l.btnNow?`<div class="w2ui-cal-now">${w2utils.lang("Now")}</div>`:""}
        </div>`}}getMinHTML(i,s){null==i&&(i=0),(s=s??{}).format||(s.format=w2utils.settings.timeFormat);var l=-1<s.format.indexOf("h24"),r=s.value||(s.anchor?s.anchor.value:"");let n=[];for(let t=0;t<60;t+=5){var a=(12<i&&!l?i-12:i)+":"+(t<10?0:"")+t+" "+(l?"":i<12?"am":"pm");let e=a;var o,h,d=t<20?0:t<40?1:2;n[d]||(n[d]=""),"datetime"===s.type&&(o=w2utils.isDateTime(r,s.format,!0),h=s.format.split("|")[0].trim(),e=w2utils.formatDate(o,h)+" "+e),n[d]+=`<span min="${t}" class="min ${this.inRange(e,s)?"w2ui-time ":"w2ui-blocked"}">${a}</span>`}return{html:`<div class="w2ui-calendar">
            <div class="w2ui-time-title">${w2utils.lang("Select Minute")}</div>
            <div class="w2ui-cal-time">
                <div class="w2ui-cal-column">${n[0]}</div>
                <div class="w2ui-cal-column">${n[1]}</div>
                <div class="w2ui-cal-column">${n[2]}</div>
            </div>
            ${s.btnNow?`<div class="w2ui-cal-now">${w2utils.lang("Now")}</div>`:""}
        </div>`}}inRange(s,l,e){let r=!1;if("date"===l.type){let i=w2utils.isDate(s,l.format,!0);if(i){if(l.start||l.end){var n="string"==typeof l.start?l.start:query(l.start).val(),a="string"==typeof l.end?l.end:query(l.end).val();let e=w2utils.isDate(n,l.format,!0),t=w2utils.isDate(a,l.format,!0);n=new Date(i);e=e||n,t=t||n,n>=e&&n<=t&&(r=!0)}else r=!0;Array.isArray(l.blockDates)&&l.blockDates.includes(s)&&(r=!1),Array.isArray(l.blockWeekdays)&&l.blockWeekdays.includes(i.getDay())&&(r=!1)}}else if("time"===l.type)if(l.start||l.end){a=this.str2min(s);let e=this.str2min(l.start),t=this.str2min(l.end);e=e||a,t=t||a,a>=e&&a<=t&&(r=!0)}else r=!0;else"datetime"!==l.type||(n=w2utils.isDateTime(s,l.format,!0))&&(a=l.format.split("|").map(e=>e.trim()),e?(s=w2utils.formatDate(n,a[0]),e=w2utils.extend({},l,{type:"date",format:a[0]}),this.inRange(s,e)&&(r=!0)):(s=w2utils.formatTime(n,a[1]),e={type:"time",format:a[1],start:l.startTime,end:l.endTime},this.inRange(s,e)&&(r=!0)));return r}str2min(e){if("string"!=typeof e)return null;let t=e.split(":");return 2!==t.length?null:(t[0]=parseInt(t[0]),t[1]=parseInt(t[1]),-1!==e.indexOf("pm")&&12!==t[0]&&(t[0]+=12),e.includes("am")&&12==t[0]&&(t[0]=0),60*t[0]+t[1])}min2str(e,t){let i="";1440<=e&&(e%=1440),e<0&&(e=1440+e);var s=Math.floor(e/60),e=(e%60<10?"0":"")+e%60;return t=t||w2utils.settings.timeFormat,i=-1!==t.indexOf("h24")?s+":"+e:(s<=12?s:s-12)+":"+e+" "+(12<=s?"pm":"am")}}let w2tooltip=new Tooltip,w2menu=new MenuTooltip,w2color=new ColorTooltip,w2date=new DateTooltip;class w2toolbar extends w2base{constructor(e){super(e.name),this.box=null,this.name=null,this.routeData={},this.items=[],this.right="",this.tooltip="top|left",this.onClick=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.item_template={id:null,type:"button",text:null,html:"",tooltip:null,count:null,hidden:!1,disabled:!1,checked:!1,icon:null,route:null,arrow:null,style:null,group:null,items:null,selected:null,color:null,overlay:{anchorClass:""},onClick:null,onRefresh:null},this.last={badge:{}};var t=e.items;delete e.items,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.items=t,"string"==typeof this.box&&(this.box=query(this.box).get(0)),this.box&&this.render(this.box)}add(e){this.insert(null,e)}insert(r,e){(e=Array.isArray(e)?e:[e]).forEach((e,t,i)=>{"string"==typeof e&&(e=i[t]={id:e,text:e});let s=["button","check","radio","drop","menu","menu-radio","menu-check","color","text-color","html","break","spacer","new-line"];if(s.includes(String(e.type)))if(null!=e.id||["break","spacer","new-line"].includes(e.type)){if(null==e.type)console.log('ERROR: The parameter "type" is required but not supplied.',e);else if(w2utils.checkUniqueId(e.id,this.items,"toolbar",this.name)){let s=w2utils.extend({},this.item_template,e);var l;"menu-check"==s.type?(Array.isArray(s.selected)||(s.selected=[]),Array.isArray(s.items)&&s.items.forEach(e=>{(e="string"==typeof e?i[t]={id:e,text:e}:e).checked&&!s.selected.includes(e.id)&&s.selected.push(e.id),!e.checked&&s.selected.includes(e.id)&&(e.checked=!0),null==e.checked&&(e.checked=!1)})):"menu-radio"==s.type&&Array.isArray(s.items)&&s.items.forEach((e,t,i)=>{(e="string"==typeof e?i[t]={id:e,text:e}:e).checked&&null==s.selected?s.selected=e.id:e.checked=!1,e.checked||s.selected!=e.id||(e.checked=!0),null==e.checked&&(e.checked=!1)}),null==r?this.items.push(s):(l=this.get(r,!0),this.items=this.items.slice(0,l).concat([s],this.items.slice(l))),s.line=s.line||1,this.refresh(s.id)}}else console.log('ERROR: The parameter "id" is required but not supplied.',e);else console.log('ERROR: The parameter "type" should be one of the following:',s,`, but ${e.type} is supplied.`,e)}),this.resize()}remove(){let i=0;return Array.from(arguments).forEach(e=>{var t=this.get(e);t&&-1==String(e).indexOf(":")&&(i++,query(this.box).find("#tb_"+this.name+"_item_"+w2utils.escapeId(t.id)).remove(),null!=(e=this.get(t.id,!0))&&this.items.splice(e,1))}),this.resize(),i}set(e,t){var i=this.get(e);return null!=i&&(Object.assign(i,t),this.refresh(String(e).split(":")[0]),!0)}get(e,i){if(0===arguments.length){let t=[];for(let e=0;e<this.items.length;e++)null!=this.items[e].id&&t.push(this.items[e].id);return t}var s=String(e).split(":");for(let e=0;e<this.items.length;e++){var t=this.items[e];if(["menu","menu-radio","menu-check"].includes(t.type)&&2==s.length&&t.id==s[0]){let e=t.items;"function"==typeof e&&(e=e(this));for(let t=0;t<e.length;t++){var l=e[t];if(l.id==s[1]||null==l.id&&l.text==s[1])return 1==i?t:l;if(Array.isArray(l.items))for(let e=0;e<l.items.length;e++)if(l.items[e].id==s[1]||null==l.items[e].id&&l.items[e].text==s[1])return 1==i?t:l.items[e]}}else if(t.id==s[0])return 1==i?e:t}return null}setCount(t,i,s,l){let r=query(this.box).find(`#tb_${this.name}_item_${w2utils.escapeId(t)} .w2ui-tb-count > span`);if(0<r.length){r.removeClass().addClass(s||"").text(i).get(0).style.cssText=l||"",this.last.badge[t]={className:s||"",style:l||""};let e=this.get(t);e.count=i}else this.set(t,{count:i}),this.setCount(...arguments)}show(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.hidden=!1,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.resize()})},15),i}hide(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.hidden=!0,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.tooltipHide(e),this.resize()})},15),i}enable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.disabled=!1,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}disable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.disabled=!0,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.tooltipHide(e)})},15),i}check(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&-1==String(e).indexOf(":")&&(t.checked=!0,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}uncheck(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&-1==String(e).indexOf(":")&&(["menu","menu-radio","menu-check","drop","color","text-color"].includes(t.type)&&t.checked&&w2tooltip.hide(this.name+"-drop"),t.checked=!1,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}click(t,i){var e=String(t).split(":");let l=this.get(e[0]),r=l&&l.items?w2utils.normMenu.call(this,l.items,l):[];if(1<e.length)(e=this.get(t))&&!e.disabled&&this.menuClick({name:this.name,item:l,subItem:e,originalEvent:i});else if(l&&!l.disabled){let e=this.trigger("click",{target:null!=t?t:this.name,item:l,object:l,originalEvent:i});if(!0!==e.isCancelled){r=l&&l.items?w2utils.normMenu.call(this,l.items,l):[];let s="#tb_"+this.name+"_item_"+w2utils.escapeId(l.id);if(query(this.box).find(s).removeClass("down"),"radio"==l.type){for(let t=0;t<this.items.length;t++){let e=this.items[t];null!=e&&e.id!=l.id&&"radio"===e.type&&e.group==l.group&&e.checked&&(e.checked=!1,this.refresh(e.id))}l.checked=!0,query(this.box).find(s).addClass("checked")}if(["menu","menu-radio","menu-check","drop","color","text-color"].includes(l.type)){if(this.tooltipHide(t),l.checked)return void w2tooltip.hide(this.name+"-drop");setTimeout(()=>{var t=(e,t)=>{let i=this;return function(){i.set(e,{checked:!1})}},i=query(this.box).find("#tb_"+this.name+"_item_"+w2utils.escapeId(l.id));if(w2utils.isPlainObject(l.overlay)||(l.overlay={}),"drop"==l.type&&w2tooltip.show(w2utils.extend({html:l.html,class:"w2ui-white",hideOn:["doc-click"]},l.overlay,{anchor:i[0],name:this.name+"-drop",data:{item:l,btn:s}})).hide(t(l.id,s)),["menu","menu-radio","menu-check"].includes(l.type)){let e="normal";"menu-radio"==l.type&&(e="radio",r.forEach(e=>{l.selected==e.id?e.checked=!0:e.checked=!1})),"menu-check"==l.type&&(e="check",r.forEach(e=>{Array.isArray(l.selected)&&l.selected.includes(e.id)?e.checked=!0:e.checked=!1})),w2menu.show(w2utils.extend({items:r},l.overlay,{type:e,name:this.name+"-drop",anchor:i[0],data:{item:l,btn:s}})).hide(t(l.id,s)).remove(e=>{this.menuClick({name:this.name,remove:!0,item:l,subItem:e.detail.item,originalEvent:e})}).select(e=>{this.menuClick({name:this.name,item:l,subItem:e.detail.item,originalEvent:e})})}["color","text-color"].includes(l.type)&&w2color.show(w2utils.extend({color:l.color},l.overlay,{anchor:i[0],name:this.name+"-drop",data:{item:l,btn:s}})).hide(t(l.id,s)).select(e=>{null!=e.detail.color&&this.colorClick({name:this.name,item:l,color:e.detail.color})})},0)}if(["check","menu","menu-radio","menu-check","drop","color","text-color"].includes(l.type)&&(l.checked=!l.checked,l.checked?query(this.box).find(s).addClass("checked"):query(this.box).find(s).removeClass("checked")),l.route){let t=String("/"+l.route).replace(/\/{2,}/g,"/");var n=w2utils.parseRoute(t);if(0<n.keys.length)for(let e=0;e<n.keys.length;e++)t=t.replace(new RegExp(":"+n.keys[e].name,"g"),this.routeData[n.keys[e].name]);setTimeout(()=>{window.location.hash=t},1)}this.tooltipShow(t),e.finish()}}}scroll(a,o,h){return new Promise((e,t)=>{let i=query(this.box).find(`.w2ui-tb-line:nth-child(${o}) .w2ui-scroll-wrapper`);var s=i.get(0).scrollLeft,l=i.find(".w2ui-tb-right").get(0),r=i.parent().get(0).getBoundingClientRect().width,n=s+parseInt(l.offsetLeft)+parseInt(l.clientWidth);switch(a){case"left":(scroll=s-r+50)<=0&&(scroll=0),i.get(0).scrollTo({top:0,left:scroll,behavior:h?"atuo":"smooth"});break;case"right":(scroll=s+r-50)>=n-r&&(scroll=n-r),i.get(0).scrollTo({top:0,left:scroll,behavior:h?"atuo":"smooth"})}setTimeout(()=>{this.resize(),e()},h?0:500)})}render(e){var t=Date.now();"string"==typeof e&&(e=query(e).get(0));let l=this.trigger("render",{target:this.name,box:e??this.box});if(!0!==l.isCancelled&&(null!=e&&(0<query(this.box).find(".w2ui-scroll-wrapper .w2ui-tb-right").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-toolbar").html(""),this.box=e),this.box)){Array.isArray(this.right)||(this.right=[this.right]);let i="",s=0;for(let t=0;t<this.items.length;t++){let e=this.items[t];null!=e&&(null==e.id&&(e.id="item_"+t),null!=e.caption&&console.log("NOTICE: toolbar item.caption property is deprecated, please use item.text. Item -> ",e),null!=e.hint&&console.log("NOTICE: toolbar item.hint property is deprecated, please use item.tooltip. Item -> ",e),0!==t&&"new-line"!=e.type||(s++,i+=`
                    <div class="w2ui-tb-line">
                        <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">
                            <div class="w2ui-tb-right">${this.right[s-1]||""}</div>
                        </div>
                        <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll", "left", "${s}"]'></div>
                        <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll", "right", "${s}"]'></div>
                    </div>
                `),e.line=s)}return query(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-toolbar").html(i),0<query(this.box).length&&(query(this.box)[0].style.cssText+=this.style),w2utils.bindEvents(query(this.box).find(".w2ui-tb-line .w2ui-eaction"),this),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),this.refresh(),this.resize(),l.finish(),Date.now()-t}}refresh(t){var i=Date.now();let l=this.trigger("refresh",{target:null!=t?t:this.name,item:this.get(t)});if(!0!==l.isCancelled){let e;if(null==t)for(let t=0;t<this.items.length;t++){let e=this.items[t];null==e.id&&(e.id="item_"+t),this.refresh(e.id)}else{var r=this.get(t);if(null==r)return!1;if("function"!=typeof r.onRefresh||!0!==(e=this.trigger("refresh",{target:t,item:r,object:r})).isCancelled){var n=`#tb_${this.name}_item_`+w2utils.escapeId(r.id);let s=query(this.box).find(n);var a=this.getItemHTML(r);if(this.tooltipHide(t),"spacer"==r.type&&query(this.box).find(".w2ui-tb-line:nth-child("+r.line).find(".w2ui-tb-right").css("width","auto"),0===s.length){t=parseInt(this.get(t,!0))+1;let e=query(this.box).find(`#tb_${this.name}_item_`+w2utils.escapeId(this.items[t]?this.items[t].id:""));0==e.length?e=query(this.box).find(".w2ui-tb-line:nth-child("+r.line).find(".w2ui-tb-right").before(a):e.after(a),w2utils.bindEvents(query(this.box).find(n),this)}else{query(this.box).find(n).replace(query.html(a));let t=query(this.box).find(n).get(0),i=(w2utils.bindEvents(t,this),w2tooltip.get(!0));Object.keys(i).forEach(e=>{i[e].anchor==s.get(0)&&(i[e].anchor=t)})}return"function"==typeof r.onRefresh&&e.finish(),l.finish(),Date.now()-i}}}}resize(){var e=Date.now();let t=this.trigger("resize",{target:this.name});if(!0!==t.isCancelled)return query(this.box).find(".w2ui-tb-line").each(e=>{let t=query(e);t.find(".w2ui-scroll-left, .w2ui-scroll-right").hide();var e=t.find(".w2ui-scroll-wrapper").get(0),i=t.find(".w2ui-tb-right"),s=t.get(0).getBoundingClientRect().width,i=0<i.length?i[0].offsetLeft+i[0].clientWidth:0;s<i&&(0<e.scrollLeft&&t.find(".w2ui-scroll-left").show(),s<i-e.scrollLeft&&t.find(".w2ui-scroll-right").show())}),t.finish(),Date.now()-e}destroy(){let e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<query(this.box).find(".w2ui-scroll-wrapper  .w2ui-tb-right").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-toolbar").html(""),query(this.box).html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],e.finish())}getItemHTML(i){let e="",t=(null!=i.caption&&null==i.text&&(i.text=i.caption),null==i.text&&(i.text=""),null==i.tooltip&&null!=i.hint&&(i.tooltip=i.hint),null==i.tooltip&&(i.tooltip=""),"function"==typeof i.get||!Array.isArray(i.items)&&"function"!=typeof i.items||(i.get=function(t){let e=i.items;return(e="function"==typeof e?i.items(i):e).find(e=>e.id==t)}),""),s="function"==typeof i.text?i.text.call(this,i):i.text,l=(i.icon&&(t=i.icon,"function"==typeof i.icon&&(t=i.icon.call(this,i)),t=`<div class="w2ui-tb-icon">${t="<"!==String(t).slice(0,1)?`<span class="${t}"></span>`:t}</div>`),["w2ui-tb-button"]);switch(i.checked&&l.push("checked"),i.disabled&&l.push("disabled"),i.hidden&&l.push("hidden"),t||l.push("no-icon"),i.type){case"color":case"text-color":"string"==typeof i.color&&("#"==i.color.slice(0,1)&&(i.color=i.color.slice(1)),[3,6,8].includes(i.color.length)&&(i.color="#"+i.color)),"color"==i.type&&(s=`<span class="w2ui-tb-color-box" style="background-color: ${null!=i.color?i.color:"#fff"}"></span>
                           `+(i.text?`<div style="margin-left: 17px;">${w2utils.lang(i.text)}</div>`:"")),"text-color"==i.type&&(s='<span style="color: '+(null!=i.color?i.color:"#444")+';">'+(i.text?w2utils.lang(i.text):"<b>Aa</b>")+"</span>");case"menu":case"menu-check":case"menu-radio":case"button":case"check":case"radio":case"drop":var r=!0===i.arrow||!1!==i.arrow&&["menu","menu-radio","menu-check","drop","color","text-color"].includes(i.type);e=`
                    <div id="tb_${this.name}_item_${i.id}" style="${i.hidden?"display: none":""}"
                        class="${l.join(" ")} ${i.class||""}"
                        ${i.disabled?"":`data-click='["click","${i.id}"]'
                               data-mouseenter='["mouseAction", "event", "this", "enter", "${i.id}"]'
                               data-mouseleave='["mouseAction", "event", "this", "leave", "${i.id}"]'
                               data-mousedown='["mouseAction", "event", "this", "down", "${i.id}"]'
                               data-mouseup='["mouseAction", "event", "this", "up", "${i.id}"]'`}
                    >
                        ${t}
                        ${""!=s?`<div class="w2ui-tb-text" style="${i.style||""}">
                                    ${w2utils.lang(s)}
                                    ${null!=i.count?w2utils.stripSpaces(`<span class="w2ui-tb-count">
                                                <span class="${this.last.badge[i.id]&&this.last.badge[i.id].className||""}"
                                                    style="${this.last.badge[i.id]&&this.last.badge[i.id].style||""}"
                                                >${i.count}</span>
                                           </span>`):""}
                                    ${r?'<span class="w2ui-tb-down"><span></span></span>':""}
                                </div>`:""}
                    </div>
                `;break;case"break":e=`<div id="tb_${this.name}_item_${i.id}" class="w2ui-tb-break"
                            style="${i.hidden?"display: none":""}; ${i.style||""}">
                            &#160;
                        </div>`;break;case"spacer":e=`<div id="tb_${this.name}_item_${i.id}" class="w2ui-tb-spacer"
                            style="${i.hidden?"display: none":""}; ${i.style||""}">
                        </div>`;break;case"html":e=`<div id="tb_${this.name}_item_${i.id}" class="w2ui-tb-html ${l.join(" ")}"
                            style="${i.hidden?"display: none":""}; ${i.style||""}">
                            ${"function"==typeof i.html?i.html.call(this,i):i.html}
                        </div>`}return e}tooltipShow(t){if(null!=this.tooltip){var i=query(this.box).find("#tb_"+this.name+"_item_"+w2utils.escapeId(t)).get(0),t=this.get(t),s=this.tooltip;let e=t.tooltip;"function"==typeof e&&(e=e.call(this,t)),["menu","menu-radio","menu-check","drop","color","text-color"].includes(t.type)&&1==t.checked||w2tooltip.show({anchor:i,name:this.name+"-tooltip",html:e,position:s})}}tooltipHide(e){null!=this.tooltip&&w2tooltip.hide(this.name+"-tooltip")}menuClick(i){if(i.item&&!i.item.disabled){let t=this.trigger(!0!==i.remove?"click":"remove",{target:i.item.id+":"+i.subItem.id,item:i.item,subItem:i.subItem,originalEvent:i.originalEvent});if(!0!==t.isCancelled){let l=i.subItem,r=this.get(i.item.id),e=r.items;if("function"==typeof e&&(e=r.items()),"menu"==r.type&&(r.selected=l.id),"menu-radio"==r.type&&(r.selected=l.id,Array.isArray(e)&&e.forEach(e=>{!0===e.checked&&delete e.checked,Array.isArray(e.items)&&e.items.forEach(e=>{!0===e.checked&&delete e.checked})}),l.checked=!0),"menu-check"==r.type)if(Array.isArray(r.selected)||(r.selected=[]),null==l.group){var s=r.selected.indexOf(l.id);-1==s?(r.selected.push(l.id),l.checked=!0):(r.selected.splice(s,1),l.checked=!1)}else if(!1!==l.group){let s=[];!function i(e){e.forEach(e=>{var t;e.group===l.group&&-1!=(t=r.selected.indexOf(e.id))&&(e.id!=l.id&&s.push(e.id),r.selected.splice(t,1)),Array.isArray(e.items)&&i(e.items)})}(e),-1==r.selected.indexOf(l.id)&&(r.selected.push(l.id),l.checked=!0)}if("string"==typeof l.route){let t=""!==l.route?String("/"+l.route).replace(/\/{2,}/g,"/"):"";var n=w2utils.parseRoute(t);if(0<n.keys.length)for(let e=0;e<n.keys.length;e++)null!=this.routeData[n.keys[e].name]&&(t=t.replace(new RegExp(":"+n.keys[e].name,"g"),this.routeData[n.keys[e].name]));setTimeout(()=>{window.location.hash=t},1)}this.refresh(i.item.id),t.finish()}}}colorClick(t){if(t.item&&!t.item.disabled){let e=this.trigger("click",{target:t.item.id,item:t.item,color:t.color,final:t.final,originalEvent:t.originalEvent});!0!==e.isCancelled&&(t.item.color=t.color,this.refresh(t.item.id),e.finish())}}mouseAction(e,t,i,s){var l=this.get(s);if(!l.disabled&&!l.hidden)switch(i){case"enter":query(t).addClass("over"),this.tooltipShow(s);break;case"leave":query(t).removeClass("over down"),this.tooltipHide(s);break;case"down":query(t).addClass("down");break;case"up":query(t).removeClass("down")}}}class w2sidebar extends w2base{constructor(e){super(e.name),this.name=null,this.box=null,this.sidebar=null,this.parent=null,this.nodes=[],this.menu=[],this.routeData={},this.selected=null,this.icon=null,this.style="",this.topHTML="",this.bottomHTML="",this.flatButton=!1,this.keyboard=!0,this.flat=!1,this.hasFocus=!1,this.levelPadding=12,this.skipRefresh=!1,this.tabIndex=null,this.handle={size:0,style:"",html:"",tooltip:""},this.onClick=null,this.onDblClick=null,this.onContextMenu=null,this.onMenuClick=null,this.onExpand=null,this.onCollapse=null,this.onKeydown=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onFocus=null,this.onBlur=null,this.onFlat=null,this.node_template={id:null,text:"",order:null,count:null,icon:null,nodes:[],style:"",route:null,selected:!1,expanded:!1,hidden:!1,disabled:!1,group:!1,groupShowHide:!0,collapsible:!1,plus:!1,onClick:null,onDblClick:null,onContextMenu:null,onExpand:null,onCollapse:null,parent:null,sidebar:null},this.last={badge:{}};var t=e.nodes;delete e.nodes,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.nodes=t,"string"==typeof this.box&&(this.box=query(this.box).get(0)),this.box&&this.render(this.box)}add(e,t){return 1==arguments.length&&(t=arguments[0],e=this),"string"==typeof e&&(e=this.get(e)),this.insert(e=null!=e&&""!=e?e:this,null,t)}insert(t,i,s){let l,r,n,a,o;if(2==arguments.length&&"string"==typeof t)if(s=arguments[1],null!=(i=arguments[0])){if(null==(r=this.get(i)))return null!=(s=Array.isArray(s)?s:[s])[0].caption&&null==s[0].text&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",s[0]),s[0].text=s[0].caption),l=s[0].text,console.log('ERROR: Cannot insert node "'+l+'" because cannot find node "'+i+'" to insert before.'),null;t=this.get(i).parent}else t=this;null!=(t="string"==typeof t?this.get(t):t)&&""!=t||(t=this),Array.isArray(s)||(s=[s]);for(let e=0;e<s.length;e++)if(null!=(a=s[e]).caption&&null==a.text&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text"),a.text=a.caption),null==typeof a.id)l=a.text,console.log('ERROR: Cannot insert node "'+l+'" because it has no id.');else if(null!=this.get(this,a.id))console.log("ERROR: Cannot insert node with id="+a.id+" (text: "+a.text+") because another node with the same id already exists.");else{if((n=Object.assign({},this.node_template,a)).sidebar=this,n.parent=t,o=n.nodes||[],n.nodes=[],null==i)t.nodes.push(n);else{if(null==(r=this.get(t,i,!0)))return console.log('ERROR: Cannot insert node "'+a.text+'" because cannot find node "'+i+'" to insert before.'),null;t.nodes.splice(r,0,n)}0<o.length&&this.insert(n,null,o)}return this.skipRefresh||this.refresh(t.id),n}remove(){let t=0,i;return Array.from(arguments).forEach(e=>{null!=(i=this.get(e))&&(null!=this.selected&&this.selected===i.id&&(this.selected=null),null!=(e=this.get(i.parent,e,!0))&&(i.parent.nodes[e].selected&&i.sidebar.unselect(i.id),i.parent.nodes.splice(e,1),t++))}),this.skipRefresh||(0<t&&1==arguments.length?this.refresh(i.parent.id):this.refresh()),t}set(t,i,s){if(2==arguments.length&&(s=i,i=t,t=this),null==(t="string"==typeof t?this.get(t):t).nodes)return null;for(let e=0;e<t.nodes.length;e++){var l;if(t.nodes[e].id===i)return l=this.update(i,s),0!=Object.keys(l).length&&(l=s.nodes,w2utils.extend(t.nodes[e],s,{nodes:[]}),null!=l&&this.add(t.nodes[e],l),this.skipRefresh||this.refresh(i)),!0;if(this.set(t.nodes[e],i,s))return!0}return!1}get(t,i,s){if(0===arguments.length){let t=[];var l=this.find({});for(let e=0;e<l.length;e++)null!=l[e].id&&t.push(l[e].id);return t}if((1==arguments.length||2==arguments.length&&!0===i)&&(s=i,i=t,t=this),null==(t="string"==typeof t?this.get(t):t).nodes)return null;for(let e=0;e<t.nodes.length;e++){if(t.nodes[e].id==i)return!0===s?e:t.nodes[e];var r=this.get(t.nodes[e],i,s);if(r||0===r)return r}return null}setCount(t,i,s,l){let r=query(this.box).find(`#node_${w2utils.escapeId(t)} .w2ui-node-count`);if(0<r.length){r.removeClass().addClass("w2ui-node-count "+(s||"")).text(i).get(0).style.cssText=l||"",this.last.badge[t]={className:s||"",style:l||""};let e=this.get(t);e.count=i}else this.set(t,{count:i}),this.setCount(...arguments)}find(i,s,l){if(1==arguments.length&&(s=i,i=this),l=l||[],null==(i="string"==typeof i?this.get(i):i).nodes)return l;for(let t=0;t<i.nodes.length;t++){let e=!0;for(var r in s)i.nodes[t][r]!=s[r]&&(e=!1);e&&l.push(i.nodes[t]),0<i.nodes[t].nodes.length&&(l=this.find(i.nodes[t],s,l))}return l}sort(l,e){null==(l=l&&"object"==typeof l?l:{}).foldersFirst&&(l.foldersFirst=!0),null==l.caseSensitive&&(l.caseSensitive=!1),null==l.reverse&&(l.reverse=!1),(e=null==e?this.nodes:e).sort((i,s)=>{var e=i.nodes&&0<i.nodes.length,t=s.nodes&&0<s.nodes.length;if(!1===l.foldersFirst||!e&&!t||e&&t){let e=i.text,t=s.text;l.caseSensitive||(e=e.toLowerCase(),t=t.toLowerCase()),null!=i.order&&(e=i.order),null!=s.order&&(t=s.order);i=w2utils.naturalCompare(e,t);return(1===i||-1===i)&l.reverse?-i:i}return e&&!t?l.reverse?1:-1:!e&&t?l.reverse?-1:1:void 0}),e.forEach(e=>{e.nodes&&0<e.nodes.length&&this.sort(l,e.nodes)})}each(t,e){(e=null==e?this.nodes:e).forEach(e=>{t.call(this,e),e.nodes&&0<e.nodes.length&&this.each(t,e.nodes)})}search(e){let t=0,i=e.toLowerCase();return this.each(e=>{-1===e.text.toLowerCase().indexOf(i)?e.hidden=!0:(t++,function e(t){t.parent&&(t.parent.hidden=!1,e(t.parent))}(e),e.hidden=!1)}),this.refresh(),t}show(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!1!==t.hidden&&(t.hidden=!1,i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}hide(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!0!==t.hidden&&(t.hidden=!0,i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}enable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!1!==t.disabled&&(t.disabled=!1,i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}disable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!0!==t.disabled&&(t.disabled=!0,t.selected&&this.unselect(t.id),i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}select(e){let t=this.get(e);if(!t)return!1;if(this.selected==e&&t.selected)return!1;this.unselect(this.selected);let i=query(this.box).find("#node_"+w2utils.escapeId(e));return i.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),0<i.length&&(this.inView(e)||this.scrollIntoView(e)),t.selected=!0,this.selected=e,!0}unselect(e){0===arguments.length&&(e=this.selected);let t=this.get(e);return!!t&&(t.selected=!1,query(this.box).find("#node_"+w2utils.escapeId(e)).removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected"),this.selected==e&&(this.selected=null),!0)}toggle(e){var t=this.get(e);return null!=t&&(t.plus?(this.set(e,{plus:!1}),this.expand(e),void this.refresh(e)):0!==t.nodes.length&&(!!t.collapsible&&(this.get(e).expanded?this.collapse(e):this.expand(e))))}collapse(e){let t=this,i=this.get(e);if(null==i)return!1;let s=this.trigger("collapse",{target:e,object:i});return!0!==s.isCancelled?(query(this.box).find("#node_"+w2utils.escapeId(e)+"_sub").hide(),query(this.box).find("#node_"+w2utils.escapeId(e)+" .w2ui-expanded").removeClass("w2ui-expanded").addClass("w2ui-collapsed"),i.expanded=!1,s.finish(),setTimeout(()=>{t.refresh(e)},0),!0):void 0}expand(e){let t=this.get(e),i=this.trigger("expand",{target:e,object:t});if(!0!==i.isCancelled)return query(this.box).find("#node_"+w2utils.escapeId(e)+"_sub").show(),query(this.box).find("#node_"+w2utils.escapeId(e)+" .w2ui-collapsed").removeClass("w2ui-collapsed").addClass("w2ui-expanded"),t.expanded=!0,i.finish(),this.refresh(e),!0}collapseAll(t){if(null==(t="string"==typeof(t=null==t?this:t)?this.get(t):t).nodes)return!1;for(let e=0;e<t.nodes.length;e++)!0===t.nodes[e].expanded&&(t.nodes[e].expanded=!1),t.nodes[e].nodes&&0<t.nodes[e].nodes.length&&this.collapseAll(t.nodes[e]);return this.refresh(t.id),!0}expandAll(t){if(null==(t="string"==typeof(t=null==t?this:t)?this.get(t):t).nodes)return!1;for(let e=0;e<t.nodes.length;e++)!1===t.nodes[e].expanded&&(t.nodes[e].expanded=!0),t.nodes[e].nodes&&0<t.nodes[e].nodes.length&&this.expandAll(t.nodes[e]);this.refresh(t.id)}expandParents(e){let t=this.get(e);return null!=t&&(t.parent&&(t.parent.expanded||(t.parent.expanded=!0,this.refresh(t.parent.id)),this.expandParents(t.parent.id)),!0)}click(l,r){let n=this,a=this.get(l);if(null!=a&&!a.disabled&&!a.group){query(n.box).find(".w2ui-node.w2ui-selected").each(e=>{var t=query(e).attr("id").replace("node_","");let i=n.get(t);null!=i&&(i.selected=!1),query(e).removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected")});let t=query(n.box).find("#node_"+w2utils.escapeId(l)),s=query(n.box).find("#node_"+w2utils.escapeId(n.selected));t.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),setTimeout(()=>{let e=n.trigger("click",{target:l,originalEvent:r,node:a,object:a});if(!0===e.isCancelled)return t.removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected"),void s.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected");if(null!=s&&(s.selected=!1),n.get(l).selected=!0,n.selected=l,"string"==typeof a.route){let t=""!==a.route?String("/"+a.route).replace(/\/{2,}/g,"/"):"";var i=w2utils.parseRoute(t);if(0<i.keys.length)for(let e=0;e<i.keys.length;e++)null!=n.routeData[i.keys[e].name]&&(t=t.replace(new RegExp(":"+i.keys[e].name,"g"),n.routeData[i.keys[e].name]));setTimeout(()=>{window.location.hash=t},1)}e.finish()},1)}}focus(e){let t=this,i=this.trigger("focus",{target:this.name,originalEvent:e});if(!0===i.isCancelled)return!1;this.hasFocus=!0,query(this.box).find(".w2ui-sidebar-body").addClass("w2ui-focus"),setTimeout(()=>{let e=query(t.box).find("#sidebar_"+t.name+"_focus").get(0);document.activeElement!=e&&e.focus()},10),i.finish()}blur(e){let t=this.trigger("blur",{target:this.name,originalEvent:e});if(!0===t.isCancelled)return!1;this.hasFocus=!1,query(this.box).find(".w2ui-sidebar-body").removeClass("w2ui-focus"),t.finish()}keydown(t){let n=this,i=n.get(n.selected);if(!0===n.keyboard){i=i||n.nodes[0];let e=n.trigger("keydown",{target:n.name,originalEvent:t});function s(e,t){null==e||e.hidden||e.disabled||e.group||(n.click(e.id,t),n.inView(e.id)||n.scrollIntoView(e.id))}function l(e,t){for(e=t(e);null!=e&&(e.hidden||e.disabled)&&!e.group;)e=t(e);return e}function r(e){if(null==e)return null;var t=e.parent,e=n.get(e.id,!0);let i=0<e?function t(i){if(i.expanded&&0<i.nodes.length){let e=i.nodes[i.nodes.length-1];return(e.hidden||e.disabled||e.group?r:t)(e)}return i}(t.nodes[e-1]):t;return i=null!=i&&(i.hidden||i.disabled||i.group)?r(i):i}!0!==e.isCancelled&&(13!=t.keyCode&&32!=t.keyCode||0<i.nodes.length&&n.toggle(n.selected),37==t.keyCode&&(0<i.nodes.length&&i.expanded?n.collapse(n.selected):(s(i.parent),i.parent.group||n.collapse(i.parent.id))),39==t.keyCode&&(0<i.nodes.length||i.plus)&&!i.expanded&&n.expand(n.selected),38==t.keyCode&&(null==n.get(n.selected)?s(this.nodes[0]||null):s(l(i,r))),40==t.keyCode&&(null==n.get(n.selected)?s(this.nodes[0]||null):s(l(i,function t(i,e){if(null==i)return null;let s=i.parent;let l=n.get(i.id,!0);let r=null;if(i.expanded&&0<i.nodes.length&&!0!==e){let e=i.nodes[0];r=e.hidden||e.disabled||e.group?t(e):e}else r=s&&l+1<s.nodes.length?s.nodes[l+1]:t(s,!0);null!=r&&(r.hidden||r.disabled||r.group)&&(r=t(r));return r}))),[13,32,37,38,39,40].includes(t.keyCode)&&(t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation()),e.finish())}}inView(e){e=query(this.box).find("#node_"+w2utils.escapeId(e)).get(0);if(!e)return!1;var t=query(this.box).find(".w2ui-sidebar-body").get(0);return!(e.offsetTop<t.scrollTop||e.offsetTop+e.clientHeight>t.clientHeight+t.scrollTop)}scrollIntoView(s,l){return new Promise((t,e)=>{null==s&&(s=this.selected);var i=this.get(s);if(null!=i){let e=query(this.box).find("#node_"+w2utils.escapeId(s)).get(0);e.scrollIntoView({block:"center",inline:"center",behavior:l?"atuo":"smooth"}),setTimeout(()=>{this.resize(),t()},l?0:500)}})}dblClick(e,t){var i=this.get(e);let s=this.trigger("dblClick",{target:e,originalEvent:t,object:i});!0!==s.isCancelled&&(this.toggle(e),s.finish())}contextMenu(t,i){var e=this.get(t);t!=this.selected&&this.click(t);let s=this.trigger("contextMenu",{target:t,originalEvent:i,object:e,allowOnDisabled:!1});!0===s.isCancelled||e.disabled&&!s.allowOnDisabled||(0<this.menu.length&&w2menu.show({name:this.name+"_menu",anchor:document.body,items:this.menu,originalEvent:i}).select(e=>{this.menuClick(t,parseInt(e.detail.index),i)}),i.preventDefault&&i.preventDefault(),s.finish())}menuClick(e,t,i){let s=this.trigger("menuClick",{target:e,originalEvent:i,menuIndex:t,menuItem:this.menu[t]});!0!==s.isCancelled&&s.finish()}goFlat(){let e=this.trigger("flat",{goFlat:!this.flat});!0!==e.isCancelled&&(this.flat=!this.flat,this.refresh(),e.finish())}render(e){var i=Date.now();let s=this,l=("string"==typeof e&&(e=query(e).get(0)),this.trigger("render",{target:this.name,box:e??this.box}));if(!0!==l.isCancelled&&(null!=e&&(0<query(this.box).find(".w2ui-sidebar-body").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-sidebar").html(""),this.box=e),this.box)){query(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-sidebar").html(`<div>
                <div class="w2ui-sidebar-top"></div>
                <input id="sidebar_${this.name}_focus" ${this.tabIndex?'tabindex="'+this.tabIndex+'"':""}
                    style="position: absolute; top: 0; right: 0; width: 1px; z-index: -1; opacity: 0"
                    ${w2utils.isIOS?"readonly":""}/>
                <div class="w2ui-sidebar-body"></div>
                <div class="w2ui-sidebar-bottom"></div>
            </div>`);e=query(this.box).get(0).getBoundingClientRect();query(this.box).find(":scope > div").css({width:e.width+"px",height:e.height+"px"}),query(this.box).get(0).style.cssText+=this.style;let t;return query(this.box).find("#sidebar_"+this.name+"_focus").on("focus",function(e){clearTimeout(t),s.hasFocus||s.focus(e)}).on("blur",function(e){t=setTimeout(()=>{s.hasFocus&&s.blur(e)},100)}).on("keydown",function(e){9!=e.keyCode&&w2ui[s.name].keydown.call(w2ui[s.name],e)}),query(this.box).off("mousedown").on("mousedown",function(e){setTimeout(()=>{if(-1==["INPUT","TEXTAREA","SELECT"].indexOf(e.target.tagName.toUpperCase())){let e=query(s.box).find("#sidebar_"+s.name+"_focus");document.activeElement!=e.get(0)&&e.get(0).focus()}},1)}),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),l.finish(),this.refresh(),Date.now()-i}}update(e,i){let s=this.get(e),l;if(s){let t=query(this.box).find("#node_"+w2utils.escapeId(s.id));if(s.group)i.text&&(s.text=i.text,t.find(".w2ui-group-text").replace("function"==typeof s.text?s.text.call(this,s):'<span class="w2ui-group-text">'+s.text+"</span>"),delete i.text),i.class&&(s.class=i.class,l=t.data("level"),t.get(0).className="w2ui-node-group w2ui-level-"+l+(s.class?" "+s.class:""),delete i.class),i.style&&(s.style=i.style,t.get(0).nextElementSibling.style=s.style+";"+(!s.hidden&&s.expanded?"":"display: none;"),delete i.style);else{if(i.icon){let e=t.find(".w2ui-node-image > span");0<e.length&&(s.icon=i.icon,e[0].className="function"==typeof s.icon?s.icon.call(this,s):s.icon,delete i.icon)}if(i.count&&(s.count=i.count,t.find(".w2ui-node-count").html(s.count),0<t.find(".w2ui-node-count").length&&delete i.count),i.class&&0<t.length&&(s.class=i.class,l=t.data("level"),t[0].className="w2ui-node w2ui-level-"+l+(s.selected?" w2ui-selected":"")+(s.disabled?" w2ui-disabled":"")+(s.class?" "+s.class:""),delete i.class),i.text&&(s.text=i.text,t.find(".w2ui-node-text").html("function"==typeof s.text?s.text.call(this,s):s.text),delete i.text),i.style&&0<t.length){let e=t.find(".w2ui-node-text");s.style=i.style,e[0].style=s.style,delete i.style}}}return i}refresh(n,a){if(null!=this.box){var o=Date.now();let r=this.trigger("refresh",{target:null!=n?n:this.name,nodeId:null!=n?n:null,fullRefresh:null==n});if(!0!==r.isCancelled){let e="";1==this.flatButton&&(e=`<div class="w2ui-flat w2ui-flat-${this.flat?"right":"left"}"></div>`),null!=n||""===this.topHTML&&""===e||(query(this.box).find(".w2ui-sidebar-top").html(this.topHTML+e),query(this.box).find(".w2ui-sidebar-body").css("top",query(this.box).find(".w2ui-sidebar-top").get(0)?.clientHeight+"px"),query(this.box).find(".w2ui-flat").off("clcik").on("click",e=>{this.goFlat()})),null!=n&&""!==this.bottomHTML&&(query(this.box).find(".w2ui-sidebar-bottom").html(this.bottomHTML),query(this.box).find(".w2ui-sidebar-body").css("bottom",query(this.box).find(".w2ui-sidebar-bottom").get(0)?.clientHeight+"px")),query(this.box).find(":scope > div").removeClass("w2ui-sidebar-flat").addClass(this.flat?"w2ui-sidebar-flat":"").css({width:query(this.box).get(0)?.clientWidth+"px",height:query(this.box).get(0)?.clientHeight+"px"}),0<this.nodes.length&&null==this.nodes[0].parent&&(d=this.nodes,this.nodes=[],this.add(this,d));let h=this,t,i;if(null==n)t=this,i=".w2ui-sidebar-body";else{if(null==(t=this.get(n)))return;i="#node_"+w2utils.escapeId(t.id)+"_sub"}var d="#node_"+w2utils.escapeId(t.id);let s,l=(t!==this&&(s=c(t),query(this.box).find(d).before('<div id="sidebar_'+this.name+'_tmp"></div>'),query(this.box).find(d).remove(),query(this.box).find(i).remove(),query(this.box).find("#sidebar_"+this.name+"_tmp").before(s),query(this.box).find("#sidebar_"+this.name+"_tmp").remove()),query(this.box).find(":scope > div").get(0));var n={top:l?.scrollTop,left:l?.scrollLeft};query(this.box).find(i).html("");for(let e=0;e<t.nodes.length;e++){var u=t.nodes[e];if(s=c(u),query(this.box).find(i).append(s),0!==u.nodes.length)this.refresh(u.id,!0);else{let e=this.trigger("refresh",{target:u.id});if(!0===e.isCancelled)return;e.finish()}}return l&&(l.scrollTop=n.top,l.scrollLeft=n.left),a||(n=query(this.box).find(d+`.w2ui-eaction, ${i} .w2ui-eaction`),w2utils.bindEvents(n,this)),r.finish(),Date.now()-o;function c(i){let s="",l=i.icon,r=(null==l&&(l=h.icon),i.parent),n=0;for(;r&&null!=r.parent;)r=r.parent,n++;if(null!=i.caption&&null==i.text&&(i.text=i.caption),null!=i.caption&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",i),i.text=i.caption),Array.isArray(i.nodes)&&0<i.nodes.length&&(i.collapsible=!0),i.group){let e=w2utils.lang("function"==typeof i.text?i.text.call(h,i):i.text);"<span"!=String(e).substr(0,5)&&(e=`<span class="w2ui-group-text">${e}</span>`),s=`
                    <div id="node_${i.id}" data-level="${n}" style="${i.hidden?"display: none":""}"
                        class="w2ui-node-group w2ui-level-${n} ${i.class||""} w2ui-eaction"
                        data-click="toggle|${i.id}"
                        data-contextmenu="contextMenu|${i.id}|event"
                        data-mouseenter="showPlus|this|inherit"
                        data-mouseleave="showPlus|this|transparent">
                        ${i.groupShowHide&&i.collapsible?`<span>${!i.hidden&&i.expanded?w2utils.lang("Hide"):w2utils.lang("Show")}</span>`:"<span></span>"} ${e}
                    </div>
                    <div class="w2ui-node-sub" id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}">
                </div>`,h.flat&&(s=`
                        <div class="w2ui-node-group" id="node_${i.id}"><span>&#160;</span></div>
                        <div id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}"></div>`)}else{i.selected&&!i.disabled&&(h.selected=i.id),r="",l&&(r=`
                    <div class="w2ui-node-image">
                        <span class="${"function"==typeof l?l.call(h,i):l}"></span>
                    </div>`);let e="";var a=null!=i.count?`<div class="w2ui-node-count ${h.last.badge[i.id]&&h.last.badge[i.id].className||""}"
                            style="${h.last.badge[i.id]&&h.last.badge[i.id].style||""}">
                                ${i.count}
                       </div>`:"",o=(!0===i.collapsible&&(e=`<div class="w2ui-${i.expanded?"expanded":"collapsed"}"><span></span></div>`),w2utils.lang("function"==typeof i.text?i.text.call(h,i):i.text));let t=["w2ui-node","w2ui-level-"+n,"w2ui-eaction"];i.selected&&t.push("w2ui-selected"),i.disabled&&t.push("w2ui-disabled"),i.class&&t.push(i.class),s=`
                    <div id="node_${i.id}" class="${t.join(" ")}" data-level="${n}"
                        style="position: relative; ${i.hidden?"display: none;":""}"
                        data-click="click|${i.id}|event"
                        data-dblclick="dblClick|${i.id}|event"
                        data-contextmenu="contextMenu|${i.id}|event">
                        ${h.handle.html?`<div class="w2ui-node-handle w2ui-eaction" style="width: ${h.handle.size}px; ${h.handle.style}"
                                    data-mouseenter="handleTooltip|this|${i.id}"
                                    data-mouseleave="handleTooltip|this"
                                >
                                   ${"function"==typeof h.handle.html?h.handle.html.call(h,i):h.handle.html}
                              </div>`:""}
                      <div class="w2ui-node-data" style="margin-left: ${n*h.levelPadding+h.handle.size}px">
                            ${e} ${r} ${a}
                            <div class="w2ui-node-text w2ui-node-caption" style="${i.style||""}">${o}</div>
                       </div>
                    </div>
                    <div class="w2ui-node-sub" id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}"></div>`,h.flat&&(a=w2utils.base64encode(o+(i.count||0===i.count?' - <span class="w2ui-node-count">'+i.count+"</span>":"")),s=`
                        <div id="node_${i.id}" class="${t.join(" ")}" style="${i.hidden?"display: none;":""}"
                            data-click="click|${i.id}|event"
                            data-dblclick="dblClick|${i.id}|event"
                            data-contextmenu="contextMenu|${i.id}|event"
                            data-mouseenter="tooltip|this|${a}|${i.id}"
                            data-mouseleave="tooltip|this|">
                            <div class="w2ui-node-data w2ui-node-flat">${r}</div>
                        </div>
                        <div class="w2ui-node-sub" id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}"></div>`)}return s}}}}tooltip(e,t,i){let s=query(e).find(".w2ui-node-data");""!==t?w2tooltip.show({anchor:s.get(0),name:this.name+"_tooltip",html:w2utils.base64decode(t),position:"right|left"}):w2tooltip.hide(this.name+"_tooltip")}handleTooltip(e,t){let i=this.handle.tooltip;""!==(i="function"==typeof i?i(t):i)&&null!=t?w2tooltip.show({anchor:e,name:this.name+"_tooltip",html:i,position:"top|bottom"}):w2tooltip.hide(this.name+"_tooltip")}showPlus(e,t){query(e).find("span:nth-child(1)").css("color",t)}resize(){var e,t=Date.now();let i=this.trigger("resize",{target:this.name});if(!0!==i.isCancelled)return e=query(this.box).get(0).getBoundingClientRect(),query(this.box).css("overflow","hidden"),query(this.box).find(":scope > div").css({width:e.width+"px",height:e.height+"px"}),i.finish(),Date.now()-t}destroy(){let e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<query(this.box).find(".w2ui-sidebar-body").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-sidebar").html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],e.finish())}lock(e,t){let i=Array.from(arguments);i.unshift(this.box),w2utils.lock(...i)}unlock(e){w2utils.unlock(this.box,e)}}class w2tabs extends w2base{constructor(e){super(e.name),this.box=null,this.name=null,this.active=null,this.reorder=!1,this.flow="down",this.tooltip="top|left",this.tabs=[],this.routeData={},this.last={},this.right="",this.style="",this.onClick=null,this.onClose=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.tab_template={id:null,text:null,route:null,hidden:!1,disabled:!1,closable:!1,tooltip:null,style:"",onClick:null,onRefresh:null,onClose:null};var t=e.tabs;delete e.tabs,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.tabs=t,"string"==typeof this.box&&(this.box=query(this.box).get(0)),this.box&&this.render(this.box)}add(e){return this.insert(null,e)}insert(s,e){Array.isArray(e)||(e=[e]);let l=[];return e.forEach(e=>{var t,i;null==e.id?console.log(`ERROR: The parameter "id" is required but not supplied. (obj: ${this.name})`):w2utils.checkUniqueId(e.id,this.tabs,"tabs",this.name)&&(e=Object.assign({},this.tab_template,e),null==s?(this.tabs.push(e),l.push(this.animateInsert(null,e))):(t=this.get(s,!0),i=this.tabs[t].id,this.tabs.splice(t,0,e),l.push(this.animateInsert(i,e))))}),Promise.all(l)}remove(){let t=0;return Array.from(arguments).forEach(e=>{e=this.get(e);e&&(t++,this.tabs.splice(this.get(e.id,!0),1),query(this.box).find(`#tabs_${this.name}_tab_`+w2utils.escapeId(e.id)).remove())}),this.resize(),t}select(e){return this.active!=e&&null!=this.get(e)&&(this.active=e,this.refresh(),!0)}set(e,t){var i=this.get(e,!0);return null!=i&&(w2utils.extend(this.tabs[i],t),this.refresh(e),!0)}get(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.tabs.length;e++)null!=this.tabs[e].id&&t.push(this.tabs[e].id);return t}for(let e=0;e<this.tabs.length;e++)if(this.tabs[e].id==t)return!0===i?e:this.tabs[e];return null}show(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!1!==t.hidden&&(t.hidden=!1,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.resize()})},15),i}hide(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!0!==t.hidden&&(t.hidden=!0,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.resize()})},15),i}enable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!1!==t.disabled&&(t.disabled=!1,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}disable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!0!==t.disabled&&(t.disabled=!0,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}dragMove(n){if(this.last.reordering){let s=this,l=this.last.moving;var a=this.tabs[l.index],o=d(l.index,1),h=d(l.index,-1);let r=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(a.id));if(0<l.divX&&o){let e=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(o.id)),t=parseInt(r.get(0).clientWidth),i=parseInt(e.get(0).clientWidth);if(t=t<i?Math.floor(t/3):Math.floor(i/3),i-=t,l.divX>i)return a=this.tabs.indexOf(o),this.tabs.splice(l.index,0,this.tabs.splice(a,1)[0]),l.$tab.before(e.get(0)),l.$tab.css("opacity",0),void Object.assign(this.last.moving,{index:a,divX:-t,x:n.pageX+t,left:l.left+l.divX+t})}if(l.divX<0&&h){let e=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(h.id)),t=parseInt(r.get(0).clientWidth),i=parseInt(e.get(0).clientWidth);t=t<i?Math.floor(t/3):Math.floor(i/3),i-=t,Math.abs(l.divX)>i&&(o=this.tabs.indexOf(h),this.tabs.splice(l.index,0,this.tabs.splice(o,1)[0]),e.before(l.$tab),l.$tab.css("opacity",0),Object.assign(l,{index:o,divX:t,x:n.pageX-t,left:l.left+l.divX-t}))}function d(e,t){e+=t;let i=s.tabs[e];return i=i&&i.hidden?d(e,t):i}}}tooltipShow(t){var i=this.get(t),t=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(t)).get(0);if(null!=this.tooltip&&!i.disabled&&!this.last.reordering){var s=this.tooltip;let e=i.tooltip;"function"==typeof e&&(e=e.call(this,i)),w2tooltip.show({anchor:t,name:this.name+"_tooltip",html:e,position:s})}}tooltipHide(e){null!=this.tooltip&&w2tooltip.hide(this.name+"_tooltip")}getTabHTML(e){e=this.get(e,!0);let t=this.tabs[e];if(null==t)return!1;null==t.text&&null!=t.caption&&(t.text=t.caption),null==t.tooltip&&null!=t.hint&&(t.tooltip=t.hint),null!=t.caption&&console.log("NOTICE: tabs tab.caption property is deprecated, please use tab.text. Tab -> ",t),null!=t.hint&&console.log("NOTICE: tabs tab.hint property is deprecated, please use tab.tooltip. Tab -> ",t);let i=t.text,s=(null==(i="function"==typeof i?i.call(this,t):i)&&(i=""),""),l="";return t.hidden&&(l+="display: none;"),t.disabled&&(l+="opacity: 0.2;"),t.closable&&!t.disabled&&(s=`<div class="w2ui-tab-close w2ui-eaction ${this.active===t.id?"active":""}"
                data-mouseenter='["tooltipShow", "${t.id}"]'
                data-mouseleave='["tooltipHide", "${t.id}"]'
                data-mousedown="stop"
                data-mouseup='["clickClose", "${t.id}", "event"]'>
            </div>`),`
            <div id="tabs_${this.name}_tab_${t.id}" style="${l} ${t.style}"
               class="w2ui-tab w2ui-eaction ${this.active===t.id?"active":""} ${t.closable?"closable":""} ${t.class||""}"
               data-mouseenter ='["tooltipShow", "${t.id}"]'
               data-mouseleave ='["tooltipHide", "${t.id}"]'
               data-mousedown  ='["initReorder", "${t.id}", "event"]'
               data-click      ='["click", "${t.id}", "event"]'
               >
                    ${w2utils.lang(i)+s}
            </div>`}refresh(t){var e=Date.now();"up"==this.flow?query(this.box).addClass("w2ui-tabs-up"):query(this.box).removeClass("w2ui-tabs-up");let i=this.trigger("refresh",{target:null!=t?t:this.name,object:this.get(t)});if(!0!==i.isCancelled){if(null==t)for(let e=0;e<this.tabs.length;e++)this.refresh(this.tabs[e].id);else{var s="#tabs_"+this.name+"_tab_"+w2utils.escapeId(t);let e=query(this.box).find(s);t=this.getTabHTML(t);0===e.length?query(this.box).find("#tabs_"+this.name+"_right").before(t):0==query(this.box).find(".tab-animate-insert").length&&e.replace(t),w2utils.bindEvents(query(this.box).find(s+`, ${s} .w2ui-eaction`),this)}return query(this.box).find("#tabs_"+this.name+"_right").html(this.right),i.finish(),Date.now()-e}}render(e){var t=Date.now();"string"==typeof e&&(e=query(e).get(0));let i=this.trigger("render",{target:this.name,box:e??this.box});if(!0!==i.isCancelled){if(null!=e&&(0<query(this.box).find("#tabs_"+this.name+"_right").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-tabs").html(""),this.box=e),!this.box)return!1;e=`
            <div class="w2ui-tabs-line"></div>
            <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">
                <div id="tabs_${this.name}_right" class="w2ui-tabs-right">${this.right}</div>
            </div>
            <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll","left"]'></div>
            <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll","right"]'></div>`;return query(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-tabs").html(e),0<query(this.box).length&&(query(this.box)[0].style.cssText+=this.style),w2utils.bindEvents(query(this.box).find(".w2ui-eaction"),this),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),i.finish(),this.refresh(),this.resize(),Date.now()-t}}initReorder(e,n){if(this.reorder){let t=this,i=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(e)),s=this.get(e,!0),l=query(i.get(0).cloneNode(!0)),r;l.attr("id","#tabs_"+this.name+"_tab_ghost"),this.last.moving={index:s,indexFrom:s,$tab:i,$ghost:l,divX:0,left:i.get(0).getBoundingClientRect().left,parentX:query(this.box).get(0).getBoundingClientRect().left,x:n.pageX,opacity:i.css("opacity")},query(document).off(".w2uiTabReorder").on("mousemove.w2uiTabReorder",function(e){if(!t.last.reordering){if(!0===(r=t.trigger("reorder",{target:t.tabs[s].id,indexFrom:s,tab:t.tabs[s]})).isCancelled)return;w2tooltip.hide(this.name+"_tooltip"),t.last.reordering=!0,l.addClass("moving"),l.css({"pointer-events":"none",position:"absolute",left:i.get(0).getBoundingClientRect().left}),i.css("opacity",0),query(t.box).find(".w2ui-scroll-wrapper").append(l.get(0)),query(t.box).find(".w2ui-tab-close").hide()}t.last.moving.divX=e.pageX-t.last.moving.x,l.css("left",t.last.moving.left-t.last.moving.parentX+t.last.moving.divX+"px"),t.dragMove(e)}).on("mouseup.w2uiTabReorder",function(){query(document).off(".w2uiTabReorder"),l.css({transition:"0.1s",left:t.last.moving.$tab.get(0).getBoundingClientRect().left-t.last.moving.parentX}),query(t.box).find(".w2ui-tab-close").show(),setTimeout(()=>{l.remove(),i.css({opacity:t.last.moving.opacity}),t.last.reordering&&r.finish({indexTo:t.last.moving.index}),t.last.reordering=!1},100)})}}scroll(a,o){return new Promise((e,t)=>{let i=query(this.box).find(".w2ui-scroll-wrapper");var s=i.get(0).scrollLeft,l=i.find(".w2ui-tabs-right").get(0),r=i.parent().get(0).getBoundingClientRect().width,n=s+parseInt(l.offsetLeft)+parseInt(l.clientWidth);switch(a){case"left":{let e=s-r+50;e<=0&&(e=0),i.get(0).scrollTo({top:0,left:e,behavior:o?"atuo":"smooth"});break}case"right":{let e=s+r-50;e>=n-r&&(e=n-r),i.get(0).scrollTo({top:0,left:e,behavior:o?"atuo":"smooth"});break}}setTimeout(()=>{this.resize(),e()},o?0:350)})}scrollIntoView(s,l){return new Promise((t,e)=>{null==s&&(s=this.active);var i=this.get(s);if(null!=i){let e=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(s)).get(0);e.scrollIntoView({block:"start",inline:"center",behavior:l?"atuo":"smooth"}),setTimeout(()=>{this.resize(),t()},l?0:500)}})}resize(){var i=Date.now();if(null!=this.box){let t=this.trigger("resize",{target:this.name});if(!0!==t.isCancelled){let e=query(this.box);e.find(".w2ui-scroll-left, .w2ui-scroll-right").hide();var s=e.find(".w2ui-scroll-wrapper").get(0),l=e.find(".w2ui-tabs-right"),r=e.get(0).getBoundingClientRect().width,l=0<l.length?l[0].offsetLeft+l[0].clientWidth:0;return r<l&&(0<s.scrollLeft&&e.find(".w2ui-scroll-left").show(),r<l-s.scrollLeft&&e.find(".w2ui-scroll-right").show()),t.finish(),Date.now()-i}}}destroy(){let e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<query(this.box).find("#tabs_"+this.name+"_right").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-tabs").html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],e.finish())}click(e,t){var i=this.get(e);if(null==i||i.disabled||this.last.reordering)return!1;let s=this.trigger("click",{target:e,tab:i,object:i,originalEvent:t});if(!0!==s.isCancelled){if(query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(this.active)).removeClass("active"),query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(this.active)).removeClass("active"),this.active=i.id,"string"==typeof i.route){let t=""!==i.route?String("/"+i.route).replace(/\/{2,}/g,"/"):"";var l=w2utils.parseRoute(t);if(0<l.keys.length)for(let e=0;e<l.keys.length;e++)null!=this.routeData[l.keys[e].name]&&(t=t.replace(new RegExp(":"+l.keys[e].name,"g"),this.routeData[l.keys[e].name]));setTimeout(()=>{window.location.hash=t},1)}s.finish(),this.refresh(e)}}clickClose(e,t){var i=this.get(e);if(null==i||i.disabled)return!1;let s=this.trigger("close",{target:e,object:i,tab:i,originalEvent:t});!0!==s.isCancelled&&(this.animateClose(e).then(()=>{this.remove(e),s.finish(),this.refresh()}),t&&t.stopPropagation())}animateClose(r){return new Promise((e,t)=>{let i=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(r));var s=parseInt(i.get(0).clientWidth||0);let l=i.replace(`<div class="tab-animate-close" style="display: inline-block; flex-shrink: 0; width: ${s}px; transition: width 0.25s"></div>`);setTimeout(()=>{l.css({width:"0px"})},1),setTimeout(()=>{l.remove(),this.resize(),e()},500)})}animateInsert(t,n){return new Promise((s,e)=>{let l=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(t)),r=query.html(this.getTabHTML(n.id));if(0==l.length)(l=query(this.box).find("#tabs_tabs_right")).before(r),this.resize();else{r.css({opacity:0}),query(this.box).find("#tabs_tabs_right").before(r.get(0));let e=query(this.box).find("#"+r.attr("id")),t=e.get(0).clientWidth??0,i=query.html('<div class="tab-animate-insert" style="flex-shrink: 0; width: 0; transition: width 0.25s"></div>');l.before(i),r.hide(),i.before(r[0]),setTimeout(()=>{i.css({width:t+"px"})},1),setTimeout(()=>{i.remove(),r.css({opacity:1}).show(),this.refresh(n.id),this.resize(),s()},500)}})}}let w2panels=["top","left","main","preview","right","bottom"];class w2layout extends w2base{constructor(e){super(e.name),this.box=null,this.name=null,this.panels=[],this.last={},this.padding=1,this.resizer=4,this.style="",this.onShow=null,this.onHide=null,this.onResizing=null,this.onResizerClick=null,this.onRender=null,this.onRefresh=null,this.onChange=null,this.onResize=null,this.onDestroy=null,this.panel_template={type:null,title:"",size:100,minSize:20,maxSize:!1,hidden:!1,resizable:!1,overflow:"auto",style:"",html:"",tabs:null,toolbar:null,width:null,height:null,show:{toolbar:!1,tabs:!1},removed:null,onRefresh:null,onShow:null,onHide:null},Object.assign(this,e),Array.isArray(this.panels)||(this.panels=[]),this.panels.forEach((t,i)=>{if(this.panels[i]=w2utils.extend({},this.panel_template,t),(w2utils.isPlainObject(t.tabs)||Array.isArray(t.tabs))&&function(e,t,i){let s=e.get(t);null!=s&&null==i&&(i=s.tabs);if(null==s||null==i)return;Array.isArray(i)&&(i={tabs:i});var l=e.name+"_"+t+"_tabs";w2ui[l]&&w2ui[l].destroy();s.tabs=new w2tabs(w2utils.extend({},i,{owner:e,name:e.name+"_"+t+"_tabs"})),s.show.tabs=!0}(this,t.type),w2utils.isPlainObject(t.toolbar)||Array.isArray(t.toolbar)){var i=this,t=t.type,s=void 0;let e=i.get(t);if(null!=e&&null==s&&(s=e.toolbar),null==e||null==s)return void!void 0;Array.isArray(s)&&(s={items:s});var l=i.name+"_"+t+"_toolbar";w2ui[l]&&w2ui[l].destroy(),e.toolbar=new w2toolbar(w2utils.extend({},s,{owner:i,name:i.name+"_"+t+"_toolbar"})),e.show.toolbar=!0}}),w2panels.forEach(e=>{null==this.get(e)&&this.panels.push(w2utils.extend({},this.panel_template,{type:e,hidden:"main"!==e,size:50}))}),"string"==typeof this.box&&(this.box=query(this.box).get(0)),this.box&&this.render(this.box)}html(i,s,l){let r=this.get(i),e={panel:i,html:r.html,error:!1,cancelled:!1,removed(e){"function"==typeof e&&(r.removed=e)}};if("function"==typeof r.removed&&(r.removed({panel:i,html:r.html,html_new:s,transition:l||"none"}),r.removed=null),"css"==i)return query(this.box).find("#layout_"+this.name+"_panel_css").html("<style>"+s+"</style>"),e.status=!0,e;if(null==r)return console.log("ERROR: incorrect panel name. Panel name can be main, left, right, top, bottom, preview or css"),e.error=!0,e;if(null==s)return e;let t=this.trigger("change",{target:i,panel:r,html_new:s,transition:l});if(!0===t.isCancelled)return e.cancelled=!0,e;let n="#layout_"+this.name+"_panel_"+r.type;var a=query(this.box).find(n+"> .w2ui-panel-content");let o=0;if(0<a.length&&(query(this.box).find(n).get(0).scrollTop=0,o=query(a).css("top")),""===r.html)r.html=s,this.refresh(i);else if(r.html=s,!r.hidden)if(null!=l&&""!==l){query(this.box).addClass("animating");let e=query(this.box).find(n+"> .w2ui-panel-content"),t=(e.after('<div class="w2ui-panel-content new-panel" style="'+e[0].style.cssText+'"></div>'),query(this.box).find(n+"> .w2ui-panel-content.new-panel"));e.css("top",o),t.css("top",o),"object"==typeof s?(s.box=t[0],s.render()):t.hide().html(s),w2utils.transition(e[0],t[0],l,()=>{e.remove(),t.removeClass("new-panel"),t.css("overflow",r.overflow),query(query(this.box).find(n+"> .w2ui-panel-content").get(1)).remove(),query(this.box).removeClass("animating"),this.refresh(i)})}else this.refresh(i);return t.finish(),e}message(e,t){var i=this.get(e);let s=query(this.box).find("#layout_"+this.name+"_panel_"+i.type),l=s.css("overflow"),r=(s.css("overflow","hidden"),w2utils.message({owner:this,box:s.get(0),after:".w2ui-panel-title",param:e},t));return r&&r.self.on("close:after",()=>{s.css("overflow",l)}),r}confirm(e,t){var i=this.get(e);let s=query(this.box).find("#layout_"+this.name+"_panel_"+i.type),l=s.css("overflow"),r=(s.css("overflow","hidden"),w2utils.confirm({owner:this,box:s.get(0),after:".w2ui-panel-title",param:e},t));return r&&r.self.on("close:after",()=>{s.css("overflow",l)}),r}load(i,s,l){return new Promise((t,e)=>{"css"!=i&&null==this.get(i)||null==s?e():fetch(s).then(e=>e.text()).then(e=>{this.resize(),t(this.html(i,e,l))})})}sizeTo(e,t,i){return null!=this.get(e)&&(query(this.box).find(":scope > div > .w2ui-panel").css("transition",!0!==i?".2s":"0s"),setTimeout(()=>{this.set(e,{size:t})},1),setTimeout(()=>{query(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),this.resize()},300),!0)}show(t,i){let s=this.trigger("show",{target:t,thisect:this.get(t),immediate:i});if(!0!==s.isCancelled){let e=this.get(t);return null==e?!1:(!(e.hidden=!1)===i?(query(this.box).find("#layout_"+this.name+"_panel_"+t).css({opacity:"1"}),s.finish(),this.resize()):(query(this.box).addClass("animating"),query(this.box).find("#layout_"+this.name+"_panel_"+t).css({opacity:"0"}),query(this.box).find(":scope > div > .w2ui-panel").css("transition",".2s"),setTimeout(()=>{this.resize()},1),setTimeout(()=>{query(this.box).find("#layout_"+this.name+"_panel_"+t).css({opacity:"1"})},250),setTimeout(()=>{query(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),query(this.box).removeClass("animating"),s.finish(),this.resize()},300)),!0)}}hide(t,i){let s=this.trigger("hide",{target:t,object:this.get(t),immediate:i});if(!0!==s.isCancelled){let e=this.get(t);return null==e?!1:((e.hidden=!0)===i?(query(this.box).find("#layout_"+this.name+"_panel_"+t).css({opacity:"0"}),s.finish(),this.resize()):(query(this.box).addClass("animating"),query(this.box).find(":scope > div > .w2ui-panel").css("transition",".2s"),query(this.box).find("#layout_"+this.name+"_panel_"+t).css({opacity:"0"}),setTimeout(()=>{this.resize()},1),setTimeout(()=>{query(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),query(this.box).removeClass("animating"),s.finish(),this.resize()},300)),!0)}}toggle(e,t){var i=this.get(e);return null!=i&&(i.hidden?this.show(e,t):this.hide(e,t))}set(e,t){var i=this.get(e,!0);return null!=i&&(w2utils.extend(this.panels[i],t),null==t.html&&null==t.resizable||this.refresh(e),this.resize(),!0)}get(t,i){for(let e=0;e<this.panels.length;e++)if(this.panels[e].type==t)return!0===i?e:this.panels[e];return null}el(e){e=query(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-content");return 1!=e.length?null:e[0]}hideToolbar(e){let t=this.get(e);t&&(t.show.toolbar=!1,query(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-toolbar").hide(),this.resize())}showToolbar(e){let t=this.get(e);t&&(t.show.toolbar=!0,query(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-toolbar").show(),this.resize())}toggleToolbar(e){var t=this.get(e);t&&(t.show.toolbar?this.hideToolbar(e):this.showToolbar(e))}assignToolbar(e,t){"string"==typeof t&&null!=w2ui[t]&&(t=w2ui[t]);let i=this.get(e),s=(i.toolbar=t,query(this.box).find(e+"> .w2ui-panel-toolbar"));null!=i.toolbar?(0===s.find("[name="+i.toolbar.name+"]").length?i.toolbar.render(s.get(0)):null!=i.toolbar&&i.toolbar.refresh(),(t.owner=this).showToolbar(e),this.refresh(e)):(s.html(""),this.hideToolbar(e))}hideTabs(e){let t=this.get(e);t&&(t.show.tabs=!1,query(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-tabs").hide(),this.resize())}showTabs(e){let t=this.get(e);t&&(t.show.tabs=!0,query(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-tabs").show(),this.resize())}toggleTabs(e){var t=this.get(e);t&&(t.show.tabs?this.hideTabs(e):this.showTabs(e))}render(e){var t=Date.now();let o=this,i=("string"==typeof e&&(e=query(e).get(0)),this.trigger("render",{target:this.name,box:e??this.box}));if(!0!==i.isCancelled){if(null!=e&&(0<query(this.box).find("#layout_"+this.name+"_panel_main").length&&query(this.box).removeAttr("name").removeClass("w2ui-layout").html(""),this.box=e),!this.box)return!1;query(this.box).attr("name",this.name).addClass("w2ui-layout").html("<div></div>"),0<query(this.box).length&&(query(this.box)[0].style.cssText+=this.style);for(let e=0;e<w2panels.length;e++){var s='<div id="layout_'+this.name+"_panel_"+w2panels[e]+'" class="w2ui-panel">    <div class="w2ui-panel-title"></div>    <div class="w2ui-panel-tabs"></div>    <div class="w2ui-panel-toolbar"></div>    <div class="w2ui-panel-content"></div></div><div id="layout_'+this.name+"_resizer_"+w2panels[e]+'" class="w2ui-resizer"></div>';query(this.box).find(":scope > div").append(s)}return query(this.box).find(":scope > div").append('<div id="layout_'+this.name+'_panel_css" style="position: absolute; top: 10000px;"></div>'),this.refresh(),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),i.finish(),setTimeout(()=>{o.last.events={resizeStart:l,mouseMove:n,mouseUp:r},this.resize()},0),Date.now()-t}function l(e,t){o.box&&(t=t||window.event,query(document).off("mousemove",o.last.events.mouseMove).on("mousemove",o.last.events.mouseMove),query(document).off("mouseup",o.last.events.mouseUp).on("mouseup",o.last.events.mouseUp),o.last.resize={type:e,x:t.screenX,y:t.screenY,diff_x:0,diff_y:0,value:0},w2panels.forEach(e=>{let t=query(o.el(e)).find(".w2ui-lock");0<t.length?t.data("locked","yes"):o.lock(e,{opacity:0})}),t=query(o.box).find("#layout_"+o.name+"_resizer_"+e).get(0),"left"!=e&&"right"!=e||(o.last.resize.value=parseInt(t.style.left)),"top"!=e&&"preview"!=e&&"bottom"!=e||(o.last.resize.value=parseInt(t.style.top)))}function r(l){if(o.box&&(l=l||window.event,query(document).off("mousemove",o.last.events.mouseMove),query(document).off("mouseup",o.last.events.mouseUp),null!=o.last.resize)){if(w2panels.forEach(e=>{let t=query(o.el(e)).find(".w2ui-lock");"yes"==t.data("locked")?t.removeData("locked"):o.unlock(e)}),0!==o.last.diff_x||0!==o.last.resize.diff_y){var r=o.get("top"),n=o.get("bottom");let e=o.get(o.last.resize.type);var l=w2utils.getSize(query(o.box),"width"),a=w2utils.getSize(query(o.box),"height");let t=String(e.size),i,s;switch(o.last.resize.type){case"top":i=parseInt(e.sizeCalculated)+o.last.resize.diff_y,s=0;break;case"bottom":i=parseInt(e.sizeCalculated)-o.last.resize.diff_y,s=0;break;case"preview":i=parseInt(e.sizeCalculated)-o.last.resize.diff_y,s=(r&&!r.hidden?r.sizeCalculated:0)+(n&&!n.hidden?n.sizeCalculated:0);break;case"left":i=parseInt(e.sizeCalculated)+o.last.resize.diff_x,s=0;break;case"right":i=parseInt(e.sizeCalculated)-o.last.resize.diff_x,s=0}"%"==t.substr(t.length-1)?e.size=Math.floor(100*i/("left"==e.type||"right"==e.type?l:a-s)*100)/100+"%":"-"==String(e.size).substr(0,1)?e.size=parseInt(e.size)-e.sizeCalculated+i:e.size=i,o.resize()}query(o.box).find("#layout_"+o.name+"_resizer_"+o.last.resize.type).removeClass("active"),delete o.last.resize}}function n(r){if(o.box&&(r=r||window.event,null!=o.last.resize)){var n=o.get(o.last.resize.type);let s=o.last.resize,l=o.trigger("resizing",{target:o.name,object:n,originalEvent:r,panel:s?s.type:"all",diff_x:s?s.diff_x:0,diff_y:s?s.diff_y:0});if(!0!==l.isCancelled){let e=query(o.box).find("#layout_"+o.name+"_resizer_"+s.type),t=r.screenX-s.x,i=r.screenY-s.y;var a=o.get("main");switch(e.hasClass("active")||e.addClass("active"),s.type){case"left":n.minSize-t>n.width&&(t=n.minSize-n.width),n.maxSize&&n.width+t>n.maxSize&&(t=n.maxSize-n.width),a.minSize+t>a.width&&(t=a.width-a.minSize);break;case"right":n.minSize+t>n.width&&(t=n.width-n.minSize),n.maxSize&&n.width-t>n.maxSize&&(t=n.width-n.maxSize),a.minSize-t>a.width&&(t=a.minSize-a.width);break;case"top":n.minSize-i>n.height&&(i=n.minSize-n.height),n.maxSize&&n.height+i>n.maxSize&&(i=n.maxSize-n.height),a.minSize+i>a.height&&(i=a.height-a.minSize);break;case"preview":case"bottom":n.minSize+i>n.height&&(i=n.height-n.minSize),n.maxSize&&n.height-i>n.maxSize&&(i=n.height-n.maxSize),a.minSize-i>a.height&&(i=a.minSize-a.height)}switch(s.diff_x=t,s.diff_y=i,s.type){case"top":case"preview":case"bottom":(s.diff_x=0)<e.length&&(e[0].style.top=s.value+s.diff_y+"px");break;case"left":case"right":(s.diff_y=0)<e.length&&(e[0].style.left=s.value+s.diff_x+"px")}l.finish()}}}}refresh(s){let l=this;null==s&&(s=null);var e=Date.now();let t=l.trigger("refresh",{target:null!=s?s:l.name,object:l.get(s)});if(!0!==t.isCancelled){if("string"==typeof s){let e=l.get(s);if(null==e)return;let t="#layout_"+l.name+"_panel_"+e.type;s="#layout_"+l.name+"_resizer_"+e.type;query(l.box).find(t).css({display:e.hidden?"none":"block"}),e.resizable?query(l.box).find(s).show():query(l.box).find(s).hide(),"object"==typeof e.html&&"function"==typeof e.html.render?(e.html.box=query(l.box).find(t+"> .w2ui-panel-content")[0],setTimeout(()=>{0<query(l.box).find(t+"> .w2ui-panel-content").length&&(query(l.box).find(t+"> .w2ui-panel-content").removeClass().removeAttr("name").addClass("w2ui-panel-content").css("overflow",e.overflow)[0].style.cssText+=";"+e.style),e.html&&"function"==typeof e.html.render&&e.html.render()},1)):0<query(l.box).find(t+"> .w2ui-panel-content").length&&(query(l.box).find(t+"> .w2ui-panel-content").removeClass().removeAttr("name").addClass("w2ui-panel-content").html(e.html).css("overflow",e.overflow)[0].style.cssText+=";"+e.style);let i=query(l.box).find(t+"> .w2ui-panel-tabs");e.show.tabs?0===i.find("[name="+e.tabs.name+"]").length&&null!=e.tabs?e.tabs.render(i.get(0)):e.tabs.refresh():i.html("").removeClass("w2ui-tabs").hide(),i=query(l.box).find(t+"> .w2ui-panel-toolbar"),e.show.toolbar?0===i.find("[name="+e.toolbar.name+"]").length&&null!=e.toolbar?e.toolbar.render(i.get(0)):e.toolbar.refresh():i.html("").removeClass("w2ui-toolbar").hide(),i=query(l.box).find(t+"> .w2ui-panel-title"),e.title?i.html(e.title).show():i.html("").hide()}else{if(0===query(l.box).find("#layout_"+l.name+"_panel_main").length)return void l.render();l.resize();for(let e=0;e<this.panels.length;e++)l.refresh(this.panels[e].type)}return t.finish(),Date.now()-e}}resize(){if(!this.box)return!1;var u=Date.now();let c=this.last.resize,p=this.trigger("resize",{target:this.name,panel:c?c.type:"all",diff_x:c?c.diff_x:0,diff_y:c?c.diff_y:0});if(!0!==p.isCancelled){this.padding<0&&(this.padding=0);var f=w2utils.getSize(query(this.box),"width"),m=w2utils.getSize(query(this.box),"height");query(this.box).find(":scope > div").css({width:f+"px",height:m+"px"});let i=this,e=this.get("main"),t=this.get("preview"),s=this.get("left"),l=this.get("right"),r=this.get("top"),n=this.get("bottom");var g=null!=t&&!0!==t.hidden,y=null!=s&&!0!==s.hidden,w=null!=l&&!0!==l.hidden,b=null!=r&&!0!==r.hidden,v=null!=n&&!0!==n.hidden;let a,o,h,d;for(let e=0;e<w2panels.length;e++)if("main"!==w2panels[e]&&(c=this.get(w2panels[e]))){let e=String(c.size||0);if("%"==e.substr(e.length-1)){let e=m;"preview"==c.type&&(e=e-(r&&!r.hidden?r.sizeCalculated:0)-(n&&!n.hidden?n.sizeCalculated:0)),c.sizeCalculated=parseInt(("left"==c.type||"right"==c.type?f:e)*parseFloat(c.size)/100)}else c.sizeCalculated=parseInt(c.size);c.sizeCalculated=Math.max(c.sizeCalculated,parseInt(c.minSize))}"-"==String(l.size).substr(0,1)&&(y&&"-"==String(s.size).substr(0,1)?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):l.sizeCalculated=f-(y?s.sizeCalculated:0)+parseInt(l.size)),"-"==String(s.size).substr(0,1)&&(w&&"-"==String(l.size).substr(0,1)?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):s.sizeCalculated=f-(w?l.sizeCalculated:0)+parseInt(s.size)),null!=r&&!0!==r.hidden?(a=0,o=0,h=f,d=r.sizeCalculated,query(this.box).find("#layout_"+this.name+"_panel_top").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),r.width=h,r.height=d,r.resizable&&(o=r.sizeCalculated-(0===this.padding?this.resizer:0),d=this.resizer>this.padding?this.resizer:this.padding,query(this.box).find("#layout_"+this.name+"_resizer_top").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(e){let t=i.trigger("resizerClick",{target:"top",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].last.events.resizeStart("top",e),t.finish(),!1}))):(query(this.box).find("#layout_"+this.name+"_panel_top").hide(),query(this.box).find("#layout_"+this.name+"_resizer_top").hide()),null!=s&&!0!==s.hidden?(a=0,o=0+(b?r.sizeCalculated+this.padding:0),h=s.sizeCalculated,d=m-(b?r.sizeCalculated+this.padding:0)-(v?n.sizeCalculated+this.padding:0),query(this.box).find("#layout_"+this.name+"_panel_left").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),s.width=h,s.height=d,s.resizable&&(a=s.sizeCalculated-(0===this.padding?this.resizer:0),h=this.resizer>this.padding?this.resizer:this.padding,query(this.box).find("#layout_"+this.name+"_resizer_left").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",function(e){let t=i.trigger("resizerClick",{target:"left",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].last.events.resizeStart("left",e),t.finish(),!1}))):(query(this.box).find("#layout_"+this.name+"_panel_left").hide(),query(this.box).find("#layout_"+this.name+"_resizer_left").hide()),null!=l&&!0!==l.hidden?(a=f-l.sizeCalculated,o=0+(b?r.sizeCalculated+this.padding:0),h=l.sizeCalculated,d=m-(b?r.sizeCalculated+this.padding:0)-(v?n.sizeCalculated+this.padding:0),query(this.box).find("#layout_"+this.name+"_panel_right").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),l.width=h,l.height=d,l.resizable&&(a-=this.padding,h=this.resizer>this.padding?this.resizer:this.padding,query(this.box).find("#layout_"+this.name+"_resizer_right").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",function(e){let t=i.trigger("resizerClick",{target:"right",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].last.events.resizeStart("right",e),t.finish(),!1}))):(query(this.box).find("#layout_"+this.name+"_panel_right").hide(),query(this.box).find("#layout_"+this.name+"_resizer_right").hide()),null!=n&&!0!==n.hidden?(a=0,o=m-n.sizeCalculated,h=f,d=n.sizeCalculated,query(this.box).find("#layout_"+this.name+"_panel_bottom").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),n.width=h,n.height=d,n.resizable&&(o-=0===this.padding?0:this.padding,d=this.resizer>this.padding?this.resizer:this.padding,query(this.box).find("#layout_"+this.name+"_resizer_bottom").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(e){let t=i.trigger("resizerClick",{target:"bottom",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].last.events.resizeStart("bottom",e),t.finish(),!1}))):(query(this.box).find("#layout_"+this.name+"_panel_bottom").hide(),query(this.box).find("#layout_"+this.name+"_resizer_bottom").hide()),a=0+(y?s.sizeCalculated+this.padding:0),o=0+(b?r.sizeCalculated+this.padding:0),h=f-(y?s.sizeCalculated+this.padding:0)-(w?l.sizeCalculated+this.padding:0),d=m-(b?r.sizeCalculated+this.padding:0)-(v?n.sizeCalculated+this.padding:0)-(g?t.sizeCalculated+this.padding:0),query(this.box).find("#layout_"+this.name+"_panel_main").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),e.width=h,e.height=d,null!=t&&!0!==t.hidden?(a=0+(y?s.sizeCalculated+this.padding:0),o=m-(v?n.sizeCalculated+this.padding:0)-t.sizeCalculated,h=f-(y?s.sizeCalculated+this.padding:0)-(w?l.sizeCalculated+this.padding:0),d=t.sizeCalculated,query(this.box).find("#layout_"+this.name+"_panel_preview").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),t.width=h,t.height=d,t.resizable&&(o-=0===this.padding?0:this.padding,d=this.resizer>this.padding?this.resizer:this.padding,query(this.box).find("#layout_"+this.name+"_resizer_preview").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(e){let t=i.trigger("resizerClick",{target:"preview",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].last.events.resizeStart("preview",e),t.finish(),!1}))):(query(this.box).find("#layout_"+this.name+"_panel_preview").hide(),query(this.box).find("#layout_"+this.name+"_resizer_preview").hide());for(let t=0;t<w2panels.length;t++){var x,_=this.get(w2panels[t]),C="#layout_"+this.name+"_panel_"+w2panels[t]+" > .w2ui-panel-";let e=0;_&&(_.title&&(x=query(this.box).find(C+"title").css({top:e+"px",display:"block"}),e+=w2utils.getSize(x,"height")),_.show.tabs&&(x=query(this.box).find(C+"tabs").css({top:e+"px",display:"block"}),e+=w2utils.getSize(x,"height")),_.show.toolbar&&(_=query(this.box).find(C+"toolbar").css({top:e+"px",display:"block"}),e+=w2utils.getSize(_,"height"))),query(this.box).find(C+"content").css({display:"block"}).css({top:e+"px"})}return p.finish(),Date.now()-u}}destroy(){let e=this.trigger("destroy",{target:this.name});if(!0!==e.isCancelled)return null!=w2ui[this.name]&&(0<query(this.box).find("#layout_"+this.name+"_panel_main").length&&query(this.box).removeAttr("name").removeClass("w2ui-layout").html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],e.finish(),this.last.events&&this.last.events.resize&&query(window).off("resize",this.last.events.resize),!0)}lock(t,e,i){if(-1==w2panels.indexOf(t))console.log("ERROR: First parameter needs to be the a valid panel name.");else{let e=Array.from(arguments);e[0]="#layout_"+this.name+"_panel_"+t,w2utils.lock(...e)}}unlock(e,t){-1==w2panels.indexOf(e)?console.log("ERROR: First parameter needs to be the a valid panel name."):(e="#layout_"+this.name+"_panel_"+e,w2utils.unlock(e,t))}}class w2grid extends w2base{constructor(e){if(super(e.name),this.name=null,this.box=null,this.columns=[],this.columnGroups=[],this.records=[],this.summary=[],this.searches=[],this.toolbar={},this.ranges=[],this.contextMenu=[],this.searchMap={},this.searchData=[],this.sortMap={},this.sortData=[],this.savedSearches=[],this.defaultSearches=[],this.total=0,this.recid=null,this.last={field:"",label:"",logic:"AND",search:"",searchIds:[],selection:{indexes:[],columns:{}},saved_sel:null,multi:!1,scrollTop:0,scrollLeft:0,colStart:0,colEnd:0,fetch:{action:"",offset:null,start:0,response:0,options:null,controller:null,loaded:!1,hasMore:!1},pull_more:!1,pull_refresh:!0,range_start:null,range_end:null,sel_ind:null,sel_col:null,sel_type:null,sel_recid:null,idCache:{},move:null,cancelClick:null,inEditMode:!1,_edit:null,kbd_timer:null,marker_timer:null,click_time:null,click_recid:null,bubbleEl:null,colResizing:!1,tmp:null,copy_event:null,userSelect:"",columnDrag:!1,state:null,show_extra:0,toolbar_height:0},this.header="",this.url="",this.limit=100,this.offset=0,this.postData={},this.routeData={},this.httpHeaders={},this.show={header:!1,toolbar:!1,footer:!1,columnMenu:!0,columnHeaders:!0,lineNumbers:!1,orderColumn:!1,expandColumn:!1,selectColumn:!1,emptyRecords:!0,toolbarReload:!0,toolbarColumns:!1,toolbarSearch:!0,toolbarAdd:!1,toolbarEdit:!1,toolbarDelete:!1,toolbarSave:!1,searchAll:!0,searchLogic:!0,searchHiddenMsg:!1,searchSave:!0,statusRange:!0,statusBuffered:!1,statusRecordID:!0,statusSelection:!0,statusResponse:!0,statusSort:!1,statusSearch:!1,recordTitles:!1,selectionBorder:!0,skipRecords:!0,saveRestoreState:!0},this.stateId=null,this.hasFocus=!1,this.autoLoad=!0,this.fixedBody=!0,this.recordHeight=32,this.lineNumberWidth=34,this.keyboard=!0,this.selectType="row",this.liveSearch=!1,this.multiSearch=!0,this.multiSelect=!0,this.multiSort=!0,this.reorderColumns=!1,this.reorderRows=!1,this.showExtraOnSearch=0,this.markSearch=!0,this.columnTooltip="top|bottom",this.disableCVS=!1,this.nestedFields=!0,this.vs_start=150,this.vs_extra=5,this.style="",this.tabIndex=null,this.method=null,this.dataType=null,this.parser=null,this.advanceOnEdit=!0,this.useLocalStorage=!0,this.colTemplate={text:"",field:"",size:null,min:20,max:null,gridMinWidth:null,sizeCorrected:null,sizeCalculated:null,sizeOriginal:null,sizeType:null,hidden:!1,sortable:!1,sortMode:null,searchable:!1,resizable:!0,hideable:!0,autoResize:null,attr:"",style:"",render:null,title:null,tooltip:null,editable:{},frozen:!1,info:null,clipboardCopy:!1},this.stateColProps={text:!1,field:!0,size:!0,min:!1,max:!1,gridMinWidth:!1,sizeCorrected:!1,sizeCalculated:!0,sizeOriginal:!0,sizeType:!0,hidden:!0,sortable:!1,sortMode:!0,searchable:!1,resizable:!1,hideable:!1,autoResize:!1,attr:!1,style:!1,render:!1,title:!1,tooltip:!1,editable:!1,frozen:!0,info:!1,clipboardCopy:!1},this.msgDelete="Are you sure you want to delete ${count} ${records}?",this.msgNotJSON="Returned data is not in valid JSON format.",this.msgHTTPError="HTTP error. See console for more details.",this.msgRefresh="Refreshing...",this.msgNeedReload="Your remote data source record count has changed, reloading from the first record.",this.msgEmpty="",this.buttons={reload:{type:"button",id:"w2ui-reload",icon:"w2ui-icon-reload",tooltip:"Reload data in the list"},columns:{type:"menu-check",id:"w2ui-column-on-off",icon:"w2ui-icon-columns",tooltip:"Show/hide columns",overlay:{align:"none"}},search:{type:"html",id:"w2ui-search",html:'<div class="w2ui-icon w2ui-icon-search w2ui-search-down w2ui-action" data-click="searchShowFields"></div>'},add:{type:"button",id:"w2ui-add",text:"Add New",tooltip:"Add new record",icon:"w2ui-icon-plus"},edit:{type:"button",id:"w2ui-edit",text:"Edit",tooltip:"Edit selected record",icon:"w2ui-icon-pencil",batch:1,disabled:!0},delete:{type:"button",id:"w2ui-delete",text:"Delete",tooltip:"Delete selected records",icon:"w2ui-icon-cross",batch:!0,disabled:!0},save:{type:"button",id:"w2ui-save",text:"Save",tooltip:"Save changed records",icon:"w2ui-icon-check"}},this.operators={text:["is","begins","contains","ends"],number:["=","between",">","<",">=","<="],date:["is",{oper:"less",text:"before"},{oper:"more",text:"since"},"between"],list:["is"],hex:["is","between"],color:["is","begins","contains","ends"],enum:["in","not in"]},this.defaultOperator={text:"begins",number:"=",date:"is",list:"is",enum:"in",hex:"begins",color:"begins"},this.operatorsMap={text:"text",int:"number",float:"number",money:"number",currency:"number",percent:"number",hex:"hex",alphanumeric:"text",color:"color",date:"date",time:"date",datetime:"date",list:"list",combo:"text",enum:"enum",file:"enum",select:"list",radio:"list",checkbox:"list",toggle:"list"},this.onAdd=null,this.onEdit=null,this.onRequest=null,this.onLoad=null,this.onDelete=null,this.onSave=null,this.onSelect=null,this.onClick=null,this.onDblClick=null,this.onContextMenu=null,this.onContextMenuClick=null,this.onColumnClick=null,this.onColumnDblClick=null,this.onColumnResize=null,this.onColumnAutoResize=null,this.onSort=null,this.onSearch=null,this.onSearchOpen=null,this.onChange=null,this.onRestore=null,this.onExpand=null,this.onCollapse=null,this.onError=null,this.onKeydown=null,this.onToolbar=null,this.onColumnOnOff=null,this.onCopy=null,this.onPaste=null,this.onSelectionExtend=null,this.onEditField=null,this.onRender=null,this.onRefresh=null,this.onReload=null,this.onResize=null,this.onDestroy=null,this.onStateSave=null,this.onStateRestore=null,this.onFocus=null,this.onBlur=null,this.onReorderRow=null,this.onSearchSave=null,this.onSearchRemove=null,this.onSearchSelect=null,this.onColumnSelect=null,this.onColumnDragStart=null,this.onColumnDragEnd=null,this.onResizerDblClick=null,w2utils.extend(this,e),Array.isArray(this.records)){let i=[];this.records.forEach((e,t)=>{null!=e[this.recid]&&(e.recid=e[this.recid]),null==e.recid&&console.log("ERROR: Cannot add records without recid. (obj: "+this.name+")"),e.w2ui&&!0===e.w2ui.summary&&(this.summary.push(e),i.push(t))}),i.sort();for(let e=i.length-1;0<=e;e--)this.records.splice(i[e],1)}Array.isArray(this.columns)&&this.columns.forEach((i,e)=>{i=w2utils.extend({},this.colTemplate,i);e=(this.columns[e]=i).searchable;if(null!=e&&!1!==e&&null==this.getSearch(i.field))if(w2utils.isPlainObject(e))this.addSearch(w2utils.extend({field:i.field,label:i.text,type:"text"},e));else{let e=i.searchable,t="";!0===i.searchable&&(e="text",t='size="20"'),this.addSearch({field:i.field,label:i.text,type:e,attr:t})}}),Array.isArray(this.defaultSearches)&&this.defaultSearches.forEach((e,t)=>{e.id="default-"+t,e.icon??="w2ui-icon-search"});let t=this.cache("searches");Array.isArray(t)&&t.forEach(e=>{this.savedSearches.push({id:e.id??"none",text:e.text??"none",icon:"w2ui-icon-search",remove:!0,logic:e.logic??"AND",data:e.data??[]})}),"string"==typeof this.box&&(this.box=query(this.box).get(0)),this.box&&this.render(this.box)}add(i,s){Array.isArray(i)||(i=[i]);let l=0;for(let t=0;t<i.length;t++){let e=i[t];null!=e[this.recid]&&(e.recid=e[this.recid]),null==e.recid?console.log("ERROR: Cannot add record without recid. (obj: "+this.name+")"):(e.w2ui&&!0===e.w2ui.summary?s?this.summary.unshift(e):this.summary.push(e):s?this.records.unshift(e):this.records.push(e),l++)}return(this.url?.get??this.url)||(this.total=this.records.length,this.localSort(!1,!0),this.localSearch()),this.refresh(),l}find(s,e,t){let l=[],r=!1;for(var i in s=null==s?{}:s)-1!=String(i).indexOf(".")&&(r=!0);var n=t?this.last.range_start:0;let a=t?this.last.range_end+1:this.records.length;a>this.records.length&&(a=this.records.length);for(let i=n;i<a;i++){let t=!0;for(var o in s){let e=this.records[i][o];r&&-1!=String(o).indexOf(".")&&(e=this.parseField(this.records[i],o)),"not-null"==s[o]?null!=e&&""!==e||(t=!1):s[o]!=e&&(t=!1)}t&&!0!==e&&l.push(this.records[i].recid),t&&!0===e&&l.push(i)}return l}set(e,t,i){if("object"==typeof e&&null!==e&&(i=t,t=e,e=null),null==e){for(let e=0;e<this.records.length;e++)w2utils.extend(this.records[e],t);!0!==i&&this.refresh()}else{var s=this.get(e,!0);if(null==s)return!1;!this.records[s]||this.records[s].recid!=e?w2utils.extend(this.summary[s],t):w2utils.extend(this.records[s],t),!0!==i&&this.refreshRow(e,s)}return!0}get(i,s){if(Array.isArray(i)){let t=[];for(let e=0;e<i.length;e++){var l=this.get(i[e],s);null!==l&&t.push(l)}return t}{let t=this.last.idCache,e=(t||(this.last.idCache=t={}),t[i]);if("number"==typeof e){if(0<=e&&e<this.records.length&&this.records[e].recid==i)return!0===s?e:this.records[e];if(0<=(e=~e)&&e<this.summary.length&&this.summary[e].recid==i)return!0===s?e:this.summary[e];this.last.idCache=t={}}for(let e=0;e<this.records.length;e++)if(this.records[e].recid==i)return t[i]=e,!0===s?e:this.records[e];for(let e=0;e<this.summary.length;e++)if(this.summary[e].recid==i)return t[i]=~e,!0===s?e:this.summary[e];return null}}getFirst(e){if(0==this.records.length)return null;let t=this.records[0];var i=this.last.searchIds;return t=0<this.searchData.length?Array.isArray(i)&&0<i.length?this.records[i[e||0]]:null:t}remove(){let i=0;for(let t=0;t<arguments.length;t++){for(let e=this.records.length-1;0<=e;e--)this.records[e].recid==arguments[t]&&(this.records.splice(e,1),i++);for(let e=this.summary.length-1;0<=e;e--)this.summary[e].recid==arguments[t]&&(this.summary.splice(e,1),i++)}return(this.url?.get??this.url)||(this.localSort(!1,!0),this.localSearch()),this.refresh(),i}addColumn(e,s){let t=0;1==arguments.length?(s=e,e=this.columns.length):null==(e="string"==typeof e?this.getColumn(e,!0):e)&&(e=this.columns.length),Array.isArray(s)||(s=[s]);for(let i=0;i<s.length;i++){var l=w2utils.extend({},this.colTemplate,s[i]);if(this.columns.splice(e,0,l),s[i].searchable){let e=s[i].searchable,t="";!0===s[i].searchable&&(e="text",t='size="20"'),this.addSearch({field:s[i].field,label:s[i].label,type:e,attr:t})}e++,t++}return this.refresh(),t}removeColumn(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.columns.length-1;0<=e;e--)this.columns[e].field==arguments[t]&&(this.columns[e].searchable&&this.removeSearch(arguments[t]),this.columns.splice(e,1),i++);return this.refresh(),i}getColumn(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.columns.length;e++)t.push(this.columns[e].field);return t}for(let e=0;e<this.columns.length;e++)if(this.columns[e].field==t)return!0===i?e:this.columns[e];return null}updateColumn(e,s){let l=0;return(e=Array.isArray(e)?e:[e]).forEach(e=>{this.columns.forEach(i=>{if(i.field==e){let t=w2utils.clone(s);Object.keys(t).forEach(e=>{"function"==typeof t[e]&&(t[e]=t[e](i)),i[e]!=t[e]&&l++}),w2utils.extend(i,t)}})}),0<l&&this.refresh(),l}toggleColumn(){return this.updateColumn(Array.from(arguments),{hidden(e){return!e.hidden}})}showColumn(){return this.updateColumn(Array.from(arguments),{hidden:!1})}hideColumn(){return this.updateColumn(Array.from(arguments),{hidden:!0})}addSearch(t,i){let s=0;1==arguments.length?(i=t,t=this.searches.length):null==(t="string"==typeof t?this.getSearch(t,!0):t)&&(t=this.searches.length),Array.isArray(i)||(i=[i]);for(let e=0;e<i.length;e++)this.searches.splice(t,0,i[e]),t++,s++;return this.searchClose(),s}removeSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&(this.searches.splice(e,1),i++);return this.searchClose(),i}getSearch(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.searches.length;e++)t.push(this.searches[e].field);return t}for(let e=0;e<this.searches.length;e++)if(this.searches[e].field==t)return!0===i?e:this.searches[e];return null}toggleSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&(this.searches[e].hidden=!this.searches[e].hidden,i++);return this.searchClose(),i}showSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&!1!==this.searches[e].hidden&&(this.searches[e].hidden=!1,i++);return this.searchClose(),i}hideSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&!0!==this.searches[e].hidden&&(this.searches[e].hidden=!0,i++);return this.searchClose(),i}getSearchData(t){for(let e=0;e<this.searchData.length;e++)if(this.searchData[e].field==t)return this.searchData[e];return null}localSort(t,i){let a=this;if(this.url?.get??this.url)console.log("ERROR: grid.localSort can only be used on local data source, grid.url should be empty.");else if(0!==Object.keys(this.sortData).length){let e=Date.now();this.selectionSave(),this.prepareData(),i||this.reset();for(let t=0;t<this.sortData.length;t++){let e=this.getColumn(this.sortData[t].field);if(!e)return;"string"==typeof e.render&&(-1!=["date","age"].indexOf(e.render.split(":")[0])&&(this.sortData[t].field_=e.field+"_"),-1!=["time"].indexOf(e.render.split(":")[0])&&(this.sortData[t].field_=e.field+"_"))}for(let t=0;t<a.records.length;t++){let e=a.records[t];e.w2ui&&null!=e.w2ui.parent_recid&&(e.w2ui._path=r(e))}this.records.sort((e,t)=>{if(!(e.w2ui&&null!=e.w2ui.parent_recid||t.w2ui&&null!=t.w2ui.parent_recid))return n(e,t);var i=r(e),s=r(t);for(let e=0;e<Math.min(i.length,s.length);e++){var l=n(i[e],s[e]);if(0!==l)return l}return i.length>s.length?1:i.length<s.length?-1:(console.log("ERROR: two paths should not be equal."),0)});for(let t=0;t<a.records.length;t++){let e=a.records[t];e.w2ui&&null!=e.w2ui.parent_recid&&(e.w2ui._path=null)}return this.selectionRestore(i),e=Date.now()-e,!0!==t&&this.show.statusSort&&setTimeout(()=>{this.status(w2utils.lang("Sorting took ${count} seconds",{count:e/1e3}))},10),e;function r(e){if(!e.w2ui||null==e.w2ui.parent_recid)return[e];if(e.w2ui._path)return e.w2ui._path;var t=a.get(e.w2ui.parent_recid);return t?r(t).concat(e):(console.log("ERROR: no parent record: "+e.w2ui.parent_recid),[e])}function n(s,l){if(s===l)return 0;for(let i=0;i<a.sortData.length;i++){var r=a.sortData[i].field,n=a.sortData[i].field_||r;let e=s[n],t=l[n];-1!=String(r).indexOf(".")&&(e=a.parseField(s,n),t=a.parseField(l,n));n=a.getColumn(r),r=(n&&0<Object.keys(n.editable).length&&(w2utils.isPlainObject(e)&&e.text&&(e=e.text),w2utils.isPlainObject(t)&&t.text&&(t=t.text)),o(e,t,i,a.sortData[i].direction,n.sortMode||"default"));if(0!==r)return r}return o(s.recid,l.recid,0,"asc")}function o(e,t,i,s,l){if(e===t)return 0;if((null==e||""===e)&&null!=t&&""!==t)return 1;if(null!=e&&""!==e&&(null==t||""===t))return-1;s="asc"===s.toLowerCase()?1:-1;if(typeof e!=typeof t)return typeof t<typeof e?s:-s;if(e.constructor.name!=t.constructor.name)return e.constructor.name>t.constructor.name?s:-s;e&&"object"==typeof e&&(e=e.valueOf()),t&&"object"==typeof t&&(t=t.valueOf());var r={}.toString;switch(e&&"object"==typeof e&&e.toString!=r&&(e=String(e)),t&&"object"==typeof t&&t.toString!=r&&(t=String(t)),"string"==typeof e&&(e=e.toLowerCase().trim()),"string"==typeof t&&(t=t.toLowerCase().trim()),l){case"natural":l=w2utils.naturalCompare;break;case"i18n":l=w2utils.i18nCompare}return"function"==typeof l?l(e,t)*s:t<e?s:e<t?-s:0}}}localSearch(t){let c=this;var i=this.url?.get??this.url;if(i)console.log("ERROR: grid.localSearch can only be used on local data source, grid.url should be empty.");else{let e=Date.now(),u={}.toString,l={};if(this.total=this.records.length,this.last.searchIds=[],this.prepareData(),0<this.searchData.length&&!i){for(let s=this.total=0;s<this.records.length;s++){var r=this.records[s];if(function i(l){let r=0,n,a,o,h;let d=!1;for(let e=0;e<c.searchData.length;e++){let i=c.searchData[e],s=c.getSearch(i.field);if(null!=i){null==s&&(s={field:i.field,type:i.type});let t=c.parseField(l,s.field);switch(n=null===t||void 0===t||"object"==typeof t&&t.toString==u?"":String(t).toLowerCase(),null!=i.value&&(Array.isArray(i.value)?(a=i.value[0],o=i.value[1]):a=String(i.value).toLowerCase()),i.operator){case"=":case"is":c.parseField(l,s.field)==i.value?r++:"date"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatDate(h,"yyyy-mm-dd"),a=w2utils.formatDate(w2utils.isDate(a,w2utils.settings.dateFormat,!0),"yyyy-mm-dd"),n==a&&r++):"time"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatTime(h,"hh24:mi"),a=w2utils.formatTime(a,"hh24:mi"),n==a&&r++):"datetime"==s.type&&(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatDateTime(h,"yyyy-mm-dd|hh24:mm:ss"),a=w2utils.formatDateTime(w2utils.isDateTime(a,w2utils.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),n==a&&r++);break;case"between":-1!=["int","float","money","currency","percent"].indexOf(s.type)?parseFloat(c.parseField(l,s.field))>=parseFloat(a)&&parseFloat(c.parseField(l,s.field))<=parseFloat(o)&&r++:"date"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.isDate(h,w2utils.settings.dateFormat,!0),a=w2utils.isDate(a,w2utils.settings.dateFormat,!0),null!=(o=w2utils.isDate(o,w2utils.settings.dateFormat,!0))&&(o=new Date(o.getTime()+864e5)),n>=a&&n<o&&r++):"time"==s.type?(n=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.isTime(a,!0),o=w2utils.isTime(o,!0),a=(new Date).setHours(a.hours,a.minutes,a.seconds||0,0),o=(new Date).setHours(o.hours,o.minutes,o.seconds||0,0),n>=a&&n<o&&r++):"datetime"==s.type&&(n=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.isDateTime(a,w2utils.settings.datetimeFormat,!0),o=(o=w2utils.isDateTime(o,w2utils.settings.datetimeFormat,!0))&&new Date(o.getTime()+864e5),n>=a&&n<o&&r++);break;case"<=":d=!0;case"<":case"less":-1!=["int","float","money","currency","percent"].indexOf(s.type)?(n=parseFloat(c.parseField(l,s.field)),a=parseFloat(i.value),(n<a||d&&n===a)&&r++):"date"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.isDate(h,w2utils.settings.dateFormat,!0),a=w2utils.isDate(a,w2utils.settings.dateFormat,!0),(n<a||d&&n===a)&&r++):"time"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatTime(h,"hh24:mi"),a=w2utils.formatTime(a,"hh24:mi"),(n<a||d&&n===a)&&r++):"datetime"==s.type&&(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatDateTime(h,"yyyy-mm-dd|hh24:mm:ss"),a=w2utils.formatDateTime(w2utils.isDateTime(a,w2utils.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),n.length==a.length&&(n<a||d&&n===a)&&r++);break;case">=":d=!0;case">":case"more":-1!=["int","float","money","currency","percent"].indexOf(s.type)?(n=parseFloat(c.parseField(l,s.field)),a=parseFloat(i.value),(n>a||d&&n===a)&&r++):"date"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.isDate(h,w2utils.settings.dateFormat,!0),a=w2utils.isDate(a,w2utils.settings.dateFormat,!0),(n>a||d&&n===a)&&r++):"time"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatTime(h,"hh24:mi"),a=w2utils.formatTime(a,"hh24:mi"),(n>a||d&&n===a)&&r++):"datetime"==s.type&&(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatDateTime(h,"yyyy-mm-dd|hh24:mm:ss"),a=w2utils.formatDateTime(w2utils.isDateTime(a,w2utils.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),n.length==a.length&&(n>a||d&&n===a)&&r++);break;case"in":h=i.value,-1===(h=i.svalue?i.svalue:h).indexOf(w2utils.isFloat(t)?parseFloat(t):t)&&-1===h.indexOf(n)||r++;break;case"not in":h=i.value,-1===(h=i.svalue?i.svalue:h).indexOf(w2utils.isFloat(t)?parseFloat(t):t)&&-1===h.indexOf(n)&&r++;break;case"begins":case"begins with":0===n.indexOf(a)&&r++;break;case"contains":0<=n.indexOf(a)&&r++;break;case"null":null==c.parseField(l,s.field)&&r++;break;case"not null":null!=c.parseField(l,s.field)&&r++;break;case"ends":case"ends with":let e=n.lastIndexOf(a);-1!==e&&e==n.length-a.length&&r++}}}if("OR"==c.last.logic&&0!==r||"AND"==c.last.logic&&r==c.searchData.length)return!0;if(l.w2ui&&l.w2ui.children&&!0!==l.w2ui.expanded)for(let t=0;t<l.w2ui.children.length;t++){let e=l.w2ui.children[t];if(i(e))return!0}return!1}(r))if(r&&r.w2ui&&!function e(t){let i=c.get(t,!0);if(null==i||null==t||l[t]||c.last.searchIds.includes(i))return;l[t]=!0;let s=c.records[i];s&&s.w2ui&&e(s.w2ui.parent_recid);c.last.searchIds.push(i)}(r.w2ui.parent_recid),0<this.showExtraOnSearch){let t=this.showExtraOnSearch,i=this.showExtraOnSearch;if(s<t&&(t=s),s+i>this.records.length&&(i=this.records.length-s),0<t)for(let e=s-t;e<s;e++)this.last.searchIds.indexOf(e)<0&&this.last.searchIds.push(e);if(this.last.searchIds.indexOf(s)<0&&this.last.searchIds.push(s),0<i)for(let e=s+1;e<=s+i;e++)this.last.searchIds.indexOf(e)<0&&this.last.searchIds.push(e)}else this.last.searchIds.push(s)}this.total=this.last.searchIds.length}return e=Date.now()-e,!0!==t&&this.show.statusSearch&&setTimeout(()=>{this.status(w2utils.lang("Search took ${count} seconds",{count:e/1e3}))},10),e}}getRangeData(e,i){var s=this.get(e[0].recid,!0),l=this.get(e[1].recid,!0),r=e[0].column,n=e[1].column;let a=[];if(r==n)for(let e=s;e<=l;e++){var t=this.records[e],o=t[this.columns[r].field]||null;!0!==i?a.push(o):a.push({data:o,column:r,index:e,record:t})}else if(s==l){var h=this.records[s];for(let e=r;e<=n;e++){var d=h[this.columns[e].field]||null;!0!==i?a.push(d):a.push({data:d,column:e,index:s,record:h})}}else for(let t=s;t<=l;t++){var u=this.records[t];a.push([]);for(let e=r;e<=n;e++){var c=u[this.columns[e].field];!0!==i?a[a.length-1].push(c):a[a.length-1].push({data:c,column:e,index:t,record:u})}}return a}addRange(s){let e=0,l,r;if("row"==this.selectType)return e;Array.isArray(s)||(s=[s]);for(let i=0;i<s.length;i++){if("object"!=typeof s[i]&&(s[i]={name:"selection"}),"selection"==s[i].name){if(!1===this.show.selectionBorder)continue;var n=this.getSelection();if(0===n.length){this.removeRange("selection");continue}l=n[0],r=n[n.length-1]}else l=s[i].range[0],r=s[i].range[1];if(l){n={name:s[i].name,range:[{recid:l.recid,column:l.column},{recid:r.recid,column:r.column}],style:s[i].style||""};let t=!1;for(let e=0;e<this.ranges.length;e++)if(this.ranges[e].name==s[i].name){t=e;break}!1!==t?this.ranges[t]=n:this.ranges.push(n),e++}}return this.refreshRanges(),e}removeRange(){let t=0;for(let e=0;e<arguments.length;e++){var i=arguments[e];query(this.box).find("#grid_"+this.name+"_"+i).remove(),query(this.box).find("#grid_"+this.name+"_f"+i).remove();for(let e=this.ranges.length-1;0<=e;e--)this.ranges[e].name==i&&(this.ranges.splice(e,1),t++)}return t}refreshRanges(){if(0!==this.ranges.length){let r=this,d;var e=Date.now();let u=query(this.box).find(`#grid_${this.name}_frecords`),c=query(this.box).find(`#grid_${this.name}_records`);for(let h=0;h<this.ranges.length;h++){var p=this.ranges[h];let e=p.range[0],t=p.range[1],i=(null==e.index&&(e.index=this.get(e.recid,!0)),null==t.index&&(t.index=this.get(t.recid,!0)),query(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(e.recid)+' td[col="'+e.column+'"]')),s=query(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t.recid)+' td[col="'+t.column+'"]'),l=query(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(e.recid)+' td[col="'+e.column+'"]'),r=query(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t.recid)+' td[col="'+t.column+'"]'),n=t.column;e.column<this.last.colStart&&t.column>this.last.colStart&&(i=query(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(e.recid)+' td[col="start"]')),e.column<this.last.colEnd&&t.column>this.last.colEnd&&(s=query(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t.recid)+' td[col="end"]'),n='"end"');var f=parseInt(query(this.box).find("#grid_"+this.name+"_rec_top").next().attr("index")),m=parseInt(query(this.box).find("#grid_"+this.name+"_rec_bottom").prev().attr("index")),g=parseInt(query(this.box).find("#grid_"+this.name+"_frec_top").next().attr("index")),y=parseInt(query(this.box).find("#grid_"+this.name+"_frec_bottom").prev().attr("index"));0===i.length&&e.index<f&&t.index>f&&(i=query(this.box).find("#grid_"+this.name+"_rec_top").next().find('td[col="'+e.column+'"]')),0===s.length&&t.index>m&&e.index<m&&(s=query(this.box).find("#grid_"+this.name+"_rec_bottom").prev().find('td[col="'+n+'"]')),0===l.length&&e.index<g&&t.index>g&&(l=query(this.box).find("#grid_"+this.name+"_frec_top").next().find('td[col="'+e.column+'"]')),0===r.length&&t.index>y&&e.index<y&&(r=query(this.box).find("#grid_"+this.name+"_frec_bottom").prev().find('td[col="'+t.column+'"]'));let a=query(this.box).find("#grid_"+this.name+"_editable"),o=a.find(".w2ui-input");var w,f=o.attr("recid"),m=o.attr("column");"selection"==p.name&&p.range[0].recid==f&&p.range[0].column==m||(d=query(this.box).find("#grid_"+this.name+"_f"+p.name),0<l.length||0<r.length?(0===d.length?(u.append('<div id="grid_'+this.name+"_f"+p.name+'" class="w2ui-selection" style="'+p.style+'">'+("selection"==p.name?'<div id="grid_'+this.name+'_resizer" class="w2ui-selection-resizer"></div>':"")+"</div>"),d=query(this.box).find("#grid_"+this.name+"_f"+p.name)):(d.attr("style",p.style),d.find(".w2ui-selection-resizer").show()),0===r.length&&(0===(r=query(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t.recid)+" td:last-child")).length&&(r=query(this.box).find("#grid_"+this.name+"_frec_bottom td:first-child")),d.css("border-right","0px"),d.find(".w2ui-selection-resizer").hide()),null!=e.recid&&null!=t.recid&&0<l.length&&0<r.length?(g=getComputedStyle(r[0]),y=l.prop("offsetTop")-l.prop("scrollTop"),f=l.prop("offsetLeft")+l.prop("scrollLeft"),m=r.prop("offsetTop")-r.prop("scrollTop"),w=r.prop("offsetLeft")+r.prop("scrollLeft"),d.show().css({top:(0<y?y:0)+"px",left:(0<f?f:0)+"px",width:w-f+parseFloat(g.width)+2+"px",height:m-y+parseFloat(g.height)+1+"px"})):d.hide()):d.hide(),d=query(this.box).find("#grid_"+this.name+"_"+p.name),0<i.length||0<s.length?(0===d.length?(c.append('<div id="grid_'+this.name+"_"+p.name+'" class="w2ui-selection" style="'+p.style+'">'+("selection"==p.name?'<div id="grid_'+this.name+'_resizer" class="w2ui-selection-resizer"></div>':"")+"</div>"),d=query(this.box).find("#grid_"+this.name+"_"+p.name)):d.attr("style",p.style),0===i.length&&0===(i=query(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(e.recid)+" td:first-child")).length&&(i=query(this.box).find("#grid_"+this.name+"_rec_top td:first-child")),0!==r.length&&d.css("border-left","0px"),null!=e.recid&&null!=t.recid&&0<i.length&&0<s.length?(w=getComputedStyle(s[0]),f=i.prop("offsetTop")-i.prop("scrollTop"),m=i.prop("offsetLeft")+i.prop("scrollLeft"),y=s.prop("offsetTop")-s.prop("scrollTop"),g=s.prop("offsetLeft")+s.prop("scrollLeft"),d.show().css({top:(0<f?f:0)+"px",left:(0<m?m:0)+"px",width:g-m+parseFloat(w.width)+2+"px",height:y-f+parseFloat(w.height)+1+"px"})):d.hide()):d.hide())}query(this.box).find(".w2ui-selection-resizer").off(".resizer").on("mousedown.resizer",function(e){var t=r.getSelection();r.last.move={type:"expand",x:e.screenX,y:e.screenY,divX:0,divY:0,recid:t[0].recid,column:t[0].column,originalRange:[w2utils.clone(t[0]),w2utils.clone(t[t.length-1])],newRange:[w2utils.clone(t[0]),w2utils.clone(t[t.length-1])]},query("body").off(".w2ui-"+r.name).on("mousemove.w2ui-"+r.name,i).on("mouseup.w2ui-"+r.name,s),e.preventDefault()}).on("dblclick.resizer",e=>{let t=this.trigger("resizerDblClick",{target:this.name,originalEvent:e});!0!==t.isCancelled&&t.finish()});let n={target:this.name,originalRange:null,newRange:null};return Date.now()-e;function i(s){let l=r.last.move;if(l&&"expand"==l.type){l.divX=s.screenX-l.x,l.divY=s.screenY-l.y;let e,t,i=s.target;"TD"!=i.tagName.toUpperCase()&&(i=query(i).closest("td")[0]),null!=(t=null!=query(i).attr("col")?parseInt(query(i).attr("col")):t)&&(i=query(i).closest("tr")[0],e=r.records[query(i).attr("index")].recid,l.newRange[1].recid==e&&l.newRange[1].column==t||(s=w2utils.clone(l.newRange),l.newRange=[{recid:l.recid,column:l.column},{recid:e,column:t}],n.detail&&(n.detail.newRange=w2utils.clone(l.newRange),n.detail.originalRange=w2utils.clone(l.originalRange)),!0===(n=r.trigger("selectionExtend",n)).isCancelled?(l.newRange=s,n.detail.newRange=s):(r.removeRange("grid-selection-expand"),r.addRange({name:"grid-selection-expand",range:l.newRange,style:"background-color: rgba(100,100,100,0.1); border: 2px dotted rgba(100,100,100,0.5);"}))))}}function s(e){r.removeRange("grid-selection-expand"),delete r.last.move,query("body").off(".w2ui-"+r.name),n.finish&&n.finish()}}}select(){if(0===arguments.length)return 0;let n=0,a=this.last.selection,t=(this.multiSelect||this.selectNone(!0),Array.from(arguments)),e=(Array.isArray(t[0])&&(t=t[0]),{target:this.name}),i=(1==t.length?(e.multiple=!1,w2utils.isPlainObject(t[0])?e.clicked={recid:t[0].recid,column:t[0].column}:e.recid=t[0]):(e.multiple=!0,e.clicked={recids:t}),this.trigger("select",e));if(!0===i.isCancelled)return 0;if("row"==this.selectType)for(let e=0;e<t.length;e++){var s="object"==typeof t[e]?t[e].recid:t[e],l=this.get(s,!0);if(null!=l){let e=null,t=null;(0!==this.searchData.length||l+1>=this.last.range_start&&l+1<=this.last.range_end)&&(e=query(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(s)),t=query(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(s))),"row"==this.selectType&&-1==a.indexes.indexOf(l)&&(a.indexes.push(l),e&&t&&(e.addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),t.addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),e.find(".w2ui-grid-select-check").prop("checked",!0)),n++)}}else{let l={};for(let e=0;e<t.length;e++){var o="object"==typeof t[e]?t[e].recid:t[e],h="object"==typeof t[e]?t[e].column:null;if(l[o]=l[o]||[],Array.isArray(h))l[o]=h;else if(w2utils.isInt(h))l[o].push(h);else for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||l[o].push(parseInt(e))}let r=[];for(var d in l){var u=this.get(d,!0);if(null!=u){let t=null,i=null,s=(u+1>=this.last.range_start&&u+1<=this.last.range_end&&(t=query(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(d)),i=query(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(d))),a.columns[u]||[]);-1==a.indexes.indexOf(u)&&a.indexes.push(u);for(let e=0;e<l[d].length;e++)-1==s.indexOf(l[d][e])&&s.push(l[d][e]);s.sort((e,t)=>e-t);for(let e=0;e<l[d].length;e++){var c=l[d][e];-1==r.indexOf(c)&&r.push(c),t&&(t.find("#grid_"+this.name+"_data_"+u+"_"+c).addClass("w2ui-selected"),t.find(".w2ui-col-number").addClass("w2ui-row-selected"),t.find(".w2ui-grid-select-check").prop("checked",!0)),i&&(i.find("#grid_"+this.name+"_data_"+u+"_"+c).addClass("w2ui-selected"),i.find(".w2ui-col-number").addClass("w2ui-row-selected"),i.find(".w2ui-grid-select-check").prop("checked",!0)),n++}a.columns[u]=s}}for(let e=0;e<r.length;e++)query(this.box).find("#grid_"+this.name+"_column_"+r[e]+" .w2ui-col-header").addClass("w2ui-col-selected")}a.indexes.sort((e,t)=>e-t);var r=0<this.records.length&&a.indexes.length==this.records.length,p=0<a.indexes.length&&0!==this.searchData.length&&a.indexes.length==this.last.searchIds.length;return r||p?query(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):query(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(a,r),i.finish(),n}unselect(){let l=0,r=this.last.selection,i=Array.from(arguments),e=(Array.isArray(i[0])&&(i=i[0]),{target:this.name}),t=(1==i.length?(e.multiple=!1,w2utils.isPlainObject(i[0])?e.clicked={recid:i[0].recid,column:i[0].column}:e.clicked={recid:i[0]}):(e.multiple=!0,e.recids=i),this.trigger("select",e));if(!0===t.isCancelled)return 0;for(let t=0;t<i.length;t++){var n="object"==typeof i[t]?i[t].recid:i[t],a=this.get(n);if(null!=a){a=this.get(a.recid,!0);let s=query(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(n)),e=query(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(n));if("row"==this.selectType)-1!=r.indexes.indexOf(a)&&(r.indexes.splice(r.indexes.indexOf(a),1),s.removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),e.removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),0!=s.length&&(s[0].style.cssText="height: "+this.recordHeight+"px; "+s.attr("custom_style"),e[0].style.cssText="height: "+this.recordHeight+"px; "+e.attr("custom_style")),s.find(".w2ui-grid-select-check").prop("checked",!1),l++);else{var o=i[t].column;if(!w2utils.isInt(o)){let t=[];for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||t.push({recid:n,column:e});return this.unselect(t)}let e=r.columns[a];if(Array.isArray(e)&&-1!=e.indexOf(o)){e.splice(e.indexOf(o),1),query(this.box).find(`#grid_${this.name}_rec_${w2utils.escapeId(n)} > td[col="${o}"]`).removeClass("w2ui-selected w2ui-inactive"),query(this.box).find(`#grid_${this.name}_frec_${w2utils.escapeId(n)} > td[col="${o}"]`).removeClass("w2ui-selected w2ui-inactive");let t=!1,i=!1;var h=this.getSelection();for(let e=0;e<h.length;e++)h[e].column==o&&(t=!0),h[e].recid==n&&(i=!0);t||query(this.box).find(`.w2ui-grid-columns td[col="${o}"] .w2ui-col-header, .w2ui-grid-fcolumns td[col="${o}"] .w2ui-col-header`).removeClass("w2ui-col-selected"),i||query(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(n)).find(".w2ui-col-number").removeClass("w2ui-row-selected"),l++,0===e.length&&(delete r.columns[a],r.indexes.splice(r.indexes.indexOf(a),1),s.find(".w2ui-grid-select-check").prop("checked",!1))}}}}var s=0<this.records.length&&r.indexes.length==this.records.length,d=0<r.indexes.length&&0!==this.searchData.length&&r.indexes.length==this.last.searchIds.length;return s||d?query(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):query(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(r,s),t.finish(),l}selectAll(){var t=Date.now();if(!1!==this.multiSelect){var l=this.url?.get??this.url;let i=w2utils.clone(this.last.selection),s=[];for(let e=0;e<this.columns.length;e++)s.push(e);if(i.indexes=[],l||0===this.searchData.length){let t=this.records.length;0==this.searchData.length||l||(t=this.last.searchIds.length);for(let e=0;e<t;e++)i.indexes.push(e),"row"!=this.selectType&&(i.columns[e]=s.slice())}else for(let e=0;e<this.last.searchIds.length;e++)i.indexes.push(this.last.searchIds[e]),"row"!=this.selectType&&(i.columns[this.last.searchIds[e]]=s.slice());let e=this.trigger("select",{target:this.name,multiple:!0,all:!0,clicked:i});if(!0!==e.isCancelled)return this.last.selection=i,"row"==this.selectType?(query(this.box).find(".w2ui-grid-records tr:not(.w2ui-empty-record)").addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected"),query(this.box).find(".w2ui-grid-frecords tr:not(.w2ui-empty-record)").addClass("w2ui-selected").find(".w2ui-col-number").addClass("w2ui-row-selected")):(query(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").addClass("w2ui-col-selected"),query(this.box).find(".w2ui-grid-records tr .w2ui-col-number").addClass("w2ui-row-selected"),query(this.box).find(".w2ui-grid-records tr:not(.w2ui-empty-record)").find(".w2ui-grid-data:not(.w2ui-col-select)").addClass("w2ui-selected"),query(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").addClass("w2ui-row-selected"),query(this.box).find(".w2ui-grid-frecords tr:not(.w2ui-empty-record)").find(".w2ui-grid-data:not(.w2ui-col-select)").addClass("w2ui-selected")),query(this.box).find("input.w2ui-grid-select-check").prop("checked",!0),i=this.getSelection(!0),this.addRange("selection"),query(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0),this.status(),this.updateToolbar({indexes:i},!0),e.finish(),Date.now()-t}}selectNone(t){var i=Date.now();let s;if(t||!0!==(s=this.trigger("select",{target:this.name,clicked:[]})).isCancelled){let e=this.last.selection;return"row"==this.selectType?(query(this.box).find(".w2ui-grid-records tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected"),query(this.box).find(".w2ui-grid-frecords tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").find(".w2ui-col-number").removeClass("w2ui-row-selected")):(query(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").removeClass("w2ui-col-selected"),query(this.box).find(".w2ui-grid-records tr .w2ui-col-number").removeClass("w2ui-row-selected"),query(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").removeClass("w2ui-row-selected"),query(this.box).find(".w2ui-grid-data.w2ui-selected").removeClass("w2ui-selected w2ui-inactive")),query(this.box).find("input.w2ui-grid-select-check").prop("checked",!1),e.indexes=[],e.columns={},this.removeRange("selection"),query(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.updateToolbar(e,!1),t||s.finish(),Date.now()-i}}updateToolbar(s){let l=this,r=s&&s.indexes?s.indexes.length:0;function i(t,i){if(null!=t.batch){let e=!1;!0===t.batch?0<r&&(e=!0):"number"==typeof t.batch?r===t.batch&&(e=!0):"function"==typeof t.batch&&(e=t.batch({cnt:r,sel:s})),e?l.toolbar.enable(i+t.id):l.toolbar.disable(i+t.id)}}this.toolbar.items.forEach(t=>{i(t,""),Array.isArray(t.items)&&t.items.forEach(e=>{i(e,t.id+":")})}),this.show.toolbarSave&&(0<this.getChanges().length?this.toolbar.enable("w2ui-save"):this.toolbar.disable("w2ui-save"))}getSelection(t){let i=[];var s=this.last.selection;if("row"==this.selectType){for(let e=0;e<s.indexes.length;e++)this.records[s.indexes[e]]&&(!0===t?i.push(s.indexes[e]):i.push(this.records[s.indexes[e]].recid));return i}for(let t=0;t<s.indexes.length;t++){var l=s.columns[s.indexes[t]];if(this.records[s.indexes[t]])for(let e=0;e<l.length;e++)i.push({recid:this.records[s.indexes[t]].recid,index:parseInt(s.indexes[t]),column:l[e]})}return i}search(l,r){var i,s,e=this.url?.get??this.url;let a=[],o=this.last.multi,t=this.last.logic,n=this.last.field,h=this.last.search,d=!1,u=query(`#w2overlay-${this.name}-search-overlay`);for(let e=0;e<this.searches.length;e++)this.searches[e].hidden&&null!=this.searches[e].value&&(a.push({field:this.searches[e].field,operator:this.searches[e].operator||"is",type:this.searches[e].type,value:this.searches[e].value||""}),d=!0);if(0===arguments.length&&0===u.length&&(r=this.multiSearch?(l=this.searchData,this.last.logic):(l=this.last.field,this.last.search)),0===arguments.length&&0!==u.length){this.focus(),t=u.find(`#grid_${this.name}_logic`).val(),h="";for(let e=0;e<this.searches.length;e++){var c=this.searches[e],p=u.find("#grid_"+this.name+"_operator_"+e).val();let i=u.find("#grid_"+this.name+"_field_"+e),s=u.find("#grid_"+this.name+"_field2_"+e),l=i.val(),r=s.val(),t=null,n=null;if(-1!=["int","float","money","currency","percent"].indexOf(c.type)){let e=i[0]._w2field,t=s[0]._w2field;e&&(l=e.clean(l)),t&&(r=t.clean(r))}if(-1!=["list","enum"].indexOf(c.type)||-1!=["in","not in"].indexOf(p))if(l=i[0]._w2field.selected||{},Array.isArray(l)){t=[];for(let e=0;e<l.length;e++)t.push(w2utils.isFloat(l[e].id)?parseFloat(l[e].id):String(l[e].id).toLowerCase()),delete l[e].hidden;0===Object.keys(l).length&&(l="")}else n=l.text||"",l=l.id||"";if(""!==l&&null!=l||null!=r&&""!==r){let e={field:c.field,type:c.type,operator:p};"between"==p?w2utils.extend(e,{value:[l,r]}):"in"==p&&"string"==typeof l||"not in"==p&&"string"==typeof l?w2utils.extend(e,{value:l.split(",")}):w2utils.extend(e,{value:l}),t&&w2utils.extend(e,{svalue:t}),n&&w2utils.extend(e,{text:n});try{"date"==c.type&&"between"==p&&(e.value[0]=l,e.value[1]=r),"date"==c.type&&"is"==p&&(e.value=l)}catch(e){}a.push(e),o=!0}}}if("string"==typeof l&&(1==arguments.length&&(r=l,l="all"),n=l,h=r,o=!1,t=d?"AND":"OR",null!=r))if("all"==l.toLowerCase())if(0<this.searches.length)for(let t=0;t<this.searches.length;t++){let e=this.searches[t];if(("text"==e.type||"alphanumeric"==e.type&&w2utils.isAlphaNumeric(r)||"int"==e.type&&w2utils.isInt(r)||"float"==e.type&&w2utils.isFloat(r)||"percent"==e.type&&w2utils.isFloat(r)||("hex"==e.type||"color"==e.type)&&w2utils.isHex(r)||"currency"==e.type&&w2utils.isMoney(r)||"money"==e.type&&w2utils.isMoney(r)||"date"==e.type&&w2utils.isDate(r)||"time"==e.type&&w2utils.isTime(r)||"datetime"==e.type&&w2utils.isDateTime(r)||"datetime"==e.type&&w2utils.isDate(r)||"enum"==e.type&&w2utils.isAlphaNumeric(r)||"list"==e.type&&w2utils.isAlphaNumeric(r))&&(i=this.defaultOperator[this.operatorsMap[e.type]],i={field:e.field,type:e.type,operator:null!=e.operator?e.operator:i,value:r},""!=String(r).trim()&&a.push(i)),-1!=["int","float","money","currency","percent"].indexOf(e.type)&&2==String(r).trim().split("-").length&&(i=String(r).trim().split("-"),s={field:e.field,type:e.type,operator:null!=e.operator?e.operator:"between",value:[i[0],i[1]]},a.push(s)),-1!=["list","enum"].indexOf(e.type)){let i=[];null==e.options&&(e.options={}),Array.isArray(e.options.items)||(e.options.items=[]);for(let t=0;t<e.options.items;t++){var f=e.options.items[t];try{let e=new RegExp(r,"i");e.test(f)&&i.push(t),f.text&&e.test(f.text)&&i.push(f.id)}catch(e){}}0<i.length&&(s={field:e.field,type:e.type,operator:null!=e.operator?e.operator:"in",value:i},a.push(s))}}else for(let e=0;e<this.columns.length;e++){var m={field:this.columns[e].field,type:"text",operator:this.defaultOperator.text,value:r};a.push(m)}else{let i=u.find("#grid_"+this.name+"_search_all"),s=this.getSearch(l);if((s=null==s?{field:l,type:"text"}:s).field==l&&(this.last.label=s.label),""!==r){let e=this.defaultOperator[this.operatorsMap[s.type]],t=r;if(-1!=["date","time","datetime"].indexOf(s.type)&&(e="is"),-1!=["list","enum"].indexOf(s.type)&&(e="is",y=i._w2field.get(),t=y&&0<Object.keys(y).length?y.id:""),"int"==s.type&&""!==r)if(e="is",-1==String(r).indexOf("-")||2==(y=r.split("-")).length&&(e="between",t=[parseInt(y[0]),parseInt(y[1])]),-1!=String(r).indexOf(",")){var g=r.split(",");e="in",t=[];for(let e=0;e<g.length;e++)t.push(g[e])}null!=s.operator&&(e=s.operator);var y={field:s.field,type:s.type,operator:e,value:t};a.push(y)}}if(Array.isArray(l)){let e="AND";"string"==typeof r&&"OR"!=(e=r.toUpperCase())&&"AND"!=e&&(e="AND"),h="",o=!0,t=e;for(let t=0;t<l.length;t++){let e=l[t];"number"==typeof e.value&&null==e.operator&&(e.operator=this.defaultOperator.number),"string"==typeof e.value&&null==e.operator&&(e.operator=this.defaultOperator.text),Array.isArray(e.value)&&null==e.operator&&(e.operator=this.defaultOperator.enum),w2utils.isDate(e.value)&&null==e.operator&&(e.operator=this.defaultOperator.date),a.push(e)}}let w=this.trigger("search",{target:this.name,multi:0===arguments.length,searchField:l||"multi",searchValue:l?r:"multi",searchData:a,searchLogic:t});!0!==w.isCancelled&&(this.searchData=w.detail.searchData,this.last.field=n,this.last.search=h,this.last.multi=o,this.last.logic=w.detail.searchLogic,this.last.scrollTop=0,this.last.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose(),e?(this.last.fetch.offset=0,this.reload()):(this.localSearch(),this.refresh()),w.finish())}searchOpen(){if(this.box&&0!==this.searches.length){let s=this.trigger("searchOpen",{target:this.name});if(!0!==s.isCancelled){let t=query(this.toolbar.box).find(".w2ui-grid-search-input .w2ui-search-drop");t.addClass("checked"),w2tooltip.show({name:this.name+"-search-overlay",anchor:query(this.box).find("#grid_"+this.name+"_search_all").get(0),position:"bottom|top",html:this.getSearchesHTML(),align:"left",arrowSize:12,class:"w2ui-grid-search-advanced",hideOn:["doc-click"]}).then(e=>{this.initSearches(),this.last.search_opened=!0;let t=query(`#w2overlay-${this.name}-search-overlay`),i=(t.data("gridName",this.name).off(".grid-search").on("click.grid-search",()=>{t.find("input, select").each(e=>{let t=query(e).data("tooltipName");t&&t.forEach(e=>{w2tooltip.hide(e)})})}),w2utils.bindEvents(t.find("select, input, button"),this),query(`#w2overlay-${this.name}-search-overlay *[rel=search]`));0<i.length&&i[0].focus(),s.finish()}).hide(e=>{t.removeClass("checked"),this.last.search_opened=!1})}}}searchClose(){w2tooltip.hide(this.name+"-search-overlay")}searchFieldTooltip(e,t,i){e=this.searches[e];let s=this.searchData[t],l=s.operator,r=("less"==(l="more"==l&&"date"==s.type?"since":l)&&"date"==s.type&&(l="before"),""),n=s.value;Array.isArray(s.value)?(s.value.forEach(e=>{r+=`<span class="value">${e.text||e}</span>`}),"date"==s.type&&(r="",s.value.forEach(e=>{r+=`<span class="value">${w2utils.formatDate(e)}</span>`}))):"date"==s.type&&(n=w2utils.formatDateTime(n)),w2tooltip.hide(this.name+"-search-props"),w2tooltip.show({name:this.name+"-search-props",anchor:i,class:"w2ui-white",hideOn:"doc-click",html:`
                <div class="w2ui-grid-search-single">
                    <span class="field">${e.label}</span>
                    <span class="operator">${w2utils.lang(l)}</span>
                    ${Array.isArray(s.value)?""+r:`<span class="value">${n}</span>`}
                    <div class="buttons">
                        <button id="remove" class="w2ui-btn">${w2utils.lang("Remove This Field")}</button>
                    </div>
                </div>`}).then(e=>{query(e.detail.overlay.box).find("#remove").on("click",()=>{this.searchData.splice(""+t,1),this.reload(),this.localSearch(),w2tooltip.hide(this.name+"-search-props")})})}searchSuggest(e,t,i){clearTimeout(this.last.kbd_timer),clearTimeout(this.last.overlay_timer),this.searchShowFields(!0),this.searchClose(),!0===t?w2tooltip.hide(this.name+"-search-suggest"):0<query(`#w2overlay-${this.name}-search-suggest`).length||(e?(t=query(this.box).find(`#grid_${this.name}_search_all`).get(0),e=[...this.defaultSearches??[],...0<this.defaultSearches?.length&&0<this.savedSearches?.length?["--"]:[],...this.savedSearches??[]],Array.isArray(e)&&0<e.length&&w2menu.show({name:this.name+"-search-suggest",anchor:t,align:"both",items:e,hideOn:["doc-click","sleect","remove"],render(e){let t=e.text;return t=e.isDefault?`<b>${t}</b>`:t}}).select(e=>{let t=this.trigger("searchSelect",{target:this.name,index:e.detail.index,item:e.detail.item});!0===t.isCancelled?e.preventDefault():(e.detail.overlay.hide(),this.last.logic=e.detail.item.logic||"AND",this.last.search="",this.last.label="[Multiple Fields]",this.searchData=w2utils.clone(e.detail.item.data),this.searchSelected=w2utils.clone(e.detail.item,{exclude:["icon","remove"]}),this.reload(),t.finish())}).remove(e=>{let i=e.detail.item,s=this.trigger("searchRemove",{target:this.name,index:e.detail.index,item:i});!0===s.isCancelled?e.preventDefault():(e.detail.overlay.hide(),this.confirm(w2utils.lang('Do you want to delete search "${item}"?',{item:i.text})).yes(e=>{var t=this.savedSearches.findIndex(e=>e.id==i.id);-1!==t&&this.savedSearches.splice(t,1),this.cacheSave("searches",this.savedSearches.map(e=>w2utils.clone(e,{exclude:["remove","icon"]}))),e.detail.self.close(),s.finish()}).no(e=>{e.detail.self.close()}))})):this.last.overlay_timer=setTimeout(()=>{this.searchSuggest(!0)},100))}searchSave(){let e="",t=(this.searchSelected&&(e=this.searchSelected.text),this.savedSearches.findIndex(e=>e.id==this.searchSelected?.id)),s=this.trigger("searchSave",{target:this.name,saveLocalStorage:!0});!0!==s.isCancelled&&this.message({width:350,height:150,body:`<div class="w2ui-grid-save-search">
                        <span>${w2utils.lang(-1!=t?"Update Search":"Save New Search")}</span>
                        <input class="search-name w2ui-input" placeholder="${w2utils.lang("Search name")}">
                   </div>`,buttons:`
                <button id="grid-search-cancel" class="w2ui-btn">${w2utils.lang("Cancel")}</button>
                <button id="grid-search-save" class="w2ui-btn w2ui-btn-blue" ${""==String(e).trim()?"disabled":""}>${w2utils.lang("Save")}</button>
            `}).open(async i=>{query(i.detail.box).find("input, button").eq(0).val(e),await i.complete,query(i.detail.box).find("#grid-search-cancel").on("click",()=>{this.message()}),query(i.detail.box).find("#grid-search-save").on("click",()=>{var e=query(i.detail.box).find(".w2ui-message .search-name").val();this.searchSelected&&-1!=t?Object.assign(this.savedSearches[t],{id:e,text:e,logic:this.last.logic,data:w2utils.clone(this.searchData)}):this.savedSearches.push({id:e,text:e,icon:"w2ui-icon-search",remove:!0,logic:this.last.logic,data:this.searchData}),this.cacheSave("searches",this.savedSearches.map(e=>w2utils.clone(e,{exclude:["remove","icon"]}))),this.message(),this.searchSelected?(this.searchSelected.text=e,query(this.box).find(`#grid_${this.name}_search_name .name-text`).html(e)):(this.searchSelected={text:e,logic:this.last.logic,data:w2utils.clone(this.searchData)},query(i.detail.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),query(i.detail.box).find(`#grid_${this.name}_search_name`).show().find(".name-text").html(e)),s.finish({name:e})}),query(i.detail.box).find("input, button").off(".message").on("keydown.message",e=>{var t=String(query(i.detail.box).find(".w2ui-message-body input").val()).trim();13==e.keyCode&&""!=t&&query(i.detail.box).find("#grid-search-save").trigger("click"),27==e.keyCode&&this.message()}).eq(0).on("input.message",e=>{let t=query(i.detail.box).closest(".w2ui-message").find("#grid-search-save");""===String(query(i.detail.box).val()).trim()?t.prop("disabled",!0):t.prop("disabled",!1)}).get(0).focus()})}cache(t){if(w2utils.hasLocalStorage&&this.useLocalStorage)try{let e=JSON.parse(localStorage.w2ui||"{}");return e[this.stateId||this.name]??={},e[this.stateId||this.name][t]}catch(e){}return null}cacheSave(t,i){if(w2utils.hasLocalStorage&&this.useLocalStorage)try{let e=JSON.parse(localStorage.w2ui||"{}");return e[this.stateId||this.name]??={},e[this.stateId||this.name][t]=i,localStorage.w2ui=JSON.stringify(e),!0}catch(e){delete localStorage.w2ui}return!1}searchReset(i){let t=[],s=!1;for(let e=0;e<this.searches.length;e++)this.searches[e].hidden&&null!=this.searches[e].value&&(t.push({field:this.searches[e].field,operator:this.searches[e].operator||"is",type:this.searches[e].type,value:this.searches[e].value||""}),s=!0);let l=this.trigger("search",{reset:!0,target:this.name,searchData:t});if(!0!==l.isCancelled){let e=query(this.box).find("#grid_"+this.name+"_search_all");if(this.searchData=l.detail.searchData,this.searchSelected=null,this.last.search="",this.last.logic=s?"AND":"OR",e.next().hide(),0<this.searches.length)if(this.multiSearch&&this.show.searchAll)this.last.field="all",this.last.label="All Fields",e.next().show();else{let e=0;for(;e<this.searches.length&&(this.searches[e].hidden||!1===this.searches[e].simple);)e++;e>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[e].field,this.last.label=this.searches[e].label)}this.last.multi=!1,this.last.fetch.offset=0,this.last.scrollTop=0,this.last.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose();let t=e.val("").get(0);t._w2field&&t._w2field.reset(),i||this.reload(),l.finish()}}searchShowFields(e){if(!0===e)w2tooltip.hide(this.name+"-search-fields");else{let l=[];for(let s=-1;s<this.searches.length;s++){let e=this.searches[s];var r=e?e.field:null,r=this.getColumn(r);let t=!1,i=null;if(1==this.show.searchHiddenMsg&&-1!=s&&(null==r||!0===r.hidden&&!1!==r.hideable)&&(t=!0,i=w2utils.lang("This column "+(null==r?"does not exist":"is hidden"))),-1==s){if(!this.multiSearch||!this.show.searchAll)continue;e={field:"all",label:"All Fields"}}else{if(null!=r&&!1===r.hideable)continue;if(!0===e.hidden&&(i=w2utils.lang("This column is hidden"),!1===e.simple))continue}null==e.label&&null!=e.caption&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",e),e.label=e.caption),l.push({id:e.field,text:w2utils.lang(e.label),search:e,tooltip:i,disabled:t,checked:e.field==this.last.field})}w2menu.show({type:"radio",name:this.name+"-search-fields",anchor:query(this.box).find("#grid_"+this.name+"_search_name").parent().find(".w2ui-search-down").get(0),items:l,align:"none",hideOn:["doc-click","select"]}).select(e=>{this.searchInitInput(e.detail.item.search.field)})}}searchInitInput(e,t){let i,s=query(this.box).find("#grid_"+this.name+"_search_all");if("all"==e)i={field:"all",label:w2utils.lang("All Fields")};else if(null==(i=this.getSearch(e)))return;""!=this.last.search?(this.last.label=i.label,this.search(i.field,this.last.search)):(this.last.field=i.field,this.last.label=i.label),s.attr("placeholder",w2utils.lang("Search")+" "+w2utils.lang(i.label||i.caption||i.field,!0))}clear(e){this.total=0,this.records=[],this.summary=[],this.last.fetch.offset=0,this.last.idCache={},this.last.selection={indexes:[],columns:{}},this.reset(!0),e||this.refresh()}reset(e){this.last.scrollTop=0,this.last.scrollLeft=0,this.last.range_start=null,this.last.range_end=null,query(this.box).find(`#grid_${this.name}_records`).prop("scrollTop",0),e||this.refresh()}skip(e,t){this.url?.get??this.url?(this.offset=parseInt(e),this.offset>this.total&&(this.offset=this.total-this.limit),(this.offset<0||!w2utils.isInt(this.offset))&&(this.offset=0),this.clear(!0),this.reload(t)):console.log("ERROR: grid.skip() can only be called when you have remote data source.")}load(e,t){return null==e?(console.log('ERROR: You need to provide url argument when calling .load() method of "'+this.name+'" object.'),new Promise((e,t)=>{t()})):(this.clear(!0),this.request("load",{},e,t))}reload(e){let t=this;var i=this.url?.get??this.url;return t.selectionSave(),i?this.load(i,()=>{t.selectionRestore(),"function"==typeof e&&e()}):(this.reset(!0),this.localSearch(),this.selectionRestore(),"function"==typeof e&&e({status:"success"}),new Promise(e=>{e()}))}request(i,e,t,s){let l=this,r,n;var a=new Promise((e,t)=>{r=e,n=t});if(null==e&&(e={}),!(t=t||this.url))return new Promise((e,t)=>{t()});w2utils.isInt(this.offset)||(this.offset=0),w2utils.isInt(this.last.fetch.offset)||(this.last.fetch.offset=0);let o,h={limit:this.limit,offset:parseInt(this.offset)+parseInt(this.last.fetch.offset),searchLogic:this.last.logic,search:this.searchData.map(e=>{let t=w2utils.clone(e);return this.searchMap&&this.searchMap[t.field]&&(t.field=this.searchMap[t.field]),t}),sort:this.sortData.map(e=>{let t=w2utils.clone(e);return this.sortMap&&this.sortMap[t.field]&&(t.field=this.sortMap[t.field]),t})};if(0===this.searchData.length&&(delete h.search,delete h.searchLogic),0===this.sortData.length&&delete h.sort,w2utils.extend(h,this.postData),w2utils.extend(h,e),"delete"!=i&&"save"!=i||(delete h.limit,delete h.offset,"delete"==(h.action=i)&&(h[this.recid||"recid"]=this.getSelection())),"load"==i){if(!0===(o=this.trigger("request",{target:this.name,url:t,postData:h,httpHeaders:this.httpHeaders})).isCancelled)return new Promise((e,t)=>{t()})}else o={detail:{url:t,postData:h,httpHeaders:this.httpHeaders}};if(0===this.last.fetch.offset&&this.lock(w2utils.lang(this.msgRefresh),!0),this.last.fetch.controller)try{this.last.fetch.controller.abort()}catch(e){}switch(t=o.detail.url,i){case"save":t?.save&&(t=t.save);break;case"delete":t?.remove&&(t=t.remove);break;default:t=t?.get??t}if(0<Object.keys(this.routeData).length){var d=w2utils.parseRoute(t);if(0<d.keys.length)for(let e=0;e<d.keys.length;e++)null!=this.routeData[d.keys[e].name]&&(t=t.replace(new RegExp(":"+d.keys[e].name,"g"),this.routeData[d.keys[e].name]))}t=new URL(t,location);let u={method:"GET",headers:o.detail.httpHeaders},c=o.detail.postData;e=o.detail.dataType??this.dataType??w2utils.settings.dataType;switch(e){case"HTTP":case"RESTFULL":Object.keys(c).forEach(e=>t.searchParams.append(e,c[e]));break;case"HTTPJSON":case"RESTFULLJSON":c={request:JSON.stringify(c)},Object.keys(c).forEach(e=>t.searchParams.append(e,c[e]));break;case"JSON":u.method="POST",u.body=JSON.stringify(c),u.headers.contentType="application/json"}return["RESTFULL","RESTFULLJSON"].includes(e)&&("save"==i&&(u.method="PUT"),"delete"==i&&(u.method="DELETE"),u.body=JSON.stringify(c)),this.method&&(u.method=this.method),o.detail.method&&(u.method=o.detail.method),Object.assign(this.last.fetch,{action:i,options:u,controller:new AbortController,start:Date.now(),loaded:!1}),u.signal=this.last.fetch.controller.signal,fetch(t,u).catch(p).then(e=>{null!=e&&(200!=e?.status?p(e??{}):(l.unlock(),e.json().catch(p).then(e=>{this.requestComplete(e,i,s,r,n)})))}),"load"==i&&o.finish(),a;function p(t){if("AbortError"!==t?.name){l.unlock();let e=l.trigger("error",{response:t,lastFetch:l.last.fetch});!0!==e.isCancelled&&(t.status&&200!=t.status?l.error(t.status+": "+t.statusText):(console.log("ERROR: Server communication failed.","\n   EXPECTED:",{total:5,records:[{recid:1,field:"value"}]},"\n         OR:",{error:!0,message:"error message"}),l.requestComplete({error:!0,message:"HTTP Request error",response:t},i,s,r,n)),e.finish())}}}requestComplete(e,t,i,s,l){let r=e.error??!1,n=(null==e.error&&"error"===e.status&&(r=!0),this.last.fetch.response=(Date.now()-this.last.fetch.start)/1e3,setTimeout(()=>{this.show.statusResponse&&this.status(w2utils.lang("Server Response ${count} seconds",{count:this.last.fetch.response}))},10),this.last.pull_more=!1,this.last.pull_refresh=!0,"load"),a=("save"==this.last.fetch.action&&(n="save"),"delete"==this.last.fetch.action&&(n="delete"),this.trigger(n,{target:this.name,error:r,data:e,lastFetch:this.last.fetch}));if(!0===a.isCancelled)l();else{if(r)e={error:r,data:e,message:w2utils.lang(this.msgHTTPError)},this.error(w2utils.lang(this.msgHTTPError)),l(e);else if("function"==typeof this.parser?"object"!=typeof(e=this.parser(e))&&console.log("ERROR: Your parser did not return proper object"):null==e?e={error:!0,message:w2utils.lang(this.msgNotJSON)}:Array.isArray(e)&&(e={error:r,records:e,total:e.length}),e.error)this.error(e.message);else if("load"==t){if(null==e.total&&(e.total=-1),null==e.records&&(e.records=[]),e.records.length==this.limit?(l=this.records.length+e.records.length,this.last.fetch.hasMore=l!=this.total):(this.last.fetch.hasMore=!1,this.total=this.offset+this.last.fetch.offset+e.records.length),this.last.fetch.hasMore||query(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more").hide(),0===this.last.fetch.offset)this.records=[],this.summary=[];else if(-1!=e.total&&parseInt(e.total)!=parseInt(this.total)){let e=this;return this.message(w2utils.lang(this.msgNeedReload)).ok(()=>{delete e.last.fetch.offset,e.reload()}),new Promise(e=>{e()})}w2utils.isInt(e.total)&&(this.total=parseInt(e.total)),e.records&&e.records.forEach(e=>{this.recid&&(e.recid=this.parseField(e,this.recid)),null==e.recid&&(e.recid="recid-"+this.records.length),(e.w2ui&&!0===e.w2ui.summary?this.summary:this.records).push(e)}),e.summary&&(this.summary=[],e.summary.forEach(e=>{this.recid&&(e.recid=this.parseField(e,this.recid)),null==e.recid&&(e.recid="recid-"+this.summary.length),this.summary.push(e)}))}else if("delete"==t)return this.reset(),this.reload();(this.url?.get??this.url)||(this.localSort(),this.localSearch()),this.total=parseInt(this.total),0===this.last.fetch.offset?this.refresh():(this.scroll(),this.resize()),"function"==typeof i&&i(e),s(e),a.finish(),this.last.fetch.loaded=!0}}error(e){let t=this.trigger("error",{target:this.name,message:e});!0!==t.isCancelled&&(this.message(e),t.finish())}getChanges(t){let i=[];void 0===t&&(t=this.records);for(let e=0;e<t.length;e++){var s=t[e];if(s.w2ui){if(null!=s.w2ui.changes){let e={};e[this.recid||"recid"]=s.recid,i.push(w2utils.extend(e,s.w2ui.changes))}!0!==s.w2ui.expanded&&s.w2ui.children&&s.w2ui.children.length&&i.push(...this.getChanges(s.w2ui.children))}}return i}mergeChanges(){let i=this.getChanges();for(let t=0;t<i.length;t++){let e=this.get(i[t][this.recid||"recid"]);for(var s in i[t])if(!("recid"==s||this.recid&&s==this.recid)){"object"==typeof i[t][s]&&(i[t][s]=i[t][s].text);try{!function e(t,i,s){let l=i.split(".");1==l.length?t[i]=s:(t=t[l[0]],l.shift(),e(t,l.join("."),s))}(e,s,i[t][s])}catch(e){console.log("ERROR: Cannot merge. ",e.message||"",e)}e.w2ui&&delete e.w2ui.changes}}this.refresh()}save(t){var e=this.getChanges(),i=this.url?.save??this.url;let s=this.trigger("save",{target:this.name,changes:e});!0!==s.isCancelled&&(i?this.request("save",{changes:s.detail.changes},null,e=>{e.error||this.mergeChanges(),s.finish(),"function"==typeof t&&t(e)}):(this.mergeChanges(),s.finish()))}editField(c,p,f,m){let g=this;if(!0===this.last.inEditMode)if(m&&13==m.keyCode){var{index:y,column:w,value:b}=this.last._edit;this.editChange({type:"custom",value:b},y,w,m),this.editDone(y,w,m)}else{let e=query(this.box).find("div.w2ui-edit-box .w2ui-input");0<e.length&&("DIV"==e.get(0).tagName?(e.text(e.text()+f),w2utils.setCursorPosition(e.get(0),e.text().length)):(e.val(e.val()+f),w2utils.setCursorPosition(e.get(0),e.val().length)))}else{let d=this.get(c,!0),u=this.getCellEditable(d,p);if(u&&!["checkbox","check"].includes(u.type)){let o=this.records[d],h=this.columns[p];b=!0===h.frozen?"_f":"_";if(-1!=["list","enum","file"].indexOf(u.type))console.log('ERROR: input types "list", "enum" and "file" are not supported in inline editing.');else{let a=this.trigger("editField",{target:this.name,recid:c,column:p,value:f,index:d,originalEvent:m});if(!0!==a.isCancelled){f=a.detail.value,this.last.inEditMode=!0,this.last.editColumn=p,this.last._edit={value:f,index:d,column:p,recid:c},this.selectNone(!0),this.select({recid:c,column:p});let e=query(this.box).find("#grid_"+this.name+b+"rec_"+w2utils.escapeId(c)),t=e.find('[col="'+p+'"] > div'),i=(this.last._edit.tr=e,this.last._edit.div=t,query(this.box).find("div.w2ui-edit-box").remove(),"row"!=this.selectType&&(query(this.box).find("#grid_"+this.name+b+"selection").attr("id","grid_"+this.name+"_editable").removeClass("w2ui-selection").addClass("w2ui-edit-box").prepend('<div style="position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px;"></div>').find(".w2ui-selection-resizer").remove(),t=query(this.box).find("#grid_"+this.name+"_editable > div:first-child")),u.attr=u.attr??"",u.text=u.text??"",u.style=u.style??"",u.items=u.items??[],null!=o.w2ui?.changes?.[h.field]?w2utils.stripTags(o.w2ui.changes[h.field]):w2utils.stripTags(g.parseField(o,h.field))),s="object"!=typeof(i=null==i?"":i)?i:"",l=(null!=a.detail.prevValue&&(s=a.detail.prevValue),null!=f&&(i=f),null!=h.style?h.style+";":"");"string"==typeof h.render&&["number","int","float","money","percent","size"].includes(h.render.split(":")[0])&&(l+="text-align: right;"),0<u.items.length&&!w2utils.isPlainObject(u.items[0])&&(u.items=w2utils.normMenu(u.items));let r,n=["date","time","datetime","color","list","combo"];y=getComputedStyle(e.find('[col="'+p+'"] > div').get(0)),w=`font-family: ${y["font-family"]}; font-size: ${y["font-size"]};`;function v(e){try{var t=getComputedStyle(e),i="DIV"==e.tagName.toUpperCase()?e.innerText:e.value,s=query(g.box).find("#grid_"+g.name+"_editable").get(0),l=`font-family: ${t["font-family"]}; font-size: ${t["font-size"]}; white-space: no-wrap;`,r=w2utils.getStrWidth(i,l);r+20>s.clientWidth&&query(s).css("width",r+20+"px")}catch(e){}}"div"===u.type?(t.addClass("w2ui-editable").html(w2utils.stripSpaces(`<div id="grid_${this.name}_edit_${c}_${p}" class="w2ui-input w2ui-focus"
                        contenteditable autocorrect="off" autocomplete="off" spellcheck="false"
                        style="${w+l+u.style}"
                        field="${h.field}" recid="${c}" column="${p}" ${u.attr}>
                    </div>`+u.text)),(r=t.find("div.w2ui-input").get(0)).innerText="object"!=typeof i?i:"",null!=f?w2utils.setCursorPosition(r,r.innerText.length):w2utils.setCursorPosition(r,0,r.innerText.length)):(t.addClass("w2ui-editable").html(w2utils.stripSpaces(`<input id="grid_${this.name}_edit_${c}_${p}" class="w2ui-input"
                        autocorrect="off" autocomplete="off" spellcheck="false" type="text"
                        style="${w+l+u.style}"
                        field="${h.field}" recid="${c}" column="${p}" ${u.attr}>`+u.text)),r=t.find("input").get(0),"number"==u.type&&(i=w2utils.formatNumber(i)),"date"==u.type&&(i=w2utils.formatDate(w2utils.isDate(i,u.format,!0)||new Date,u.format)),r.value="object"!=typeof i?i:"",m=e=>{var t=this.last._edit?.escKey;let i=!1;var s=query(r).data("tooltipName");s&&null!=w2tooltip.get(s[0])?.selected&&(i=!0),!this.last.inEditMode||t||!n.includes(u.type)||e.detail.overlay.anchor?.id!=this.last._edit.input?.id&&"list"!=u.type||(this.editChange(),this.editDone(void 0,void 0,{keyCode:i?13:0}))},new w2field(w2utils.extend({},u,{el:r,selected:i,onSelect:m,onHide:m})),null==f&&r&&r.select()),Object.assign(this.last._edit,{input:r,edit:u}),query(r).off(".w2ui-editable").on("blur.w2ui-editable",e=>{var t,i;this.last.inEditMode&&(t=this.last._edit.edit.type,i=query(r).data("tooltipName"),n.includes(t)&&i||(this.editChange(r,d,p,e),this.editDone()))}).on("mousedown.w2ui-editable",e=>{e.stopPropagation()}).on("click.w2ui-editable",e=>{v.call(r,e)}).on("paste.w2ui-editable",e=>{e.preventDefault();e=e.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,e)}).on("keyup.w2ui-editable",e=>{v.call(r,e)}).on("keydown.w2ui-editable",i=>{switch(i.keyCode){case 8:"list"!=u.type||r._w2field||i.preventDefault();break;case 9:case 13:i.preventDefault();break;case 27:var e=query(r).data("tooltipName");e&&0<e.length&&(this.last._edit.escKey=!0,w2tooltip.hide(e[0]),i.preventDefault()),i.stopPropagation()}setTimeout(()=>{switch(i.keyCode){case 9:var e=i.shiftKey?g.prevCell(d,p,!0):g.nextCell(d,p,!0);null!=e&&(t=g.records[e.index].recid,this.editChange(r,d,p,i),this.editDone(d,p,i),"row"!=g.selectType?(g.selectNone(!0),g.select({recid:t,column:e.colIndex})):g.editField(t,e.colIndex,null,i),i.preventDefault&&i.preventDefault());break;case 13:{let e=!1;var t=query(r).data("tooltipName");t&&null!=w2tooltip.get(t[0]).selected&&(e=!0),t&&e||(this.editChange(r,d,p,i),this.editDone(d,p,i));break}case 27:{this.last._edit.escKey=!1;let e=g.parseField(o,h.field);null!=o.w2ui?.changes?.[h.field]&&(e=o.w2ui.changes[h.field]),null!=r._prevValue&&(e=r._prevValue),"DIV"==r.tagName?r.innerText=null!=e?e:"":r.value=null!=e?e:"",this.editDone(d,p,i),setTimeout(()=>{g.select({recid:c,column:p})},1);break}}v(r)},1)}),r&&(r._prevValue=s),setTimeout(()=>{this.last.inEditMode&&r&&(r.focus(),clearTimeout(this.last.kbd_timer),(r.resize=v)(r))},50),a.finish({input:r})}}}}}editChange(e,t,i,s){e=e??this.last._edit.input,t=t??this.last._edit.index,i=i??this.last._edit.column,s=s??{};let l=(t<0?this.summary:this.records)[t=t<0?-t-1:t];var r=this.columns[i];let n="DIV"==e?.tagName?e.innerText:e.value,a=e._w2field;a&&("list"==a.type&&(n=a.selected),0!==Object.keys(n).length&&null!=n||(n=""),w2utils.isPlainObject(n)||(n=a.clean(n))),"checkbox"==e.type&&(l.w2ui&&!1===l.w2ui.editable&&(e.checked=!e.checked),n=e.checked);var o=this.parseField(l,r.field),h=l.w2ui&&l.w2ui.changes&&l.w2ui.changes.hasOwnProperty(r.field)?l.w2ui.changes[r.field]:o;let d={target:this.name,input:e,recid:l.recid,index:t,column:i,originalEvent:s,value:{new:n,previous:h,original:o}},u=(null!=s.target?._prevValue&&(d.value.previous=s.target._prevValue),0);for(;u<20;){if(u++,"object"!=typeof(n=d.value.new)&&String(o)!=String(n)||"object"==typeof n&&n&&n.id!=o&&("object"!=typeof o||null==o||n.id!=o.id)){if(!0!==(d=this.trigger("change",d)).isCancelled){if(n!==d.detail.value.new)continue;(""!==d.detail.value.new&&null!=d.detail.value.new||""!==h&&null!=h)&&(l.w2ui=l.w2ui??{},l.w2ui.changes=l.w2ui.changes??{},l.w2ui.changes[r.field]=d.detail.value.new),d.finish()}}else if(!0!==(d=this.trigger("restore",d)).isCancelled){if(n!==d.detail.value.new)continue;l.w2ui?.changes&&(delete l.w2ui.changes[r.field],0===Object.keys(l.w2ui.changes).length&&delete l.w2ui.changes),d.finish()}break}}editDone(t,i,s){if(t=t??this.last._edit.index,i=i??this.last._edit.column,s=s??{},this.advanceOnEdit&&13==s.keyCode){let e=s.shiftKey?this.prevRow(t,i,1):this.nextRow(t,i,1);null==e&&(e=t),setTimeout(()=>{"row"!=this.selectType?(this.selectNone(!0),this.select({recid:this.records[e].recid,column:i})):this.editField(this.records[e].recid,i,null,s)},1)}var e=t<0;let l=query(this.last._edit.tr).find('[col="'+i+'"]');var r=this.records[t],n=this.columns[i];this.last.inEditMode=!1,this.last._edit=null,e||(null!=r.w2ui?.changes?.[n.field]?l.addClass("w2ui-changed"):l.removeClass("w2ui-changed"),l.replace(this.getCellHTML(t,i,e))),query(this.box).find("div.w2ui-edit-box").remove(),this.updateToolbar(),setTimeout(()=>{let e=query(this.box).find(`#grid_${this.name}_focus`).get(0);document.activeElement===e||this.last.inEditMode||e.focus()},10)}delete(e){let t=this.trigger("delete",{target:this.name,force:e});if(e&&this.message(),!0!==t.isCancelled){e=t.detail.force;var i=this.getSelection();if(0!==i.length)if(""==this.msgDelete||e){if("object"!=typeof this.url?this.url:this.url.remove)this.request("delete");else if("object"!=typeof i[0])this.selectNone(),this.remove.apply(this,i);else{for(let t=0;t<i.length;t++){var s=this.columns[i[t].column].field,l=this.get(i[t].recid,!0);let e=this.records[l];null!=l&&"recid"!=s&&(this.records[l][s]="",e.w2ui&&e.w2ui.changes&&delete e.w2ui.changes[s])}this.update()}t.finish()}else this.confirm({text:w2utils.lang(this.msgDelete,{count:i.length,records:w2utils.lang(1==i.length?"record":"records")}),width:380,height:170,yes_text:"Delete",yes_class:"w2ui-btn-red",no_text:"Cancel"}).yes(e=>{e.detail.self.close(),this.delete(!0)}).no(e=>{e.detail.self.close()})}}click(n,a){var o=Date.now();let h=null;if(!(1==this.last.cancelClick||a&&a.altKey))if("object"==typeof n&&null!==n&&(h=n.column,n=n.recid),null==a&&(a={}),o-parseInt(this.last.click_time)<350&&this.last.click_recid==n&&"click"==a.type)this.dblClick(n,a);else{this.last.bubbleEl&&(this.last.bubbleEl=null),this.last.click_time=o;o=this.last.click_recid;if(this.last.click_recid=n,null==h&&a.target){let e=a.target;"TD"!=e.tagName&&(e=query(e).closest("td")[0]),null!=query(e).attr("col")&&(h=parseInt(query(e).attr("col")))}let i=this.trigger("click",{target:this.name,recid:n,column:h,originalEvent:a});if(!0!==i.isCancelled){var d=this.getSelection(),u=(query(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.get(n,!0));let s=[];this.last.sel_ind=u,this.last.sel_col=h,this.last.sel_recid=n,this.last.sel_type="click";let e,l,t,r;if(a.shiftKey&&0<d.length&&this.multiSelect){if(d[0].recid){e=this.get(d[0].recid,!0),l=this.get(n,!0),r=h>d[0].column?(t=d[0].column,h):(t=h,d[0].column);for(let e=t;e<=r;e++)s.push(e)}else e=this.get(o,!0),l=this.get(n,!0);let i=[];e>l&&(o=e,e=l,l=o);var c=this.url?.get?this.url.get:this.url;for(let t=e;t<=l;t++)if(!(0<this.searchData.length)||c||this.last.searchIds.includes(t))if("row"==this.selectType)i.push(this.records[t].recid);else for(let e=0;e<s.length;e++)i.push({recid:this.records[t].recid,column:s[e]});this.select(i)}else{let e=this.last.selection,t=-1!=e.indexes.indexOf(u),i=!1;query(a.target).closest("td").hasClass("w2ui-col-select")&&(i=!0),(a.ctrlKey||a.shiftKey||a.metaKey||i)&&this.multiSelect||this.showSelectColumn?!0===(t="row"==this.selectType||e.columns[u]?.includes(h)?t:!1)?this.unselect({recid:n,column:h}):this.select({recid:n,column:h}):("row"==this.selectType||e.columns[u]?.includes(h)||(t=!1),this.selectNone(!0),!0===t&&1==d.length?this.unselect({recid:n,column:h}):this.select({recid:n,column:h}))}this.status(),this.initResize(),i.finish()}}}columnClick(l,i){if(!0!==this.last.colResizing){let e=this.trigger("columnClick",{target:this.name,field:l,originalEvent:i});if(!0!==e.isCancelled){if("row"==this.selectType){var r=this.getColumn(l);r&&r.sortable&&this.sort(l,null,!(!i||!i.ctrlKey&&!i.metaKey)),"line-number"==e.detail.field&&(this.getSelection().length>=this.records.length?this.selectNone():this.selectAll())}else if(!i.altKey||(r=this.getColumn(l))&&r.sortable&&this.sort(l,null,!(!i||!i.ctrlKey&&!i.metaKey)),"line-number"==e.detail.field)this.getSelection().length>=this.records.length?this.selectNone():this.selectAll();else{i.shiftKey||i.metaKey||i.ctrlKey||this.selectNone(!0);r=this.getSelection(),l=this.getColumn(e.detail.field,!0);let t=[],s=[];if(0!=r.length&&i.shiftKey){let t=l,i=r[0].column;t>i&&(t=r[0].column,i=l);for(let e=t;e<=i;e++)s.push(e)}else s.push(l);if(!0!==(e=this.trigger("columnSelect",{target:this.name,columns:s})).isCancelled){for(let e=0;e<this.records.length;e++)t.push({recid:this.records[e].recid,column:s});this.select(t)}e.finish()}e.finish()}}}columnDblClick(e,t){let i=this.trigger("columnDblClick",{target:this.name,field:e,originalEvent:t});!0!==i.isCancelled&&i.finish()}focus(e){let t=this.trigger("focus",{target:this.name,originalEvent:e});if(!0===t.isCancelled)return!1;this.hasFocus=!0,query(this.box).removeClass("w2ui-inactive").find(".w2ui-inactive").removeClass("w2ui-inactive"),setTimeout(()=>{let e=query(this.box).find(`#grid_${this.name}_focus`).get(0);e&&document.activeElement!=e&&e.focus()},10),t.finish()}blur(e){let t=this.trigger("blur",{target:this.name,originalEvent:e});if(!0===t.isCancelled)return!1;this.hasFocus=!1,query(this.box).addClass("w2ui-inactive").find(".w2ui-selected").addClass("w2ui-inactive"),query(this.box).find(".w2ui-selection").addClass("w2ui-inactive"),t.finish()}keydown(f){let m=this,g="object"!=typeof this.url?this.url:this.url.get;if(!0===m.keyboard){let p=m.trigger("keydown",{target:m.name,originalEvent:f});if(!0!==p.isCancelled)if(0<query(this.box).find(".w2ui-message").length)27==f.keyCode&&this.message();else{let t=!1,i=query(m.box).find("#grid_"+m.name+"_records"),r=m.getSelection(),s=(0===r.length&&(t=!0),r[0]||null),n=[],l=r[r.length-1];if("object"==typeof s&&null!=s){s=r[0].recid,n=[];let e=0;for(;;){if(!r[e]||r[e].recid!=s)break;n.push(r[e].column),e++}l=r[r.length-1].recid}let a=m.get(s,!0),o=m.get(l,!0),h=query(m.box).find(`#grid_${m.name}_rec_`+(null!=a?w2utils.escapeId(m.records[a].recid):"none"));var y=Math.floor(i[0].clientHeight/m.recordHeight);let d=!1,e=f.keyCode,u=f.shiftKey;switch(e){case 8:case 46:m.delete(),d=!0,f.stopPropagation();break;case 27:m.selectNone(),d=!0;break;case 65:if(!f.metaKey&&!f.ctrlKey)break;m.selectAll(),d=!0;break;case 13:if("row"==this.selectType&&!0===m.show.expandColumn){if(h.length<=0)break;m.toggle(s,f),d=!0}else{for(let e=0;e<this.columns.length;e++)if(this.getCellEditable(a,e)){n.push(parseInt(e));break}0<(n="row"==this.selectType&&this.last._edit&&this.last._edit.column?[this.last._edit.column]:n).length&&(m.editField(s,this.last.editColumn||n[0],null,f),d=!0)}break;case 37:!function(){if(t)v();else{if("row"==m.selectType){if(h.length<=0)return;var e=m.records[a].w2ui||{};!e||null==e.parent_recid||Array.isArray(e.children)&&0!==e.children.length&&e.expanded?m.collapse(s,f):(m.unselect(s),m.collapse(e.parent_recid,f),m.select(e.parent_recid))}else{let l=m.prevCell(a,n[0]);if(l=l?.index!=a?null:l?.colIndex,u||null!=l||(m.selectNone(!0),l=0),null!=l)if(u&&m.multiSelect){if(x())return;let t=[],i=[],s=[];if(0===n.indexOf(m.last.sel_col)&&1<n.length){for(let e=0;e<r.length;e++)-1==t.indexOf(r[e].recid)&&t.push(r[e].recid),s.push({recid:r[e].recid,column:n[n.length-1]});m.unselect(s),m.scrollIntoView(a,n[n.length-1],!0)}else{for(let e=0;e<r.length;e++)-1==t.indexOf(r[e].recid)&&t.push(r[e].recid),i.push({recid:r[e].recid,column:l});m.select(i),m.scrollIntoView(a,l,!0)}}else m.click({recid:s,column:l},f),m.scrollIntoView(a,l,!0);else u||m.selectNone(!0)}d=!0}}();break;case 39:!function(){if(t)v();else{if("row"==m.selectType){if(h.length<=0)return;m.expand(s,f)}else{let l=m.nextCell(a,n[n.length-1]);if(l=l.index!=a?null:l.colIndex,u||null!=l||(m.selectNone(!0),l=m.columns.length-1),null!=l)if(u&&39==e&&m.multiSelect){if(x())return;let t=[],i=[],s=[];if(n.indexOf(m.last.sel_col)==n.length-1&&1<n.length){for(let e=0;e<r.length;e++)-1==t.indexOf(r[e].recid)&&t.push(r[e].recid),s.push({recid:r[e].recid,column:n[0]});m.unselect(s),m.scrollIntoView(a,n[0],!0)}else{for(let e=0;e<r.length;e++)-1==t.indexOf(r[e].recid)&&t.push(r[e].recid),i.push({recid:r[e].recid,column:l});m.select(i),m.scrollIntoView(a,l,!0)}}else m.click({recid:s,column:l},f),m.scrollIntoView(a,l,!0);else u||m.selectNone(!0)}d=!0}}();break;case 33:w(y);break;case 34:b(y);break;case 35:b(-1);break;case 36:w(-1);break;case 38:w(f.metaKey||f.ctrlKey?-1:1);break;case 40:b(f.metaKey||f.ctrlKey?-1:1);break;case 17:case 91:if(t)break;if(w2utils.isSafari){m.last.copy_event=m.copy(!1,f);let e=query(m.box).find("#grid_"+m.name+"_focus");e.val(m.last.copy_event.detail.text),e[0].select()}break;case 67:if(f.metaKey||f.ctrlKey)if(w2utils.isSafari)m.copy(m.last.copy_event,f);else{m.last.copy_event=m.copy(!1,f);let e=query(m.box).find("#grid_"+m.name+"_focus");e.val(m.last.copy_event.detail.text),e[0].select(),m.copy(m.last.copy_event,f)}break;case 88:if(t)break;if(f.ctrlKey||f.metaKey)if(w2utils.isSafari)m.copy(m.last.copy_event,f);else{m.last.copy_event=m.copy(!1,f);let e=query(m.box).find("#grid_"+m.name+"_focus");e.val(m.last.copy_event.detail.text),e[0].select(),m.copy(m.last.copy_event,f)}}let c=[32,187,189,192,219,220,221,186,222,188,190,191];for(let e=48;e<=111;e++)c.push(e);function w(e){if(t&&v(),!(h.length<=0)){let i=m.prevRow(a,"row"==m.selectType?0:r[0].column,e);if(null!=(i=u||null!=i?i:0==m.searchData.length||g?0:m.last.searchIds[0])){if(u&&m.multiSelect){if(x())return;if("row"==m.selectType)m.last.sel_ind>i&&m.last.sel_ind!=o?m.unselect(m.records[o].recid):m.select(m.records[i].recid);else if(m.last.sel_ind>i&&m.last.sel_ind!=o){i=o;let t=[];for(let e=0;e<n.length;e++)t.push({recid:m.records[i].recid,column:n[e]});m.unselect(t)}else{let t=[];for(let e=0;e<n.length;e++)t.push({recid:m.records[i].recid,column:n[e]});m.select(t)}}else m.selectNone(!0),m.click({recid:m.records[i].recid,column:n[0]},f);m.scrollIntoView(i,null,!1,1!=e),f.preventDefault&&f.preventDefault()}else u||m.selectNone(!0)}}function b(e){if(t&&v(),!(h.length<=0)){let i=m.nextRow(o,"row"==m.selectType?0:r[0].column,e);if(null!=(i=u||null!=i?i:0==m.searchData.length||g?m.records.length-1:m.last.searchIds[m.last.searchIds.length-1])){if(u&&m.multiSelect){if(x())return;if("row"==m.selectType)m.last.sel_ind<i&&m.last.sel_ind!=a?m.unselect(m.records[a].recid):m.select(m.records[i].recid);else if(m.last.sel_ind<i&&m.last.sel_ind!=a){i=a;let t=[];for(let e=0;e<n.length;e++)t.push({recid:m.records[i].recid,column:n[e]});m.unselect(t)}else{let t=[];for(let e=0;e<n.length;e++)t.push({recid:m.records[i].recid,column:n[e]});m.select(t)}}else m.selectNone(!0),m.click({recid:m.records[i].recid,column:n[0]},f);m.scrollIntoView(i,null,!1,1!=e),d=!0}else u||m.selectNone(!0)}}function v(){if(m.records&&0!==m.records.length){let e=Math.floor(i[0].scrollTop/m.recordHeight)+1;(!m.records[e]||e<2)&&(e=0),void 0!==m.records[e]&&m.select({recid:m.records[e].recid,column:0})}}function x(){if("click"==m.last.sel_type){if("row"==m.selectType)return m.last.sel_type="key",1<r.length&&(r.splice(r.indexOf(m.records[m.last.sel_ind].recid),1),m.unselect(r),1);if(m.last.sel_type="key",1<r.length){for(let e=0;e<r.length;e++)if(r[e].recid==m.last.sel_recid&&r[e].column==m.last.sel_col){r.splice(e,1);break}return m.unselect(r),1}}}-1==c.indexOf(e)||f.ctrlKey||f.metaKey||d||(0===n.length&&n.push(0),d=!1,setTimeout(()=>{let e=query(m.box).find("#grid_"+m.name+"_focus");var t=e.val();e.val(""),m.editField(s,n[0],t,f)},1)),d&&f.preventDefault&&f.preventDefault(),p.finish()}}}scrollIntoView(t,s,i,l){let r=this.records.length;if(0!==(r=0==this.searchData.length||this.url?r:this.last.searchIds.length)){if(null==t){var n=this.getSelection();if(0===n.length)return;w2utils.isPlainObject(n[0])?(t=n[0].index,s=n[0].column):t=this.get(n[0],!0)}let e=query(this.box).find(`#grid_${this.name}_records`);var n=e[0].clientWidth,a=e[0].clientHeight,o=e[0].scrollTop,h=e[0].scrollLeft,d=this.last.searchIds.length;if(0<d&&(t=this.last.searchIds.indexOf(t)),e.css({"scroll-behavior":i?"auto":"smooth"}),a<this.recordHeight*(0<d?d:r)&&0<e.length&&(d=(i=Math.floor(o/this.recordHeight))+Math.floor(a/this.recordHeight),t==i&&e.prop("scrollTop",o-a/1.3),t==d&&e.prop("scrollTop",o+a/1.3),(t<i||d<t)&&e.prop("scrollTop",(t-1)*this.recordHeight),!0===l&&e.prop("scrollTop",t*this.recordHeight)),null!=s){let t=0,i=0;o=w2utils.scrollBarSize();for(let e=0;e<=s;e++){var u=this.columns[e];u.frozen||u.hidden||(t=i,i+=parseInt(u.sizeCalculated))}n<i-h?e.prop("scrollLeft",t-o):t<h&&e.prop("scrollLeft",i-n+2*o)}}}scrollToColumn(s){if(null!=s){let t=0,i=!1;for(let e=0;e<this.columns.length;e++){var l=this.columns[e];if(l.field==s){i=!0;break}l.frozen||l.hidden||(l=parseInt(l.sizeCalculated||l.size),t+=l)}i&&(this.last.scrollLeft=t+1,this.scroll())}}dblClick(e,t){let i=null;if("object"==typeof e&&null!==e&&(i=e.column,e=e.recid),null==t&&(t={}),null==i&&t.target){let e=t.target;"TD"!=e.tagName.toUpperCase()&&(e=query(e).closest("td")[0]),i=parseInt(query(e).attr("col"))}var s=this.get(e,!0),l=this.records[s];let r=this.trigger("dblClick",{target:this.name,recid:e,column:i,originalEvent:t});!0!==r.isCancelled&&(this.selectNone(!0),this.getCellEditable(s,i)?this.editField(e,i,null,t):(this.select({recid:e,column:i}),(this.show.expandColumn||l&&l.w2ui&&Array.isArray(l.w2ui.children))&&this.toggle(e)),r.finish())}showContextMenu(s,l,r){if("text"!=this.last.userSelect){null==(r=null==r?{offsetX:0,offsetY:0,target:query(this.box).find(`#grid_${this.name}_rec_`+s)[0]}:r).offsetX&&(r.offsetX=r.layerX-r.target.offsetLeft,r.offsetY=r.layerY-r.target.offsetTop),w2utils.isFloat(s)&&(s=parseFloat(s));let i=this.getSelection();if("row"==this.selectType)-1==i.indexOf(s)&&this.click(s);else{let e=query(r.target),t=!1;l=(e="TD"!=e[0].tagName.toUpperCase()?query(r.target).closest("td"):e).attr("col");for(let e=0;e<i.length;e++)i[e].recid!=s&&i[e].column!=l||(t=!0);t||null==s||this.click({recid:s,column:l}),t||null==l||this.columnClick(this.columns[l].field,r)}let e=this.trigger("contextMenu",{target:this.name,originalEvent:r,recid:s,column:l});!0!==e.isCancelled&&(0<this.contextMenu.length&&(w2menu.show({anchor:document.body,originalEvent:r,items:this.contextMenu}).select(e=>{clearTimeout(this.last.kbd_timer),this.contextMenuClick(s,e)}),clearTimeout(this.last.kbd_timer)),r.preventDefault(),e.finish())}}contextMenuClick(e,t){let i=this.trigger("contextMenuClick",{target:this.name,recid:e,originalEvent:t.detail.originalEvent,menuEvent:t,menuIndex:t.detail.index,menuItem:t.detail.item});!0!==i.isCancelled&&i.finish()}toggle(e){let t=this.get(e);if(null!=t)return t.w2ui=t.w2ui||{},!0===t.w2ui.expanded?this.collapse(e):this.expand(e)}expand(i,e){var s=this.get(i,!0);let l=this.records[s];l.w2ui=l.w2ui||{};var r=w2utils.escapeId(i);let t=l.w2ui.children,n;if(Array.isArray(t)){if(!0===l.w2ui.expanded||0===t.length)return!1;if(!0===(n=this.trigger("expand",{target:this.name,recid:i})).isCancelled)return!1;l.w2ui.expanded=!0,t.forEach(e=>{e.w2ui=e.w2ui||{},e.w2ui.parent_recid=l.recid,null==e.w2ui.children&&(e.w2ui.children=[])}),this.records.splice.apply(this.records,[s+1,0].concat(t)),-1!==this.total&&(this.total+=t.length),("object"!=typeof this.url?this.url:this.url.get)||(this.localSort(!0,!0),0<this.searchData.length&&this.localSearch(!0)),!0!==e&&this.refresh(),n.finish()}else{if(0<query(this.box).find("#grid_"+this.name+"_rec_"+r+"_expanded_row").length||!0!==this.show.expandColumn)return!1;if("none"==l.w2ui.expanded)return!1;if(query(this.box).find("#grid_"+this.name+"_rec_"+r).after(`<tr id="grid_${this.name}_rec_${i}_expanded_row" class="w2ui-expanded-row">
                    <td colspan="100" class="w2ui-expanded2">
                        <div id="grid_${this.name}_rec_${i}_expanded"></div>
                    </td>
                    <td class="w2ui-grid-data-last"></td>
                </tr>`),query(this.box).find("#grid_"+this.name+"_frec_"+r).after(`<tr id="grid_${this.name}_frec_${i}_expanded_row" class="w2ui-expanded-row">
                    ${this.show.lineNumbers?'<td class="w2ui-col-number"></td>':""}
                    <td class="w2ui-grid-data w2ui-expanded1" colspan="100">
                       <div id="grid_${this.name}_frec_${i}_expanded"></div>
                    </td>
                </tr>`),!0===(n=this.trigger("expand",{target:this.name,recid:i,box_id:"grid_"+this.name+"_rec_"+i+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+r+"_expanded"})).isCancelled)return query(this.box).find("#grid_"+this.name+"_rec_"+r+"_expanded_row").remove(),query(this.box).find("#grid_"+this.name+"_frec_"+r+"_expanded_row").remove(),!1;let e=query(this.box).find("#grid_"+this.name+"_rec_"+i+"_expanded"),t=query(this.box).find("#grid_"+this.name+"_frec_"+i+"_expanded");s=e.find(":scope div:first-child")[0]?.clientHeight??50;e[0].clientHeight<s&&e.css({height:s+"px"}),t[0].clientHeight<s&&t.css({height:s+"px"}),query(this.box).find("#grid_"+this.name+"_rec_"+r).attr("expanded","yes").addClass("w2ui-expanded"),query(this.box).find("#grid_"+this.name+"_frec_"+r).attr("expanded","yes").addClass("w2ui-expanded"),query(this.box).find("#grid_"+this.name+"_cell_"+this.get(i,!0)+"_expand div").html("-"),l.w2ui.expanded=!0,n.finish(),this.resizeRecords()}return!0}collapse(i,s){var l=this.get(i,!0);let r=this.records[l],e=(r.w2ui=r.w2ui||{},w2utils.escapeId(i));var n=r.w2ui.children;let a;if(Array.isArray(n)){if(!0!==r.w2ui.expanded)return!1;if(!0===(a=this.trigger("collapse",{target:this.name,recid:i})).isCancelled)return!1;!function i(s){s.w2ui.expanded=!1;for(let t=0;t<s.w2ui.children.length;t++){let e=s.w2ui.children[t];e.w2ui.expanded&&i(e)}}(r);let t=[];for(let e=r;null!=e;e=this.get(e.w2ui.parent_recid))t.push(e.w2ui.parent_recid);n=l+1;let e=n;for(;;){if(this.records.length<=e+1||null==this.records[e+1].w2ui||0<=t.indexOf(this.records[e+1].w2ui.parent_recid))break;e++}this.records.splice(n,e-n+1),-1!==this.total&&(this.total-=e-n+1),("object"!=typeof this.url?this.url:this.url.get)||0<this.searchData.length&&this.localSearch(!0),!0!==s&&this.refresh(),a.finish()}else{if(0===query(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded_row").length||!0!==this.show.expandColumn)return!1;if(!0===(a=this.trigger("collapse",{target:this.name,recid:i,box_id:"grid_"+this.name+"_rec_"+e+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+e+"_expanded"})).isCancelled)return!1;query(this.box).find("#grid_"+this.name+"_rec_"+e).removeAttr("expanded").removeClass("w2ui-expanded"),query(this.box).find("#grid_"+this.name+"_frec_"+e).removeAttr("expanded").removeClass("w2ui-expanded"),query(this.box).find("#grid_"+this.name+"_cell_"+this.get(i,!0)+"_expand div").html("+"),query(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded").css("height","0px"),query(this.box).find("#grid_"+this.name+"_frec_"+e+"_expanded").css("height","0px"),setTimeout(()=>{query(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded_row").remove(),query(this.box).find("#grid_"+this.name+"_frec_"+e+"_expanded_row").remove(),r.w2ui.expanded=!1,a.finish(),this.resizeRecords()},300)}return!0}sort(i,e,s){let t=this.trigger("sort",{target:this.name,field:i,direction:e,multiField:s});if(!0!==t.isCancelled){if(null!=i){let t=this.sortData.length;for(let e=0;e<this.sortData.length;e++)if(this.sortData[e].field==i){t=e;break}null==e&&(e=null==this.sortData[t]?"asc":(null==this.sortData[t].direction&&(this.sortData[t].direction=""),"asc"===this.sortData[t].direction.toLowerCase()?"desc":"asc")),!1===this.multiSort&&(this.sortData=[],t=0),1!=s&&(this.sortData=[],t=0),null==this.sortData[t]&&(this.sortData[t]={}),this.sortData[t].field=i,this.sortData[t].direction=e}else this.sortData=[];("object"!=typeof this.url?this.url:this.url.get)?(t.finish({direction:e}),this.last.fetch.offset=0,this.reload()):(this.localSort(!1,!0),0<this.searchData.length&&this.localSearch(!0),this.last.scrollTop=0,query(this.box).find(`#grid_${this.name}_records`).prop("scrollTop",0),t.finish({direction:e}),this.refresh())}}copy(e,t){if(w2utils.isPlainObject(e))return e.finish(),e.text;var l=this.getSelection();if(0===l.length)return"";let r="";if("object"==typeof l[0]){let t=l[0].column,i=l[0].column,s=[];for(let e=0;e<l.length;e++)l[e].column<t&&(t=l[e].column),l[e].column>i&&(i=l[e].column),-1==s.indexOf(l[e].index)&&s.push(l[e].index);s.sort((e,t)=>e-t);for(let e=0;e<s.length;e++){var n=s[e];for(let e=t;e<=i;e++)!0!==this.columns[e].hidden&&(r+=this.getCellCopy(n,e)+"\t");r=r.substr(0,r.length-1),r+="\n"}}else{for(let e=0;e<this.columns.length;e++){var i=this.columns[e];if(!0!==i.hidden){let e=i.text||i.field;i.text&&i.text.length<3&&i.tooltip&&(e=i.tooltip),r+='"'+w2utils.stripTags(e)+'"\t'}}r=r.substr(0,r.length-1),r+="\n";for(let e=0;e<l.length;e++){var s=this.get(l[e],!0);for(let e=0;e<this.columns.length;e++)!0!==this.columns[e].hidden&&(r+='"'+this.getCellCopy(s,e)+'"\t');r=r.substr(0,r.length-1),r+="\n"}}r=r.substr(0,r.length-1);let a;return null==e?!0===(a=this.trigger("copy",{target:this.name,text:r,cut:88==t.keyCode,originalEvent:t})).isCancelled?"":(r=a.detail.text,a.finish(),r):!1===e?!0===(a=this.trigger("copy",{target:this.name,text:r,cut:88==t.keyCode,originalEvent:t})).isCancelled?"":(r=a.detail.text,a):void 0}getCellCopy(e,t){return w2utils.stripTags(this.getCellHTML(e,t))}paste(l,e){var t=this.getSelection();let r=this.get(t[0].recid,!0);var n,a,o,h=t[0].column;let i=this.trigger("paste",{target:this.name,text:l,index:r,column:h,originalEvent:e});if(!0!==i.isCancelled){if(l=i.detail.text,"row"==this.selectType||0===t.length)return console.log("ERROR: You can paste only if grid.selectType = 'cell' and when at least one cell selected."),void i.finish();if("object"!=typeof l){let s=[];l=l.split("\n");for(let e=0;e<l.length;e++){var d=l[e].split("\t");let t=0;var u=this.records[r];let i=[];if(null!=u){for(let e=0;e<d.length;e++)this.columns[h+t]&&(n=u,a=this.columns[h+t].field,o=d[e],n.w2ui=n.w2ui||{},n.w2ui.changes=n.w2ui.changes||{},n.w2ui.changes[a]=o,i.push(h+t),t++);for(let e=0;e<i.length;e++)s.push({recid:u.recid,column:i[e]});r++}}this.selectNone(!0),this.select(s)}else this.selectNone(!0),this.select([{recid:this.records[r],column:h}]);this.refresh(),i.finish()}}resize(){var t=Date.now();if(this.box&&query(this.box).attr("name")==this.name){query(this.box).find(":scope > div.w2ui-grid-box").css("width",query(this.box)[0].clientWidth+"px").css("height",query(this.box)[0].clientHeight+"px");let e=this.trigger("resize",{target:this.name});if(!0!==e.isCancelled)return this.resizeBoxes(),this.resizeRecords(),e.finish(),Date.now()-t}}update({cells:t,fullCellRefresh:i,ignoreColumns:l}={}){var e=Date.now();let h=this;if(null==this.box)return 0;if(Array.isArray(t))for(let e=0;e<t.length;e++){var s=t[e].index,r=t[e].column;if(!(s<0))if(null==s||null==r)console.log("ERROR: Wrong argument for grid.update({ cells }), cells should be [{ index: X, column: Y }, ...]");else{let e=this.records[s]??{},t=(e.w2ui=e.w2ui??{},e.w2ui._update=e.w2ui._update??{cells:[]},e.w2ui._update.row1),i=e.w2ui._update.row2;null!=t&&t.isConnected&&null!=i&&i.isColSelected||(t=this.box.querySelector(`#grid_${this.name}_rec_`+w2utils.escapeId(e.recid)),i=this.box.querySelector(`#grid_${this.name}_frec_`+w2utils.escapeId(e.recid)),e.w2ui._update.row1=t,e.w2ui._update.row2=i),n(e,t,i,s,r)}}else for(let e=this.last.range_start-1;e<=this.last.range_end;e++){let s=e,l=(s=0<this.last.searchIds.length?this.last.searchIds[e]:e,this.records[s]);if(!(s<0||null==l)){l.w2ui=l.w2ui??{},l.w2ui._update=l.w2ui._update??{cells:[]};let t=l.w2ui._update.row1,i=l.w2ui._update.row2;null!=t&&t.isConnected&&null!=i&&i.isColSelected||(t=this.box.querySelector(`#grid_${this.name}_rec_`+w2utils.escapeId(l.recid)),i=this.box.querySelector(`#grid_${this.name}_frec_`+w2utils.escapeId(l.recid)),l.w2ui._update.row1=t,l.w2ui._update.row2=i);for(let e=0;e<this.columns.length;e++)n(l,t,i,s,e)}}return Date.now()-e;function n(e,s,r,n,a){var o=h.columns[a];if(!Array.isArray(l)||!l.includes(a)&&!l.includes(o.field)){let l=e.w2ui._update.cells[a];if(null!=l&&l.isConnected||(l=h.box.querySelector(`#grid_${h.name}_data_${n}_`+a),e.w2ui._update.cells[a]=l),null!=l){if(i)query(l).replace(h.getCellHTML(n,a,!1)),l=h.box.querySelector(`#grid_${h.name}_data_${n}_`+a),e.w2ui._update.cells[a]=l;else{let e=l.children[0],{value:t,style:i,className:s}=h.getCellValue(n,a,!1,!0);if(e.innerHTML!=t&&(e.innerHTML=t),""!=i&&l.style.cssText!=i&&(l.style.cssText=i),""!=s){let t=["w2ui-grid-data"],i=[];n=s.split(" ").filter(e=>!!e);l.classList.forEach(e=>{t.includes(e)||i.push(e)}),l.classList.remove(...i),l.classList.add(...n)}}if(h.columns[a].style&&h.columns[a].style!=l.style.cssText&&(l.style.cssText=h.columns[a].style??""),null!=e.w2ui.class){if("string"==typeof e.w2ui.class){let t=["w2ui-odd","w2ui-even","w2ui-record"],i=[];n=e.w2ui.class.split(" ").filter(e=>!!e);s&&r&&(s.classList.forEach(e=>{t.includes(e)||i.push(e)}),s.classList.remove(...i),s.classList.add(...n),r.classList.remove(...i),r.classList.add(...n))}if(w2utils.isPlainObject(e.w2ui.class)&&"string"==typeof e.w2ui.class[o.field]){let t=["w2ui-grid-data"],i=[];a=e.w2ui.class[o.field].split(" ").filter(e=>!!e);l.classList.forEach(e=>{t.includes(e)||i.push(e)}),l.classList.remove(...i),l.classList.add(...a)}}null!=e.w2ui.style&&(s&&r&&"string"==typeof e.w2ui.style&&s.style.cssText!==e.w2ui.style&&(s.style.cssText="height: "+h.recordHeight+"px;"+e.w2ui.style,s.setAttribute("custom_style",e.w2ui.style),r.style.cssText="height: "+h.recordHeight+"px;"+e.w2ui.style,r.setAttribute("custom_style",e.w2ui.style)),w2utils.isPlainObject(e.w2ui.style)&&"string"==typeof e.w2ui.style[o.field]&&l.style.cssText!==e.w2ui.style[o.field]&&(l.style.cssText=e.w2ui.style[o.field]))}}}}refreshCell(e,t){var i=this.get(e,!0),t=this.getColumn(t,!0),e=!this.records[i]||this.records[i].recid!=e;let s=query(this.box).find(`${e?".w2ui-grid-summary ":""}#grid_${this.name}_data_${i}_`+t);return 0!=s.length&&(s.replace(this.getCellHTML(i,t,e)),!0)}refreshRow(t,i=null){let s=query(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t)),l=query(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t));if(0<s.length){null==i&&(i=this.get(t,!0));var r=s.attr("line"),n=!this.records[i]||this.records[i].recid!=t,a="object"!=typeof this.url?this.url:this.url.get;if(0<this.searchData.length&&!a)for(let e=0;e<this.last.searchIds.length;e++)this.last.searchIds[e]==i&&(i=e);a=this.getRecordHTML(i,r,n);s.replace(a[0]),l.replace(a[1]);let e=this.records[i].w2ui?this.records[i].w2ui.style:"";return"string"==typeof e&&(s=query(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t)),l=query(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t)),s.attr("custom_style",e),l.attr("custom_style",e),s.hasClass("w2ui-selected")&&(e=e.replace("background-color","none")),s[0].style.cssText="height: "+this.recordHeight+"px;"+e,l[0].style.cssText="height: "+this.recordHeight+"px;"+e),n&&this.resize(),!0}return!1}refresh(){var t=Date.now(),s="object"!=typeof this.url?this.url:this.url.get;if(this.total<=0&&!s&&0===this.searchData.length&&(this.total=this.records.length),this.box){let e=this.trigger("refresh",{target:this.name});if(!0!==e.isCancelled){this.show.header?query(this.box).find(`#grid_${this.name}_header`).html(w2utils.lang(this.header)+"&#160;").show():query(this.box).find(`#grid_${this.name}_header`).hide(),this.show.toolbar?query(this.box).find("#grid_"+this.name+"_toolbar").show():query(this.box).find("#grid_"+this.name+"_toolbar").hide(),this.searchClose();let i=query(this.box).find("#grid_"+this.name+"_search_all");!this.multiSearch&&"all"==this.last.field&&0<this.searches.length&&(this.last.field=this.searches[0].field,this.last.label=this.searches[0].label);for(let e=0;e<this.searches.length;e++)this.searches[e].field==this.last.field&&(this.last.label=this.searches[e].label);if(this.last.multi?i.attr("placeholder","["+w2utils.lang("Multiple Fields")+"]"):i.attr("placeholder",w2utils.lang("Search")+" "+w2utils.lang(this.last.label,!0)),i.val()!=this.last.search){let e=this.last.search,t=i._w2field;t&&(e=t.format(e)),i.val(e)}this.refreshSearch(),this.refreshBody(),this.show.footer?query(this.box).find(`#grid_${this.name}_footer`).html(this.getFooterHTML()).show():query(this.box).find(`#grid_${this.name}_footer`).hide();var s=this.last.selection,l=0<this.records.length&&s.indexes.length==this.records.length,s=0<s.indexes.length&&0!==this.searchData.length&&s.indexes.length==this.last.searchIds.length,r=(l||s?query(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):query(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.find({"w2ui.expanded":!0},!0,!0));for(let t=0;t<r.length;t++){let e=this.records[r[t]].w2ui;e&&!Array.isArray(e.children)&&(e.expanded=!1)}return this.markSearch&&setTimeout(()=>{let t=[];for(let e=0;e<this.searchData.length;e++){var i=this.searchData[e],s=this.getSearch(i.field);s&&!s.hidden&&(s=this.getColumn(i.field,!0),t.push({field:i.field,search:i.value,col:s}))}0<t.length&&t.forEach(e=>{var t=query(this.box).find('td[col="'+e.col+'"]:not(.w2ui-head)');w2utils.marker(t,e.search)})},50),this.updateToolbar(),e.finish(),this.resize(),this.addRange("selection"),setTimeout(()=>{this.resize(),this.scroll()},1),this.reorderColumns&&!this.last.columnDrag?this.last.columnDrag=this.initColumnDrag():!this.reorderColumns&&this.last.columnDrag&&this.last.columnDrag.remove(),Date.now()-t}}}refreshSearch(){if(this.multiSearch&&0<this.searchData.length){0==query(this.box).find(".w2ui-grid-searches").length&&query(this.box).find(".w2ui-grid-toolbar").css("height",this.last.toolbar_height+35+"px").append(`<div id="grid_${this.name}_searches" class="w2ui-grid-searches"></div>`);let r=`
                <span id="grid_${this.name}_search_logic" class="w2ui-grid-search-logic"></span>
                <div class="grid-search-line"></div>`;this.searchData.forEach((i,e)=>{var t=this.getSearch(i.field,!0),s=this.searches[t];let l;if(l=Array.isArray(i.value)?`<span class="grid-search-count">${i.value.length}</span>`:": "+i.value,s&&"date"==s.type)if("between"==i.operator){let e=i.value[0],t=i.value[1];Number(e)===e&&(e=w2utils.formatDate(e)),Number(t)===t&&(t=w2utils.formatDate(t)),l=`: ${e} - `+t}else{let e=i.value,t=(Number(e)==e&&(e=w2utils.formatDate(e)),i.operator);"more:"==(t="less"==(t="more"==t?"since":t)?"before":t).substr(0,5)&&(t="since"),l=`: ${t} `+e}r+=`<span class="w2ui-action" data-click="searchFieldTooltip|${t}|${e}|this">
                    ${s?s.label:""}
                    ${l}
                    <span class="icon-chevron-down"></span>
                </span>`}),r+=`
                ${this.show.searchSave?`<div class="grid-search-line"></div>
                       <button class="w2ui-btn grid-search-btn" data-click="searchSave">${w2utils.lang("Save")}</button>
                      `:""}
                <button class="w2ui-btn grid-search-btn btn-remove"
                    data-click="searchReset">X</button>
            `,query(this.box).find(`#grid_${this.name}_searches`).html(r),query(this.box).find(`#grid_${this.name}_search_logic`).html(w2utils.lang("AND"==this.last.logic?"All":"Any"))}else query(this.box).find(".w2ui-grid-toolbar").css("height",this.last.toolbar_height+"px").find(".w2ui-grid-searches").remove();this.searchSelected?(query(this.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),query(this.box).find(`#grid_${this.name}_search_name`).show().find(".name-text").html(this.searchSelected.text)):(query(this.box).find(`#grid_${this.name}_search_all`).prop("readOnly",!1),query(this.box).find(`#grid_${this.name}_search_name`).hide().find(".name-text").html("")),w2utils.bindEvents(query(this.box).find(`#grid_${this.name}_searches .w2ui-action, #grid_${this.name}_searches button`),this)}refreshBody(){this.scroll();var e=this.getRecordsHTML(),t=this.getColumnsHTML(),e='<div id="grid_'+this.name+'_frecords" class="w2ui-grid-frecords" style="margin-bottom: '+(w2utils.scrollBarSize()-1)+'px;">'+e[0]+'</div><div id="grid_'+this.name+'_records" class="w2ui-grid-records">'+e[1]+'</div><div id="grid_'+this.name+'_scroll1" class="w2ui-grid-scroll1" style="height: '+w2utils.scrollBarSize()+'px"></div><div id="grid_'+this.name+'_fcolumns" class="w2ui-grid-fcolumns">    <table><tbody>'+t[0]+'</tbody></table></div><div id="grid_'+this.name+'_columns" class="w2ui-grid-columns">    <table><tbody>'+t[1]+"</tbody></table></div>"+`<div class="w2ui-intersection-marker" style="display: none; height: ${this.recordHeight-5}px">
               <div class="top-marker"></div>
               <div class="bottom-marker"></div>
            </div>`;let l=query(this.box).find(`#grid_${this.name}_body`,this.box).html(e),i=query(this.box).find(`#grid_${this.name}_records`,this.box),s=query(this.box).find(`#grid_${this.name}_frecords`,this.box);"row"==this.selectType&&(i.on("mouseover mouseout",{delegate:"tr"},e=>{var t=query(e.delegate).attr("recid");query(this.box).find(`#grid_${this.name}_frec_`+w2utils.escapeId(t)).toggleClass("w2ui-record-hover","mouseover"==e.type)}),s.on("mouseover mouseout",{delegate:"tr"},e=>{var t=query(e.delegate).attr("recid");query(this.box).find(`#grid_${this.name}_rec_`+w2utils.escapeId(t)).toggleClass("w2ui-record-hover","mouseover"==e.type)})),w2utils.isIOS?i.append(s).on("click",{delegate:"tr"},e=>{var t=query(e.delegate).attr("recid");this.dblClick(t,e)}):i.add(s).on("click",{delegate:"tr"},e=>{var t=query(e.delegate).attr("recid");this.click(t,e)}).on("contextmenu",{delegate:"tr"},e=>{var t=query(e.delegate).attr("recid");this.showContextMenu(t,null,e)}),l.data("scroll",{lastDelta:0,lastTime:0}).find(".w2ui-grid-frecords").on("mousewheel DOMMouseScroll ",e=>{e.preventDefault();let t=l.data("scroll"),i=l.find(".w2ui-grid-records");var e=null!=typeof e.wheelDelta?-e.wheelDelta:e.detail||e.deltaY,s=i.prop("scrollTop");t.lastDelta+=e,e=Math.round(t.lastDelta),l.data("scroll",t),i.get(0).scroll({top:s+e,behavior:"smooth"})}),i.off(".body-global").on("scroll.body-global",{delegate:".w2ui-grid-records"},e=>{this.scroll(e)}),query(this.box).find(".w2ui-grid-body").off(".body-global").on("click.body-global dblclick.body-global contextmenu.body-global",{delegate:"td.w2ui-head"},e=>{var t=query(e.delegate).attr("col"),i=this.columns[t]??{field:t};switch(e.type){case"click":this.columnClick(i.field,e);break;case"dblclick":this.columnDblClick(i.field,e);break;case"contextmenu":this.show.columnMenu&&(w2menu.show({type:"check",anchor:document.body,originalEvent:e,items:this.initColumnOnOff()}).then(()=>{query("#w2overlay-context-menu .w2ui-grid-skip").off(".w2ui-grid").on("click.w2ui-grid",e=>{e.stopPropagation()}).on("keypress",e=>{13==e.keyCode&&(this.skip(e.target.value),this.toolbar.click("w2ui-column-on-off"))})}).select(e=>{let t=e.detail.item.id;["w2ui-stateSave","w2ui-stateReset"].includes(t)?this[t.substring(5)]():"w2ui-skip"!=t&&this.columnOnOff(e,e.detail.item.id),clearTimeout(this.last.kbd_timer)}),clearTimeout(this.last.kbd_timer)),e.preventDefault()}}).on("mouseover.body-global",{delegate:".w2ui-col-header"},e=>{let t=query(e.delegate).parent().attr("col");this.columnTooltipShow(t,e),query(e.delegate).off(".tooltip").on("mouseleave.tooltip",()=>{this.columnTooltipHide(t,e)})}).on("click.body-global",{delegate:"input.w2ui-select-all"},e=>{e.delegate.checked?this.selectAll():this.selectNone(),e.stopPropagation(),clearTimeout(this.last.kbd_timer)}).on("click.body-global",{delegate:".w2ui-show-children, .w2ui-col-expand"},e=>{e.stopPropagation(),this.toggle(query(e.target).parents("tr").attr("recid"))}).on("click.body-global mouseover.body-global",{delegate:".w2ui-info"},e=>{let t=query(e.delegate).closest("td"),i=t.parent(),s=this.columns[t.attr("col")];var l=i.parents(".w2ui-grid-body").hasClass("w2ui-grid-summary");["mouseenter","mouseover"].includes(s.info?.showOn?.toLowerCase())&&"mouseover"==e.type?this.showBubble(i.attr("index"),t.attr("col"),l).then(()=>{query(e.delegate).off(".tooltip").on("mouseleave.tooltip",()=>{w2tooltip.hide(this.name+"-bubble")})}):"click"==e.type&&(w2tooltip.hide(this.name+"-bubble"),this.showBubble(i.attr("index"),t.attr("col"),l))}).on("mouseover.body-global",{delegate:".w2ui-clipboard-copy"},l=>{if(!l.delegate._tooltipShow){let t=query(l.delegate).parent(),i=t.parent();var e=this.columns[t.attr("col")];let s=i.parents(".w2ui-grid-body").hasClass("w2ui-grid-summary");w2tooltip.show({name:this.name+"-bubble",anchor:l.delegate,html:w2utils.lang("string"==typeof e.clipboardCopy?e.clipboardCopy:"Copy to clipboard"),position:"top|bottom",offsetY:-2}).hide(e=>{l.delegate._tooltipShow=!1,query(l.delegate).off(".tooltip")}),query(l.delegate).off(".tooltip").on("mouseleave.tooltip",e=>{w2tooltip.hide(this.name+"-bubble")}).on("click.tooltip",e=>{e.stopPropagation(),w2tooltip.update(this.name+"-bubble",w2utils.lang("Copied")),this.clipboardCopy(i.attr("index"),t.attr("col"),s)}),l.delegate._tooltipShow=!0}}).on("click.body-global",{delegate:".w2ui-editable-checkbox"},e=>{var t=query(e.delegate).data();this.editChange.call(this,e.delegate,t.changeind,t.colind,e)}),0===this.records.length&&this.msgEmpty?query(this.box).find(`#grid_${this.name}_body`).append(`<div id="grid_${this.name}_empty_msg" class="w2ui-grid-empty-msg"><div>${this.msgEmpty}</div></div>`):0<query(this.box).find(`#grid_${this.name}_empty_msg`).length&&query(this.box).find(`#grid_${this.name}_empty_msg`).remove(),0<this.summary.length?(t=this.getSummaryHTML(),query(this.box).find(`#grid_${this.name}_fsummary`).html(t[0]).show(),query(this.box).find(`#grid_${this.name}_summary`).html(t[1]).show()):(query(this.box).find(`#grid_${this.name}_fsummary`).hide(),query(this.box).find(`#grid_${this.name}_summary`).hide())}render(e){var i=Date.now();let p=this,s=("string"==typeof e&&(e=query(e).get(0)),this.trigger("render",{target:this.name,box:e??this.box}));if(!0!==s.isCancelled&&(null!=e&&(0<query(this.box).find(`#grid_${this.name}_body`).length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-grid w2ui-inactive").html(""),this.box=e),this.box)){e="object"!=typeof this.url?this.url:this.url.get;if(this.reset(!0),!this.last.field)if(this.multiSearch&&this.show.searchAll)this.last.field="all",this.last.label="All Fields";else{let e=0;for(;e<this.searches.length&&(this.searches[e].hidden||!1===this.searches[e].simple);)e++;e>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[e].field,this.last.label=this.searches[e].label)}if(query(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-grid w2ui-inactive").html('<div class="w2ui-grid-box">    <div id="grid_'+this.name+'_header" class="w2ui-grid-header"></div>    <div id="grid_'+this.name+'_toolbar" class="w2ui-grid-toolbar"></div>    <div id="grid_'+this.name+'_body" class="w2ui-grid-body"></div>    <div id="grid_'+this.name+'_fsummary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_summary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_footer" class="w2ui-grid-footer"></div>    <textarea id="grid_'+this.name+'_focus" class="w2ui-grid-focus-input" '+(this.tabIndex?'tabindex="'+this.tabIndex+'"':"")+(w2utils.isIOS?"readonly":"")+"></textarea></div>"),"row"!=this.selectType&&query(this.box).addClass("w2ui-ss"),0<query(this.box).length&&(query(this.box)[0].style.cssText+=this.style),this.initToolbar(),null!=this.toolbar&&this.toolbar.render(query(this.box).find("#grid_"+this.name+"_toolbar")[0]),this.last.toolbar_height=query(this.box).find(`#grid_${this.name}_toolbar`).prop("offsetHeight"),this.last.field&&"all"!=this.last.field){let e=this.searchData;setTimeout(()=>{this.searchInitInput(this.last.field,1==e.length?e[0].value:null)},1)}query(this.box).find(`#grid_${this.name}_footer`).html(this.getFooterHTML()),this.last.state||(this.last.state=this.stateSave(!0)),this.stateRestore(),e&&(this.clear(),this.refresh());let t=!1;for(let e=0;e<this.searches.length;e++)if(this.searches[e].hidden){t=!0;break}t?(this.searchReset(!1),e||setTimeout(()=>{this.searchReset()},1)):this.reload(),query(this.box).find(`#grid_${this.name}_focus`).on("focus",e=>{clearTimeout(this.last.kbd_timer),this.hasFocus||this.focus()}).on("blur",e=>{clearTimeout(this.last.kbd_timer),this.last.kbd_timer=setTimeout(()=>{this.hasFocus&&this.blur()},100)}).on("paste",s=>{let l=s.clipboardData||null;if(l){let e=l.items,i=[];for(var r in e=2==e.length&&2==(e=2==e.length&&"file"==e[1].kind?[e[1]]:e).length&&"text/plain"==e[0].type&&"text/html"==e[1].type?[e[1]]:e){let t=e[r];if("file"===t.kind){r=t.getAsFile();i.push({kind:"file",data:r})}else if("string"===t.kind&&("text/plain"===t.type||"text/html"===t.type)){s.preventDefault();let e=l.getData("text/plain");-1!=e.indexOf("\r")&&-1==e.indexOf("\n")&&(e=e.replace(/\r/g,"\n")),i.push({kind:"text/html"==t.type?"html":"text",data:e})}}1===i.length&&"file"!=i[0].kind&&(i=i[0].data),w2ui[this.name].paste(i,s),s.preventDefault()}}).on("keydown",function(e){w2ui[p.name].keydown.call(w2ui[p.name],e)});let c;return query(this.box).off("mousedown.mouseStart").on("mousedown.mouseStart",function(r){if(1==r.which&&("text"==p.last.userSelect&&(p.last.userSelect="",query(p.box).find(".w2ui-grid-body").css("user-select","none")),!("row"==p.selectType&&(query(r.target).parents().hasClass("w2ui-head")||query(r.target).hasClass("w2ui-head"))||p.last.move&&"expand"==p.last.move.type))){if(r.altKey)query(p.box).find(".w2ui-grid-body").css("user-select","text"),p.selectNone(),p.last.move={type:"text-select"},p.last.userSelect="text";else{let e=r.target,t={x:r.offsetX-10,y:r.offsetY-10},i=!1;for(;e&&(!e.classList||!e.classList.contains("w2ui-grid"));)e.tagName&&"TD"==e.tagName.toUpperCase()&&(i=!0),e.tagName&&"TR"!=e.tagName.toUpperCase()&&1==i&&(t.x+=e.offsetLeft,t.y+=e.offsetTop),e=e.parentNode;p.last.move={x:r.screenX,y:r.screenY,divX:0,divY:0,focusX:t.x,focusY:t.y,recid:query(r.target).parents("tr").attr("recid"),column:parseInt(("TD"==r.target.tagName.toUpperCase()?query(r.target):query(r.target).parents("td")).attr("col")),type:"select",ghost:!1,start:!0},null==p.last.move.recid&&(p.last.move.type="select-column");let s=r.target,l=query(p.box).find("#grid_"+p.name+"_focus");if(p.last.move){let e=p.last.move.focusX,t=p.last.move.focusY,i=query(s).parents("table").parent();(i.hasClass("w2ui-grid-records")||i.hasClass("w2ui-grid-frecords")||i.hasClass("w2ui-grid-columns")||i.hasClass("w2ui-grid-fcolumns")||i.hasClass("w2ui-grid-summary"))&&(e=p.last.move.focusX-query(p.box).find("#grid_"+p.name+"_records").prop("scrollLeft"),t=p.last.move.focusY-query(p.box).find("#grid_"+p.name+"_records").prop("scrollTop")),(query(s).hasClass("w2ui-grid-footer")||0<query(s).parents("div.w2ui-grid-footer").length)&&(t=query(p.box).find("#grid_"+p.name+"_footer").get(0).offsetTop),i.hasClass("w2ui-scroll-wrapper")&&i.parent().hasClass("w2ui-toolbar")&&(e=p.last.move.focusX-i.prop("scrollLeft")),l.css({left:e-10,top:t})}setTimeout(()=>{p.last.inEditMode||(["INPUT","TEXTAREA","SELECT"].includes(s.tagName)?s.focus():l.get(0)!==document.active&&l.get(0).focus())},50),p.multiSelect||p.reorderRows||"drag"!=p.last.move.type||delete p.last.move}if(1==p.reorderRows){let e=r.target;if("TD"!=e.tagName.toUpperCase()&&(e=query(e).parents("td")[0]),query(e).hasClass("w2ui-col-number")||query(e).hasClass("w2ui-col-order")){p.selectNone(),p.last.move.reorder=!0;var s=query(p.box).find(".w2ui-even.w2ui-empty-record").css("background-color"),l=query(p.box).find(".w2ui-odd.w2ui-empty-record").css("background-color");query(p.box).find(".w2ui-even td").filter(":not(.w2ui-col-number)").css("background-color",s),query(p.box).find(".w2ui-odd td").filter(":not(.w2ui-col-number)").css("background-color",l);let t=p.last.move,i=query(p.box).find(".w2ui-grid-records");if(!t.ghost){let e=query(p.box).find(`#grid_${p.name}_rec_`+t.recid);s=e.parents("table").find("tr:first-child").get(0).cloneNode(!0);t.offsetY=r.offsetY,t.from=t.recid,t.pos={top:e.get(0).offsetTop-1,left:e.get(0).offsetLeft},t.ghost=query(e.get(0).cloneNode(!0)),t.ghost.removeAttr("id"),t.ghost.find("td").css({"border-top":"1px solid silver","border-bottom":"1px solid silver"}),e.find("td").remove(),e.append(`<td colspan="1000"><div class="w2ui-reorder-empty" style="height: ${p.recordHeight-2}px"></div></td>`),i.append('<div id="grid_'+p.name+'_ghost_line" style="position: absolute; z-index: 999999; pointer-events: none; width: 100%;"></div>'),i.append('<table id="grid_'+p.name+'_ghost" style="position: absolute; z-index: 999998; opacity: 0.9; pointer-events: none;"></table>'),query(p.box).find("#grid_"+p.name+"_ghost").append(s).append(t.ghost)}let e=query(p.box).find("#grid_"+p.name+"_ghost");e.css({top:t.pos.top+"px",left:t.pos.left+"px"})}else p.last.move.reorder=!1}query(document).on("mousemove.w2ui-"+p.name,n).on("mouseup.w2ui-"+p.name,a),r.stopPropagation()}}),this.updateToolbar(),s.finish(),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),Date.now()-i;function n(a){if(a.target.tagName){let n=p.last.move;if(n&&-1!=["select","select-column"].indexOf(n.type)&&(n.divX=a.screenX-n.x,n.divY=a.screenY-n.y,!(Math.abs(n.divX)<=1&&Math.abs(n.divY)<=1)))if(p.last.cancelClick=!0,1==p.reorderRows&&p.last.move.reorder){let e=query(a.target).parents("tr"),i=e.attr("recid");if((i="-none-"==i?"bottom":i)!=n.from){let e=query(p.box).find("#grid_"+p.name+"_rec_"+i);query(p.box).find(".insert-before"),e.addClass("insert-before"),n.lastY=a.screenY,n.to=i;var o={top:e.get(0)?.offsetTop,left:e.get(0)?.offsetLeft};let t=query(p.box).find("#grid_"+p.name+"_ghost_line");t.css({top:o.top+"px",left:n.pos.left+"px","border-top":"2px solid #769EFC"})}let t=query(p.box).find("#grid_"+p.name+"_ghost");void t.css({top:n.pos.top+n.divY+"px",left:n.pos.left+"px"})}else{n.start&&n.recid&&(p.selectNone(),n.start=!1);let r=[];o=("TR"==a.target.tagName.toUpperCase()?query(a.target):query(a.target).parents("tr")).attr("recid");if(null==o){if("row"!=p.selectType&&(!p.last.move||"select"!=p.last.move.type)){var h=parseInt(query(a.target).parents("td").attr("col"));if(isNaN(h))p.removeRange("column-selection"),query(p.box).find(".w2ui-grid-columns .w2ui-col-header, .w2ui-grid-fcolumns .w2ui-col-header").removeClass("w2ui-col-selected"),query(p.box).find(".w2ui-col-number").removeClass("w2ui-row-selected"),delete n.colRange;else{let e=h+"-"+h,t=(n.column<h&&(e=n.column+"-"+h),[]);var i=(e=n.column>h?h+"-"+n.column:e).split("-");for(let e=parseInt(i[0]);e<=parseInt(i[1]);e++)t.push(e);if(n.colRange!=e&&!0!==(c=p.trigger("columnSelect",{target:p.name,columns:t})).isCancelled){null==n.colRange&&p.selectNone();var s=e.split("-");query(p.box).find(".w2ui-grid-columns .w2ui-col-header, .w2ui-grid-fcolumns .w2ui-col-header").removeClass("w2ui-col-selected");for(let e=parseInt(s[0]);e<=parseInt(s[1]);e++)query(p.box).find("#grid_"+p.name+"_column_"+e+" .w2ui-col-header").addClass("w2ui-col-selected");query(p.box).find(".w2ui-col-number").not(".w2ui-head").addClass("w2ui-row-selected"),n.colRange=e,p.removeRange("column-selection"),p.addRange({name:"column-selection",range:[{recid:p.records[0].recid,column:s[0]},{recid:p.records[p.records.length-1].recid,column:s[1]}],style:"background-color: rgba(90, 145, 234, 0.1)"})}}}}else{let l=p.get(n.recid,!0);if(!(null==l||p.records[l]&&p.records[l].recid!=n.recid)){let e=p.get(o,!0);if(null!=e){let i=parseInt(n.column),s=parseInt(("TD"==a.target.tagName.toUpperCase()?query(a.target):query(a.target).parents("td")).attr("col"));isNaN(i)&&isNaN(s)&&(i=0,s=p.columns.length-1),l>e&&(h=l,l=e,e=h);var d,o="ind1:"+l+",ind2;"+e+",col1:"+i+",col2:"+s;if(n.range!=o){n.range=o;for(let t=l;t<=e;t++)if(!(0<p.last.searchIds.length&&-1==p.last.searchIds.indexOf(t)))if("row"!=p.selectType){i>s&&(d=i,i=s,s=d);for(let e=i;e<=s;e++)p.columns[e].hidden||r.push({recid:p.records[t].recid,column:parseInt(e)})}else r.push(p.records[t].recid);if("row"!=p.selectType){var u=p.getSelection();let e=[];for(let i=0;i<r.length;i++){let t=!1;for(let e=0;e<u.length;e++)r[i].recid==u[e].recid&&r[i].column==u[e].column&&(t=!0);t||e.push({recid:r[i].recid,column:r[i].column})}p.select(e),e=[];for(let i=0;i<u.length;i++){let t=!1;for(let e=0;e<r.length;e++)r[e].recid==u[i].recid&&r[e].column==u[i].column&&(t=!0);t||e.push({recid:u[i].recid,column:u[i].column})}p.unselect(e)}else if(p.multiSelect){let t=p.getSelection();for(let e=0;e<r.length;e++)-1==t.indexOf(r[e])&&p.select(r[e]);for(let e=0;e<t.length;e++)-1==r.indexOf(t[e])&&p.unselect(t[e])}}}}}}}}function a(i){let s=p.last.move;if(setTimeout(()=>{delete p.last.cancelClick},1),!query(i.target).parents().hasClass(".w2ui-head")&&!query(i.target).hasClass(".w2ui-head")){if(s&&-1!=["select","select-column"].indexOf(s.type)){if(null!=s.colRange&&!0!==c.isCancelled){var l=s.colRange.split("-");let i=[];for(let e=0;e<p.records.length;e++){let t=[];for(let e=parseInt(l[0]);e<=parseInt(l[1]);e++)t.push(e);i.push({recid:p.records[e].recid,column:t})}p.removeRange("column-selection"),c.finish(),p.select(i)}if(1==p.reorderRows&&p.last.move.reorder)if(null!=s.to){let e=p.trigger("reorderRow",{target:p.name,recid:s.from,moveBefore:s.to});if(!0===e.isCancelled)return o(),void delete p.last.move;i=p.get(s.from,!0);let t=p.get(s.to,!0);"bottom"==s.to&&(t=p.records.length);var r=p.records[i];null!=i&&null!=t&&(p.records.splice(i,1),i>t?p.records.splice(t,0,r):p.records.splice(t-1,0,r)),o(),e.finish()}else o()}delete p.last.move,query(document).off(".w2ui-"+p.name)}}function o(){query(p.box).find(`#grid_${p.name}_ghost`).remove(),query(p.box).find(`#grid_${p.name}_ghost_line`).remove(),p.refresh(),delete p.last.move}}}destroy(){let e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(query(this.box).off(),"object"==typeof this.toolbar&&this.toolbar.destroy&&this.toolbar.destroy(),0<query(this.box).find(`#grid_${this.name}_body`).length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-grid w2ui-inactive").html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],e.finish())}initColumnOnOff(){let i=[{id:"line-numbers",text:"Line #",checked:this.show.lineNumbers}];for(let t=0;t<this.columns.length;t++){var s=this.columns[t];let e=this.columns[t].text;!1!==s.hideable&&(e=(e=!e&&this.columns[t].tooltip?this.columns[t].tooltip:e)||"- column "+(parseInt(t)+1)+" -",i.push({id:s.field,text:w2utils.stripTags(e),checked:!s.hidden}))}var e;(("object"!=typeof this.url?this.url:this.url.get)&&this.show.skipRecords||this.show.saveRestoreState)&&i.push({text:"--"}),this.show.skipRecords&&(e=w2utils.lang("Skip")+`<input id="${this.name}_skip" type="text" class="w2ui-input w2ui-grid-skip" value="${this.offset}">`+w2utils.lang("records"),i.push({id:"w2ui-skip",text:e,group:!1,icon:"w2ui-icon-empty"})),this.show.saveRestoreState&&i.push({id:"w2ui-stateSave",text:w2utils.lang("Save Grid State"),icon:"w2ui-icon-empty",group:!1},{id:"w2ui-stateReset",text:w2utils.lang("Restore Default State"),icon:"w2ui-icon-empty",group:!1});let t=[];return i.forEach(e=>{e.text=w2utils.lang(e.text),e.checked&&t.push(e.id)}),this.toolbar.set("w2ui-column-on-off",{selected:t,items:i}),i}initColumnDrag(e){if(this.columnGroups&&this.columnGroups.length)throw"Draggable columns are not currently supported with column groups.";let h=this,d={targetPos:null,pressed:!1,columnHead:null};function u(e){var t,i,s,l;d.pressed&&(t=e.pageX,i=e.pageY,e=e,0!=query(e.target).closest("td").length&&(l=query(h.box).find(".w2ui-grid-body").get(0).getBoundingClientRect(),s=query(e.target).closest("td").get(0).getBoundingClientRect(),query(h.box).find(".w2ui-intersection-marker").show().css({left:s.left-l.left+"px"}),d.targetPos=parseInt(query(e.target).closest("td").attr("col"))),s=t,l=i,query(d.ghost).css({left:s-10+"px",top:l-10+"px"}).show())}function c(l){if(d.pressed){d.pressed=!1;let e,t,i,s=query(h.box).find(".w2ui-grid-ghost");if(!0===(e=h.trigger("columnDragEnd",{originalEvent:l,target:d.columnHead[0]})).isCancelled)return!1;t=h.columns[d.originalPos],i=h.columns,d.originalPos!=d.targetPos&&null!=d.targetPos&&(i.splice(d.targetPos,0,w2utils.clone(t)),i.splice(i.indexOf(t),1)),query(h.box).find(".w2ui-intersection-marker").hide(),query(d.ghost).remove(),s.remove(),query(document).off(".colDrag"),d={},h.refresh(),e.finish({targetColumn:NaN})}}return query(h.box).off(".colDrag").on("mousedown.colDrag",function(r){if(!d.pressed&&0!==d.numberPreColumnsPresent&&0===r.button){d.pressed=!0;let t,i,s,l;var n=["w2ui-col-number","w2ui-col-expand","w2ui-col-select"].concat(["w2ui-head-last"]);if(query(r.target).parents().hasClass("w2ui-head")){for(let e=0,t=n.length;e<t;e++)if(query(r.target).parents().hasClass(n[e]))return;if(d.numberPreColumnsPresent=query(h.box).find(".w2ui-head.w2ui-col-number, .w2ui-head.w2ui-col-expand, .w2ui-head.w2ui-col-select").length,d.columnHead=s=query(r.target).parents(".w2ui-head"),d.originalPos=l=parseInt(s.attr("col"),10),!0===(t=h.trigger("columnDragStart",{originalEvent:r,origColumnNumber:l,target:s[0]})).isCancelled)return!1;i=d.columns=query(h.box).find(".w2ui-head:not(.w2ui-head-last)"),query(document).on("mouseup",c),query(document).on("mousemove",u);let e=h.columns[d.originalPos];var a=w2utils.lang("function"==typeof e.text?e.text(e):e.text);d.ghost=query.html(`<span col="${d.originalPos}">${a}</span>`)[0],query(document.body).append(d.ghost),query(d.ghost).css({display:"none",left:r.pageX,top:r.pageY,opacity:1,margin:"3px 0 0 20px",padding:"3px","background-color":"white",position:"fixed","z-index":999999}).addClass(".w2ui-grid-ghost"),d.offsets=[];for(let e=0,t=i.length;e<t;e++){var o=i[e].getBoundingClientRect();d.offsets.push(o.left)}t.finish()}}}),{remove(){query(h.box).off(".colDrag"),h.last.columnDrag=!1}}}columnOnOff(e,t){let i=this.trigger("columnOnOff",{target:this.name,field:t,originalEvent:e});if(!0!==i.isCancelled){var s=this.find({"w2ui.expanded":!0},!0);for(let e=0;e<s.length;e++){var l=this.records[e].w2ui;l&&!Array.isArray(l.children)&&(this.records[e].w2ui.expanded=!1)}"line-numbers"==t?(this.show.lineNumbers=!this.show.lineNumbers,this.refresh()):(e=this.getColumn(t)).hidden?this.showColumn(e.field):this.hideColumn(e.field),i.finish()}}initToolbar(){if(null==this.toolbar.render){let t=this.toolbar.items||[];var e;if(this.toolbar.items=[],this.toolbar=new w2toolbar(w2utils.extend({},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.show.toolbarReload&&this.toolbar.items.push(w2utils.extend({},this.buttons.reload)),this.show.toolbarColumns&&this.toolbar.items.push(w2utils.extend({},this.buttons.columns)),this.show.toolbarSearch&&(e=`
                <div class="w2ui-grid-search-input">
                    ${this.buttons.search.html}
                    <div id="grid_${this.name}_search_name" class="w2ui-grid-search-name">
                        <span class="name-icon w2ui-icon-search"></span>
                        <span class="name-text"></span>
                        <span class="name-cross w2ui-action" data-click="searchReset">x</span>
                    </div>
                    <input type="text" id="grid_${this.name}_search_all" class="w2ui-search-all" tabindex="-1"
                        autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                        placeholder="${w2utils.lang(this.last.label,!0)}" value="${this.last.search}"
                        data-focus="searchSuggest" data-click="stop"
                    >
                    <div class="w2ui-search-drop w2ui-action" data-click="searchOpen"
                            style="${this.multiSearch?"":"display: none"}">
                        <span class="w2ui-icon-drop"></span>
                    </div>
                </div>`,this.toolbar.items.push({id:"w2ui-search",type:"html",html:e,onRefresh:async e=>{await e.complete;let t=query(this.box).find(`#grid_${this.name}_search_all`);w2utils.bindEvents(query(this.box).find(`#grid_${this.name}_search_all, .w2ui-action`),this),t.on("change",e=>{this.liveSearch||(this.search(this.last.field,e.target.value),this.searchSuggest(!0,!0,this))}).on("blur",()=>{this.last.liveText=""}).on("keyup",e=>{var t=e.target.value;this.liveSearch&&this.last.liveText!=t&&(this.last.liveText=t,this.search(this.last.field,t)),40==e.keyCode&&this.searchSuggest(!0)})}})),Array.isArray(t)){let e=t.map(e=>e.id);this.show.toolbarAdd&&!e.includes(this.buttons.add.id)&&this.toolbar.items.push(w2utils.extend({},this.buttons.add)),this.show.toolbarEdit&&!e.includes(this.buttons.edit.id)&&this.toolbar.items.push(w2utils.extend({},this.buttons.edit)),this.show.toolbarDelete&&!e.includes(this.buttons.delete.id)&&this.toolbar.items.push(w2utils.extend({},this.buttons.delete)),this.show.toolbarSave&&!e.includes(this.buttons.save.id)&&((this.show.toolbarAdd||this.show.toolbarDelete||this.show.toolbarEdit)&&this.toolbar.items.push({type:"break",id:"w2ui-break2"}),this.toolbar.items.push(w2utils.extend({},this.buttons.save)))}this.toolbar.items.push(...t),this.toolbar.on("click",i=>{let e=this.trigger("toolbar",{target:i.target,originalEvent:i});if(!0!==e.isCancelled){let t;switch(i.detail.item.id){case"w2ui-reload":if(!0===(t=this.trigger("reload",{target:this.name})).isCancelled)return!1;this.reload(),t.finish();break;case"w2ui-column-on-off":if(i.detail.subItem){let e=i.detail.subItem.id;["w2ui-stateSave","w2ui-stateReset"].includes(e)?this[e.substring(5)]():"w2ui-skip"!=e&&this.columnOnOff(i,i.detail.subItem.id)}else this.initColumnOnOff(),setTimeout(()=>{query(`#w2overlay-${this.name}_toolbar-drop .w2ui-grid-skip`).off(".w2ui-grid").on("click.w2ui-grid",e=>{e.stopPropagation()}).on("keypress",e=>{13==e.keyCode&&(this.skip(e.target.value),this.toolbar.click("w2ui-column-on-off"))})},100);break;case"w2ui-add":if(!0===(t=this.trigger("add",{target:this.name,recid:null})).isCancelled)return!1;t.finish();break;case"w2ui-edit":{var s=this.getSelection();let e=null;if(1==s.length&&(e=s[0]),!0===(t=this.trigger("edit",{target:this.name,recid:e})).isCancelled)return!1;t.finish();break}case"w2ui-delete":this.delete();break;case"w2ui-save":this.save()}e.finish()}}),this.toolbar.on("refresh",e=>{if("w2ui-search"==e.target){let e=this.searchData;setTimeout(()=>{this.searchInitInput(this.last.field,1==e.length?e[0].value:null)},1)}})}}initResize(){let r=this;query(this.box).find(".w2ui-resizer").off(".grid-col-resize").on("click.grid-col-resize",function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault()}).on("mousedown.grid-col-resize",function(e){e=e||window.event,r.last.colResizing=!0,r.last.tmp={x:e.screenX,y:e.screenY,gx:e.screenX,gy:e.screenY,col:parseInt(query(this).attr("name"))},r.last.tmp.tds=query(r.box).find("#grid_"+r.name+'_body table tr:first-child td[col="'+r.last.tmp.col+'"]'),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault();for(let e=0;e<r.columns.length;e++)r.columns[e].hidden||(null==r.columns[e].sizeOriginal&&(r.columns[e].sizeOriginal=r.columns[e].size),r.columns[e].size=r.columns[e].sizeCalculated);let i={phase:"before",type:"columnResize",target:r.name,column:r.last.tmp.col,field:r.columns[r.last.tmp.col].field};i=r.trigger(w2utils.extend(i,{resizeBy:0,originalEvent:e}));let s;query(document).off(".grid-col-resize").on("mousemove.grid-col-resize",function(e){var t;1==r.last.colResizing&&(e=e||window.event,!0===(i=r.trigger(w2utils.extend(i,{resizeBy:e.screenX-r.last.tmp.gx,originalEvent:e}))).isCancelled?i.isCancelled=!1:(r.last.tmp.x=e.screenX-r.last.tmp.x,r.last.tmp.y=e.screenY-r.last.tmp.y,t=parseInt(r.columns[r.last.tmp.col].size)+r.last.tmp.x+"px",r.columns[r.last.tmp.col].size=t,s&&clearTimeout(s),s=setTimeout(()=>{r.resizeRecords(),r.scroll()},100),r.last.tmp.tds.css({width:t}),r.last.tmp.x=e.screenX,r.last.tmp.y=e.screenY))}).on("mouseup.grid-col-resize",function(e){query(document).off(".grid-col-resize"),r.resizeRecords(),r.scroll(),i.finish({originalEvent:e}),setTimeout(()=>{r.last.colResizing=!1},1)})}).on("dblclick.grid-col-resize",function(e){let t=parseInt(query(this).attr("name")),i=r.columns[t],s=0;if(!1===i.autoResize)return!0;e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault(),query(r.box).find('.w2ui-grid-records td[col="'+t+'"] > div',r.box).each(()=>{var e=this.offsetWidth-this.scrollWidth;e<s&&(s=e-3)});let l={phase:"before",type:"columnAutoResize",target:r.name,column:i,field:i.field};!0===(l=r.trigger(w2utils.extend(l,{resizeBy:Math.abs(s),originalEvent:e}))).isCancelled?l.isCancelled=!1:(s<0&&(i.size=Math.min(parseInt(i.size)+Math.abs(s),i.max||1/0)+"px",r.resizeRecords(),r.resizeRecords(),r.scroll()),l.finish({originalEvent:e}))}).each(e=>{var t=query(e).get(0).parentNode;query(e).css({height:t.clientHeight+"px","margin-left":t.clientWidth-3+"px"})})}resizeBoxes(){let e=query(this.box).find(`#grid_${this.name}_header`),t=query(this.box).find(`#grid_${this.name}_toolbar`),i=query(this.box).find(`#grid_${this.name}_fsummary`),s=query(this.box).find(`#grid_${this.name}_summary`),l=query(this.box).find(`#grid_${this.name}_footer`),r=query(this.box).find(`#grid_${this.name}_body`);this.show.header&&e.css({top:"0px",left:"0px",right:"0px"}),this.show.toolbar&&t.css({top:0+(this.show.header?w2utils.getSize(e,"height"):0)+"px",left:"0px",right:"0px"}),0<this.summary.length&&(i.css({bottom:0+(this.show.footer?w2utils.getSize(l,"height"):0)+"px"}),s.css({bottom:0+(this.show.footer?w2utils.getSize(l,"height"):0)+"px",right:"0px"})),this.show.footer&&l.css({bottom:"0px",left:"0px",right:"0px"}),r.css({top:0+(this.show.header?w2utils.getSize(e,"height"):0)+(this.show.toolbar?w2utils.getSize(t,"height"):0)+"px",bottom:0+(this.show.footer?w2utils.getSize(l,"height"):0)+(0<this.summary.length?w2utils.getSize(s,"height"):0)+"px",left:"0px",right:"0px"})}resizeRecords(){let i=this,e=(query(this.box).find(".w2ui-empty-record").remove(),query(this.box)),t=query(this.box).find(":scope > div.w2ui-grid-box");var s=query(this.box).find(`#grid_${this.name}_header`),l=query(this.box).find(`#grid_${this.name}_toolbar`);let r=query(this.box).find(`#grid_${this.name}_summary`),n=query(this.box).find(`#grid_${this.name}_fsummary`);var a,o,h=query(this.box).find(`#grid_${this.name}_footer`);let d=query(this.box).find(`#grid_${this.name}_body`),u=query(this.box).find(`#grid_${this.name}_columns`),c=query(this.box).find(`#grid_${this.name}_fcolumns`),p=query(this.box).find(`#grid_${this.name}_records`),f=query(this.box).find(`#grid_${this.name}_frecords`),m=query(this.box).find(`#grid_${this.name}_scroll1`),g=8*String(this.total).length+10,y=(g<34&&(g=34),null!=this.lineNumberWidth&&(g=this.lineNumberWidth),!1),w=!1,b=0;for(let e=0;e<this.columns.length;e++)this.columns[e].frozen||this.columns[e].hidden||(a=parseInt(this.columns[e].sizeCalculated||this.columns[e].size),b+=a);p[0]?.clientWidth<b&&(y=!0),d[0].clientHeight-(u[0]?.clientHeight??0)<(query(p).find(":scope > table")[0]?.clientHeight??0)+(y?w2utils.scrollBarSize():0)&&(w=!0),this.fixedBody?(o=t[0].clientHeight-(this.show.header?w2utils.getSize(s,"height"):0)-(this.show.toolbar?w2utils.getSize(l,"height"):0)-("none"!=r.css("display")?w2utils.getSize(r,"height"):0)-(this.show.footer?w2utils.getSize(h,"height"):0),d.css("height",o+"px")):(s=(o=w2utils.getSize(u,"height")+w2utils.getSize(query(this.box).find("#grid_"+this.name+"_records table"),"height")+(y?w2utils.scrollBarSize():0))+(this.show.header?w2utils.getSize(s,"height"):0)+(this.show.toolbar?w2utils.getSize(l,"height"):0)+("none"!=r.css("display")?w2utils.getSize(r,"height"):0)+(this.show.footer?w2utils.getSize(h,"height"):0),t.css("height",s+"px"),d.css("height",o+"px"),e.css("height",w2utils.getSize(t,"height")+"px"));let v=this.records.length;l="object"!=typeof this.url?this.url:this.url.get;if(0==this.searchData.length||l||(v=this.last.searchIds.length),this.fixedBody||(w=!1),y||w?(u.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",w2utils.scrollBarSize()+"px").show(),p.css({top:(0<this.columnGroups.length&&this.show.columns?1:0)+w2utils.getSize(u,"height")+"px","-webkit-overflow-scrolling":"touch","overflow-x":y?"auto":"hidden","overflow-y":w?"auto":"hidden"})):(u.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").hide(),p.css({top:(0<this.columnGroups.length&&this.show.columns?1:0)+w2utils.getSize(u,"height")+"px",overflow:"hidden"}),0<p.length&&(this.last.scrollTop=0,this.last.scrollLeft=0)),y?(f.css("margin-bottom",w2utils.scrollBarSize()+"px"),m.show()):(f.css("margin-bottom",0),m.hide()),f.css({overflow:"hidden",top:p.css("top")}),this.show.emptyRecords&&!w){let t=Math.floor((p[0]?.clientHeight??0)/this.recordHeight)-1,e=0;if((e=p[0]?p[0].scrollHeight-t*this.recordHeight:e)>=this.recordHeight&&(e-=this.recordHeight,t++),this.fixedBody){for(let e=v;e<t;e++)x(e,this.recordHeight,this);x(t,e,this)}}function x(e,t,i){let s="",l="";var r;s+='<tr class="'+(e%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+t+'px">',l+='<tr class="'+(e%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+t+'px">',i.show.lineNumbers&&(s+='<td class="w2ui-col-number"></td>'),i.show.selectColumn&&(s+='<td class="w2ui-grid-data w2ui-col-select"></td>'),i.show.expandColumn&&(s+='<td class="w2ui-grid-data w2ui-col-expand"></td>'),l+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',i.show.orderColumn&&(l+='<td class="w2ui-grid-data w2ui-col-order" col="order"></td>');for(let e=0;e<i.columns.length;e++){var n=i.columns[e];(n.hidden||e<i.last.colStart||e>i.last.colEnd)&&!n.frozen||(r='<td class="w2ui-grid-data" '+(null!=n.attr?n.attr:"")+' col="'+e+'"></td>',n.frozen?s+=r:l+=r)}s+='<td class="w2ui-grid-data-last"></td> </tr>',l+='<td class="w2ui-grid-data-last" col="end"></td> </tr>',query(i.box).find("#grid_"+i.name+"_frecords > table").append(s),query(i.box).find("#grid_"+i.name+"_records > table").append(l)}let _,C;if(0<d.length){let i=parseInt(d[0].clientWidth)-(w?w2utils.scrollBarSize():0)-(this.show.lineNumbers?g:0)-(this.show.selectColumn?26:0)-(this.show.expandColumn?26:0)-1,s=(_=i,!1);for(let t=C=0;t<this.columns.length;t++){let e=this.columns[t];0<e.gridMinWidth&&(e.gridMinWidth>_&&!0!==e.hidden&&(e.hidden=!0,s=!0),e.gridMinWidth<_&&!0===e.hidden&&(e.hidden=!1,s=!0))}if(!0===s)return void this.refresh();for(let t=0;t<this.columns.length;t++){let e=this.columns[t];e.hidden||("px"==String(e.size).substr(String(e.size).length-2).toLowerCase()?(i-=parseFloat(e.size),this.columns[t].sizeCalculated=e.size,this.columns[t].sizeType="px"):(C+=parseFloat(e.size),this.columns[t].sizeType="%",delete e.sizeCorrected))}if(100!=C&&0<C)for(let t=0;t<this.columns.length;t++){let e=this.columns[t];e.hidden||"%"==e.sizeType&&(e.sizeCorrected=Math.round(100*parseFloat(e.size)*100/C)/100+"%")}for(let e=0;e<this.columns.length;e++){var q=this.columns[e];q.hidden||"%"==q.sizeType&&(null!=this.columns[e].sizeCorrected?this.columns[e].sizeCalculated=Math.floor(i*parseFloat(q.sizeCorrected)/100)-1+"px":this.columns[e].sizeCalculated=Math.floor(i*parseFloat(q.size)/100)-1+"px")}}let k=0;for(let t=0;t<this.columns.length;t++){let e=this.columns[t];e.hidden||(null==e.min&&(e.min=20),parseInt(e.sizeCalculated)<parseInt(e.min)&&(e.sizeCalculated=e.min+"px"),parseInt(e.sizeCalculated)>parseInt(e.max)&&(e.sizeCalculated=e.max+"px"),k+=parseInt(e.sizeCalculated))}let S=parseInt(_)-parseInt(k);if(0<S&&0<C){let t=0;for(;;){let e=this.columns[t];if(null==e)t=0;else if(e.hidden||"px"==e.sizeType)t++;else{if(e.sizeCalculated=parseInt(e.sizeCalculated)+1+"px",0===--S)break;t++}}}else 0<S&&u.find(":scope > table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",w2utils.scrollBarSize()+"px").show();let T=1;this.show.lineNumbers&&(T+=g),this.show.selectColumn&&(T+=26),this.show.expandColumn&&(T+=26);for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||this.columns[e].frozen&&(T+=parseInt(this.columns[e].sizeCalculated));c.css("width",T+"px"),f.css("width",T+"px"),n.css("width",T+"px"),m.css("width",T+"px"),u.css("left",T+"px"),p.css("left",T+"px"),r.css("left",T+"px"),u.find(":scope > table > tbody > tr:nth-child(1) td").add(c.find(":scope > table > tbody > tr:nth-child(1) td")).each(e=>{query(e).hasClass("w2ui-col-number")&&query(e).css("width",g+"px");var t=query(e).attr("col");if(null!=t){if("start"==t){let t=0;for(let e=0;e<i.last.colStart;e++)!i.columns[e]||i.columns[e].frozen||i.columns[e].hidden||(t+=parseInt(i.columns[e].sizeCalculated));query(e).css("width",t+"px")}i.columns[t]&&query(e).css("width",i.columns[t].sizeCalculated)}if(query(e).hasClass("w2ui-head-last"))if(i.last.colEnd+1<i.columns.length){let t=0;for(let e=i.last.colEnd+1;e<i.columns.length;e++)!i.columns[e]||i.columns[e].frozen||i.columns[e].hidden||(t+=parseInt(i.columns[e].sizeCalculated));query(e).css("width",t+"px")}else query(e).css("width",w2utils.scrollBarSize()+(0<S&&0===C?S:0)+"px")}),3==u.find(":scope > table > tbody > tr").length&&u.find(":scope > table > tbody > tr:nth-child(1) td").add(c.find(":scope > table > tbody > tr:nth-child(1) td")).html("").css({height:"0",border:"0",padding:"0",margin:"0"}),p.find(":scope > table > tbody > tr:nth-child(1) td").add(f.find(":scope > table > tbody > tr:nth-child(1) td")).each(e=>{query(e).hasClass("w2ui-col-number")&&query(e).css("width",g+"px");var t=query(e).attr("col");if(null!=t){if("start"==t){let t=0;for(let e=0;e<i.last.colStart;e++)!i.columns[e]||i.columns[e].frozen||i.columns[e].hidden||(t+=parseInt(i.columns[e].sizeCalculated));query(e).css("width",t+"px")}i.columns[t]&&query(e).css("width",i.columns[t].sizeCalculated)}if(query(e).hasClass("w2ui-grid-data-last")&&0===query(e).parents(".w2ui-grid-frecords").length)if(i.last.colEnd+1<i.columns.length){let t=0;for(let e=i.last.colEnd+1;e<i.columns.length;e++)!i.columns[e]||i.columns[e].frozen||i.columns[e].hidden||(t+=parseInt(i.columns[e].sizeCalculated));query(e).css("width",t+"px")}else query(e).css("width",(0<S&&0===C?S:0)+"px")}),r.find(":scope > table > tbody > tr:nth-child(1) td").add(n.find(":scope > table > tbody > tr:nth-child(1) td")).each(e=>{query(e).hasClass("w2ui-col-number")&&query(e).css("width",g+"px");var t=query(e).attr("col");if(null!=t){if("start"==t){let t=0;for(let e=0;e<i.last.colStart;e++)!i.columns[e]||i.columns[e].frozen||i.columns[e].hidden||(t+=parseInt(i.columns[e].sizeCalculated));query(e).css("width",t+"px")}i.columns[t]&&query(e).css("width",i.columns[t].sizeCalculated)}query(e).hasClass("w2ui-grid-data-last")&&0===query(e).parents(".w2ui-grid-frecords").length&&query(e).css("width",w2utils.scrollBarSize()+(0<S&&0===C?S:0)+"px")}),this.initResize(),this.refreshRanges(),(this.last.scrollTop||this.last.scrollLeft)&&0<p.length&&(u.prop("scrollLeft",this.last.scrollLeft),p.prop("scrollTop",this.last.scrollTop),p.prop("scrollLeft",this.last.scrollLeft))}getSearchesHTML(){let s=`
            <div class="search-title">
                ${w2utils.lang("Advanced Search")}
                <span class="search-logic" style="${this.show.searchLogic?"":"display: none"}">
                    <select id="grid_${this.name}_logic" class="w2ui-input">
                        <option value="AND" ${"AND"==this.last.logic?"selected":""}>${w2utils.lang("All")}</option>
                        <option value="OR" ${"OR"==this.last.logic?"selected":""}>${w2utils.lang("Any")}</option>
                    </select>
                </span>
            </div>
            <table cellspacing="0"><tbody>
        `;for(let i=0;i<this.searches.length;i++){let t=this.searches[i];if(t.type=String(t.type).toLowerCase(),!t.hidden){null==t.attr&&(t.attr=""),null==t.text&&(t.text=""),null==t.style&&(t.style=""),null==t.type&&(t.type="text"),null==t.label&&null!=t.caption&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",t),t.label=t.caption);var l=`<select id="grid_${this.name}_operator_${i}" class="w2ui-input" data-change="initOperator|${i}">
                    ${this.getOperators(t.type,t.operators)}
                </select>`;s+=`<tr>
                        <td class="caption">${w2utils.lang(t.label)||""}</td>
                        <td class="operator">${l}</td>
                        <td class="value">`;let e;switch(t.type){case"text":case"alphanumeric":case"hex":case"color":case"list":case"combo":case"enum":e="width: 250px;",-1!=["hex","color"].indexOf(t.type)&&(e="width: 90px;"),s+=`<input rel="search" type="text" id="grid_${this.name}_field_${i}" name="${t.field}"
                               class="w2ui-input" style="${e+t.style}" ${t.attr}>`;break;case"int":case"float":case"money":case"currency":case"percent":case"date":case"time":case"datetime":e="width: 90px;","datetime"==t.type&&(e="width: 140px;"),s+=`<input id="grid_${this.name}_field_${i}" name="${t.field}" ${t.attr} rel="search" type="text"
                                class="w2ui-input" style="${e+t.style}">
                            <span id="grid_${this.name}_range_${i}" style="display: none">&#160;-&#160;&#160;
                                <input rel="search" type="text" class="w2ui-input" style="${e+t.style}" id="grid_${this.name}_field2_${i}" name="${t.field}" ${t.attr}>
                            </span>`;break;case"select":s+=`<select rel="search" class="w2ui-input" style="${t.style}" id="grid_${this.name}_field_${i}"
                                name="${t.field}" ${t.attr}></select>`}s+=t.text+"    </td></tr>"}}return s+=`<tr>
            <td colspan="2" class="actions">
                <button type="button" class="w2ui-btn close-btn" data-click="searchClose">${w2utils.lang("Close")}</button>
            </td>
            <td class="actions">
                <button type="button" class="w2ui-btn" data-click="searchReset">${w2utils.lang("Reset")}</button>
                <button type="button" class="w2ui-btn w2ui-btn-blue" data-click="search">${w2utils.lang("Search")}</button>
            </td>
        </tr></tbody></table>`}getOperators(e,t){let i=this.operators[this.operatorsMap[e]]||[],s=(null!=t&&Array.isArray(t)&&(i=t),"");return i.forEach(e=>{let t=e,i=e;Array.isArray(e)?(t=e[1],i=e[0]):w2utils.isPlainObject(e)&&(t=e.text,i=e.oper),null==t&&(t=e),s+=`<option name="11" value="${i}">${w2utils.lang(t)}</option>
`}),s}initOperator(e){let i;var t=this.searches[e],s=this.getSearchData(t.field);let l=query(`#w2overlay-${this.name}-search-overlay`),r=l.find(`#grid_${this.name}_range_`+e),n=l.find(`#grid_${this.name}_field_`+e),a=l.find(`#grid_${this.name}_field2_`+e),o=l.find(`#grid_${this.name}_operator_`+e);var h=o.val();switch(n.show(),r.hide(),h){case"between":r.show();break;case"null":case"not null":n.hide(),n.val(h),n.trigger("change")}switch(t.type){case"text":case"alphanumeric":let e=n[0]._w2field;e&&e.reset();break;case"int":case"float":case"hex":case"color":case"money":case"currency":case"percent":case"date":case"time":case"datetime":n[0]._w2field||(new w2field(t.type,{el:n[0],...t.options}),new w2field(t.type,{el:a[0],...t.options}),setTimeout(()=>{n.trigger("keydown"),a.trigger("keydown")},1));break;case"list":case"combo":case"enum":if(i=t.options,"list"==t.type&&(i.selected={}),"enum"==t.type&&(i.selected=[]),s&&(i.selected=s.value),!n[0]._w2field){let e=new w2field(t.type,{el:n[0],...i});s&&null!=s.text&&e.set({id:s.value,text:s.text})}break;case"select":i='<option value="">--</option>';for(let e=0;e<t.options.items.length;e++){var d=t.options.items[e];if(w2utils.isPlainObject(t.options.items[e])){let e=d.id,t=d.text;null==e&&null!=d.value&&(e=d.value),null==t&&null!=d.text&&(t=d.text),null==e&&(e=""),i+='<option value="'+e+'">'+t+"</option>"}else i+='<option value="'+d+'">'+d+"</option>"}n.html(i)}}initSearches(){let n=query(`#w2overlay-${this.name}-search-overlay`);for(let r=0;r<this.searches.length;r++){let e=this.searches[r];var a=this.getSearchData(e.field);e.type=String(e.type).toLowerCase(),"object"!=typeof e.options&&(e.options={});let t=e.operator,i=[...this.operators[this.operatorsMap[e.type]]];e.operators&&(i=e.operators),w2utils.isPlainObject(t)&&(t=t.oper),i.forEach((e,t)=>{w2utils.isPlainObject(e)&&(i[t]=e.oper)}),a&&a.operator&&(t=a.operator);var o=this.defaultOperator[this.operatorsMap[e.type]];-1==i.indexOf(t)&&(t=o),n.find(`#grid_${this.name}_operator_`+r).val(t),this.initOperator(r);let s=n.find(`#grid_${this.name}_field_`+r),l=n.find(`#grid_${this.name}_field2_`+r);null!=a&&(Array.isArray(a.value)?["in","not in"].includes(a.operator)?s[0]._w2field.set(a.value):(s.val(a.value[0]).trigger("change"),l.val(a.value[1]).trigger("change")):null!=a.value&&s.val(a.value).trigger("change"))}n.find(".w2ui-grid-search-advanced *[rel=search]").on("keypress",e=>{13==e.keyCode&&(this.search(),w2tooltip.hide(this.name+"-search-overlay"))})}getColumnsHTML(){let h=this,e="",t="";var i,s,l;return this.show.columnHeaders&&(t=0<this.columnGroups.length?(l=r(!0),i=function(){let l="<tr>",r="<tr>",n="",e=h.columnGroups.length-1;null==h.columnGroups[e].text&&null!=h.columnGroups[e].caption&&(console.log("NOTICE: grid columnGroup.caption property is deprecated, please use columnGroup.text. Group -> ",h.columnGroups[e]),h.columnGroups[e].text=h.columnGroups[e].caption);""!=h.columnGroups[h.columnGroups.length-1].text&&h.columnGroups.push({text:""});h.show.lineNumbers&&(l+='<td class="w2ui-head w2ui-col-number" col="line-number">    <div>&#160;</div></td>');h.show.selectColumn&&(l+='<td class="w2ui-head w2ui-col-select" col="select">    <div style="height: 25px">&#160;</div></td>');h.show.expandColumn&&(l+='<td class="w2ui-head w2ui-col-expand" col="expand">    <div style="height: 25px">&#160;</div></td>');let a=0;r+='<td id="grid_'+h.name+'_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>',h.show.orderColumn&&(r+='<td class="w2ui-head w2ui-col-order" col="order">    <div style="height: 25px">&#160;</div></td>');for(let e=0;e<h.columnGroups.length;e++){let t=h.columnGroups[e],i=h.columns[a]||{},s=(null!=t.colspan&&(t.span=t.colspan),null!=t.span&&t.span==parseInt(t.span)||(t.span=1),null==i.text&&null!=i.caption&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column ->",i),i.text=i.caption),0);for(let e=a;e<a+t.span;e++)h.columns[e]&&!h.columns[e].hidden&&s++;if(!((s=e==h.columnGroups.length-1?100:s)<=0))if(!0===t.main){let t="";for(let e=0;e<h.sortData.length;e++)h.sortData[e].field==i.field&&("asc"===(h.sortData[e].direction||"").toLowerCase()&&(t="w2ui-sort-up"),"desc"===(h.sortData[e].direction||"").toLowerCase()&&(t="w2ui-sort-down"));let e="";!1!==i.resizable&&(e='<div class="w2ui-resizer" name="'+a+'"></div>');var o=w2utils.lang("function"==typeof i.text?i.text(i):i.text);n='<td id="grid_'+h.name+"_column_"+a+'" class="w2ui-head '+t+'" col="'+a+'"     rowspan="2" colspan="'+s+'">'+e+'    <div class="w2ui-col-group w2ui-col-header '+(t?"w2ui-col-sorted":"")+'">        <div class="'+t+'"></div>'+(o||"&#160;")+"    </div></td>",i&&i.frozen?l+=n:r+=n}else{o=w2utils.lang("function"==typeof t.text?t.text(t):t.text);n='<td id="grid_'+h.name+"_column_"+a+'" class="w2ui-head" col="'+a+'"         colspan="'+s+'">    <div class="w2ui-col-group">'+(o||"&#160;")+"    </div></td>",i&&i.frozen?l+=n:r+=n}a+=t.span}return l+="<td></td></tr>",r+='<td id="grid_'+h.name+'_column_end" class="w2ui-head" col="end"></td></tr>',[l,r]}(),s=r(!1),e=l[0]+i[0]+s[0],l[1]+i[1]+s[1]):(l=r(!0),e=l[0],l[1])),[e,t];function r(i){let s="<tr>",l="<tr>",r=(h.show.lineNumbers&&(s+='<td class="w2ui-head w2ui-col-number" col="line-number">    <div>#</div></td>'),h.show.selectColumn&&(s+='<td class="w2ui-head w2ui-col-select" col="select">    <div>        <input type="checkbox" id="grid_'+h.name+'_check_all" class="w2ui-select-all" tabindex="-1"            style="'+(0==h.multiSelect?"display: none;":"")+'"        >    </div></td>'),h.show.expandColumn&&(s+='<td class="w2ui-head w2ui-col-expand" col="expand">    <div>&#160;</div></td>'),0),n=0,a;l+='<td id="grid_'+h.name+'_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>',h.show.orderColumn&&(l+='<td class="w2ui-head w2ui-col-order" col="order">    <div>&#160;</div></td>');for(let t=0;t<h.columns.length;t++){let e=h.columns[t];var o;null==e.text&&null!=e.caption&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column -> ",e),e.text=e.caption),null==e.size&&(e.size="100%"),t==n&&(a=h.columnGroups[r++]||{},n+=a.span),(t<h.last.colStart||t>h.last.colEnd)&&!e.frozen||e.hidden||!0===a.main&&!i||(o=h.getColumnCellHTML(t),e&&e.frozen?s+=o:l+=o)}return s+='<td class="w2ui-head w2ui-head-last"><div>&#160;</div></td>',l+='<td class="w2ui-head w2ui-head-last" col="end"><div>&#160;</div></td>',s+="</tr>",l+="</tr>",[s,l]}}getColumnCellHTML(t){let i=this.columns[t];if(null==i)return"";var e=!this.reorderColumns||this.columnGroups&&this.columnGroups.length?"":" w2ui-reorder-cols-head ";let s="";for(let e=0;e<this.sortData.length;e++)this.sortData[e].field==i.field&&("asc"===(this.sortData[e].direction||"").toLowerCase()&&(s="w2ui-sort-up"),"desc"===(this.sortData[e].direction||"").toLowerCase()&&(s="w2ui-sort-down"));var l,r=this.last.selection.columns;let n=!1;for(l in r)for(let e=0;e<r[l].length;e++)r[l][e]==t&&(n=!0);var a=w2utils.lang("function"==typeof i.text?i.text(i):i.text);return'<td id="grid_'+this.name+"_column_"+t+'" col="'+t+'" class="w2ui-head '+s+e+'">'+(!1!==i.resizable?'<div class="w2ui-resizer" name="'+t+'"></div>':"")+'    <div class="w2ui-col-header '+(s?"w2ui-col-sorted":"")+" "+(n?"w2ui-col-selected":"")+'">        <div class="'+s+'"></div>'+(a||"&#160;")+"    </div></td>"}columnTooltipShow(e,t){let i=query(this.box).find("#grid_"+this.name+"_column_"+e);var e=this.columns[e],s=this.columnTooltip;w2tooltip.show({name:this.name+"-column-tooltip",anchor:i.get(0),html:e.tooltip,position:s})}columnTooltipHide(e,t){w2tooltip.hide(this.name+"-column-tooltip")}getRecordsHTML(){let e=this.records.length;var t="object"!=typeof this.url?this.url:this.url.get;(e=0==this.searchData.length||t?e:this.last.searchIds.length)>this.vs_start?this.last.show_extra=this.vs_extra:this.last.show_extra=this.vs_start;let i=query(this.box).find(`#grid_${this.name}_records`),s=Math.floor((i.get(0)?.clientHeight||0)/this.recordHeight)+this.last.show_extra+1;(!this.fixedBody||s>e)&&(s=e);var l=this.getRecordHTML(-1,0);let r="<table><tbody>"+l[0],n="<table><tbody>"+l[1];r+='<tr id="grid_'+this.name+'_frec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>',n+='<tr id="grid_'+this.name+'_rec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>';for(let e=0;e<s;e++)l=this.getRecordHTML(e,e+1),r+=l[0],n+=l[1];t=(e-s)*this.recordHeight;return r+='<tr id="grid_'+this.name+'_frec_bottom" rec="bottom" line="bottom" style="height: '+t+'px; vertical-align: top">    <td colspan="2000" style="border-right: 1px solid #D6D5D7;"></td></tr><tr id="grid_'+this.name+'_frec_more" style="display: none; ">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',n+='<tr id="grid_'+this.name+'_rec_bottom" rec="bottom" line="bottom" style="height: '+t+'px; vertical-align: top">    <td colspan="2000" style="border: 0"></td></tr><tr id="grid_'+this.name+'_rec_more" style="display: none">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',this.last.range_start=0,this.last.range_end=s,[r,n]}getSummaryHTML(){if(0!==this.summary.length){var s=this.getRecordHTML(-1,0);let t="<table><tbody>"+s[0],i="<table><tbody>"+s[1];for(let e=0;e<this.summary.length;e++)s=this.getRecordHTML(e,e+1,!0),t+=s[0],i+=s[1];return t+="</tbody></table>",i+="</tbody></table>",[t,i]}}scroll(c){let p=this;var i="object"!=typeof this.url?this.url:this.url.get;let f=query(this.box).find(`#grid_${this.name}_records`),m=query(this.box).find(`#grid_${this.name}_frecords`),o=(c&&(g=c.target.scrollTop,c=c.target.scrollLeft,this.last.scrollTop=g,this.last.scrollLeft=c,query(this.box).find(`#grid_${this.name}_columns`)[0].scrollLeft=c,query(this.box).find(`#grid_${this.name}_summary`)[0].scrollLeft=c,m[0].scrollTop=g),this.last.bubbleEl&&(w2tooltip.hide(this.name+"-bubble"),this.last.bubbleEl=null),null),h=null;if(this.disableCVS||0<this.columnGroups.length)o=0,h=this.columns.length-1;else{var s,l=f.prop("clientWidth");let t=0;for(let e=0;e<this.columns.length;e++)this.columns[e].frozen||this.columns[e].hidden||(s=parseInt(this.columns[e].sizeCalculated||this.columns[e].size),t+s+30>this.last.scrollLeft&&null==o&&(o=e),t+s-30>this.last.scrollLeft+l&&null==h&&(h=e),t+=s);null==h&&(h=this.columns.length-1)}if(null!=o&&(o<0&&(o=0),h<0&&(h=0),o==h&&(0<o?o--:h++),o!=this.last.colStart||h!=this.last.colEnd)){let a=query(this.box);var c=Math.abs(o-this.last.colStart),g=Math.abs(h-this.last.colEnd);if(c<5&&g<5){let e=a.find(`.w2ui-grid-columns #grid_${this.name}_column_start`),t=a.find(".w2ui-grid-columns .w2ui-head-last"),i=a.find(`#grid_${this.name}_records .w2ui-grid-data-spacer`),l=a.find(`#grid_${this.name}_records .w2ui-grid-data-last`),r=a.find(`#grid_${this.name}_summary .w2ui-grid-data-spacer`),n=a.find(`#grid_${this.name}_summary .w2ui-grid-data-last`);if(o>this.last.colStart)for(let e=this.last.colStart;e<o;e++)a.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+e).remove(),a.find("#grid_"+this.name+'_records td[col="'+e+'"]').remove(),a.find("#grid_"+this.name+'_summary td[col="'+e+'"]').remove();if(h<this.last.colEnd)for(let e=this.last.colEnd;e>h;e--)a.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+e).remove(),a.find("#grid_"+this.name+'_records td[col="'+e+'"]').remove(),a.find("#grid_"+this.name+'_summary td[col="'+e+'"]').remove();if(o<this.last.colStart)for(let s=this.last.colStart-1;s>=o;s--)this.columns[s]&&(this.columns[s].frozen||this.columns[s].hidden)||(e.after(this.getColumnCellHTML(s)),i.each(e=>{var t=query(e).parent().attr("index");let i='<td class="w2ui-grid-data" col="'+s+'" style="height: 0px"></td>';null!=t&&(i=this.getCellHTML(parseInt(t),s,!1)),query(e).after(i)}),r.each(e=>{var t=query(e).parent().attr("index");let i='<td class="w2ui-grid-data" col="'+s+'" style="height: 0px"></td>';null!=t&&(i=this.getCellHTML(parseInt(t),s,!0)),query(e).after(i)}));if(h>this.last.colEnd)for(let s=this.last.colEnd+1;s<=h;s++)this.columns[s]&&(this.columns[s].frozen||this.columns[s].hidden)||(t.before(this.getColumnCellHTML(s)),l.each(e=>{var t=query(e).parent().attr("index");let i='<td class="w2ui-grid-data" col="'+s+'" style="height: 0px"></td>';null!=t&&(i=this.getCellHTML(parseInt(t),s,!1)),query(e).before(i)}),n.each(e=>{var t=query(e).parent().attr("index")||-1,t=this.getCellHTML(parseInt(t),s,!0);query(e).before(t)}));this.last.colStart=o,this.last.colEnd=h,this.resizeRecords()}else{this.last.colStart=o,this.last.colEnd=h;var c=this.getColumnsHTML(),g=this.getRecordsHTML(),y=this.getSummaryHTML();let e=a.find(`#grid_${this.name}_columns`),t=a.find(`#grid_${this.name}_records`),i=a.find(`#grid_${this.name}_frecords`),s=a.find(`#grid_${this.name}_summary`);e.find("tbody").html(c[1]),i.html(g[0]),t.prepend(g[1]),null!=y&&s.html(y[1]),setTimeout(()=>{t.find(":scope > table").filter(":not(table:first-child)").remove(),s[0]&&(s[0].scrollLeft=this.last.scrollLeft)},1),this.resizeRecords()}}let w=this.records.length;if(w>this.total&&-1!==this.total&&(w=this.total),0!==(w=0==this.searchData.length||i?w:this.last.searchIds.length)&&0!==f.length&&0!==f.prop("clientHeight")){w>this.vs_start?this.last.show_extra=this.vs_extra:this.last.show_extra=this.vs_start;let e=Math.round(f.prop("scrollTop")/this.recordHeight+1),t=e+(Math.round(f.prop("clientHeight")/this.recordHeight)-1);if(e>w&&(e=w),t>=w-1&&(t=w),query(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-right").html((this.show.statusRange?w2utils.formatNumber(this.offset+e)+"-"+w2utils.formatNumber(this.offset+t)+(-1!=this.total?" "+w2utils.lang("of")+" "+w2utils.formatNumber(this.total):""):"")+(i&&this.show.statusBuffered?" ("+w2utils.lang("buffered")+" "+w2utils.formatNumber(w)+(0<this.offset?", skip "+w2utils.formatNumber(this.offset):"")+")":"")),i||this.fixedBody&&!(-1!=this.total&&this.total<=this.vs_start)){let t=Math.floor(f.prop("scrollTop")/this.recordHeight)-this.last.show_extra,i=t+Math.floor(f.prop("clientHeight")/this.recordHeight)+2*this.last.show_extra+1,s=(t<1&&(t=1),i>this.total&&-1!=this.total&&(i=this.total),f.find("#grid_"+this.name+"_rec_top")),l=f.find("#grid_"+this.name+"_rec_bottom"),r=m.find("#grid_"+this.name+"_frec_top"),n=m.find("#grid_"+this.name+"_frec_bottom");-1!=String(s.next().prop("id")).indexOf("_expanded_row")&&(s.next().remove(),r.next().remove()),this.total>i&&-1!=String(l.prev().prop("id")).indexOf("_expanded_row")&&(l.prev().remove(),n.prev().remove());c=parseInt(s.next().attr("line")),g=parseInt(l.prev().attr("line"));let e,a,o,h,d;if(c<t||1==c||this.last.pull_refresh){if(i<=g+this.last.show_extra-2&&i!=this.total)return;for(this.last.pull_refresh=!1;;){if(a=m.find("#grid_"+this.name+"_frec_top").next(),"bottom"==(o=f.find("#grid_"+this.name+"_rec_top").next()).attr("line"))break;if(!(parseInt(o.attr("line"))<t))break;a.remove(),o.remove()}e=f.find("#grid_"+this.name+"_rec_bottom").prev(),"top"==(h=e.attr("line"))&&(h=t);for(let e=parseInt(h)+1;e<=i;e++)this.records[e-1]&&((o=this.records[e-1].w2ui)&&!Array.isArray(o.children)&&(o.expanded=!1),d=this.getRecordHTML(e-1,e),l.before(d[1]),n.before(d[0]));b(),setTimeout(()=>{this.refreshRanges()},0)}else{if(t>=c-this.last.show_extra+2&&1<t)return;for(;;){if(a=m.find("#grid_"+this.name+"_frec_bottom").prev(),"top"==(o=f.find("#grid_"+this.name+"_rec_bottom").prev()).attr("line"))break;if(!(parseInt(o.attr("line"))>i))break;a.remove(),o.remove()}e=f.find("#grid_"+this.name+"_rec_top").next(),"bottom"==(h=e.attr("line"))&&(h=i);for(let e=parseInt(h)-1;e>=t;e--)this.records[e-1]&&((o=this.records[e-1].w2ui)&&!Array.isArray(o.children)&&(o.expanded=!1),d=this.getRecordHTML(e-1,e),s.after(d[1]),r.after(d[0]));b(),setTimeout(()=>{this.refreshRanges()},0)}y=(t-1)*this.recordHeight;let u=(w-i)*this.recordHeight;if(u<0&&(u=0),s.css("height",y+"px"),r.css("height",y+"px"),l.css("height",u+"px"),n.css("height",u+"px"),this.last.range_start=t,this.last.range_end=i,Math.floor(f.prop("scrollTop")/this.recordHeight)+Math.floor(f.prop("clientHeight")/this.recordHeight)+10>w&&!0!==this.last.pull_more&&(w<this.total-this.offset||-1==this.total&&this.last.fetch.hasMore)){!0===this.autoLoad&&(this.last.pull_more=!0,this.last.fetch.offset+=this.limit,this.request("load"));let e=query(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more");e.show().eq(1).off(".load-more").on("click.load-more",function(){query(this).find("td").html('<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>'),p.last.pull_more=!0,p.last.fetch.offset+=p.limit,p.request("load")}).find("td").html(p.autoLoad?'<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>':'<div style="padding-top: 15px">'+w2utils.lang("Load ${count} more...",{count:p.limit})+"</div>")}function b(){p.markSearch&&(clearTimeout(p.last.marker_timer),p.last.marker_timer=setTimeout(()=>{let t=[];for(let e=0;e<p.searchData.length;e++){var i=p.searchData[e],s=p.getSearch(i.field);s&&!s.hidden&&(s=p.getColumn(i.field,!0),t.push({field:i.field,search:i.value,col:s}))}0<t.length&&t.forEach(e=>{var t=query(p.box).find('td[col="'+e.col+'"]:not(.w2ui-head)');w2utils.marker(t,e.search)})},50))}}}}getRecordHTML(t,e,i){let s="",l="",r=this.last.selection,n;if(-1==t){s+='<tr line="0">',l+='<tr line="0">',this.show.lineNumbers&&(s+='<td class="w2ui-col-number" style="height: 0px"></td>'),this.show.selectColumn&&(s+='<td class="w2ui-col-select" style="height: 0px"></td>'),this.show.expandColumn&&(s+='<td class="w2ui-col-expand" style="height: 0px"></td>'),l+='<td class="w2ui-grid-data w2ui-grid-data-spacer" col="start" style="height: 0px; width: 0px"></td>',this.show.orderColumn&&(l+='<td class="w2ui-col-order" style="height: 0px"></td>');for(let e=0;e<this.columns.length;e++){var a=this.columns[e],o='<td class="w2ui-grid-data" col="'+e+'" style="height: 0px;"></td>';a.frozen&&!a.hidden?s+=o:a.hidden||e<this.last.colStart||e>this.last.colEnd||(l+=o)}return s+='<td class="w2ui-grid-data-last" style="height: 0px"></td>',l+='<td class="w2ui-grid-data-last" col="end" style="height: 0px"></td>',s+="</tr>",l+="</tr>",[s,l]}var h="object"!=typeof this.url?this.url:this.url.get;if(!0!==i)if(0<this.searchData.length&&!h){if(t>=this.last.searchIds.length)return"";t=this.last.searchIds[t],n=this.records[t]}else{if(t>=this.records.length)return"";n=this.records[t]}else{if(t>=this.summary.length)return"";n=this.summary[t]}if(!n)return"";null==n.recid&&null!=this.recid&&null!=(h=this.parseField(n,this.recid))&&(n.recid=h);let d=!1,u=(-1!=r.indexes.indexOf(t)&&(d=!0),n.w2ui?n.w2ui.style:""),c=(null!=u&&"string"==typeof u||(u=""),n.w2ui?n.w2ui.class:"");if(null!=c&&"string"==typeof c||(c=""),s+='<tr id="grid_'+this.name+"_frec_"+n.recid+'" recid="'+n.recid+'" line="'+e+'" index="'+t+'"  class="'+(e%2==0?"w2ui-even":"w2ui-odd")+" w2ui-record "+c+(d&&"row"==this.selectType?" w2ui-selected":"")+(n.w2ui&&!1===n.w2ui.editable?" w2ui-no-edit":"")+(n.w2ui&&!0===n.w2ui.expanded?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(d||""==u?u.replace("background-color","none"):u)+'" '+(""!=u?'custom_style="'+u+'"':"")+">",l+='<tr id="grid_'+this.name+"_rec_"+n.recid+'" recid="'+n.recid+'" line="'+e+'" index="'+t+'"  class="'+(e%2==0?"w2ui-even":"w2ui-odd")+" w2ui-record "+c+(d&&"row"==this.selectType?" w2ui-selected":"")+(n.w2ui&&!1===n.w2ui.editable?" w2ui-no-edit":"")+(n.w2ui&&!0===n.w2ui.expanded?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(d||""==u?u.replace("background-color","none"):u)+'" '+(""!=u?'custom_style="'+u+'"':"")+">",this.show.lineNumbers&&(s+='<td id="grid_'+this.name+"_cell_"+t+"_number"+(i?"_s":"")+'"    class="w2ui-col-number '+(d?" w2ui-row-selected":"")+'"'+(this.reorderRows?' style="cursor: move"':"")+">"+(!0!==i?this.getLineHTML(e,n):"")+"</td>"),this.show.selectColumn&&(s+='<td id="grid_'+this.name+"_cell_"+t+"_select"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-select">'+(!0===i||n.w2ui&&!0===n.w2ui.hideCheckBox?"":'    <div>        <input class="w2ui-grid-select-check" type="checkbox" tabindex="-1" '+(d?'checked="checked"':"")+' style="pointer-events: none"/>    </div>')+"</td>"),this.show.expandColumn){let e="";e=n.w2ui&&!0===n.w2ui.expanded?"-":"+",!n.w2ui||"none"!=n.w2ui.expanded&&Array.isArray(n.w2ui.children)&&n.w2ui.children.length||(e=""),n.w2ui&&"spinner"==n.w2ui.expanded&&(e='<div class="w2ui-spinner" style="width: 16px; margin: -2px 2px;"></div>'),s+='<td id="grid_'+this.name+"_cell_"+t+"_expand"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-expand">'+(!0!==i?`<div>${e}</div>`:"")+"</td>"}l+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',this.show.orderColumn&&(l+='<td id="grid_'+this.name+"_cell_"+t+"_order"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-order" col="order">'+(!0!==i?'<div title="Drag to reorder">&nbsp;</div>':"")+"</td>");let p=0,f=0;for(;;){let e=1;var m=this.columns[p];if(null==m)break;if(m.hidden)p++,0<f&&f--;else if(0<f){if(p++,null==this.columns[p])break;n.w2ui.colspan[this.columns[p-1].field]=0,f--}else{if(n.w2ui){let e=n.w2ui.colspan;var g=this.columns[p].field;e&&0===e[g]&&delete e[g]}if((p<this.last.colStart||p>this.last.colEnd)&&!m.frozen)p++;else{if(n.w2ui&&"object"==typeof n.w2ui.colspan){var y=parseInt(n.w2ui.colspan[m.field])||null;if(1<y){let t=0;for(let e=p;e<p+y&&!(e>=this.columns.length);e++)this.columns[e].hidden&&t++;e=y-t,f=y-1}}g=this.getCellHTML(t,p,i,e);m.frozen?s+=g:l+=g,p++}}}return s+='<td class="w2ui-grid-data-last"></td>',l+='<td class="w2ui-grid-data-last" col="end"></td>',s+="</tr>",l+="</tr>",[s,l]}getLineHTML(e){return"<div>"+e+"</div>"}getCellHTML(i,s,l,e){let r=this,n=this.columns[s];if(null==n)return"";let a=(!0!==l?this.records:this.summary)[i],{value:t,style:o,className:h,attr:d,divAttr:u}=this.getCellValue(i,s,l,!0);var c=-1!==i?this.getCellEditable(i,s):"";let p="max-height: "+parseInt(this.recordHeight)+"px;"+(n.clipboardCopy?"margin-right: 20px":"");var f=!l&&a&&a.w2ui&&a.w2ui.changes&&null!=a.w2ui.changes[n.field];let m=this.last.selection,g=!1,y="";if(-1!=m.indexes.indexOf(i)&&(g=!0),null==e&&(e=a&&a.w2ui&&a.w2ui.colspan&&a.w2ui.colspan[n.field]?a.w2ui.colspan[n.field]:1),0===s&&a&&a.w2ui&&Array.isArray(a.w2ui.children)){let t=0,e=this.get(a.w2ui.parent_recid,!0);for(;;){if(null==e)break;t++;var w=this.records[e].w2ui;if(null==w||null==w.parent_recid)break;e=this.get(w.parent_recid,!0)}if(a.w2ui.parent_recid)for(let e=0;e<t;e++)y+='<span class="w2ui-show-children w2ui-icon-empty"></span>';var b=0<a.w2ui.children.length?a.w2ui.expanded?"w2ui-icon-collapse":"w2ui-icon-expand":"w2ui-icon-empty";y+=`<span class="w2ui-show-children ${b}"></span>`}if(!0===n.info&&(n.info={}),null!=n.info){let e="w2ui-icon-info",t=("function"==typeof n.info.icon?e=n.info.icon(a,{self:this,index:i,colIndex:s,summary:!!l}):"object"==typeof n.info.icon?e=n.info.icon[this.parseField(a,n.field)]||"":"string"==typeof n.info.icon&&(e=n.info.icon),n.info.style||"");"function"==typeof n.info.style?t=n.info.style(a,{self:this,index:i,colIndex:s,summary:!!l}):"object"==typeof n.info.style?t=n.info.style[this.parseField(a,n.field)]||"":"string"==typeof n.info.style&&(t=n.info.style),y+=`<span class="w2ui-info ${e}" style="${t}"></span>`}let v=t,x=(c&&-1!=["checkbox","check"].indexOf(c.type)&&(p+="text-align: center;",v=`<input tabindex="-1" type="checkbox" class="w2ui-editable-checkbox"
                            data-changeInd="${l?-(i+1):i}" data-colInd="${s}" ${v?'checked="checked"':""}>`,y=""),null==(v=`<div style="${p}" ${function(e){let t;r.show.recordTitles&&(null!=n.title?("function"==typeof n.title&&(t=n.title.call(r,a,{self:this,index:i,colIndex:s,summary:!!l})),"string"==typeof n.title&&(t=n.title)):t=w2utils.stripTags(String(e).replace(/"/g,"''")));return null!=t?'title="'+String(t)+'"':""}(v)} ${u}>${y}${String(v)}</div>`)&&(v=""),"string"==typeof n.render&&(b=n.render.toLowerCase().split(":"),-1!=["number","int","float","money","currency","percent","size"].indexOf(b[0])&&(o+="text-align: right;")),a&&a.w2ui&&("object"==typeof a.w2ui.style&&("string"==typeof a.w2ui.style[s]&&(o+=a.w2ui.style[s]+";"),"string"==typeof a.w2ui.style[n.field]&&(o+=a.w2ui.style[n.field]+";")),"object"==typeof a.w2ui.class&&("string"==typeof a.w2ui.class[s]&&(h+=a.w2ui.class[s]+" "),"string"==typeof a.w2ui.class[n.field]&&(h+=a.w2ui.class[n.field]+" "))),!1);g&&m.columns[i]?.includes(s)&&(x=!0);let _;return n.clipboardCopy&&(_='<span class="w2ui-clipboard-copy w2ui-icon-paste"></span>'),v='<td class="w2ui-grid-data'+(x?" w2ui-selected":"")+" "+h+(f?" w2ui-changed":"")+'"    id="grid_'+this.name+"_data_"+i+"_"+s+'" col="'+s+'"    style="'+o+(null!=n.style?n.style:"")+'" '+(null!=n.attr?n.attr:"")+d+(1<e?'colspan="'+e+'"':"")+">"+v+(_&&w2utils.stripTags(v)?_:"")+"</td>",v=-1===i&&!0===l?'<td class="w2ui-grid-data" col="'+s+'" style="height: 0px; '+o+'" '+(1<e?'colspan="'+e+'"':"")+"></td>":v}clipboardCopy(e,t,i){var s=(i?this.summary:this.records)[e];let l=this.columns[t],r=l?this.parseField(s,l.field):"";"function"==typeof l.clipboardCopy&&(r=l.clipboardCopy(s,{self:this,index:e,colIndex:t,summary:!!i})),query(this.box).find("#grid_"+this.name+"_focus").text(r).get(0).select(),document.execCommand("copy")}showBubble(l,r,n){let a=this.columns[r].info;if(a){let s="";var o=this.records[l];let e=query(this.box).find(`${n?".w2ui-grid-summary":""} #grid_${this.name}_data_${l}_${r} .w2ui-info`);if(this.last.bubbleEl&&w2tooltip.hide(this.name+"-bubble"),this.last.bubbleEl=e,null==a.fields){a.fields=[];for(let e=0;e<this.columns.length;e++){var i=this.columns[e];a.fields.push(i.field+("string"==typeof i.render?":"+i.render:""))}}let t=a.fields;if("function"==typeof t&&(t=t(o,{self:this,index:l,colIndex:r,summary:!!n})),"function"==typeof a.render)s=a.render(o,{self:this,index:l,colIndex:r,summary:!!n});else if(Array.isArray(t)){s='<table cellpadding="0" cellspacing="0">';for(let e=0;e<t.length;e++){var h=String(t[e]).split(":");if(""==h[0]||"-"==h[0]||"--"==h[0]||"---"==h[0])s+='<tr><td colspan=2><div style="border-top: '+(""==h[0]?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>';else{let e=this.getColumn(h[0]),t=(e=null==e?{field:h[0],caption:h[0]}:e)?this.parseField(o,e.field):"";1<h.length&&(w2utils.formatters[h[1]]?t=w2utils.formatters[h[1]](t,h[2]||null,o):console.log('ERROR: w2utils.formatters["'+h[1]+'"] does not exists.')),(!0===a.showEmpty||null!=t&&""!=t)&&(null!=a.maxLength&&"string"==typeof t&&t.length>a.maxLength&&(t=t.substr(0,a.maxLength)+"..."),s+="<tr><td>"+e.text+"</td><td>"+((0===t?"0":t)||"")+"</td></tr>")}}s+="</table>"}else if(w2utils.isPlainObject(t)){for(var d in s='<table cellpadding="0" cellspacing="0">',t){let i=t[d];if(""==i||"-"==i||"--"==i||"---"==i)s+='<tr><td colspan=2><div style="border-top: '+(""==i?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>';else{var u=String(i).split(":");let e=this.getColumn(u[0]),t=(e=null==e?{field:u[0],caption:u[0]}:e)?this.parseField(o,e.field):"";1<u.length&&(w2utils.formatters[u[1]]?t=w2utils.formatters[u[1]](t,u[2]||null,o):console.log('ERROR: w2utils.formatters["'+u[1]+'"] does not exists.')),"function"==typeof i&&(t=i(o,{self:this,index:l,colIndex:r,summary:!!n})),(!0===a.showEmpty||null!=t&&""!=t)&&(null!=a.maxLength&&"string"==typeof t&&t.length>a.maxLength&&(t=t.substr(0,a.maxLength)+"..."),s+="<tr><td>"+d+"</td><td>"+((0===t?"0":t)||"")+"</td></tr>")}}s+="</table>"}return w2tooltip.show(w2utils.extend({name:this.name+"-bubble",html:s,anchor:e.get(0),position:"top|bottom",class:"w2ui-info-bubble",style:"",hideOn:["doc-click"]},a.options??{})).hide(()=>[this.last.bubbleEl=null])}}getCellEditable(e,t){var i=this.columns[t],s=this.records[e];if(!s||!i)return null;let l=s.w2ui?s.w2ui.editable:null;return!1===l?null:(null!=l&&!0!==l||"function"==typeof(l=i&&0<Object.keys(i.editable).length?i.editable:null)&&(i=this.getCellValue(e,t,!1),l=l.call(this,s,{self:this,value:i,index:e,colIndex:t,summary:!!summary})),l)}getCellValue(t,i,s,e){let l=this.columns[i];var r=(!0!==s?this.records:this.summary)[t];let n=this.parseField(r,l.field),a="",o="",h="",d="";if(null!=r?.w2ui?.changes?.[l.field]&&(n=r.w2ui.changes[l.field]),null!=l.render&&-1!==t){if("function"==typeof l.render&&null!=r){let e;try{e=l.render(r,{self:this,value:n,index:t,colIndex:i,summary:!!s})}catch(e){throw new Error(`Render function for column "${l.field}" in grid "${this.name}": -- `+e.message)}null!=e&&"object"==typeof e&&"function"!=typeof e?(null!=e.id&&null!=e.text?n=e.text:"string"==typeof e.html?n=(e.html||"").trim():(n="",console.log("ERROR: render function should return a primitive or an object of the following structure.",{html:"",attr:"",style:"",class:"",divAttr:""})),h=e.attr??"",o=e.style??"",a=e.class??"",d=e.divAttr??""):n=String(e||"").trim()}if("object"!=typeof l.render||null!=(t=l.render[n])&&""!==t&&(n=t),"string"==typeof l.render){i=l.render.toLowerCase().indexOf(":");let e=[],t=(-1==i?(e[0]=l.render.toLowerCase(),e[1]=""):(e[0]=l.render.toLowerCase().substr(0,i),e[1]=l.render.toLowerCase().substr(i+1)),w2utils.formatters[e[0]]);l.options&&!1===l.options.autoFormat&&(t=null),n="function"==typeof t?t(n,e[1],r):""}}return null==n&&(n=""),e?{value:n,attr:h,style:o,className:a,divAttr:d}:n}getFooterHTML(){return'<div>    <div class="w2ui-footer-left"></div>    <div class="w2ui-footer-right"></div>    <div class="w2ui-footer-center"></div></div>'}status(i){if(null!=i)query(this.box).find(`#grid_${this.name}_footer`).find(".w2ui-footer-left").html(i);else{let t="";i=this.getSelection();if(0<i.length&&(this.show.statusSelection&&1<i.length&&(t=String(i.length).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+w2utils.settings.groupSymbol)+" "+w2utils.lang("selected")),this.show.statusRecordID&&1==i.length)){let e=i[0];"object"==typeof e&&(e=e.recid+", "+w2utils.lang("Column")+": "+e.column),t=w2utils.lang("Record ID")+": "+e+" "}query(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-left").html(t)}}lock(e,t){let i=Array.from(arguments);i.unshift(this.box),setTimeout(()=>{query(this.box).find("#grid_"+this.name+"_empty_msg").remove(),w2utils.lock(...i)},10)}unlock(e){setTimeout(()=>{query(this.box).find(".w2ui-message").hasClass("w2ui-closing")||w2utils.unlock(this.box,e)},25)}stateSave(e){let t={columns:[],show:w2utils.clone(this.show),last:{search:this.last.search,multi:this.last.multi,logic:this.last.logic,label:this.last.label,field:this.last.field,scrollTop:this.last.scrollTop,scrollLeft:this.last.scrollLeft},sortData:[],searchData:[]},l;for(let e=0;e<this.columns.length;e++){let i=this.columns[e],s={};Object.keys(this.stateColProps).forEach((e,t)=>{this.stateColProps[e]&&(l=void 0!==i[e]?i[e]:this.colTemplate[e]||null,s[e]=l)}),t.columns.push(s)}for(let e=0;e<this.sortData.length;e++)t.sortData.push(w2utils.clone(this.sortData[e]));for(let e=0;e<this.searchData.length;e++)t.searchData.push(w2utils.clone(this.searchData[e]));let i=this.trigger("stateSave",{target:this.name,state:t});if(!0!==i.isCancelled)return!0!==e&&this.cacheSave("state",t),i.finish(),t}stateRestore(i){let s="object"!=typeof this.url?this.url:this.url.get,e=(i=i||this.cache("state"),this.trigger("stateRestore",{target:this.name,state:i}));if(!0!==e.isCancelled){if(w2utils.isPlainObject(i)){w2utils.extend(this.show,i.show??{}),w2utils.extend(this.last,i.last??{});let e=this.last.scrollTop,t=this.last.scrollLeft;for(let e=0;e<i.columns?.length;e++){var l=i.columns[e],r=this.getColumn(l.field,!0);null!==r&&(w2utils.extend(this.columns[r],l),e!==r&&this.columns.splice(e,0,this.columns.splice(r,1)[0]))}this.sortData.splice(0,this.sortData.length);for(let e=0;e<i.sortData?.length;e++)this.sortData.push(i.sortData[e]);this.searchData.splice(0,this.searchData.length);for(let e=0;e<i.searchData?.length;e++)this.searchData.push(i.searchData[e]);setTimeout(()=>{s||(0<this.sortData.length&&this.localSort(),0<this.searchData.length&&this.localSearch()),this.last.scrollTop=e,this.last.scrollLeft=t,this.refresh()},1),console.log('INFO (w2ui): state restored for "${this.name}"')}return e.finish(),!0}}stateReset(){this.stateRestore(this.last.state),this.cacheSave("state",null)}parseField(e,i){if(this.nestedFields){let t="";try{t=e;var s=String(i).split(".");for(let e=0;e<s.length;e++)t=t[s[e]]}catch(e){t=""}return t}return e?e[i]:""}prepareData(){let t=this;for(let e=0;e<this.records.length;e++)!function i(s){for(let e=0;e<t.columns.length;e++){let i=t.columns[e];if(null!=s[i.field]&&"string"==typeof i.render){if(-1!=["number","int","float","money","currency","percent"].indexOf(i.render.split(":")[0])&&"number"!=typeof s[i.field]&&(s[i.field]=parseFloat(s[i.field])),-1!=["date","age"].indexOf(i.render.split(":")[0])&&!s[i.field+"_"]){let e=s[i.field];w2utils.isInt(e)&&(e=parseInt(e)),s[i.field+"_"]=new Date(e)}if(-1!=["time"].indexOf(i.render))if(w2utils.isTime(s[i.field])){let e=w2utils.isTime(s[i.field],!0),t=new Date;t.setHours(e.hours,e.minutes,e.seconds||0,0),s[i.field+"_"]||(s[i.field+"_"]=t)}else{let e=s[i.field],t=(e=null!=(e=w2utils.isInt(e)?parseInt(e):e)?new Date(e):new Date,new Date);t.setHours(e.getHours(),e.getMinutes(),e.getSeconds(),0),s[i.field+"_"]||(s[i.field+"_"]=t)}}}if(s.w2ui&&s.w2ui.children&&!0!==s.w2ui.expanded)for(let t=0;t<s.w2ui.children.length;t++){let e=s.w2ui.children[t];i(e)}}(this.records[e])}nextCell(e,t,i){t+=1;if(t>=this.columns.length)return null==(e=this.nextRow(e))?e:this.nextCell(e,-1,i);var s=this.records[e].w2ui,l=this.columns[t],s=s&&s.colspan&&!isNaN(s.colspan[l.field])?parseInt(s.colspan[l.field]):1;if(null==l)return null;if(l&&l.hidden||0===s)return this.nextCell(e,t,i);if(i){l=this.getCellEditable(e,t);if(null==l||-1!=["checkbox","check"].indexOf(l.type))return this.nextCell(e,t,i)}return{index:e,colIndex:t}}prevCell(e,t,i){t-=1;if(t<0)return null==(e=this.prevRow(e))?e:this.prevCell(e,this.columns.length,i);if(t<0)return null;var s=this.records[e].w2ui,l=this.columns[t],s=s&&s.colspan&&!isNaN(s.colspan[l.field])?parseInt(s.colspan[l.field]):1;if(null==l)return null;if(l&&l.hidden||0===s)return this.prevCell(e,t,i);if(i){l=this.getCellEditable(e,t);if(null==l||-1!=["checkbox","check"].indexOf(l.type))return this.prevCell(e,t,i)}return{index:e,colIndex:t}}nextRow(e,t,i){let s=this.last.searchIds,l=null;if(-1==(i=null==i?1:i))return this.records.length-1;if(e+i<this.records.length&&0===s.length||0<s.length&&e<s[s.length-i]){if(e+=i,0<s.length)for(;;){if(s.includes(e)||e>this.records.length)break;e+=i}var r=this.records[e].w2ui,n=this.columns[t],r=r&&r.colspan&&null!=n&&!isNaN(r.colspan[n.field])?parseInt(r.colspan[n.field]):1;l=0===r?this.nextRow(e,t,i):e}return l}prevRow(e,t,i){let s=this.last.searchIds,l=null;if(-1==(i=null==i?1:i))return 0;if(0<=e-i&&0===s.length||0<s.length&&e>s[0]){if(e-=i,0<s.length)for(;;){if(s.includes(e)||e<0)break;e-=i}var r=this.records[e].w2ui,n=this.columns[t],r=r&&r.colspan&&null!=n&&!isNaN(r.colspan[n.field])?parseInt(r.colspan[n.field]):1;l=0===r?this.prevRow(e,t,i):e}return l}selectionSave(){return this.last.saved_sel=this.getSelection(),this.last.saved_sel}selectionRestore(e){var t=Date.now();this.last.selection={indexes:[],columns:{}};let i=this.last.selection;var s,l=this.last.saved_sel;if(l)for(let e=0;e<l.length;e++)w2utils.isPlainObject(l[e])?null!=(s=this.get(l[e].recid,!0))&&(-1==i.indexes.indexOf(s)&&i.indexes.push(s),i.columns[s]||(i.columns[s]=[]),i.columns[s].push(l[e].column)):null!=(s=this.get(l[e],!0))&&i.indexes.push(s);return delete this.last.saved_sel,!0!==e&&this.refresh(),Date.now()-t}message(e){return w2utils.message({owner:this,box:this.box,after:".w2ui-grid-header"},e)}confirm(e){return w2utils.confirm({owner:this,box:this.box,after:".w2ui-grid-header"},e)}}class w2form extends w2base{constructor(e){super(e.name),this.name=null,this.header="",this.box=null,this.url="",this.routeData={},this.formURL="",this.formHTML="",this.page=0,this.pageStyle="",this.recid=0,this.fields=[],this.actions={},this.record={},this.original=null,this.method=null,this.dataType=null,this.postData={},this.httpHeaders={},this.toolbar={},this.tabs={},this.style="",this.focus=0,this.autosize=!0,this.nestedFields=!0,this.multipart=!1,this.tabindexBase=0,this.isGenerated=!1,this.last={fetchCtrl:null,fetchOptions:null,errors:[]},this.onRequest=null,this.onLoad=null,this.onValidate=null,this.onSubmit=null,this.onProgress=null,this.onSave=null,this.onChange=null,this.onInput=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onAction=null,this.onToolbar=null,this.onError=null,this.msgRefresh="Loading...",this.msgSaving="Saving...",this.ALL_TYPES=["text","textarea","email","pass","password","int","float","money","currency","percent","hex","alphanumeric","color","date","time","datetime","toggle","checkbox","radio","check","checks","list","combo","enum","file","select","map","array","div","custom","html","empty"],this.LIST_TYPES=["select","radio","check","checks","list","combo","enum"],this.W2FIELD_TYPES=["int","float","money","currency","percent","hex","alphanumeric","color","date","time","datetime","list","combo","enum","file"],w2utils.extend(this,e);var t,i,s=e.record,l=e.original,r=e.fields,n=e.toolbar;let a=e.tabs;if(Object.assign(this,{record:{},original:null,fields:[],tabs:{},toolbar:{},handlers:[]}),r&&(e=function l(r){let n=[];let a=[];if(w2utils.isPlainObject(r)){let e=r;function o(t){let i=["html"];return null==t.html&&(t.html={}),Object.keys(t).forEach(e=>{-1==i.indexOf(e)&&-1!=["label","attr","style","text","span","page","column","anchor","group","groupStyle","groupTitleStyle","groupCollapsible"].indexOf(e)&&(t.html[e]=t[e],delete t[e])}),t}function h(t,i){let s=["style","html"];Object.keys(t).forEach(e=>{-1==s.indexOf(e)&&-1!=["span","column","attr","text","label"].indexOf(e)&&t[e]&&!i.html[e]&&(i.html[e]=t[e])})}r=[],Object.keys(e).forEach(i=>{let s=e[i];if("group"==s.type){if(s.text=i,w2utils.isPlainObject(s.fields)){let i=s.fields;s.fields=[],Object.keys(i).forEach(e=>{let t=i[e];t.field=e,s.fields.push(o(t))})}r.push(s)}else if("tab"==s.type){let e={id:i,text:i},t=(s.style&&(e.style=s.style),a.push(e),l(s.fields).fields);t.forEach(e=>{e.html=e.html||{},e.html.page=a.length-1,h(s,e)}),r.push(...t)}else s.field=i,r.push(o(s))})}r.forEach(s=>{if("group"==s.type){let i={group:s.text||"",groupStyle:s.style||"",groupTitleStyle:s.titleStyle||"",groupCollapsible:!0===s.collapsible};Array.isArray(s.fields)&&s.fields.forEach(e=>{let t=w2utils.clone(e);null==t.html&&(t.html={}),w2utils.extend(t.html,i),Array("span","column","attr","label","page").forEach(e=>{null==t.html[e]&&null!=s[e]&&(t.html[e]=s[e])}),null==t.field&&null!=t.name&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",s),t.field=t.name),n.push(t)})}else{let e=w2utils.clone(s);null==e.field&&null!=e.name&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",s),e.field=e.name),n.push(e)}});return{fields:n,tabs:a}}(r),this.fields=e.fields,!a&&0<e.tabs.length&&(a=e.tabs)),Array.isArray(a)){w2utils.extend(this.tabs,{tabs:[]});for(let e=0;e<a.length;e++){var o=a[e];"object"==typeof o?(this.tabs.tabs.push(o),!0===o.active&&(this.tabs.active=o.id)):this.tabs.tabs.push({id:o,text:o})}}else w2utils.extend(this.tabs,a);for(t in w2utils.extend(this.toolbar,n),s)w2utils.isPlainObject(s[t])?this.record[t]=w2utils.clone(s[t]):this.record[t]=s[t];for(i in l)w2utils.isPlainObject(l[i])?this.original[i]=w2utils.clone(l[i]):this.original[i]=l[i];""!==this.formURL?fetch(this.formURL).then(e=>e.text()).then(e=>{this.formHTML=e,this.isGenerated=!0,this.box&&this.render(this.box)}):this.formURL||this.formHTML?this.formHTML&&(this.isGenerated=!0):(this.formHTML=this.generateHTML(),this.isGenerated=!0),"string"==typeof this.box&&(this.box=query(this.box).get(0)),this.box&&this.render(this.box)}get(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.fields.length;e++)null!=this.fields[e].field&&t.push(this.fields[e].field);return t}for(let e=0;e<this.fields.length;e++)if(this.fields[e].field==t)return!0===i?e:this.fields[e];return null}set(t,i){for(let e=0;e<this.fields.length;e++)if(this.fields[e].field==t)return w2utils.extend(this.fields[e],i),this.refresh(t),!0;return!1}getValue(t,i){if(this.nestedFields){let e=void 0;try{var s=!0===i?this.original:this.record;e=String(t).split(".").reduce((e,t)=>e[t],s)}catch(e){}return e}return this.record[t]}setValue(e,l){if((""===l||null==l||Array.isArray(l)&&0===l.length||w2utils.isPlainObject(l)&&0==Object.keys(l).length)&&(l=null),!this.nestedFields)return this.record[e]=l,!0;try{let s=this.record;return String(e).split(".").map((e,t,i)=>{i.length-1!==t?s=s[e]||(s[e]={},s[e]):s[e]=l}),!0}catch(e){return!1}}getFieldValue(e){let s=this.get(e);if(null!=s){var l=s.el;let t=this.getValue(e);e=this.getValue(e,!0);let i=l.value;if(["int","float","percent","money","currency"].includes(s.type)&&(i=s.w2field.clean(i)),["radio"].includes(s.type)&&(r=query(l).closest("div").find("input:checked").get(0),i=r?s.options.items[query(r).data("index")].id:null),["toggle","checkbox"].includes(s.type)&&(i=l.checked),-1!==["check","checks"].indexOf(s.type)){i=[];let e=query(l).closest("div").find("input:checked");0<e.length&&e.each(e=>{e=s.options.items[query(e).data("index")];i.push(e.id)}),Array.isArray(t)||(t=[])}var r=l._w2field?.selected;if(["list","enum","file"].includes(s.type)&&r){var n=r,a=t;if(Array.isArray(n)){i=[];for(let e=0;e<n.length;e++)i[e]=w2utils.clone(n[e])}if(Array.isArray(a)){t=[];for(let e=0;e<a.length;e++)t[e]=w2utils.clone(a[e])}w2utils.isPlainObject(n)&&(i=w2utils.clone(n)),w2utils.isPlainObject(a)&&(t=w2utils.clone(a))}return["map","array"].includes(s.type)&&(i="map"==s.type?{}:[],s.$el.parent().find(".w2ui-map-field").each(e=>{var t=query(e).find(".w2ui-map.key").val(),e=query(e).find(".w2ui-map.value").val();"map"==s.type?i[t]=e:i.push(e)})),{current:i,previous:t,original:e}}}setFieldValue(e,r){let n=this.get(e);if(null!=n){let s=n.el;switch(n.type){case"toggle":case"checkbox":s.checked=!!r;break;case"radio":{r=r?.id??r;let i=query(s).closest("div").find("input"),e=n.options.items;e.forEach((e,t)=>{e.id===r&&i.filter(`[data-index="${t}"]`).prop("checked",!0)});break}case"check":case"checks":{r=(r=Array.isArray(r)?r:null!=r?[r]:[]).map(e=>e?.id??e);let i=query(s).closest("div").find("input"),e=n.options.items;e.forEach((e,t)=>{i.filter(`[data-index="${t}"]`).prop("checked",!!r.includes(e.id))});break}case"list":case"combo":let t=r;null==t?.id&&n.options.items.forEach(e=>{e.id===r&&(t=e)}),t!=r&&this.setValue(n.name,t),"list"==n.type?(n.w2field.selected=t,n.w2field.refresh()):n.el.value=t?.text??r;break;case"enum":case"file":{let s=[...r=Array.isArray(r)?r:null!=r?[r]:[]],l=!1;s.forEach((t,i)=>{null==t?.id&&Array.isArray(n.options.items)&&n.options.items.forEach(e=>{e.id==t&&(s[i]=e,l=!0)})}),l&&this.setValue(n.name,s),n.w2field.selected=s,n.w2field.refresh();break}case"map":case"array":"map"!=n.type||null!=r&&w2utils.isPlainObject(r)||(this.setValue(n.field,{}),r=this.getValue(n.field)),"array"!=n.type||null!=r&&Array.isArray(r)||(this.setValue(n.field,[]),r=this.getValue(n.field));var i=query(n.el).parent().find(".w2ui-map-container");n.el.mapRefresh(r,i);break;case"div":case"custom":query(s).html(r);break;case"html":case"empty":break;default:s.value=r??""}}}show(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&e.hidden&&(e.hidden=!1,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),this.updateEmptyGroups(),i}hide(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&!e.hidden&&(e.hidden=!0,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),this.updateEmptyGroups(),i}enable(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&e.disabled&&(e.disabled=!1,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),i}disable(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&!e.disabled&&(e.disabled=!0,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),i}updateEmptyGroups(){query(this.box).find(".w2ui-group").each(e=>{!function(e){let t=!0;return e.each(e=>{"none"!=e.style.display&&(t=!1)}),t}(query(e).find(".w2ui-field"))?query(e).show():query(e).hide()})}change(){Array.from(arguments).forEach(e=>{let t=this.get(e);t.$el&&t.$el.change()})}reload(e){return("object"!=typeof this.url?this.url:this.url.get)&&0!==this.recid&&null!=this.recid?this.request(e):("function"==typeof e&&e(),new Promise(e=>{e()}))}clear(){0!=arguments.length?Array.from(arguments).forEach(e=>{let s=this.record;String(e).split(".").map((e,t,i)=>{i.length-1!==t?s=s[e]:delete s[e]}),this.refresh(e)}):(this.recid=0,this.record={},this.original=null,this.refresh(),this.hideErrors())}error(e){let t=this.trigger("error",{target:this.name,message:e,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions});!0!==t.isCancelled&&(setTimeout(()=>{this.message(e)},1),t.finish())}message(e){return w2utils.message({owner:this,box:this.box,after:".w2ui-form-header"},e)}confirm(e){return w2utils.confirm({owner:this,box:this.box,after:".w2ui-form-header"},e)}validate(e){null==e&&(e=!0);let i=[];for(let t=0;t<this.fields.length;t++){let e=this.fields[t];var s,l;switch(null==this.getValue(e.field)&&this.setValue(e.field,""),-1!=["int","float","currency","money"].indexOf(e.type)&&(s=this.getValue(e.field),r=e.options.min,l=e.options.max,null!=r&&s<r&&i.push({field:e,error:w2utils.lang("Should be more than ${min}",{min:r})}),null!=l&&l<s&&i.push({field:e,error:w2utils.lang("Should be less than ${max}",{max:l})})),e.type){case"alphanumeric":this.getValue(e.field)&&!w2utils.isAlphaNumeric(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not alpha-numeric")});break;case"int":this.getValue(e.field)&&!w2utils.isInt(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not an integer")});break;case"percent":case"float":this.getValue(e.field)&&!w2utils.isFloat(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not a float")});break;case"currency":case"money":this.getValue(e.field)&&!w2utils.isMoney(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not in money format")});break;case"color":case"hex":this.getValue(e.field)&&!w2utils.isHex(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not a hex number")});break;case"email":this.getValue(e.field)&&!w2utils.isEmail(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not a valid email")});break;case"checkbox":1==this.getValue(e.field)?this.setValue(e.field,!0):this.setValue(e.field,!1);break;case"date":e.options.format||(e.options.format=w2utils.settings.dateFormat),this.getValue(e.field)&&!w2utils.isDate(this.getValue(e.field),e.options.format)&&i.push({field:e,error:w2utils.lang("Not a valid date")+": "+e.options.format})}var r=this.getValue(e.field);e.required&&!0!==e.hidden&&!["div","custom","html","empty"].includes(e.type)&&(null==r||""===r||Array.isArray(r)&&0===r.length||w2utils.isPlainObject(r)&&0==Object.keys(r).length)&&i.push({field:e,error:w2utils.lang("Required field")}),e.options&&!0!==e.hidden&&0<e.options.minLength&&-1==["enum","list","combo"].indexOf(e.type)&&this.getValue(e.field).length<e.options.minLength&&i.push({field:e,error:w2utils.lang("Field should be at least ${count} characters.",{count:e.options.minLength})})}let t=this.trigger("validate",{target:this.name,errors:i});if(!0!==t.isCancelled)return this.last.errors=i,e&&this.showErrors(),t.finish(),i}showErrors(){let e=this.last.errors;e.length<=0||(this.goto(e[0].field.page),query(e[0].field.$el).parents(".w2ui-field")[0].scrollIntoView({block:"nearest",inline:"nearest"}),e.forEach(t=>{var i=w2utils.extend({anchorClass:"w2ui-error",class:"w2ui-light",position:"right|left",hideOn:["input"]},t.options);if(null!=t.field){let e=t.field.el;"radio"===t.field.type?e=query(t.field.el).closest("div").get(0):["enum","file"].includes(t.field.type),w2tooltip.show(w2utils.extend({anchor:e,name:`${this.name}-${t.field.field}-error`,html:t.error},i))}}),query(e[0].field.$el).parents(".w2ui-page").off(".hideErrors").on("scroll.hideErrors",e=>{this.hideErrors()}))}hideErrors(){this.fields.forEach(e=>{w2tooltip.hide(`${this.name}-${e.field}-error`)})}getChanges(){let e={};return e=null!=this.original&&"object"==typeof this.original&&0!==Object.keys(this.record).length?function e(t,i,s){if(Array.isArray(t)&&Array.isArray(i))for(;t.length<i.length;)t.push(null);for(var l in t)null!=t[l]&&"object"==typeof t[l]?(s[l]=e(t[l],i[l]||{},{}),(!s[l]||0==Object.keys(s[l]).length&&Object.keys(0==i[l].length))&&delete s[l]):(t[l]!=i[l]||null==t[l]&&null!=i[l])&&(s[l]=t[l]);return 0!=Object.keys(s).length?s:null}(this.record,this.original,{}):e}getCleanRecord(e){let l=w2utils.clone(this.record);return this.fields.forEach(t=>{if(-1!=["list","combo","enum"].indexOf(t.type)){var s={nestedFields:!0,record:l};let i=this.getValue.call(s,t.field);w2utils.isPlainObject(i)&&null!=i.id&&this.setValue.call(s,t.field,i.id),Array.isArray(i)&&i.forEach((e,t)=>{w2utils.isPlainObject(e)&&e.id&&(i[t]=e.id)})}if("map"==t.type){s={nestedFields:!0,record:l};let e=this.getValue.call(s,t.field);e._order&&delete e._order}if("file"==t.type){s={nestedFields:!0,record:l};let e=this.getValue.call(s,t.field)??[];e.forEach(e=>{delete e.file,delete e.modified}),this.setValue.call(s,t.field,e)}}),!0===e&&Object.keys(l).forEach(e=>{this.get(e)||delete l[e]}),l}request(t,l){let r=this,n,a;var o=new Promise((e,t)=>{n=e,a=t});if("function"==typeof t&&(l=t,t=null),null==t&&(t={}),this.url&&("object"!=typeof this.url||this.url.get)){null==this.recid&&(this.recid=0);let e={cmd:"get"},s=(e.recid=this.recid,e.name=this.name,w2utils.extend(e,this.postData),w2utils.extend(e,t),this.trigger("request",{target:this.name,url:this.url,method:this.method,postData:e,httpHeaders:this.httpHeaders}));if(!0!==s.isCancelled){this.record={},this.original=null,this.lock(w2utils.lang(this.msgRefresh));let t=s.detail.url;if("object"==typeof t&&t.get&&(t=t.get),this.last.fetchCtrl)try{this.last.fetchCtrl.abort()}catch(e){}if(0!=Object.keys(this.routeData).length){var h=w2utils.parseRoute(t);if(0<h.keys.length)for(let e=0;e<h.keys.length;e++)null!=this.routeData[h.keys[e].name]&&(t=t.replace(new RegExp(":"+h.keys[e].name,"g"),this.routeData[h.keys[e].name]))}t=new URL(t,location);let e={method:"GET",headers:s.detail.httpHeaders},i=s.detail.postData;switch(s.detail.dataType??this.dataType??w2utils.settings.dataType){case"HTTP":case"RESTFULL":Object.keys(i).forEach(e=>t.searchParams.append(e,i[e]));break;case"HTTPJSON":case"RESTFULLJSON":i={request:JSON.stringify(i)},Object.keys(i).forEach(e=>t.searchParams.append(e,i[e]));break;case"JSON":e.method="POST",e.body=JSON.stringify(i),e.headers.contentType="application/json"}return this.method&&(e.method=this.method),s.detail.method&&(e.method=s.detail.method),this.last.fetchCtrl=new AbortController,e.signal=this.last.fetchCtrl.signal,this.last.fetchOptions=e,fetch(t,e).catch(d).then(e=>{if(200!=e?.status)e&&d(e);else{let t=r.trigger("load",{target:r.name,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions,data:e});!0!==t.isCancelled&&e.json().catch(d).then(e=>{!0===(e=e.record?e:{error:!1,record:e}).error?r.error(w2utils.lang(e.message)):r.record=w2utils.clone(e.record),r.unlock(),t.finish(),r.refresh(),r.setFocus(),"function"==typeof l&&l(e),n(e)})}}),s.finish(),o;function d(t){if("AbortError"!==t.name){r.unlock();let e=r.trigger("error",{response:t,fetchCtrl:r.last.fetchCtrl,fetchOptions:r.last.fetchOptions});!0!==e.isCancelled&&(t.status&&200!=t.status?r.error(t.status+": "+t.statusText):(console.log("ERROR: Server request failed.",t,". ","Expected Response:",{error:!1,record:{field1:1,field2:"item"}},"OR:",{error:!0,message:"Error description"}),r.error(String(t))),e.finish(),a(t))}}}}}submit(e,t){return this.save(e,t)}save(t,r){let n=this,a,o;var h=new Promise((e,t)=>{a=e,o=t}),d=("function"==typeof t&&(r=t,t=null),n.validate(!0));if(0===d.length)if(null==t&&(t={}),!n.url||"object"==typeof n.url&&!n.url.save)console.log("ERROR: Form cannot be saved because no url is defined.");else{n.lock(w2utils.lang(n.msgSaving)+' <span id="'+n.name+'_progress"></span>');let e={cmd:"save"},l=(e.recid=n.recid,e.name=n.name,w2utils.extend(e,n.postData),w2utils.extend(e,t),n.multipart||n.fields.forEach(e=>{"file"===e.type&&Array.isArray(n.getValue(e.field))&&n.getValue(e.field).forEach(e=>{delete e.file})}),e.record=w2utils.clone(n.record),n.trigger("submit",{target:n.name,url:n.url,method:n.method,postData:e,httpHeaders:n.httpHeaders}));if(!0!==l.isCancelled){let t=l.detail.url;if("object"==typeof t&&t.save&&(t=t.save),n.last.fetchCtrl&&n.last.fetchCtrl.abort(),0<Object.keys(n.routeData).length){var u=w2utils.parseRoute(t);if(0<u.keys.length)for(let e=0;e<u.keys.length;e++)null!=n.routeData[u.keys[e].name]&&(t=t.replace(new RegExp(":"+u.keys[e].name,"g"),n.routeData[u.keys[e].name]))}t=new URL(t,location);let i={method:"POST",headers:l.detail.httpHeaders,body:l.detail.postData};d=l.detail.dataType??this.dataType??w2utils.settings.dataType;let s=l.detail.postData;switch(d){case"HTTP":i.type="GET",Object.keys(s).forEach(e=>t.searchParams.append(e,s[e])),delete i.body;break;case"HTTPJSON":i.type="GET",s=JSON.stringify({request:s}),Object.keys(s).forEach(e=>t.searchParams.append(e,s[e])),delete i.body;break;case"RESTFULL":break;case"RESTFULLJSON":i.body=JSON.stringify(i.body),i.headers.contentType="application/json";break;case"JSON":if(i.headers.contentType="application/json",n.multipart){function c(e,t,i,s){for(var l in null==s&&(s=""),t){var r=""==s?l:"${p}[${prop}]",n=i&&i[l];!function t(i,s,l){if("object"==typeof i&&i instanceof File&&e.append(l,i),"object"==typeof i)if(i&&i.constructor===Array)for(let e=0;e<i.length;e++){var r=s&&s[e];t(i[e],r,l+"["+e+"]")}else c(e,i,s,l)}(t[l],n,r)}}let e=new FormData;e.append("__body",JSON.stringify(i.body)),c(e,i.body),i.body=e}else i.body=JSON.stringify(i.body)}return this.method&&(i.method=this.method),l.detail.method&&(i.method=l.detail.method),this.last.fetchCtrl=new AbortController,i.signal=this.last.fetchCtrl.signal,this.last.fetchOptions=i,fetch(t,i).catch(p).then(e=>{if(n.unlock(),200!=e?.status)p(e??{});else{let t=n.trigger("save",{target:n.name,fetchCtrl:this.last.fetchCtrl,fetchOptions:this.last.fetchOptions,data:e});!0!==t.isCancelled&&e.json().catch(p).then(e=>{!0===e.error?n.error(w2utils.lang(e.message)):n.original=null,t.finish(),n.refresh(),"function"==typeof r&&r(e),a(e)})}}),l.finish(),h;function p(t){if("AbortError"!==t?.name){n.unlock();let e=n.trigger("error",{response:t,fetchCtrl:n.last.fetchCtrl,fetchOptions:n.last.fetchOptions});!0!==e.isCancelled&&(t.status&&200!=t.status?n.error(t.status+": "+t.statusText):(console.log("ERROR: Server request failed.",t,". ","Expected Response:",{error:!1,record:{field1:1,field2:"item"}},"OR:",{error:!0,message:"Error description"}),n.error(String(t))),e.finish(),o())}}}}}lock(e,t){let i=Array.from(arguments);i.unshift(this.box),w2utils.lock(...i)}unlock(e){var t=this.box;w2utils.unlock(t,e)}lockPage(e,t,i){e=query(this.box).find(".page-"+e);return!!e.length&&(w2utils.lock(e,t,i),!0)}unlockPage(e,t){e=query(this.box).find(".page-"+e);return!!e.length&&(w2utils.unlock(e,t),!0)}goto(e){this.page!==e&&(null!=e&&(this.page=e),!0===query(this.box).data("autoSize")&&(query(this.box).get(0).clientHeight=0),this.refresh())}generateHTML(){let l=[],t="",r,n,a,o;var h;for(let e=0;e<this.fields.length;e++){a="",h=' tabindex="'+(o=this.tabindexBase+e+1)+'"';let i=this.fields[e],s=(null==i.html&&(i.html={}),null==i.options&&(i.options={}),null!=i.html.caption&&null==i.html.label&&(console.log("NOTICE: form field.html.caption property is deprecated, please use field.html.label. Field ->",i),i.html.label=i.html.caption),null==i.html.label&&(i.html.label=i.field),i.html=w2utils.extend({label:"",span:6,attr:"",text:"",style:"",page:0,column:0},i.html),null==r&&(r=i.html.page),null==n&&(n=i.html.column),`<input id="${i.field}" name="${i.field}" class="w2ui-input" type="text" ${i.html.attr+h}>`);switch(i.type){case"pass":case"password":s=s.replace('type="text"','type="password"');break;case"checkbox":s=`
                        <label class="w2ui-box-label">
                            <input id="${i.field}" name="${i.field}" class="w2ui-input" type="checkbox" ${i.html.attr+h}>
                            <span>${i.html.label}</span>
                        </label>`;break;case"check":case"checks":{null==i.options.items&&null!=i.html.items&&(i.options.items=i.html.items);let t=i.options.items;s="",0<(t=Array.isArray(t)?t:[]).length&&(t=w2utils.normMenu.call(this,t,i));for(let e=0;e<t.length;e++)s+=`
                            <label class="w2ui-box-label">
                                <input id="${i.field+e}" name="${i.field}" class="w2ui-input" type="checkbox"
                                    ${i.html.attr+h} data-value="${t[e].id}" data-index="${e}">
                                <span>&#160;${t[e].text}</span>
                            </label>
                            <br>`;break}case"radio":{s="",null==i.options.items&&null!=i.html.items&&(i.options.items=i.html.items);let t=i.options.items;0<(t=Array.isArray(t)?t:[]).length&&(t=w2utils.normMenu.call(this,t,i));for(let e=0;e<t.length;e++)s+=`
                            <label class="w2ui-box-label">
                                <input id="${i.field+e}" name="${i.field}" class="w2ui-input" type="radio"
                                    ${i.html.attr+(0===e?h:"")}
                                    data-value="${t[e].id}" data-index="${e}">
                                <span>&#160;${t[e].text}</span>
                            </label>
                            <br>`;break}case"select":{s=`<select id="${i.field}" name="${i.field}" class="w2ui-input" ${i.html.attr+h}>`,null==i.options.items&&null!=i.html.items&&(i.options.items=i.html.items);let t=i.options.items;0<(t=Array.isArray(t)?t:[]).length&&(t=w2utils.normMenu.call(this,t,i));for(let e=0;e<t.length;e++)s+=`<option value="${t[e].id}">${t[e].text}</option>`;s+="</select>";break}case"textarea":s=`<textarea id="${i.field}" name="${i.field}" class="w2ui-input" ${i.html.attr+h}></textarea>`;break;case"toggle":s=`<input id="${i.field}" name="${i.field}" class="w2ui-input w2ui-toggle" type="checkbox" ${i.html.attr+h}>
                            <div><div></div></div>`;break;case"map":case"array":i.html.key=i.html.key||{},i.html.value=i.html.value||{},i.html.tabindex_str=h,s='<span style="float: right">'+(i.html.text||"")+'</span><input id="'+i.field+'" name="'+i.field+'" type="hidden" '+i.html.attr+h+'><div class="w2ui-map-container"></div>';break;case"div":case"custom":s='<div id="'+i.field+'" name="'+i.field+'" '+i.html.attr+h+' class="w2ui-input">'+(i&&i.html&&i.html.html?i.html.html:"")+"</div>";break;case"html":case"empty":s=i&&i.html?(i.html.html||"")+(i.html.text||""):""}if(""!==t&&(r!=i.html.page||n!=i.html.column||i.html.group&&t!=i.html.group)&&(l[r][n]+="\n   </div>\n  </div>",t=""),i.html.group&&t!=i.html.group){let e="";i.html.groupCollapsible&&(e='<span class="w2ui-icon-collapse" style="width: 15px; display: inline-block; position: relative; top: -2px;"></span>'),a+='\n <div class="w2ui-group">\n   <div class="w2ui-group-title w2ui-eaction" style="'+(i.html.groupTitleStyle||"")+"; "+(""!=e?"cursor: pointer; user-select: none":"")+'"'+(""!=e?'data-group="'+w2utils.base64encode(i.html.group)+'"':"")+(""!=e?'data-click="toggleGroup|'+i.html.group+'"':"")+">"+e+w2utils.lang(i.html.group)+'</div>\n   <div class="w2ui-group-fields" style="'+(i.html.groupStyle||"")+'">',t=i.html.group}if(null==i.html.anchor){let e=null!=i.html.span?"w2ui-span"+i.html.span:"",t="<label"+("none"==(e=-1==i.html.span?"w2ui-span-none":e)?' style="display: none"':"")+">"+w2utils.lang("checkbox"!=i.type?i.html.label:i.html.text)+"</label>";i.html.label||(t=""),a+='\n      <div class="w2ui-field '+e+'" style="'+(i.hidden?"display: none;":"")+i.html.style+'">\n         '+t+("empty"===i.type?s:"\n         <div>"+s+("array"!=i.type&&"map"!=i.type?w2utils.lang("checkbox"!=i.type?i.html.text:""):"")+"</div>")+"\n      </div>"}else l[i.html.page].anchors=l[i.html.page].anchors||{},l[i.html.page].anchors[i.html.anchor]='<div class="w2ui-field w2ui-field-inline" style="'+(i.hidden?"display: none;":"")+i.html.style+'">'+("empty"===i.type?s:"<div>"+w2utils.lang("checkbox"!=i.type?i.html.label:i.html.text,!0)+s+w2utils.lang("checkbox"!=i.type?i.html.text:"")+"</div>")+"</div>";null==l[i.html.page]&&(l[i.html.page]={}),null==l[i.html.page][i.html.column]&&(l[i.html.page][i.html.column]=""),l[i.html.page][i.html.column]+=a,r=i.html.page,n=i.html.column}if(""!==t&&(l[r][n]+="\n   </div>\n  </div>"),this.tabs.tabs)for(let e=0;e<this.tabs.tabs.length;e++)null==l[e]&&(l[e]=[]);let i="";if(0<Object.keys(this.actions).length){for(var s in i+='\n<div class="w2ui-buttons">',o=this.tabindexBase+this.fields.length+1,this.actions){let e=this.actions[s],t={text:"",style:"",class:""};w2utils.isPlainObject(e)?(null==e.text&&null!=e.caption&&(console.log("NOTICE: form action.caption property is deprecated, please use action.text. Action ->",e),e.text=e.caption),e.text&&(t.text=e.text),e.style&&(t.style=e.style),e.class&&(t.class=e.class)):(t.text=s,-1!==["save","update","create"].indexOf(s.toLowerCase())?t.class="w2ui-btn-blue":t.class=""),i+='\n    <button name="'+s+'" class="w2ui-btn '+t.class+'" style="'+t.style+'" tabindex="'+o+'">'+w2utils.lang(t.text)+"</button>",o++}i+="\n</div>"}a="";for(let i=0;i<l.length;i++){if(a+='<div class="w2ui-page page-'+i+'" style="'+(0!==i?"display: none;":"")+this.pageStyle+'">',!l[i])return console.log(`ERROR: Page ${i} does not exist`),!1;l[i].before&&(a+=l[i].before),a+='<div class="w2ui-column-container">',Object.keys(l[i]).sort().forEach((e,t)=>{e==parseInt(e)&&(a+='<div class="w2ui-column col-'+e+'">'+(l[i][e]||"")+"\n</div>")}),a+="\n</div>",l[i].after&&(a+=l[i].after),a+="\n</div>",l[i].anchors&&Object.keys(l[i].anchors).forEach((e,t)=>{a=a.replace(e,l[i].anchors[e])})}return a+=i}toggleGroup(e,t){let i=query(this.box).find('.w2ui-group-title[data-group="'+w2utils.base64encode(e)+'"]');if(0!==i.length){let e=query(i.prop("nextElementSibling"));(t=void 0===t?"none"==e.css("display"):t)?(e.show(),i.find("span").addClass("w2ui-icon-collapse").removeClass("w2ui-icon-expand")):(e.hide(),i.find("span").addClass("w2ui-icon-expand").removeClass("w2ui-icon-collapse"))}}action(e,t){var i=this.actions[e];let s=i,l=(w2utils.isPlainObject(i)&&i.onClick&&(s=i.onClick),this.trigger("action",{target:e,action:i,originalEvent:t}));!0!==l.isCancelled&&("function"==typeof s&&s.call(this,t),l.finish())}resize(){let d=this,e=this.trigger("resize",{target:this.name});if(!0!==e.isCancelled){let l=query(this.box).find(":scope > div.w2ui-form-box"),r=query(this.box).find(":scope > div .w2ui-form-header"),n=query(this.box).find(":scope > div .w2ui-form-toolbar"),a=query(this.box).find(":scope > div .w2ui-form-tabs"),o=query(this.box).find(":scope > div .w2ui-page");var t=query(this.box).find(":scope > div .w2ui-page.page-"+this.page+" > div");let h=query(this.box).find(":scope > div .w2ui-buttons");var{headerHeight:i,tbHeight:s,tabsHeight:u}=c();function c(){var e=d.box.getBoundingClientRect(),t=""!==d.header?w2utils.getSize(r,"height"):0,i=Array.isArray(d.toolbar?.items)&&0<d.toolbar?.items?.length?w2utils.getSize(n,"height"):0,s=Array.isArray(d.tabs?.tabs)&&0<d.tabs?.tabs?.length?w2utils.getSize(a,"height"):0;return l.css({width:e.width+"px",height:e.height+"px"}),n.css({top:t+"px"}),a.css({top:t+i+"px"}),o.css({top:t+i+s+"px"}),o.css({bottom:(0<h.length?w2utils.getSize(h,"height"):0)+"px"}),{width:e.width,height:e.height,headerHeight:t,tbHeight:i,tabsHeight:s}}this.autosize&&(0!==query(this.box).get(0).clientHeight&&"yes"!=query(this.box).data("autosize")||(query(this.box).css({height:i+s+u+15+(0<o.length?w2utils.getSize(t,"height"):0)+(0<h.length?w2utils.getSize(h,"height"):0)+"px"}),query(this.box).data("autosize","yes")),c()),e.finish()}}refresh(){var t,i=Date.now();let c=this;if(this.box&&this.isGenerated&&query(this.box).html()){let e=this.trigger("refresh",{target:this.name,page:this.page,field:arguments[0],fields:arguments});if(!0!==e.isCancelled){let s=Array.from(this.fields.keys());0<arguments.length?s=Array.from(arguments).map((e,t)=>("string"!=typeof e&&console.log("ERROR: Arguments in refresh functions should be field names"),this.get(e,!0))).filter((e,t)=>null!=e):(query(this.box).find("input, textarea, select").each(e=>{var t=null!=query(e).attr("name")?query(e).attr("name"):query(e).attr("id");let i=this.get(t);if(i){let t=query(e).closest(".w2ui-page");if(0<t.length)for(let e=0;e<100;e++)if(t.hasClass("page-"+e)){i.page=e;break}}}),query(this.box).find(".w2ui-page").hide(),query(this.box).find(".w2ui-page.page-"+this.page).show(),query(this.box).find(".w2ui-form-header").html(w2utils.lang(this.header)),"object"==typeof this.tabs&&Array.isArray(this.tabs.tabs)&&0<this.tabs.tabs.length?(query(this.box).find("#form_"+this.name+"_tabs").show(),this.tabs.active=this.tabs.tabs[this.page].id,this.tabs.refresh()):query(this.box).find("#form_"+this.name+"_tabs").hide(),"object"==typeof this.toolbar&&Array.isArray(this.toolbar.items)&&0<this.toolbar.items.length?(query(this.box).find("#form_"+this.name+"_toolbar").show(),this.toolbar.refresh()):query(this.box).find("#form_"+this.name+"_toolbar").hide());for(let t=0;t<s.length;t++){let l=this.fields[s[t]],e=(null==l.name&&null!=l.field&&(l.name=l.field),null==l.field&&null!=l.name&&(l.field=l.name),l.$el=query(this.box).find(`[name='${String(l.name).replace(/\\/g,"\\\\")}']`),l.el=l.$el.get(0),l.el&&(l.el.id=l.name),l.w2field&&l.w2field.reset(),l.$el.off(".w2form").on("change.w2form",function(e){let t=c.getFieldValue(l.field);var i;["enum","file"].includes(l.type)&&(i=l.el._w2field?.helpers?.multi,query(i).removeClass("w2ui-error")),null!=this._previous&&(t.previous=this._previous,delete this._previous);let s=c.trigger("change",{target:this.name,field:this.name,value:t,originalEvent:e});!0!==s.isCancelled&&(c.setValue(this.name,t.current),s.finish())}).on("input.w2form",function(e){null==c.original&&(0<Object.keys(c.record).length?c.original=w2utils.clone(c.record):c.original={});var t=c.getFieldValue(l.field);null==this._previous&&(this._previous=t.previous);let i=c.trigger("input",{target:c.name,value:t,originalEvent:e});!0!==i.isCancelled&&(c.setValue(this.name,t.current),i.finish())}),l.required?l.$el.closest(".w2ui-field").addClass("w2ui-required"):l.$el.closest(".w2ui-field").removeClass("w2ui-required"),null!=l.disabled&&(l.disabled?(null==l.$el.data("tabIndex")&&l.$el.data("tabIndex",l.$el.prop("tabIndex")),l.$el.prop("readOnly",!0).prop("tabIndex",-1).closest(".w2ui-field").addClass("w2ui-disabled")):l.$el.prop("readOnly",!1).prop("tabIndex",l.$el.data("tabIndex")??l.$el.prop("tabIndex")??0).closest(".w2ui-field").removeClass("w2ui-disabled")),l.el);e=e||query(this.box).find("#"+l.field),l.hidden?query(e).closest(".w2ui-field").hide():query(e).closest(".w2ui-field").show()}query(this.box).find("button, input[type=button]").each(e=>{query(e).off("click").on("click",function(e){let t=this.value;this.id&&(t=this.id),this.name&&(t=this.name),c.action(t,e)})});for(let e=0;e<s.length;e++){let i=this.fields[s[e]];if(i.el){if(i.$el.hasClass("w2ui-input")||i.$el.addClass("w2ui-input"),i.type=String(i.type).toLowerCase(),i.options||(i.options={}),this.LIST_TYPES.includes(i.type)&&(null==(t=i.options.items)&&(i.options.items=[]),i.options.items=w2utils.normMenu.call(this,t,i)),"select"==i.type){let e=i.options.items,t="";e.forEach(e=>{t+=`<option value="${e.id}">${e.text}</option>`}),i.$el.html(t)}this.W2FIELD_TYPES.includes(i.type)&&(i.w2field=i.w2field??new w2field(w2utils.extend({},i.options,{type:i.type})),i.w2field.render(i.el)),["map","array"].includes(i.type)&&!function(d){let u;d.el.mapAdd=function(e,t,i){var s=(e.disabled?" readOnly ":"")+(e.html.tabindex_str||""),i=`
                            <div class="w2ui-map-field" style="margin-bottom: 5px" data-index="${i}">
                            ${"map"==e.type?`<input type="text" ${e.html.key.attr+s} class="w2ui-input w2ui-map key">
                                    ${e.html.key.text||""}
                                `:""}
                            <input type="text" ${e.html.value.attr+s} class="w2ui-input w2ui-map value">
                                ${e.html.value.text||""}
                            </div>`;t.append(i)},d.el.mapRefresh=function(l,n){let r,a,o;var h;"map"==d.type&&(null==(l=w2utils.isPlainObject(l)?l:{})._order&&(l._order=Object.keys(l)),r=l._order),"array"==d.type&&(Array.isArray(l)||(l=[]),r=l.map((e,t)=>t));for(let e=n.find(".w2ui-map-field").length-1;e>=r.length;e--)n.find(`div[data-index='${e}']`).remove();for(let s=0;s<r.length;s++){let t=r[s],e=n.find(`div[data-index='${s}']`),i=(0==e.length&&(d.el.mapAdd(d,n,s),e=n.find(`div[data-index='${s}']`)),e.attr("data-key",t),a=e.find(".w2ui-map.key"),o=e.find(".w2ui-map.value"),l[t]);"array"!=d.type||0<(h=l.filter(e=>e.key==t)).length&&(i=h[0].value),a.val(t),o.val(i),!0!==d.disabled&&!1!==d.disabled||(a.prop("readOnly",!!d.disabled),o.prop("readOnly",!!d.disabled))}var e=r.length;let t=n.find(`div[data-index='${e}']`);0!==t.length||a&&""==a.val()&&""==o.val()||a&&(!0===a.prop("readOnly")||!0===a.prop("disabled"))||d.el.mapAdd(d,n,e),!0!==d.disabled&&!1!==d.disabled||(t.find(".key").prop("readOnly",!!d.disabled),t.find(".value").prop("readOnly",!!d.disabled));e=query(d.el).get(0)?.nextSibling;query(e).find("input.w2ui-map").off(".mapChange").on("keyup.mapChange",function(e){let t=query(e.target).closest(".w2ui-map-field");var i=t.get(0).nextElementSibling,s=t.get(0).previousElementSibling;if(13==e.keyCode){var l=u??i;if(l instanceof HTMLElement){let e=query(l).find("input");0<e.length&&e.get(0).focus()}u=void 0}l=query(e.target).hasClass("key")?"key":"value";38==e.keyCode&&s&&(query(s).find("input."+l).get(0).select(),e.preventDefault()),40==e.keyCode&&i&&(query(i).find("input."+l).get(0).select(),e.preventDefault())}).on("keydown.mapChange",function(e){38!=e.keyCode&&40!=e.keyCode||e.preventDefault()}).on("input.mapChange",function(e){let t=query(e.target).closest("div");var e=t.data("index"),i=t.get(0).nextElementSibling;if(""==t.find("input").val()||i){if(""==t.find("input").val()&&i){let t=!0;query(i).find("input").each(e=>{""!=e.value&&(t=!1)}),t&&query(i).remove()}}else d.el.mapAdd(d,n,parseInt(e)+1)}).on("change.mapChange",function(e){null==c.original&&(0<Object.keys(c.record).length?c.original=w2utils.clone(c.record):c.original={});let{current:t,previous:i,original:s}=c.getFieldValue(d.field),l=query(e.target).closest(".w2ui-map-container"),r=("map"==d.type&&(t._order=[]),l.find(".w2ui-map.key").each(e=>{t._order.push(e.value)}),c.trigger("change",{target:d.field,field:d.field,originalEvent:e,value:{current:t,previous:i,original:s}}));!0!==r.isCancelled&&("map"==d.type&&(t._order=t._order.filter(e=>""!==e),delete t[""]),"array"==d.type&&(t=t.filter(e=>""!==e)),""==query(e.target).parent().find("input").val()&&(u=e.target),c.setValue(d.field,t),d.el.mapRefresh(t,n),r.finish())})}}(i),this.setFieldValue(i.field,this.getValue(i.name)),i.$el.trigger("change")}}return e.finish(),this.resize(),Date.now()-i}}}render(e){var t=Date.now();let i=this,s=("string"==typeof e&&(e=query(e).get(0)),this.trigger("render",{target:this.name,box:e??this.box}));if(!0!==s.isCancelled&&(null!=e&&(0<query(this.box).find("#form_"+this.name+"_form").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-form").html(""),this.box=e),(this.isGenerated||this.formHTML)&&this.box)){e='<div class="w2ui-form-box">'+(""!==this.header?'<div class="w2ui-form-header">'+w2utils.lang(this.header)+"</div>":"")+'    <div id="form_'+this.name+'_toolbar" class="w2ui-form-toolbar" style="display: none"></div>    <div id="form_'+this.name+'_tabs" class="w2ui-form-tabs" style="display: none"></div>'+this.formHTML+"</div>",e=(query(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-form").html(e),0<query(this.box).length&&(query(this.box)[0].style.cssText+=this.style),w2utils.bindEvents(query(this.box).find(".w2ui-eaction"),this),"function"!=typeof this.toolbar.render&&(this.toolbar=new w2toolbar(w2utils.extend({},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.toolbar.on("click",function(e){let t=i.trigger("toolbar",{target:e.target,originalEvent:e});!0!==t.isCancelled&&t.finish()})),"object"==typeof this.toolbar&&"function"==typeof this.toolbar.render&&this.toolbar.render(query(this.box).find("#form_"+this.name+"_toolbar")[0]),"function"!=typeof this.tabs.render&&(this.tabs=new w2tabs(w2utils.extend({},this.tabs,{name:this.name+"_tabs",owner:this,active:this.tabs.active})),this.tabs.on("click",function(e){i.goto(this.get(e.target,!0))})),"object"==typeof this.tabs&&"function"==typeof this.tabs.render&&(this.tabs.render(query(this.box).find("#form_"+this.name+"_tabs")[0]),this.tabs.active&&this.tabs.click(this.tabs.active)),s.finish(),this.resize(),"object"!=typeof this.url?this.url:this.url.get);if(e&&0!==this.recid&&null!=this.recid?this.request():this.refresh(),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),-1!=this.focus){let e=0,t=()=>{0<query(i.box).find("input, select, textarea").length?i.setFocus():++e<20&&setTimeout(t,50)};t()}return Date.now()-t}}setFocus(e){void 0===e&&(e=this.focus);let t;if(w2utils.isInt(e)){if(e<0)return;for(var i=query(this.box).find("div:not(.w2ui-field-helper) > input, select, textarea, div > label:nth-child(1) > [type=radio]").filter(":not(.file-input)");null==i[e].offsetParent&&i.length>=e;)e++;i[e]&&(t=query(i[e]))}else"string"==typeof e&&(t=query(this.box).find(`[name='${e}']`));return 0<t.length&&t.get(0).focus(),t}destroy(){let e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&("object"==typeof this.toolbar&&this.toolbar.destroy&&this.toolbar.destroy(),"object"==typeof this.tabs&&this.tabs.destroy&&this.tabs.destroy(),0<query(this.box).find("#form_"+this.name+"_tabs").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-form").html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],e.finish())}}class w2field extends w2base{constructor(e,t){super(),"string"==typeof e&&null==t&&(t={type:e}),"object"==typeof e&&null==t&&(t=w2utils.clone(e)),"string"==typeof e&&"object"==typeof t&&(t.type=e),t.type=String(t.type).toLowerCase(),this.el=t.el??null,this.selected=null,this.helpers={},this.type=t.type??"text",this.options=w2utils.clone(t),this.onSearch=t.onSearch??null,this.onRequest=t.onRequest??null,this.onLoad=t.onLoad??null,this.onError=t.onError??null,this.onClick=t.onClick??null,this.onAdd=t.onAdd??null,this.onNew=t.onNew??null,this.onRemove=t.onRemove??null,this.onMouseEnter=t.onMouseEnter??null,this.onMouseLeave=t.onMouseLeave??null,this.onScroll=t.onScroll??null,this.tmp={},delete this.options.type,delete this.options.onSearch,delete this.options.onRequest,delete this.options.onLoad,delete this.options.onError,delete this.options.onClick,delete this.options.onMouseEnter,delete this.options.onMouseLeave,delete this.options.onScroll,this.el&&this.render(this.el)}render(e){e instanceof HTMLElement?(e._w2field?e._w2field.reset():e._w2field=this,this.el=e,this.init()):console.log("ERROR: Cannot init w2field on empty subject")}init(){let t=this.options,e;if(["INPUT","TEXTAREA"].includes(this.el.tagName.toUpperCase())){switch(this.type){case"text":case"int":case"float":case"money":case"currency":case"percent":case"alphanumeric":case"bin":case"hex":e={min:null,max:null,step:1,autoFormat:!0,autoCorrect:!0,currencyPrefix:w2utils.settings.currencyPrefix,currencySuffix:w2utils.settings.currencySuffix,currencyPrecision:w2utils.settings.currencyPrecision,decimalSymbol:w2utils.settings.decimalSymbol,groupSymbol:w2utils.settings.groupSymbol,arrow:!1,keyboard:!0,precision:null,prefix:"",suffix:""},this.options=w2utils.extend({},e,t),(t=this.options).numberRE=new RegExp("["+t.groupSymbol+"]","g"),t.moneyRE=new RegExp("["+t.currencyPrefix+t.currencySuffix+t.groupSymbol+"]","g"),t.percentRE=new RegExp("["+t.groupSymbol+"%]","g"),["text","alphanumeric","hex","bin"].includes(this.type)&&(t.arrow=!1,t.keyboard=!1);break;case"color":e={prefix:"#",suffix:`<div style="width: ${parseInt(getComputedStyle(this.el)["font-size"])||12}px">&#160;</div>`,arrow:!1,advanced:null,transparent:!0},this.options=w2utils.extend({},e,t),t=this.options;break;case"date":e={format:w2utils.settings.dateFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:!0},this.options=w2utils.extend({type:"date"},e,t),t=this.options,null==query(this.el).attr("placeholder")&&query(this.el).attr("placeholder",t.format);break;case"time":e={format:w2utils.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,btnNow:!0,noMinutes:!1},this.options=w2utils.extend({type:"time"},e,t),t=this.options,null==query(this.el).attr("placeholder")&&query(this.el).attr("placeholder",t.format);break;case"datetime":e={format:w2utils.settings.dateFormat+"|"+w2utils.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,startTime:null,endTime:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:!0,noMinutes:!1},this.options=w2utils.extend({type:"datetime"},e,t),t=this.options,null==query(this.el).attr("placeholder")&&query(this.el).attr("placeholder",t.placeholder||t.format);break;case"list":case"combo":e={items:[],selected:{},url:null,recId:null,recText:null,method:null,interval:350,postData:{},minLength:1,cacheMax:250,maxDropHeight:350,maxDropWidth:null,minDropWidth:null,match:"begins",icon:null,iconStyle:"",align:"both",altRows:!0,onSearch:null,onRequest:null,onLoad:null,onError:null,renderDrop:null,compare:null,filter:!0,hideSelected:!1,prefix:"",suffix:"",openOnFocus:!1,markSearch:!1},"function"==typeof t.items&&(t._items_fun=t.items),t.items=w2utils.normMenu.call(this,t.items),"list"===this.type&&(query(this.el).addClass("w2ui-select"),!w2utils.isPlainObject(t.selected)&&Array.isArray(t.items)&&t.items.forEach(e=>{e&&e.id===t.selected&&(t.selected=w2utils.clone(e))})),t=w2utils.extend({},e,t),this.options=t,w2utils.isPlainObject(t.selected)||(t.selected={}),this.selected=t.selected,query(this.el).attr("autocapitalize","off").attr("autocomplete","off").attr("autocorrect","off").attr("spellcheck","false"),null!=t.selected.text&&query(this.el).val(t.selected.text);break;case"enum":e={items:[],selected:[],max:0,url:null,recId:null,recText:null,interval:350,method:null,postData:{},minLength:1,cacheMax:250,maxItemWidth:250,maxDropHeight:350,maxDropWidth:null,match:"contains",align:"",altRows:!0,openOnFocus:!1,markSearch:!1,renderDrop:null,renderItem:null,compare:null,filter:!0,hideSelected:!0,style:"",onSearch:null,onRequest:null,onLoad:null,onError:null,onClick:null,onAdd:null,onNew:null,onRemove:null,onMouseEnter:null,onMouseLeave:null,onScroll:null},"function"==typeof(t=w2utils.extend({},e,t,{suffix:""})).items&&(t._items_fun=t.items),t.items=w2utils.normMenu.call(this,t.items),t.selected=w2utils.normMenu.call(this,t.selected),this.options=t,Array.isArray(t.selected)||(t.selected=[]),this.selected=t.selected;break;case"file":e={selected:[],max:0,maxSize:0,maxFileSize:0,maxItemWidth:250,maxDropHeight:350,maxDropWidth:null,readContent:!0,silent:!0,align:"both",altRows:!0,renderItem:null,style:"",onClick:null,onAdd:null,onRemove:null,onMouseEnter:null,onMouseLeave:null},t=w2utils.extend({},e,t),this.options=t,Array.isArray(t.selected)||(t.selected=[]),this.selected=t.selected,null==query(this.el).attr("placeholder")&&query(this.el).attr("placeholder",w2utils.lang("Attach files by dragging and dropping or Click to Select"))}query(this.el).css("box-sizing","border-box").addClass("w2field w2ui-input").off(".w2field").on("change.w2field",e=>{this.change(e)}).on("click.w2field",e=>{this.click(e)}).on("focus.w2field",e=>{this.focus(e)}).on("blur.w2field",e=>{"list"!==this.type&&this.blur(e)}).on("keydown.w2field",e=>{this.keyDown(e)}).on("keyup.w2field",e=>{this.keyUp(e)}),this.addPrefix(),this.addSuffix(),this.addSearch(),this.addMultiSearch(),this.change(new Event("change"))}else console.log("ERROR: w2field could only be applied to INPUT or TEXTAREA.",this.el)}get(){let e;return e=-1!==["list","enum","file"].indexOf(this.type)?this.selected:query(this.el).val()}set(t,e){if(-1!==["list","enum","file"].indexOf(this.type)){if("list"!==this.type&&e){Array.isArray(this.selected)||(this.selected=[]),this.selected.push(t);let e=w2menu.get(this.el.id+"_menu");e&&(e.options.selected=this.selected),query(this.el).trigger("input").trigger("change")}else{null==t&&(t=[]);e="enum"!==this.type||Array.isArray(t)?t:[t];this.selected=e,query(this.el).trigger("input").trigger("change")}this.refresh()}else query(this.el).val(t)}setIndex(t,i){if(-1!==["list","enum"].indexOf(this.type)){var s=this.options.items;if(s&&s[t]){"list"==this.type&&(this.selected=s[t]),"enum"==this.type&&(i||(this.selected=[]),this.selected.push(s[t]));let e=w2menu.get(this.el.id+"_menu");return e&&(e.options.selected=this.selected),query(this.el).trigger("input").trigger("change"),this.refresh(),!0}}return!1}refresh(){let s=this.options;var i,l,e=Date.now(),t=getComputedStyle(this.el);if("list"==this.type){if(query(this.el).parent().css("white-space","nowrap"),this.helpers.prefix&&this.helpers.prefix.hide(),!this.helpers.search)return;null==this.selected&&s.icon?s.prefix=`
                    <span class="w2ui-icon ${s.icon} "style="cursor: pointer; font-size: 14px;
                        display: inline-block; margin-top: -1px; color: #7F98AD; ${s.iconStyle}">
                    </span>`:s.prefix="",this.addPrefix();let e=query(this.helpers.search_focus),t=query(e[0].previousElementSibling);e.css({outline:"none"}),""===e.val()?(e.css("opacity",0),t.css("opacity",0),this.selected?.id?(l=this.selected.text,i=this.findItemIndex(s.items,this.selected.id),null!=l&&query(this.el).val(w2utils.lang(l)).data({selected:l,selectedIndex:i[0]})):(this.el.value="",query(this.el).removeData("selected selectedIndex"))):(e.css("opacity",1),t.css("opacity",1),query(this.el).val(""),setTimeout(()=>{this.helpers.prefix&&this.helpers.prefix.hide(),s.icon?(e.css("margin-left","17px"),query(this.helpers.search).find(".w2ui-icon-search").addClass("show-search")):(e.css("margin-left","0px"),query(this.helpers.search).find(".w2ui-icon-search").removeClass("show-search"))},1)),query(this.el).prop("readonly")||query(this.el).prop("disabled")?setTimeout(()=>{this.helpers.prefix&&query(this.helpers.prefix).css("opacity","0.6"),this.helpers.suffix&&query(this.helpers.suffix).css("opacity","0.6")},1):setTimeout(()=>{this.helpers.prefix&&query(this.helpers.prefix).css("opacity","1"),this.helpers.suffix&&query(this.helpers.suffix).css("opacity","1")},1)}let r=this.helpers.multi;if(["enum","file"].includes(this.type)&&r){let i="",e=(Array.isArray(this.selected)&&this.selected.forEach((e,t)=>{null!=e&&(i+=`
                        <div class="li-item" index="${t}" style="max-width: ${parseInt(s.maxItemWidth)}px; ${e.style||""}">
                        ${"function"==typeof s.renderItem?s.renderItem(e,t,`<div class="w2ui-list-remove" index="${t}">&#160;&#160;</div>`):`
                               ${e.icon?`<span class="w2ui-icon ${e.icon}"></span>`:""}
                               <div class="w2ui-list-remove" index="${t}">&#160;&#160;</div>
                               ${("enum"===this.type?e.text:e.name)??e.id??e}
                               ${e.size?`<span class="file-size"> - ${w2utils.formatSize(e.size)}</span>`:""}
                            `}
                        </div>`)}),r.find(".w2ui-multi-items"));if(s.style&&r.attr("style",r.attr("style")+";"+s.style),query(this.el).css("z-index","-1"),query(this.el).prop("readonly")||query(this.el).prop("disabled")?setTimeout(()=>{r[0].scrollTop=0,r.addClass("w2ui-readonly").find(".li-item").css("opacity","0.9").parent().find(".li-search").hide().find("input").prop("readonly",!0).closest(".w2ui-multi-items").find(".w2ui-list-remove").hide()},1):setTimeout(()=>{r.removeClass("w2ui-readonly").find(".li-item").css("opacity","1").parent().find(".li-search").show().find("input").prop("readonly",!1).closest(".w2ui-multi-items").find(".w2ui-list-remove").show()},1),0<this.selected?.length&&query(this.el).attr("placeholder",""),r.find(".w2ui-enum-placeholder").remove(),e.find(".li-item").remove(),""!==i?e.prepend(i):null!=query(this.el).attr("placeholder")&&""===r.find("input").val()&&(l=w2utils.stripSpaces(`
                    padding-top: ${t["padding-top"]};
                    padding-left: ${t["padding-left"]};
                    box-sizing: ${t["box-sizing"]};
                    line-height: ${t["line-height"]};
                    font-size: ${t["font-size"]};
                    font-family: ${t["font-family"]};
                `),r.prepend(`<div class="w2ui-enum-placeholder" style="${l}">${query(this.el).attr("placeholder")}</div>`)),r.off(".w2item").on("scroll.w2item",e=>{let t=this.trigger("scroll",{target:this.el,originalEvent:e});!0!==t.isCancelled&&(w2tooltip.hide(this.el.id+"_preview"),t.finish())}).find(".li-item").on("click.w2item",e=>{let s=query(e.target).closest(".li-item");var i=s.attr("index"),l=this.selected[i];if(!query(s).hasClass("li-search")){e.stopPropagation();let t;if(query(e.target).hasClass("w2ui-list-remove"))query(this.el).prop("readonly")||query(this.el).prop("disabled")||!0!==(t=this.trigger("remove",{target:this.el,originalEvent:e,item:l})).isCancelled&&(this.selected.splice(i,1),query(this.el).trigger("input").trigger("change"),query(e.target).remove());else if(!0!==(t=this.trigger("click",{target:this.el,originalEvent:e.originalEvent,item:l})).isCancelled){let e=l.tooltip;if("file"===this.type&&(/image/i.test(l.type)&&(e=`
                                    <div class="w2ui-file-preview">
                                        <img src="${l.content?"data:"+l.type+";base64,"+l.content:""}"
                                            style="max-width: 300px">
                                    </div>`),e+=`
                                <div class="w2ui-file-info">
                                    <div class="file-caption">${w2utils.lang("Name")}:</div>
                                    <div class="file-value">${l.name}</div>
                                    <div class="file-caption">${w2utils.lang("Size")}:</div>
                                    <div class="file-value">${w2utils.formatSize(l.size)}</div>
                                    <div class="file-caption">${w2utils.lang("Type")}:</div>
                                    <div class="file-value file-type">${l.type}</div>
                                    <div class="file-caption">${w2utils.lang("Modified")}:</div>
                                    <div class="file-value">${w2utils.date(l.modified)}</div>
                                </div>`),e){let i=this.el.id+"_preview";w2tooltip.show({name:i,anchor:s.get(0),html:e,hideOn:["doc-click"],class:""}).show(e=>{let t=query(`#w2overlay-${i} img`);t.on("load",function(e){var t=this.clientWidth,i=this.clientHeight;t<300&i<300||(i<=t&&300<t&&query(this).css("width","300px"),t<i&&300<i&&query(this).css("height","300px"))}).on("error",function(e){this.style.display="none"})})}t.finish()}}}).on("mouseenter.w2item",t=>{var i=query(t.target).closest(".li-item");if(!query(i).hasClass("li-search")){i=this.selected[query(t.target).attr("index")];let e=this.trigger("mouseEnter",{target:this.el,originalEvent:t,item:i});!0!==e.isCancelled&&e.finish()}}).on("mouseleave.w2item",t=>{var i=query(t.target).closest(".li-item");if(!query(i).hasClass("li-search")){i=this.selected[query(t.target).attr("index")];let e=this.trigger("mouseLeave",{target:this.el,originalEvent:t,item:i});!0!==e.isCancelled&&e.finish()}}),"enum"===this.type){let e=this.helpers.multi.find("input");e.css({width:"15px"})}else this.helpers.multi.find(".li-search").hide();this.resize()}return Date.now()-e}resize(){var e=this.el.clientWidth,t=(this.el.clientHeight,getComputedStyle(this.el)),i=this.helpers.search,s=this.helpers.multi,l=this.helpers.suffix,r=this.helpers.prefix,i=(i&&query(i).css("width",e),s&&query(s).css("width",e-parseInt(t["margin-left"],10)-parseInt(t["margin-right"],10)),l&&this.addSuffix(),r&&this.addPrefix(),this.helpers.multi);if(["enum","file"].includes(this.type)&&i){query(this.el).css("height","auto");let e=query(i).find(":scope div.w2ui-multi-items").get(0).clientHeight+5;(e=(e=e<20?20:e)>this.tmp["max-height"]?this.tmp["max-height"]:e)<this.tmp["min-height"]&&(e=this.tmp["min-height"]);s=w2utils.getSize(this.el,"height")-2;s>e&&(e=s),query(i).css({height:e+"px",overflow:e==this.tmp["max-height"]?"auto":"hidden"}),query(i).css("height",e+"px"),query(this.el).css({height:e+"px"})}this.tmp.current_width=e}reset(){null!=this.tmp&&(query(this.el).css("height","auto"),Array("padding-left","padding-right","background-color","border-color").forEach(e=>{this.tmp&&null!=this.tmp["old-"+e]&&(query(this.el).css(e,this.tmp["old-"+e]),delete this.tmp["old-"+e])}),clearInterval(this.tmp.sizeTimer)),query(this.el).val(this.clean(query(this.el).val())).removeClass("w2field").removeData("selected selectedIndex").off(".w2field"),Object.keys(this.helpers).forEach(e=>{query(this.helpers[e]).remove()}),this.helpers={}}clean(e){if("number"==typeof e)return e;var t=this.options;return e=String(e).trim(),["int","float","money","currency","percent"].includes(this.type)&&("string"==typeof e&&(t.autoFormat&&(["money","currency"].includes(this.type)&&(e=String(e).replace(t.moneyRE,"")),"percent"===this.type&&(e=String(e).replace(t.percentRE,"")),["int","float"].includes(this.type)&&(e=String(e).replace(t.numberRE,""))),e=e.replace(/\s+/g,"").replace(new RegExp(t.groupSymbol,"g"),"").replace(t.decimalSymbol,".")),e=""!==e&&w2utils.isFloat(e)?Number(e):""),e}format(e){var t=this.options;if(t.autoFormat&&""!==e){switch(this.type){case"money":case"currency":""!==(e=w2utils.formatNumber(e,t.currencyPrecision,!0))&&(e=t.currencyPrefix+e+t.currencySuffix);break;case"percent":""!==(e=w2utils.formatNumber(e,t.precision,!0))&&(e+="%");break;case"float":e=w2utils.formatNumber(e,t.precision,!0);break;case"int":e=w2utils.formatNumber(e,0,!0)}var i=parseInt(1e3).toLocaleString(w2utils.settings.locale,{useGrouping:!0}).slice(1,2);i!==this.options.groupSymbol&&(e=e.replaceAll(i,this.options.groupSymbol))}return e}change(e){if(-1!==["int","float","money","currency","percent"].indexOf(this.type)){var t=query(this.el).val(),i=this.format(this.clean(query(this.el).val()));if(""!==t&&t!=i)return query(this.el).val(i),e.stopPropagation(),e.preventDefault(),!1}if("color"===this.type){let e=query(this.el).val();"rgb"!==e.substr(0,3).toLowerCase()&&(e="#"+e,8!==(t=query(this.el).val().length)&&6!==t&&3!==t&&(e=""));i=query(this.el).get(0).nextElementSibling;query(i).find("div").css("background-color",e),query(this.el).hasClass("has-focus")&&this.updateOverlay()}if(-1!==["list","enum","file"].indexOf(this.type)&&this.refresh(),-1!==["date","time","datetime"].indexOf(this.type)){let e=parseInt(this.el.value);w2utils.isInt(this.el.value)&&3e3<e&&("time"===this.type&&(e=w2utils.formatTime(new Date(e),this.options.format)),"date"===this.type&&(e=w2utils.formatDate(new Date(e),this.options.format)),"datetime"===this.type&&(e=w2utils.formatDateTime(new Date(e),this.options.format)),query(this.el).val(e).trigger("input").trigger("change"))}}click(e){["list","combo","enum"].includes(this.type)&&(query(this.el).hasClass("has-focus")||this.focus(e),"combo"==this.type&&this.updateOverlay(),"list"==this.type&&(this.updateOverlay(),e.stopPropagation())),["date","time","datetime","color"].includes(this.type)&&this.updateOverlay()}focus(e){if("list"==this.type&&document.activeElement==this.el)this.helpers.search_focus.focus();else{if(-1!==["color","date","time","datetime"].indexOf(this.type)){if(query(this.el).prop("readonly")||query(this.el).prop("disabled"))return;this.updateOverlay()}if(-1!==["list","combo","enum"].indexOf(this.type)){if(query(this.el).prop("readonly")||query(this.el).prop("disabled"))return void query(this.el).addClass("has-focus");if("function"==typeof this.options._items_fun&&(this.options.items=w2utils.normMenu.call(this,this.options._items_fun)),this.helpers.search){let e=this.helpers.search_focus;e.value="",e.select()}if("enum"==this.type){let e=query(this.el.previousElementSibling).find(".li-search input").get(0);document.activeElement!==e&&e.focus()}this.resize(),!1===e.showMenu||!1===this.options.openOnFocus&&!query(this.el).hasClass("has-focus")||setTimeout(()=>{this.updateOverlay()},100)}"file"==this.type&&(e=query(this.el).get(0).previousElementSibling,query(e).addClass("has-focus")),query(this.el).addClass("has-focus")}}blur(e){var i,s=query(this.el).val().trim();if(query(this.el).removeClass("has-focus"),["int","float","money","currency","percent"].includes(this.type)&&""!==s){let e=s,t="";this.isStrValid(s)?(i=this.clean(s),null!=this.options.min&&i<this.options.min&&(e=this.options.min,t="Should be >= "+this.options.min),null!=this.options.max&&i>this.options.max&&(e=this.options.max,t="Should be <= "+this.options.max)):e="",this.options.autoCorrect&&(query(this.el).val(e).trigger("input").trigger("change"),t&&(w2tooltip.show({name:this.el.id+"_error",anchor:this.el,html:t}),setTimeout(()=>{w2tooltip.hide(this.el.id+"_error")},3e3)))}if(["date","time","datetime"].includes(this.type)&&this.options.autoCorrect&&""!==s){let e="date"==this.type?w2utils.isDate:"time"==this.type?w2utils.isTime:w2utils.isDateTime;w2date.inRange(this.el.value,this.options)&&e.bind(w2utils)(this.el.value,this.options.format)||query(this.el).val("").trigger("input").trigger("change")}"enum"===this.type&&query(this.helpers.multi).find("input").val("").css("width","15px"),"file"==this.type&&(i=this.el.previousElementSibling,query(i).removeClass("has-focus")),"list"===this.type&&(this.el.value=this.selected?.text??"")}keyDown(i,s){var l=this.options,s=i.keyCode||s&&s.keyCode;let r=!1,t,n,a,o,e,h;if(["int","float","money","currency","percent","hex","bin","color","alphanumeric"].includes(this.type)&&!(i.metaKey||i.ctrlKey||i.altKey||this.isStrValid(i.key??"1",!0)||[9,8,13,27,37,38,39,40,46].includes(i.keyCode)))return i.preventDefault(),i.stopPropagation?i.stopPropagation():i.cancelBubble=!0,!1;if(["int","float","money","currency","percent"].includes(this.type)){if(!l.keyboard||query(this.el).prop("readonly")||query(this.el).prop("disabled"))return;switch(t=parseFloat(query(this.el).val().replace(l.moneyRE,""))||0,n=l.step,(i.ctrlKey||i.metaKey)&&(n=10*l.step),s){case 38:if(i.shiftKey)break;e=t+n<=l.max||null==l.max?Number((t+n).toFixed(12)):l.max,query(this.el).val(e).trigger("input").trigger("change"),r=!0;break;case 40:if(i.shiftKey)break;e=t-n>=l.min||null==l.min?Number((t-n).toFixed(12)):l.min,query(this.el).val(e).trigger("input").trigger("change"),r=!0}r&&(i.preventDefault(),this.moveCaret2end())}if(["date","datetime"].includes(this.type)){if(!l.keyboard||query(this.el).prop("readonly")||query(this.el).prop("disabled"))return;let e=("date"==this.type?w2utils.isDate:w2utils.isDateTime).bind(w2utils),t=("date"==this.type?w2utils.formatDate:w2utils.formatDateTime).bind(w2utils);switch(a=864e5,n=1,(i.ctrlKey||i.metaKey)&&(n=10),(o=e(query(this.el).val(),l.format,!0))||(o=new Date,a=0),s){case 38:if(i.shiftKey)break;10==n?o.setMonth(o.getMonth()+1):o.setTime(o.getTime()+a),h=t(o.getTime(),l.format),query(this.el).val(h).trigger("input").trigger("change"),r=!0;break;case 40:if(i.shiftKey)break;10==n?o.setMonth(o.getMonth()-1):o.setTime(o.getTime()-a),h=t(o.getTime(),l.format),query(this.el).val(h).trigger("input").trigger("change"),r=!0}r&&(i.preventDefault(),this.moveCaret2end(),this.updateOverlay())}if("time"===this.type){if(!l.keyboard||query(this.el).prop("readonly")||query(this.el).prop("disabled"))return;n=i.ctrlKey||i.metaKey?60:1,t=query(this.el).val();let e=w2date.str2min(t)||w2date.str2min((new Date).getHours()+":"+((new Date).getMinutes()-1));switch(s){case 38:if(i.shiftKey)break;e+=n,r=!0;break;case 40:if(i.shiftKey)break;e-=n,r=!0}r&&(i.preventDefault(),query(this.el).val(w2date.min2str(e)).trigger("input").trigger("change"),this.moveCaret2end())}if(["list","enum"].includes(this.type))switch(s){case 8:case 46:if("list"==this.type){let e=query(this.helpers.search_focus);""==e.val()&&(this.selected=null,w2menu.hide(this.el.id+"_menu"),query(this.el).val("").trigger("input").trigger("change"))}else{let e=query(this.helpers.multi).find("input");if(""==e.val()){w2menu.hide(this.el.id+"_menu"),this.selected.pop();let e=w2menu.get(this.el.id+"_menu");e&&(e.options.selected=this.selected),this.refresh()}}break;case 9:case 16:break;case 27:w2menu.hide(this.el.id+"_menu"),this.refresh()}}keyUp(t){if("list"==this.type){let e=query(this.helpers.search_focus);""!==e.val()?query(this.el).attr("placeholder",""):query(this.el).attr("placeholder",this.tmp.pholder),13==t.keyCode?setTimeout(()=>{e.val(""),w2menu.hide(this.el.id+"_menu"),this.refresh()},1):[8,9,16,27,46].includes(t.keyCode)?w2menu.hide(this.el.id+"_menu"):this.updateOverlay(),this.refresh()}if("combo"==this.type&&this.updateOverlay(),"enum"==this.type){let e=this.helpers.multi.find("input");t=getComputedStyle(e.get(0)),t=w2utils.getStrWidth(e.val(),`font-family: ${t["font-family"]}; font-size: ${t["font-size"]};`);e.css({width:t+15+"px"}),this.resize()}}findItemIndex(e,i,s){let l=[];return s=s||[],e.forEach((e,t)=>{e.id===i&&(l=s.concat([t]),this.options.index=[t]),0==l.length&&e.items&&0<e.items.length&&(s.push(t),l=this.findItemIndex(e.items,i,s),s.pop())}),l}updateOverlay(e){let l=this.options;if("color"===this.type){if(query(this.el).prop("readonly")||query(this.el).prop("disabled"))return;w2color.show(w2utils.extend({name:this.el.id+"_color",anchor:this.el,transparent:l.transparent,advanced:l.advanced,color:this.el.value,liveUpdate:!0},this.options)).select(e=>{e=e.detail.color;query(this.el).val(e).trigger("input").trigger("change")}).liveUpdate(e=>{e=e.detail.color;query(this.helpers.suffix).find(":scope > div").css("background-color","#"+e)})}if(["list","combo","enum"].includes(this.type)){var i;this.el;let t=this.el;if("enum"===this.type&&(i=this.helpers.multi.get(0),t=query(i).find("input").get(0)),"list"===this.type&&(i=this.selected,w2utils.isPlainObject(i)&&0<Object.keys(i).length&&(0<(i=this.findItemIndex(l.items,i.id)).length&&(l.index=i)),t=this.helpers.search_focus),query(this.el).hasClass("has-focus")&&!this.el.readOnly&&!this.el.disabled){let e=w2utils.lang("No matches");null!=l.url&&String(query(t).val()).length<l.minLength&&!0!==this.tmp.emptySet&&(e=w2utils.lang("${count} letters or more...",{count:l.minLength})),null!=l.url&&""===query(t).val()&&!0!==this.tmp.emptySet&&(e=w2utils.lang(l.msgSearch||"Type to search...")),i=w2utils.extend({},l,{name:this.el.id+"_menu",anchor:t,selected:this.selected,search:!1,render:l.renderDrop,anchorClass:"",offsetY:5,maxHeight:l.maxDropHeight,maxWidth:l.maxDropWidth,minWidth:l.minDropWidth,msgNoItems:e}),this.tmp.overlay=w2menu.show(i).select(e=>{if(["list","combo"].includes(this.type))this.selected=e.detail.item,query(t).val(""),query(this.el).val(this.selected.text).trigger("input").trigger("change"),this.focus({showMenu:!1});else{let i=this.selected,s=e.detail?.item;if(s){let t=this.trigger("add",{target:this.el,item:s,originalEvent:e});if(!0!==t.isCancelled){i.length>=l.max&&0<l.max&&i.pop(),delete s.hidden,i.push(s),query(this.el).trigger("input").trigger("change"),query(this.helpers.multi).find("input").val("");let e=w2menu.get(this.el.id+"_menu");e&&(e.options.selected=this.selected),t.finish()}}}})}}!["date","time","datetime"].includes(this.type)||query(this.el).prop("readonly")||query(this.el).prop("disabled")||w2date.show(w2utils.extend({name:this.el.id+"_date",anchor:this.el,value:this.el.value},this.options)).select(e=>{e=e.detail.date;null!=e&&query(this.el).val(e).trigger("input").trigger("change")})}isStrValid(e,t){let i=!0;switch(this.type){case"int":i=!(!t||!["-",this.options.groupSymbol].includes(e))||w2utils.isInt(e.replace(this.options.numberRE,""));break;case"percent":e=e.replace(/%/g,"");case"float":i=!(!t||!["-","",this.options.decimalSymbol,this.options.groupSymbol].includes(e))||w2utils.isFloat(e.replace(this.options.numberRE,""));break;case"money":case"currency":i=!(!t||!["-",this.options.decimalSymbol,this.options.groupSymbol,this.options.currencyPrefix,this.options.currencySuffix].includes(e))||w2utils.isFloat(e.replace(this.options.moneyRE,""));break;case"bin":i=w2utils.isBin(e);break;case"color":case"hex":i=w2utils.isHex(e);break;case"alphanumeric":i=w2utils.isAlphaNumeric(e)}return i}addPrefix(){var e,t;this.options.prefix&&(t=getComputedStyle(this.el),null==this.tmp["old-padding-left"]&&(this.tmp["old-padding-left"]=t["padding-left"]),this.helpers.prefix&&query(this.helpers.prefix).remove(),query(this.el).before(`<div class="w2ui-field-helper">${this.options.prefix}</div>`),e=query(this.el).get(0).previousElementSibling,query(e).css({color:t.color,"font-family":t["font-family"],"font-size":t["font-size"],height:this.el.clientHeight+"px","padding-top":t["padding-top"],"padding-bottom":t["padding-bottom"],"padding-left":this.tmp["old-padding-left"],"padding-right":0,"margin-top":parseInt(t["margin-top"],10)+2+"px","margin-bottom":parseInt(t["margin-bottom"],10)+1+"px","margin-left":t["margin-left"],"margin-right":0,"z-index":1}),query(this.el).css("padding-left",e.clientWidth+"px !important"),this.helpers.prefix=e)}addSuffix(){if(this.options.prefix||this.options.arrow){let e,t=this;var i=getComputedStyle(this.el),s=(null==this.tmp["old-padding-right"]&&(this.tmp["old-padding-right"]=i["padding-right"]),parseInt(i["padding-right"]||0));this.options.arrow&&(this.helpers.arrow&&query(this.helpers.arrow).remove(),query(this.el).after('<div class="w2ui-field-helper" style="border: 1px solid transparent">&#160;    <div class="w2ui-field-up" type="up">        <div class="arrow-up" type="up"></div>    </div>    <div class="w2ui-field-down" type="down">        <div class="arrow-down" type="down"></div>    </div></div>'),e=query(this.el).get(0).nextElementSibling,query(e).css({color:i.color,"font-family":i["font-family"],"font-size":i["font-size"],height:this.el.clientHeight+"px",padding:0,"margin-top":parseInt(i["margin-top"],10)+1+"px","margin-bottom":0,"border-left":"1px solid silver",width:"16px",transform:"translateX(-100%)"}).on("mousedown",function(e){query(e.target).hasClass("arrow-up")&&t.keyDown(e,{keyCode:38}),query(e.target).hasClass("arrow-down")&&t.keyDown(e,{keyCode:40})}),s+=e.clientWidth,query(this.el).css("padding-right",s+"px !important"),this.helpers.arrow=e),""!==this.options.suffix&&(this.helpers.suffix&&query(this.helpers.suffix).remove(),query(this.el).after(`<div class="w2ui-field-helper">${this.options.suffix}</div>`),e=query(this.el).get(0).nextElementSibling,query(e).css({color:i.color,"font-family":i["font-family"],"font-size":i["font-size"],height:this.el.clientHeight+"px","padding-top":i["padding-top"],"padding-bottom":i["padding-bottom"],"padding-left":0,"padding-right":i["padding-right"],"margin-top":parseInt(i["margin-top"],10)+2+"px","margin-bottom":parseInt(i["margin-bottom"],10)+1+"px",transform:"translateX(-100%)"}),query(this.el).css("padding-right",e.clientWidth+"px !important"),this.helpers.suffix=e)}}addSearch(){if("list"===this.type){this.helpers.search&&query(this.helpers.search).remove();let e=parseInt(query(this.el).attr("tabIndex")),t=(isNaN(e)||-1===e||(this.tmp["old-tabIndex"]=e),null!=(e=this.tmp["old-tabIndex"]?this.tmp["old-tabIndex"]:e)&&!isNaN(e)||(e=0),"");var i=`
            <div class="w2ui-field-helper">
                <span class="w2ui-icon w2ui-icon-search"></span>
                <input ${t=null!=query(this.el).attr("id")?'id="'+query(this.el).attr("id")+'_search"':t} type="text" tabIndex="${e}" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"/>
            </div>`,i=(query(this.el).attr("tabindex",-1).before(i),query(this.el).get(0).previousElementSibling),s=(this.helpers.search=i,this.helpers.search_focus=query(i).find("input").get(0),getComputedStyle(this.el));query(i).css({width:this.el.clientWidth+"px","margin-top":s["margin-top"],"margin-left":s["margin-left"],"margin-bottom":s["margin-bottom"],"margin-right":s["margin-right"]}).find("input").css({cursor:"default",width:"100%",opacity:1,padding:s.padding,margin:s.margin,border:"1px solid transparent","background-color":"transparent"}),query(i).find("input").off(".helper").on("focus.helper",e=>{query(e.target).val(""),this.tmp.pholder=query(this.el).attr("placeholder")??"",this.focus(e),e.stopPropagation()}).on("blur.helper",e=>{query(e.target).val(""),null!=this.tmp.pholder&&query(this.el).attr("placeholder",this.tmp.pholder),this.blur(e),e.stopPropagation()}).on("keydown.helper",e=>{this.keyDown(e)}).on("keyup.helper",e=>{this.keyUp(e)}),query(i).on("click",e=>{query(e.target).find("input").focus()})}}addMultiSearch(){if(["enum","file"].includes(this.type)){query(this.helpers.multi).remove();let e="";var l,r,n=getComputedStyle(this.el),a=w2utils.stripSpaces(`
            margin-top: 0px;
            margin-bottom: 0px;
            margin-left: ${n["margin-left"]};
            margin-right: ${n["margin-right"]};
            width: ${w2utils.getSize(this.el,"width")-parseInt(n["margin-left"],10)-parseInt(n["margin-right"],10)}px;
        `);null==this.tmp["min-height"]&&(l=this.tmp["min-height"]=parseInt(("none"!=n["min-height"]?n["min-height"]:0)||0),r=parseInt(n.height),this.tmp["min-height"]=Math.max(l,r)),null==this.tmp["max-height"]&&"none"!=n["max-height"]&&(this.tmp["max-height"]=parseInt(n["max-height"]));let t="",i=(null!=query(this.el).attr("id")&&(t=`id="${query(this.el).attr("id")}_search"`),parseInt(query(this.el).attr("tabIndex"))),s=(isNaN(i)||-1===i||(this.tmp["old-tabIndex"]=i),null!=(i=this.tmp["old-tabIndex"]?this.tmp["old-tabIndex"]:i)&&!isNaN(i)||(i=0),"enum"===this.type&&(e=`
            <div class="w2ui-field-helper w2ui-list" style="${a}">
                <div class="w2ui-multi-items">
                    <div class="li-search">
                        <input ${t} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            tabindex="${i}"
                            ${query(this.el).prop("readonly")?"readonly":""}
                            ${query(this.el).prop("disabled")?"disabled":""}>
                    </div>
                </div>
            </div>`),"file"===this.type&&(e=`
            <div class="w2ui-field-helper w2ui-list" style="${a}">
                <div class="w2ui-multi-file">
                    <input name="attachment" class="file-input" type="file" tabindex="-1"'
                        style="width: 100%; height: 100%; opacity: 0" title=""
                        ${1!==this.options.max?"multiple":""}
                        ${query(this.el).prop("readonly")?"readonly":""}
                        ${query(this.el).prop("disabled")?"disabled":""}
                        ${query(this.el).attr("accept")?' accept="'+query(this.el).attr("accept")+'"':""}>
                </div>
                <div class="w2ui-multi-items">
                    <div class="li-search" style="display: none">
                        <input ${t} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            tabindex="${i}"
                            ${query(this.el).prop("readonly")?"readonly":""}
                            ${query(this.el).prop("disabled")?"disabled":""}>
                    </div>
                </div>
            </div>`),this.tmp["old-background-color"]=n["background-color"],this.tmp["old-border-color"]=n["border-color"],query(this.el).before(e).css({"border-color":"transparent","background-color":"transparent"}),query(this.el.previousElementSibling));this.helpers.multi=s,query(this.el).attr("tabindex",-1),s.on("click",e=>{this.focus(e)}),s.find("input:not(.file-input)").on("click",e=>{this.click(e)}).on("focus",e=>{this.focus(e)}).on("blur",e=>{this.blur(e)}).on("keydown",e=>{this.keyDown(e)}).on("keyup",e=>{this.keyUp(e)}),"file"===this.type&&s.find("input.file-input").off(".drag").on("click.drag",e=>{e.stopPropagation(),query(this.el).prop("readonly")||query(this.el).prop("disabled")||this.focus(e)}).on("dragenter.drag",e=>{query(this.el).prop("readonly")||query(this.el).prop("disabled")||s.addClass("w2ui-file-dragover")}).on("dragleave.drag",e=>{query(this.el).prop("readonly")||query(this.el).prop("disabled")||s.removeClass("w2ui-file-dragover")}).on("drop.drag",t=>{if(!query(this.el).prop("readonly")&&!query(this.el).prop("disabled")){s.removeClass("w2ui-file-dragover");let e=Array.from(t.dataTransfer.files);e.forEach(e=>{this.addFile(e)}),this.focus(t),t.preventDefault(),t.stopPropagation()}}).on("dragover.drag",e=>{e.preventDefault(),e.stopPropagation()}).on("change.drag",e=>{void 0!==e.target.files&&Array.from(e.target.files).forEach(e=>{this.addFile(e)}),this.focus(e)}),this.refresh()}}addFile(t){var e=this.options;let i=this.selected,s={name:t.name,type:t.type,modified:t.lastModifiedDate,size:t.size,content:null,file:t},l=0,r=0,n=[],a=(Array.isArray(i)&&i.forEach(e=>{e.name==t.name&&e.size==t.size&&n.push(w2utils.lang('The file "${name}" (${size}) is already added.',{name:t.name,size:w2utils.formatSize(t.size)})),l+=e.size,r++}),0!==e.maxFileSize&&s.size>e.maxFileSize&&n.push(w2utils.lang("Maximum file size is ${size}",{size:w2utils.formatSize(e.maxFileSize)})),0!==e.maxSize&&l+s.size>e.maxSize&&n.push(w2utils.lang("Maximum total size is ${size}",{size:w2utils.formatSize(e.maxSize)})),0!==e.max&&r>=e.max&&n.push(w2utils.lang("Maximum number of files is ${count}",{count:e.max})),this.trigger("add",{target:this.el,file:s,total:r,totalSize:l,errors:n}));if(!0!==a.isCancelled){if(!0!==e.silent&&0<n.length)return w2tooltip.show(this.el,"Errors: "+n.join("<br>")),void console.log("ERRORS (while adding files): ",n);if(i.push(s),"undefined"!=typeof FileReader&&!0===e.readContent){let e=new FileReader,i=this;e.onload=function(e){let t=e.target.result;e=t.indexOf(",");s.content=t.substr(e+1),i.refresh(),query(i.el).trigger("input").trigger("change"),a.finish()},e.readAsDataURL(t)}else this.refresh(),query(this.el).trigger("input").trigger("change"),a.finish()}}moveCaret2end(){setTimeout(()=>{this.el.setSelectionRange(this.el.value.length,this.el.value.length)},0)}}export{w2ui,w2utils,query,w2locale,w2event,w2base,w2popup,w2alert,w2confirm,w2prompt,Dialog,w2tooltip,w2menu,w2color,w2date,Tooltip,w2toolbar,w2sidebar,w2tabs,w2layout,w2grid,w2form,w2field};